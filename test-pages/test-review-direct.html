<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Direct E2E Test - Review Step Issues</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .header {
            background: #4a5568;
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .test-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #2d3748;
        }
        .test-step {
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 4px;
            background: #f7fafc;
            border-left: 3px solid #e2e8f0;
        }
        .pass { 
            background: #c6f6d5; 
            border-left-color: #48bb78;
        }
        .fail { 
            background: #fed7d7; 
            border-left-color: #fc8181;
        }
        .code {
            font-family: monospace;
            background: #edf2f7;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 13px;
        }
        button {
            background: #4299e1;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background: #3182ce;
        }
        .instructions {
            background: #fef5e7;
            border: 1px solid #f6e05e;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .results {
            background: #f0f4f8;
            border-radius: 6px;
            padding: 15px;
            margin-top: 20px;
        }
        pre {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 12px;
        }
        .data-display {
            background: #edf2f7;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîç Direct E2E Test - WizardStepReview Issues</h1>
        <p>Test the 4 persistent issues in the Review step (v7.5.1)</p>
    </div>

    <div class="instructions">
        <h3>üìã Instructions:</h3>
        <ol>
            <li>Open the Advanced Retirement Planner in a new tab</li>
            <li>Navigate to the Review step (Step 9)</li>
            <li>Open browser console (F12)</li>
            <li>Click "Copy Test Script" below and paste it in the console</li>
            <li>Review the results and click "Copy Debug Script" for detailed analysis</li>
        </ol>
    </div>

    <div class="test-section">
        <h3>üß™ Test Scripts</h3>
        <button onclick="copyTestScript()">üìã Copy Test Script</button>
        <button onclick="copyDebugScript()">üîç Copy Debug Script</button>
        <button onclick="copyFixScript()">üîß Copy Fix Script</button>
        <button onclick="copyHotfixScript()">üö® Copy Hotfix Script</button>
        <button onclick="showTestData()">üìä Show Test Data</button>
    </div>

    <div id="results" class="results" style="display:none;">
        <h3>Test Data for Manual Entry:</h3>
        <div id="test-data"></div>
    </div>

    <script>
        // Comprehensive test script
        const testScript = `
// === E2E TEST SCRIPT FOR REVIEW STEP ISSUES ===
// Run this in the browser console when on the Review step

(function runReviewStepTests() {
    console.log('üß™ Starting Review Step E2E Tests...');
    
    const results = {
        timestamp: new Date().toISOString(),
        url: window.location.href,
        issues: []
    };
    
    // Test 1: Retirement Projection Panel
    console.log('\\nüìä Test 1: Retirement Projection Panel');
    const projectionTest = (() => {
        // Check if function exists
        if (!window.generateRetirementProjectionChart) {
            return { 
                passed: false, 
                error: 'generateRetirementProjectionChart function not found',
                issue: 'Chart generation function missing'
            };
        }
        
        // Get current inputs
        const inputs = window.getAllInputs ? window.getAllInputs() : {};
        
        // Try to generate chart data
        try {
            const chartData = window.generateRetirementProjectionChart(inputs);
            
            // Check if data is valid
            if (!chartData || !Array.isArray(chartData)) {
                return { 
                    passed: false, 
                    error: 'Chart data is not an array',
                    data: chartData,
                    issue: 'Invalid chart data structure'
                };
            }
            
            if (chartData.length === 0) {
                return { 
                    passed: false, 
                    error: 'Chart data array is empty',
                    issue: 'No data points generated'
                };
            }
            
            // Check for "Missing data" message in DOM
            const hasMissingDataMsg = document.body.textContent.includes('Missing data for projection calculation');
            if (hasMissingDataMsg) {
                return { 
                    passed: false, 
                    error: 'UI shows "Missing data" message despite having data',
                    chartDataLength: chartData.length,
                    issue: 'UI not reflecting generated data'
                };
            }
            
            return { 
                passed: true, 
                dataPoints: chartData.length,
                firstPoint: chartData[0],
                lastPoint: chartData[chartData.length - 1]
            };
            
        } catch (error) {
            return { 
                passed: false, 
                error: error.message,
                stack: error.stack,
                issue: 'Chart generation throws error'
            };
        }
    })();
    
    console.log('Result:', projectionTest.passed ? '‚úÖ PASS' : '‚ùå FAIL');
    if (!projectionTest.passed) {
        console.error('Issue:', projectionTest.issue);
        results.issues.push({
            test: 'Retirement Projection',
            issue: projectionTest.issue,
            details: projectionTest
        });
    }
    
    // Test 2: Component Scores
    console.log('\\nüí∞ Test 2: Component Scores (Total Accumulation & Monthly Income)');
    const componentScoresTest = (() => {
        // Find the values in DOM
        const findValue = (searchTerms) => {
            const elements = Array.from(document.querySelectorAll('*')).filter(el => 
                searchTerms.some(term => el.textContent.includes(term))
            );
            
            for (const el of elements) {
                const parent = el.parentElement || el;
                const text = parent.textContent;
                const match = text.match(/[‚Ç™$‚Ç¨¬£]?([\\d,]+)/);
                if (match) {
                    return parseInt(match[1].replace(/,/g, ''));
                }
            }
            return 0;
        };
        
        const totalAccumulation = findValue(['Total Accumulation', '◊¶◊ë◊ô◊®◊î ◊¶◊§◊ï◊ô◊î']);
        const monthlyIncome = findValue(['Monthly Income', '◊î◊õ◊†◊°◊î ◊ó◊ï◊ì◊©◊ô◊™']);
        
        // Calculate expected values
        const inputs = window.getAllInputs ? window.getAllInputs() : {};
        let expectedAccumulation = 0;
        let expectedIncome = 0;
        
        if (inputs.planningType === 'couple') {
            // Accumulation
            expectedAccumulation += parseFloat(inputs.partner1CurrentPension || 0);
            expectedAccumulation += parseFloat(inputs.partner2CurrentPension || 0);
            expectedAccumulation += parseFloat(inputs.partner1CurrentTrainingFund || 0);
            expectedAccumulation += parseFloat(inputs.partner2CurrentTrainingFund || 0);
            expectedAccumulation += parseFloat(inputs.partner1PersonalPortfolio || 0);
            expectedAccumulation += parseFloat(inputs.partner2PersonalPortfolio || 0);
            
            // Monthly income
            expectedIncome += parseFloat(inputs.partner1Salary || 0);
            expectedIncome += parseFloat(inputs.partner2Salary || 0);
            expectedIncome += parseFloat(inputs.partner1Bonus || 0) / 12;
            expectedIncome += parseFloat(inputs.partner2Bonus || 0) / 12;
            expectedIncome += parseFloat(inputs.partner1RSU || 0) / 3;
            expectedIncome += parseFloat(inputs.partner2RSU || 0) / 3;
        } else {
            expectedAccumulation += parseFloat(inputs.currentSavings || 0);
            expectedAccumulation += parseFloat(inputs.currentTrainingFund || 0);
            expectedAccumulation += parseFloat(inputs.currentPersonalPortfolio || 0);
            
            expectedIncome += parseFloat(inputs.currentMonthlySalary || 0);
            expectedIncome += parseFloat(inputs.annualBonus || 0) / 12;
            expectedIncome += parseFloat(inputs.quarterlyRSU || 0) / 3;
        }
        
        const accumulationOk = totalAccumulation > 0;
        const incomeOk = monthlyIncome > 0;
        
        return {
            passed: accumulationOk && incomeOk,
            totalAccumulation: {
                displayed: totalAccumulation,
                expected: Math.round(expectedAccumulation),
                ok: accumulationOk
            },
            monthlyIncome: {
                displayed: monthlyIncome,
                expected: Math.round(expectedIncome),
                ok: incomeOk
            },
            issue: !accumulationOk || !incomeOk ? 'Values showing as 0' : null
        };
    })();
    
    console.log('Result:', componentScoresTest.passed ? '‚úÖ PASS' : '‚ùå FAIL');
    if (!componentScoresTest.passed) {
        console.error('Total Accumulation:', componentScoresTest.totalAccumulation);
        console.error('Monthly Income:', componentScoresTest.monthlyIncome);
        results.issues.push({
            test: 'Component Scores',
            issue: componentScoresTest.issue,
            details: componentScoresTest
        });
    }
    
    // Test 3: Financial Health Score Components
    console.log('\\nüè• Test 3: Financial Health Score (Savings Rate & Tax Efficiency)');
    const healthScoreTest = (() => {
        // Find percentages in DOM
        const findPercentage = (searchTerms) => {
            const elements = Array.from(document.querySelectorAll('*')).filter(el => 
                searchTerms.some(term => el.textContent.includes(term))
            );
            
            for (const el of elements) {
                const parent = el.closest('[class*="metric"], [class*="component"], div') || el.parentElement;
                if (parent) {
                    const text = parent.textContent;
                    const match = text.match(/(\\d+(?:\\.\\d+)?)\\s*%/);
                    if (match) {
                        return parseFloat(match[1]);
                    }
                }
            }
            return 0;
        };
        
        const savingsRate = findPercentage(['Savings Rate', '◊©◊ô◊¢◊ï◊® ◊ó◊ô◊°◊õ◊ï◊ü']);
        const taxEfficiency = findPercentage(['Tax Efficiency', '◊ô◊¢◊ô◊ú◊ï◊™ ◊û◊°']);
        
        // Try to calculate expected values
        const inputs = window.getAllInputs ? window.getAllInputs() : {};
        let expectedSavingsRate = 0;
        
        if (inputs.planningType === 'couple') {
            const rate1 = parseFloat(inputs.partner1PensionEmployeeRate || 0) + 
                         parseFloat(inputs.partner1TrainingFundEmployeeRate || 0);
            const rate2 = parseFloat(inputs.partner2PensionEmployeeRate || 0) + 
                         parseFloat(inputs.partner2TrainingFundEmployeeRate || 0);
            expectedSavingsRate = (rate1 + rate2) / 2;
        } else {
            expectedSavingsRate = parseFloat(inputs.employeePensionRate || 0) + 
                                parseFloat(inputs.trainingFundEmployeeRate || 0);
        }
        
        return {
            passed: savingsRate > 0 && taxEfficiency > 0,
            savingsRate: {
                displayed: savingsRate,
                expected: expectedSavingsRate,
                ok: savingsRate > 0
            },
            taxEfficiency: {
                displayed: taxEfficiency,
                ok: taxEfficiency > 0
            },
            issue: savingsRate === 0 || taxEfficiency === 0 ? 'Percentages showing as 0%' : null
        };
    })();
    
    console.log('Result:', healthScoreTest.passed ? '‚úÖ PASS' : '‚ùå FAIL');
    if (!healthScoreTest.passed) {
        console.error('Savings Rate:', healthScoreTest.savingsRate);
        console.error('Tax Efficiency:', healthScoreTest.taxEfficiency);
        results.issues.push({
            test: 'Financial Health Score',
            issue: healthScoreTest.issue,
            details: healthScoreTest
        });
    }
    
    // Test 4: Portfolio Tax Reactivity
    console.log('\\nüí∏ Test 4: Portfolio Tax Calculation Reactivity');
    console.log('‚ö†Ô∏è  This test requires manual interaction - please test in the Savings step');
    
    // Summary
    console.log('\\nüìä TEST SUMMARY');
    console.log('================');
    console.log('Total Issues Found:', results.issues.length);
    
    if (results.issues.length > 0) {
        console.log('\\n‚ùå Failed Tests:');
        results.issues.forEach((issue, i) => {
            console.log(\`\${i + 1}. \${issue.test}: \${issue.issue}\`);
        });
        
        console.log('\\nüìã Detailed Results:');
        console.log(JSON.stringify(results, null, 2));
    } else {
        console.log('‚úÖ All tests passed!');
    }
    
    // Save to window for further analysis
    window.reviewTestResults = results;
    console.log('\\nüíæ Results saved to window.reviewTestResults');
    
    return results;
})();
`;

        // Debug script
        const debugScript = `
// === DETAILED DEBUG SCRIPT FOR REVIEW STEP ===
// Run this after the test script for detailed analysis

(function debugReviewStep() {
    console.log('üîç DETAILED DEBUG ANALYSIS');
    console.log('========================');
    
    // 1. Input Analysis
    console.log('\\nüìã INPUT ANALYSIS');
    const inputs = window.getAllInputs ? window.getAllInputs() : {};
    const inputCount = Object.keys(inputs).length;
    console.log('Total input fields:', inputCount);
    console.log('Planning type:', inputs.planningType || 'NOT SET');
    
    // Critical fields by category
    const categories = {
        'Salary/Income': {
            individual: ['currentMonthlySalary', 'annualBonus', 'quarterlyRSU'],
            couple: ['partner1Salary', 'partner2Salary', 'partner1Bonus', 'partner2Bonus', 'partner1RSU', 'partner2RSU']
        },
        'Current Savings': {
            individual: ['currentSavings', 'currentTrainingFund', 'currentPersonalPortfolio'],
            couple: ['partner1CurrentPension', 'partner2CurrentPension', 'partner1PersonalPortfolio', 'partner2PersonalPortfolio']
        },
        'Contribution Rates': {
            individual: ['employeePensionRate', 'trainingFundEmployeeRate'],
            couple: ['partner1PensionEmployeeRate', 'partner2PensionEmployeeRate', 'partner1TrainingFundEmployeeRate', 'partner2TrainingFundEmployeeRate']
        },
        'Tax/Returns': {
            individual: ['personalPortfolioTaxRate', 'pensionReturn', 'personalPortfolioReturn'],
            couple: ['partner1PortfolioTaxRate', 'partner2PortfolioTaxRate', 'pensionReturn']
        }
    };
    
    const mode = inputs.planningType === 'couple' ? 'couple' : 'individual';
    console.log('\\nField Analysis (' + mode + ' mode):');
    
    Object.entries(categories).forEach(([category, fields]) => {
        console.log('\\n' + category + ':');
        let hasData = false;
        fields[mode].forEach(field => {
            const value = inputs[field];
            const exists = value !== undefined && value !== null && value !== '';
            if (exists) hasData = true;
            console.log('  ' + field + ':', exists ? '‚úÖ ' + value : '‚ùå MISSING');
        });
        if (!hasData) {
            console.warn('  ‚ö†Ô∏è  No data in this category!');
        }
    });
    
    // 2. Function availability
    console.log('\\n‚öôÔ∏è  FUNCTION AVAILABILITY');
    const functions = {
        'generateRetirementProjectionChart': window.generateRetirementProjectionChart,
        'calculateRetirement': window.calculateRetirement,
        'calculateFinancialHealthScore': window.calculateFinancialHealthScore,
        'enhancedGetFieldValue': window.enhancedGetFieldValue,
        'formatCurrency': window.formatCurrency,
        'getAllInputs': window.getAllInputs
    };
    
    Object.entries(functions).forEach(([name, func]) => {
        console.log(name + ':', typeof func === 'function' ? '‚úÖ Available' : '‚ùå Missing');
    });
    
    // 3. DOM Analysis
    console.log('\\nüñºÔ∏è  DOM ELEMENT ANALYSIS');
    const selectors = {
        'Review Step Container': '[class*="review"], #step-9',
        'Retirement Projection': '[class*="retirement-projection"]',
        'Component Scores': '.component-scores, #component-scores',
        'Financial Health': '[class*="financial-health"]',
        'Missing Data Message': ':contains("Missing data")'
    };
    
    Object.entries(selectors).forEach(([name, selector]) => {
        try {
            const elements = document.querySelectorAll(selector);
            console.log(name + ':', elements.length > 0 ? '‚úÖ Found (' + elements.length + ')' : '‚ùå Not found');
        } catch (e) {
            // For :contains selector
            const found = document.body.textContent.includes('Missing data');
            console.log(name + ':', found ? '‚ö†Ô∏è  Found' : '‚úÖ Not found');
        }
    });
    
    // 4. Calculation Tests
    console.log('\\nüßÆ CALCULATION TESTS');
    
    // Test retirement calculation
    if (window.calculateRetirement) {
        try {
            console.log('\\nTesting calculateRetirement...');
            const result = window.calculateRetirement(inputs);
            console.log('- Total Savings:', result.totalSavings || 0);
            console.log('- Monthly Income:', result.monthlyIncome || 0);
            console.log('- Pension Savings:', result.pensionSavings || 0);
            console.log('- Training Fund:', result.trainingFundValue || 0);
            
            if (result.totalSavings === 0) {
                console.warn('‚ö†Ô∏è  Total savings is 0 - check input mapping');
            }
        } catch (e) {
            console.error('‚ùå calculateRetirement error:', e.message);
        }
    }
    
    // Test financial health score
    if (window.calculateFinancialHealthScore) {
        try {
            console.log('\\nTesting calculateFinancialHealthScore...');
            const score = window.calculateFinancialHealthScore(inputs);
            console.log('- Total Score:', score.totalScore || 0);
            if (score.components) {
                Object.entries(score.components).forEach(([comp, data]) => {
                    console.log('- ' + comp + ':', data.score + '/' + data.maxScore);
                });
            }
        } catch (e) {
            console.error('‚ùå calculateFinancialHealthScore error:', e.message);
        }
    }
    
    // 5. Field Mapping Test
    console.log('\\nüîó FIELD MAPPING TEST');
    if (window.enhancedGetFieldValue) {
        // Test various field mappings
        const mappingTests = [
            {
                name: 'Monthly Salary',
                fields: ['currentMonthlySalary', 'monthlySalary', 'currentSalary', 'partner1Salary', 'partner2Salary'],
                options: { combinePartners: mode === 'couple' }
            },
            {
                name: 'Pension Rate',
                fields: ['employeePensionRate', 'pensionEmployeeRate', 'partner1PensionEmployeeRate', 'partner2PensionEmployeeRate'],
                options: { allowZero: true }
            },
            {
                name: 'Current Pension',
                fields: ['currentSavings', 'currentPension', 'partner1CurrentPension', 'partner2CurrentPension'],
                options: { combinePartners: mode === 'couple' }
            }
        ];
        
        mappingTests.forEach(test => {
            const value = window.enhancedGetFieldValue(inputs, test.fields, test.options);
            console.log(test.name + ':', value || 'NOT FOUND');
        });
    }
    
    // 6. Recommendations
    console.log('\\nüí° RECOMMENDATIONS');
    const recommendations = [];
    
    if (inputCount < 20) {
        recommendations.push('‚ö†Ô∏è  Very few inputs detected - ensure wizard data is being saved properly');
    }
    
    if (!functions.generateRetirementProjectionChart) {
        recommendations.push('‚ùå Chart generation function missing - check if chartDataGenerator.js is loaded');
    }
    
    if (mode === 'couple' && !inputs.partner1Salary && !inputs.partner2Salary) {
        recommendations.push('‚ùå No partner salary data - required for couple mode calculations');
    }
    
    if (!inputs.employeePensionRate && !inputs.partner1PensionEmployeeRate) {
        recommendations.push('‚ùå No pension contribution rates - required for savings rate calculation');
    }
    
    if (recommendations.length > 0) {
        recommendations.forEach((rec, i) => console.log((i + 1) + '.', rec));
    } else {
        console.log('‚úÖ No critical issues detected in setup');
    }
    
    console.log('\\nüíæ Debug data saved to window.debugReviewData');
    window.debugReviewData = {
        inputs,
        functions: Object.fromEntries(Object.entries(functions).map(([k, v]) => [k, typeof v === 'function'])),
        mode,
        timestamp: new Date().toISOString()
    };
})();
`;

        // Fix script to inject test data
        const fixScript = `
// === INJECT TEST DATA FOR REVIEW STEP ===
// Run this to inject comprehensive test data

(function injectTestData() {
    console.log('üíâ Injecting test data...');
    
    const testData = {
        // Planning type
        planningType: 'couple',
        
        // Basic info
        currentAge: 35,
        retirementAge: 67,
        
        // Partner 1
        partner1Name: 'John Test',
        partner1Salary: 25000,
        partner1Bonus: 50000,
        partner1RSU: 60000,
        partner1CurrentPension: 150000,
        partner1CurrentTrainingFund: 80000,
        partner1PersonalPortfolio: 500000,
        partner1PortfolioTaxRate: 25,
        partner1PensionEmployeeRate: 7,
        partner1PensionEmployerRate: 14.333,
        partner1TrainingFundEmployeeRate: 2.5,
        partner1TrainingFundEmployerRate: 7.5,
        partner1RealEstate: 200000,
        partner1Crypto: 50000,
        partner1BankAccount: 40000,
        
        // Partner 2
        partner2Name: 'Jane Test',
        partner2Salary: 20000,
        partner2Bonus: 30000,
        partner2RSU: 45000,
        partner2CurrentPension: 100000,
        partner2CurrentTrainingFund: 60000,
        partner2PersonalPortfolio: 300000,
        partner2PortfolioTaxRate: 30,
        partner2PensionEmployeeRate: 6,
        partner2PensionEmployerRate: 14.333,
        partner2TrainingFundEmployeeRate: 2.5,
        partner2TrainingFundEmployerRate: 7.5,
        partner2RealEstate: 150000,
        partner2Crypto: 30000,
        partner2BankAccount: 25000,
        
        // Investment settings
        riskTolerance: 'moderate',
        stockPercentage: 60,
        pensionReturn: 7,
        trainingFundReturn: 6.5,
        personalPortfolioReturn: 8,
        realEstateReturn: 6,
        cryptoReturn: 15,
        
        // Goals & expenses
        monthlyExpenses: 15000,
        emergencyFund: 65000,
        targetReplacement: 70,
        
        // Country
        taxCountry: 'israel',
        country: 'israel'
    };
    
    // Try multiple injection methods
    let injected = false;
    
    // Method 1: Direct state update
    if (window.setAllInputs) {
        window.setAllInputs(testData);
        injected = true;
        console.log('‚úÖ Injected via setAllInputs');
    }
    
    // Method 2: Update inputs function
    if (!injected && window.updateInputs) {
        window.updateInputs(testData);
        injected = true;
        console.log('‚úÖ Injected via updateInputs');
    }
    
    // Method 3: LocalStorage
    if (!injected) {
        localStorage.setItem('retirementWizardInputs', JSON.stringify(testData));
        console.log('‚úÖ Injected via localStorage');
        console.log('‚ö†Ô∏è  You may need to refresh the page');
    }
    
    // Method 4: Direct React state manipulation
    if (!injected) {
        const event = new CustomEvent('updateWizardData', { detail: testData });
        document.dispatchEvent(event);
        console.log('‚úÖ Dispatched update event');
    }
    
    console.log('\\nüìä Test data summary:');
    console.log('- Mode: Couple');
    console.log('- Partner 1 Total Savings: ‚Ç™' + (150000 + 80000 + 500000 + 200000 + 50000).toLocaleString());
    console.log('- Partner 2 Total Savings: ‚Ç™' + (100000 + 60000 + 300000 + 150000 + 30000).toLocaleString());
    console.log('- Combined Monthly Income: ‚Ç™' + (25000 + 20000 + 50000/12 + 30000/12 + 60000/3 + 45000/3).toLocaleString());
    
    console.log('\\n‚úÖ Test data injected. Navigate to Review step to test.');
    
    return testData;
})();
`;

        function copyTestScript() {
            navigator.clipboard.writeText(testScript).then(() => {
                alert('Test script copied! Paste it in the browser console when on the Review step.');
            });
        }

        function copyDebugScript() {
            navigator.clipboard.writeText(debugScript).then(() => {
                alert('Debug script copied! Run it after the test script for detailed analysis.');
            });
        }

        function copyFixScript() {
            navigator.clipboard.writeText(fixScript).then(() => {
                alert('Fix script copied! This will inject test data into the wizard.');
            });
        }
        
        // Hotfix script for production
        const hotfixScript = `// Production Hotfix for Review Step Issues
// Run this in console to fix the 4 persistent issues

(function applyReviewStepHotfix() {
    console.log('üîß Applying Review Step Hotfix...');
    
    // 1. Add missing getAllInputs function
    if (!window.getAllInputs) {
        window.getAllInputs = function() {
            // Try localStorage first
            try {
                const savedInputs = localStorage.getItem('retirementWizardInputs');
                if (savedInputs) {
                    const inputs = JSON.parse(savedInputs);
                    console.log('‚úÖ Retrieved', Object.keys(inputs).length, 'fields from localStorage');
                    return inputs;
                }
            } catch (e) {
                console.error('Failed to get inputs from localStorage:', e);
            }
            
            // Try window.wizardInputs
            if (window.wizardInputs) {
                return window.wizardInputs;
            }
            
            console.warn('‚ö†Ô∏è No inputs found');
            return {};
        };
        console.log('‚úÖ Added window.getAllInputs()');
    }
    
    // 2. Fix Component Scores calculation
    const originalCalcRetirement = window.calculateRetirement;
    window.calculateRetirement = function(inputs) {
        const result = originalCalcRetirement ? originalCalcRetirement.call(this, inputs) : {};
        
        // Ensure totalSavings includes all components for couple mode
        if (inputs.planningType === 'couple' && result.totalSavings === 0) {
            let totalSavings = 0;
            
            // Add all partner savings
            totalSavings += parseFloat(inputs.partner1CurrentPension || 0);
            totalSavings += parseFloat(inputs.partner2CurrentPension || 0);
            totalSavings += parseFloat(inputs.partner1CurrentTrainingFund || 0);
            totalSavings += parseFloat(inputs.partner2CurrentTrainingFund || 0);
            totalSavings += parseFloat(inputs.partner1PersonalPortfolio || 0);
            totalSavings += parseFloat(inputs.partner2PersonalPortfolio || 0);
            totalSavings += parseFloat(inputs.partner1RealEstate || 0);
            totalSavings += parseFloat(inputs.partner2RealEstate || 0);
            totalSavings += parseFloat(inputs.partner1Crypto || 0);
            totalSavings += parseFloat(inputs.partner2Crypto || 0);
            
            result.totalSavings = totalSavings;
            console.log('‚úÖ Fixed totalSavings calculation:', totalSavings);
        }
        
        // Calculate current monthly income (not retirement income)
        if (!result.currentMonthlyIncome) {
            let monthlyIncome = 0;
            
            if (inputs.planningType === 'couple') {
                // Partner salaries
                monthlyIncome += parseFloat(inputs.partner1Salary || 0);
                monthlyIncome += parseFloat(inputs.partner2Salary || 0);
                
                // Bonuses (annual to monthly)
                monthlyIncome += parseFloat(inputs.partner1Bonus || inputs.partner1AnnualBonus || 0) / 12;
                monthlyIncome += parseFloat(inputs.partner2Bonus || inputs.partner2AnnualBonus || 0) / 12;
                
                // RSUs (quarterly to monthly)
                monthlyIncome += parseFloat(inputs.partner1RSU || inputs.partner1QuarterlyRSU || 0) / 3;
                monthlyIncome += parseFloat(inputs.partner2RSU || inputs.partner2QuarterlyRSU || 0) / 3;
                
                // Other income
                monthlyIncome += parseFloat(inputs.partner1FreelanceIncome || 0);
                monthlyIncome += parseFloat(inputs.partner2FreelanceIncome || 0);
            } else {
                monthlyIncome += parseFloat(inputs.currentMonthlySalary || inputs.currentSalary || 0);
                monthlyIncome += parseFloat(inputs.annualBonus || 0) / 12;
                monthlyIncome += parseFloat(inputs.quarterlyRSU || 0) / 3;
                monthlyIncome += parseFloat(inputs.freelanceIncome || 0);
            }
            
            result.currentMonthlyIncome = monthlyIncome;
            console.log('‚úÖ Calculated current monthly income:', monthlyIncome);
        }
        
        return result;
    };
    console.log('‚úÖ Patched calculateRetirement function');
    
    // 3. Fix enhancedGetFieldValue if missing
    if (!window.enhancedGetFieldValue) {
        window.enhancedGetFieldValue = function(inputs, fieldNames, options = {}) {
            const { combinePartners = false, allowZero = false } = options;
            
            let values = [];
            for (const field of fieldNames) {
                const value = parseFloat(inputs[field] || 0);
                if (!isNaN(value) && (allowZero || value > 0)) {
                    values.push(value);
                }
            }
            
            if (values.length === 0) return 0;
            
            if (combinePartners && values.length > 1) {
                return values.reduce((sum, val) => sum + val, 0);
            }
            
            return values[0];
        };
        console.log('‚úÖ Added enhancedGetFieldValue function');
    }
    
    // 4. Trigger recalculation
    const inputs = window.getAllInputs();
    if (Object.keys(inputs).length > 0) {
        console.log('üîÑ Triggering recalculation with', Object.keys(inputs).length, 'fields');
        
        // Dispatch event to trigger React updates
        window.dispatchEvent(new CustomEvent('wizardInputsUpdated', { 
            detail: { inputs: inputs } 
        }));
        
        // If on Review step, try to force re-render
        const reviewStep = document.querySelector('[class*="review"], #step-9');
        if (reviewStep) {
            console.log('üîÑ Attempting to refresh Review step...');
            // Trigger a small state change to force re-render
            const event = new Event('change', { bubbles: true });
            reviewStep.dispatchEvent(event);
        }
    }
    
    console.log('‚úÖ Review Step Hotfix Applied!');
    console.log('üìù You may need to navigate away and back to the Review step to see changes');
    
    return {
        success: true,
        inputs: inputs,
        functions: {
            getAllInputs: !!window.getAllInputs,
            calculateRetirement: !!window.calculateRetirement,
            enhancedGetFieldValue: !!window.enhancedGetFieldValue
        }
    };
})();`;
        
        function copyHotfixScript() {
            navigator.clipboard.writeText(hotfixScript).then(() => {
                alert('Hotfix script copied! Run this to fix the Review step issues in production.');
            });
        }

        function showTestData() {
            const testData = {
                couple: {
                    planningType: 'couple',
                    currentAge: 35,
                    retirementAge: 67,
                    partner1Name: 'John',
                    partner1Salary: 25000,
                    partner1Bonus: 50000,
                    partner1RSU: 60000,
                    partner1CurrentPension: 150000,
                    partner1PersonalPortfolio: 500000,
                    partner1PortfolioTaxRate: 25,
                    partner2Name: 'Jane',
                    partner2Salary: 20000,
                    partner2Bonus: 30000,
                    partner2RSU: 45000,
                    partner2CurrentPension: 100000,
                    partner2PersonalPortfolio: 300000,
                    partner2PortfolioTaxRate: 30
                },
                individual: {
                    planningType: 'individual',
                    currentAge: 35,
                    retirementAge: 67,
                    currentMonthlySalary: 25000,
                    annualBonus: 50000,
                    quarterlyRSU: 60000,
                    currentSavings: 150000,
                    currentPersonalPortfolio: 500000,
                    personalPortfolioTaxRate: 25
                }
            };

            document.getElementById('test-data').innerHTML = `
                <h4>Couple Mode Test Data:</h4>
                <pre>${JSON.stringify(testData.couple, null, 2)}</pre>
                <h4>Individual Mode Test Data:</h4>
                <pre>${JSON.stringify(testData.individual, null, 2)}</pre>
            `;
            document.getElementById('results').style.display = 'block';
        }
    </script>
</body>
</html>