<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Health Score Comprehensive E2E Tests - TICKET-006</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }
        .header h1 {
            margin: 0 0 10px 0;
            font-size: 32px;
        }
        .header p {
            margin: 0;
            font-size: 18px;
            opacity: 0.9;
        }
        .controls {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        .controls button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-primary {
            background: #667eea;
            color: white;
        }
        .btn-primary:hover {
            background: #5a67d8;
            transform: translateY(-1px);
        }
        .btn-secondary {
            background: #48bb78;
            color: white;
        }
        .btn-secondary:hover {
            background: #38a169;
        }
        .btn-danger {
            background: #f56565;
            color: white;
        }
        .statistics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }
        .stat-value {
            font-size: 36px;
            font-weight: bold;
            margin: 10px 0;
        }
        .stat-label {
            color: #666;
            font-size: 14px;
        }
        .stat-card.error { border-left: 4px solid #f56565; }
        .stat-card.warning { border-left: 4px solid #ed8936; }
        .stat-card.success { border-left: 4px solid #48bb78; }
        .test-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }
        .test-title {
            font-size: 20px;
            font-weight: bold;
            color: #2d3748;
        }
        .test-status {
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
        }
        .status-pass { background: #c6f6d5; color: #22543d; }
        .status-fail { background: #fed7d7; color: #742a2a; }
        .status-warning { background: #feebc8; color: #744210; }
        .status-running { background: #bee3f8; color: #2a4e7c; }
        .test-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }
        .info-item {
            background: #f7fafc;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #e2e8f0;
        }
        .info-label {
            font-size: 12px;
            color: #718096;
            margin-bottom: 3px;
        }
        .info-value {
            font-size: 16px;
            font-weight: bold;
            color: #2d3748;
        }
        .fallback-section {
            background: #fff5f5;
            border: 1px solid #feb2b2;
            border-radius: 5px;
            padding: 15px;
            margin-top: 15px;
        }
        .fallback-header {
            font-weight: bold;
            color: #c53030;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .fallback-count {
            background: #fc8181;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 14px;
        }
        .fallback-item {
            background: white;
            padding: 8px;
            margin: 5px 0;
            border-radius: 3px;
            font-family: monospace;
            font-size: 12px;
            border-left: 3px solid #fc8181;
        }
        .log-viewer {
            background: #1a202c;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 10px;
        }
        .log-entry {
            margin: 2px 0;
            padding: 2px 0;
        }
        .log-warn { color: #fbbf24; }
        .log-error { color: #f87171; }
        .log-info { color: #60a5fa; }
        .log-success { color: #34d399; }
        .summary-section {
            background: white;
            border-radius: 8px;
            padding: 30px;
            margin-top: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-top: 20px;
        }
        .field-analysis {
            background: #f7fafc;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #e2e8f0;
        }
        .field-analysis h3 {
            margin-top: 0;
            color: #2d3748;
        }
        .field-list {
            font-family: monospace;
            font-size: 12px;
            line-height: 1.6;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e2e8f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }
        .hidden { display: none; }
        .export-section {
            text-align: center;
            margin-top: 20px;
        }
        .export-btn {
            background: #4299e1;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            margin: 0 10px;
        }
        .export-btn:hover {
            background: #3182ce;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üèÜ Financial Health Score Comprehensive E2E Tests</h1>
        <p>TICKET-006: Zero Fallback Achievement - Testing 20 Diverse Scenarios</p>
    </div>

    <div class="controls">
        <button class="btn-primary" onclick="runAllTests()">üöÄ Run All Tests</button>
        <button class="btn-secondary" onclick="runSelectedTest()">‚ñ∂Ô∏è Run Selected</button>
        <button class="btn-danger" onclick="clearResults()">üóëÔ∏è Clear Results</button>
        <select id="scenarioSelect">
            <option value="">Select a scenario...</option>
        </select>
        <label>
            <input type="checkbox" id="verboseLogging" checked>
            Verbose Logging
        </label>
    </div>

    <div class="statistics">
        <div class="stat-card">
            <div class="stat-label">Total Scenarios</div>
            <div class="stat-value" id="totalScenarios">0</div>
        </div>
        <div class="stat-card success">
            <div class="stat-label">Passed</div>
            <div class="stat-value" id="passedTests">0</div>
        </div>
        <div class="stat-card warning">
            <div class="stat-label">Warnings</div>
            <div class="stat-value" id="warningTests">0</div>
        </div>
        <div class="stat-card error">
            <div class="stat-label">Failed</div>
            <div class="stat-value" id="failedTests">0</div>
        </div>
    </div>

    <div class="progress-bar">
        <div class="progress-fill" id="progressBar" style="width: 0%">0%</div>
    </div>

    <div id="testResults"></div>

    <div class="summary-section hidden" id="summarySection">
        <h2>üìä Test Summary & Analysis</h2>
        <div class="summary-grid">
            <div class="field-analysis">
                <h3>Most Common Fallback Fields</h3>
                <div id="commonFallbacks" class="field-list"></div>
            </div>
            <div class="field-analysis">
                <h3>Field Mapping Recommendations</h3>
                <div id="fieldRecommendations" class="field-list"></div>
            </div>
        </div>
        <div class="export-section">
            <button class="export-btn" onclick="exportLogs()">üì• Export Logs (JSON)</button>
            <button class="export-btn" onclick="exportReport()">üìÑ Export Report (HTML)</button>
            <button class="export-btn" onclick="exportFieldMappings()">üó∫Ô∏è Export Field Mappings</button>
        </div>
    </div>

    <!-- Load dependencies -->
    <script src="src/utils/fieldMappingDictionary.js"></script>
    <script src="src/data/marketConstants.js"></script>
    <script src="src/translations/multiLanguage.js"></script>
    <script src="src/utils/retirementCalculations.js"></script>
    <script src="src/utils/financialHealthEngine.js"></script>

    <script>
        // Enhanced Test Runner with Comprehensive Logging
        const testRunner = {
            scenarios: [],
            results: [],
            currentScenario: null,
            originalConsole: {
                log: console.log,
                warn: console.warn,
                error: console.error
            },
            logs: {
                all: [],
                warnings: [],
                errors: [],
                fallbacks: [],
                fieldSearches: []
            },
            fallbackAnalysis: {},
            
            init() {
                this.loadScenarios();
                this.interceptConsole();
                this.populateScenarioSelect();
            },
            
            interceptConsole() {
                const self = this;
                
                console.log = function(...args) {
                    const message = args.join(' ');
                    self.logs.all.push({
                        type: 'log',
                        message,
                        timestamp: Date.now(),
                        scenario: self.currentScenario
                    });
                    
                    // Detect field searches
                    if (message.includes('Field search failed') || message.includes('Available fields:')) {
                        self.logs.fieldSearches.push({
                            message,
                            scenario: self.currentScenario,
                            timestamp: Date.now()
                        });
                    }
                    
                    if (document.getElementById('verboseLogging').checked) {
                        self.originalConsole.log.apply(console, args);
                    }
                };
                
                console.warn = function(...args) {
                    const message = args.join(' ');
                    self.logs.all.push({
                        type: 'warn',
                        message,
                        timestamp: Date.now(),
                        scenario: self.currentScenario
                    });
                    
                    self.logs.warnings.push({
                        message,
                        scenario: self.currentScenario,
                        timestamp: Date.now()
                    });
                    
                    // Detect fallback activations
                    if (message.includes('Fallback Activated')) {
                        const fieldMatch = message.match(/No value found for fields: \[([^\]]+)\]/);
                        if (fieldMatch) {
                            const fields = fieldMatch[1].split(', ').map(f => f.trim());
                            self.logs.fallbacks.push({
                                fields,
                                message,
                                scenario: self.currentScenario,
                                timestamp: Date.now()
                            });
                            
                            // Track fallback frequency
                            fields.forEach(field => {
                                self.fallbackAnalysis[field] = (self.fallbackAnalysis[field] || 0) + 1;
                            });
                        }
                    }
                    
                    self.originalConsole.warn.apply(console, args);
                };
                
                console.error = function(...args) {
                    const message = args.join(' ');
                    self.logs.all.push({
                        type: 'error',
                        message,
                        timestamp: Date.now(),
                        scenario: self.currentScenario
                    });
                    
                    self.logs.errors.push({
                        message,
                        scenario: self.currentScenario,
                        timestamp: Date.now()
                    });
                    
                    self.originalConsole.error.apply(console, args);
                };
            },
            
            loadScenarios() {
                // 20 Comprehensive Test Scenarios
                this.scenarios = [
                    // Individual Mode Scenarios
                    {
                        name: "1. Young Professional (Israel)",
                        description: "Basic pension + savings",
                        inputs: {
                            planningType: "individual",
                            currentAge: 28,
                            retirementAge: 67,
                            country: "israel",
                            currentMonthlySalary: 15000,
                            currency: "ILS",
                            pensionEmployeeRate: 7,
                            pensionEmployerRate: 14.33,
                            trainingFundEmployeeRate: 2.5,
                            trainingFundEmployerRate: 7.5,
                            currentBankAccount: 30000,
                            currentPersonalPortfolio: 50000,
                            personalPortfolioReturn: 8,
                            currentMonthlyExpenses: 12000,
                            monthlyAdditionalSavings: 1000,
                            riskTolerance: "moderate"
                        },
                        expectedRange: { min: 65, max: 75 }
                    },
                    {
                        name: "2. Mid-Career (USA)",
                        description: "401k + IRA + portfolio",
                        inputs: {
                            planningType: "individual",
                            currentAge: 42,
                            retirementAge: 65,
                            country: "usa",
                            currentMonthlySalary: 8000,
                            currency: "USD",
                            current401k: 300000,
                            currentIRA: 150000,
                            currentPersonalPortfolio: 200000,
                            currentBankAccount: 50000,
                            monthlyContribution401k: 1500,
                            monthlyContributionIRA: 500,
                            currentMonthlyExpenses: 6000,
                            riskTolerance: "moderate"
                        },
                        expectedRange: { min: 75, max: 85 }
                    },
                    {
                        name: "3. Pre-Retiree (UK)",
                        description: "Complex portfolio + pension",
                        inputs: {
                            planningType: "individual",
                            currentAge: 58,
                            retirementAge: 65,
                            country: "uk",
                            currentMonthlySalary: 6000,
                            currency: "GBP",
                            currentPensionSavings: 500000,
                            currentPersonalPortfolio: 300000,
                            currentRealEstate: 400000,
                            emergencyFund: 50000,
                            currentMonthlyExpenses: 4500,
                            riskTolerance: "conservative"
                        },
                        expectedRange: { min: 80, max: 90 }
                    },
                    {
                        name: "4. High Earner with RSUs (Israel)",
                        description: "RSUs + bonus + crypto",
                        inputs: {
                            planningType: "individual",
                            currentAge: 35,
                            retirementAge: 60,
                            country: "israel",
                            currentMonthlySalary: 40000,
                            currency: "ILS",
                            rsuCompany: "AAPL",
                            rsuUnits: 100,
                            rsuFrequency: "quarterly",
                            rsuCurrentStockPrice: 190.75,
                            annualBonus: 150000,
                            currentPensionSavings: 300000,
                            currentCrypto: 100000,
                            currentPersonalPortfolio: 500000,
                            emergencyFund: 200000,
                            pensionEmployeeRate: 7,
                            pensionEmployerRate: 14.33,
                            riskTolerance: "aggressive"
                        },
                        expectedRange: { min: 85, max: 95 }
                    },
                    {
                        name: "5. Freelancer (Israel)",
                        description: "Irregular income + self-employed pension",
                        inputs: {
                            planningType: "individual",
                            currentAge: 38,
                            retirementAge: 67,
                            country: "israel",
                            currentMonthlySalary: 20000,
                            currency: "ILS",
                            selfEmployed: true,
                            pensionEmployeeRate: 16,
                            currentPensionSavings: 150000,
                            currentPersonalPortfolio: 100000,
                            emergencyFund: 120000,
                            currentMonthlyExpenses: 15000,
                            riskTolerance: "moderate"
                        },
                        expectedRange: { min: 60, max: 70 }
                    },
                    {
                        name: "6. Minimal Data",
                        description: "Only required fields",
                        inputs: {
                            planningType: "individual",
                            currentAge: 40,
                            retirementAge: 67,
                            currentMonthlySalary: 10000,
                            currency: "ILS"
                        },
                        expectedRange: { min: 15, max: 25 }
                    },
                    {
                        name: "7. Maximum Data",
                        description: "All possible fields populated",
                        inputs: {
                            planningType: "individual",
                            currentAge: 45,
                            retirementAge: 65,
                            country: "israel",
                            currentMonthlySalary: 35000,
                            currency: "ILS",
                            pensionEmployeeRate: 7,
                            pensionEmployerRate: 14.33,
                            trainingFundEmployeeRate: 2.5,
                            trainingFundEmployerRate: 7.5,
                            currentPensionSavings: 800000,
                            currentTrainingFund: 200000,
                            current401k: 100000,
                            currentIRA: 50000,
                            currentPersonalPortfolio: 400000,
                            currentRealEstate: 1500000,
                            currentCrypto: 50000,
                            emergencyFund: 300000,
                            currentBankAccount: 100000,
                            monthlyAdditionalSavings: 5000,
                            annualBonus: 100000,
                            currentMonthlyExpenses: 25000,
                            riskTolerance: "moderate"
                        },
                        expectedRange: { min: 90, max: 100 }
                    },
                    {
                        name: "8. Retired Individual",
                        description: "Pension income + withdrawals",
                        inputs: {
                            planningType: "individual",
                            currentAge: 68,
                            retirementAge: 65,
                            country: "israel",
                            monthlyPensionIncome: 12000,
                            currency: "ILS",
                            currentPensionSavings: 1000000,
                            currentPersonalPortfolio: 500000,
                            emergencyFund: 100000,
                            currentMonthlyExpenses: 10000,
                            riskTolerance: "conservative"
                        },
                        expectedRange: { min: 70, max: 80 }
                    },
                    {
                        name: "9. International Worker",
                        description: "Multi-country pensions",
                        inputs: {
                            planningType: "individual",
                            currentAge: 45,
                            retirementAge: 65,
                            country: "israel",
                            currentMonthlySalary: 20000,
                            currency: "ILS",
                            currentPensionSavings: 400000,
                            foreignPension: 200000,
                            current401k: 150000,
                            emergencyFund: 80000,
                            currentMonthlyExpenses: 15000,
                            riskTolerance: "moderate"
                        },
                        expectedRange: { min: 60, max: 70 }
                    },
                    {
                        name: "10. Debt Situation",
                        description: "Loans + credit cards",
                        inputs: {
                            planningType: "individual",
                            currentAge: 35,
                            retirementAge: 67,
                            country: "israel",
                            currentMonthlySalary: 15000,
                            currency: "ILS",
                            currentPensionSavings: 50000,
                            emergencyFund: 5000,
                            monthlyDebt: 5000,
                            totalDebt: 200000,
                            currentMonthlyExpenses: 12000,
                            riskTolerance: "conservative"
                        },
                        expectedRange: { min: 20, max: 30 }
                    },
                    
                    // Couple Mode Scenarios
                    {
                        name: "11. Young Couple (Israel)",
                        description: "Starting retirement planning",
                        inputs: {
                            planningType: "couple",
                            currentAge: 30,
                            partnerCurrentAge: 28,
                            retirementAge: 67,
                            partnerRetirementAge: 67,
                            country: "israel",
                            partner1Salary: 12000,
                            partner2Salary: 10000,
                            currency: "ILS",
                            currentPensionSavings: 50000,
                            partnerCurrentSavings: 30000,
                            emergencyFund: 40000,
                            expenses: 18000,
                            pensionEmployeeRate: 7,
                            pensionEmployerRate: 14.33
                        },
                        expectedRange: { min: 55, max: 65 }
                    },
                    {
                        name: "12. Mid-Career Family",
                        description: "Kids + mortgage + dual income",
                        inputs: {
                            planningType: "couple",
                            currentAge: 42,
                            partnerCurrentAge: 40,
                            retirementAge: 67,
                            partnerRetirementAge: 65,
                            country: "israel",
                            partner1Salary: 25000,
                            partner2Salary: 20000,
                            currency: "ILS",
                            currentPensionSavings: 800000,
                            partnerCurrentSavings: 600000,
                            emergencyFund: 150000,
                            currentPersonalPortfolio: 300000,
                            expenses: 30000,
                            monthlyDebt: 10000,
                            pensionEmployeeRate: 7,
                            pensionEmployerRate: 14.33
                        },
                        expectedRange: { min: 75, max: 85 }
                    },
                    {
                        name: "13. Single Earner Couple",
                        description: "One working, one not",
                        inputs: {
                            planningType: "couple",
                            currentAge: 45,
                            partnerCurrentAge: 43,
                            retirementAge: 67,
                            partnerRetirementAge: 67,
                            country: "israel",
                            partner1Salary: 30000,
                            partner2Salary: 0,
                            currency: "ILS",
                            currentPensionSavings: 500000,
                            partnerCurrentSavings: 100000,
                            emergencyFund: 100000,
                            expenses: 20000,
                            pensionEmployeeRate: 7,
                            pensionEmployerRate: 14.33
                        },
                        expectedRange: { min: 60, max: 70 }
                    },
                    {
                        name: "14. Both Retired",
                        description: "Pension income only",
                        inputs: {
                            planningType: "couple",
                            currentAge: 70,
                            partnerCurrentAge: 68,
                            retirementAge: 65,
                            partnerRetirementAge: 65,
                            country: "israel",
                            monthlyPensionIncome: 8000,
                            partnerMonthlyPensionIncome: 6000,
                            currency: "ILS",
                            currentPensionSavings: 600000,
                            partnerCurrentSavings: 400000,
                            emergencyFund: 150000,
                            expenses: 12000,
                            riskTolerance: "conservative"
                        },
                        expectedRange: { min: 70, max: 80 }
                    },
                    {
                        name: "15. Mixed Employment",
                        description: "One employed, one freelance",
                        inputs: {
                            planningType: "couple",
                            currentAge: 38,
                            partnerCurrentAge: 36,
                            retirementAge: 67,
                            partnerRetirementAge: 67,
                            country: "israel",
                            partner1Salary: 18000,
                            partner2Salary: 15000,
                            currency: "ILS",
                            partner2SelfEmployed: true,
                            currentPensionSavings: 200000,
                            partnerCurrentSavings: 150000,
                            emergencyFund: 80000,
                            expenses: 25000,
                            pensionEmployeeRate: 7,
                            pensionEmployerRate: 14.33
                        },
                        expectedRange: { min: 65, max: 75 }
                    },
                    {
                        name: "16. International Couple",
                        description: "Different countries/currencies",
                        inputs: {
                            planningType: "couple",
                            currentAge: 40,
                            partnerCurrentAge: 38,
                            retirementAge: 65,
                            partnerRetirementAge: 65,
                            country: "israel",
                            partner1Salary: 20000,
                            partner2Salary: 5000,
                            partner2Currency: "USD",
                            currency: "ILS",
                            currentPensionSavings: 300000,
                            partnerCurrentSavings: 100000,
                            partner2Foreign401k: 200000,
                            emergencyFund: 100000,
                            expenses: 22000,
                            pensionEmployeeRate: 7,
                            pensionEmployerRate: 14.33
                        },
                        expectedRange: { min: 70, max: 80 }
                    },
                    {
                        name: "17. High Net Worth Couple",
                        description: "Multiple asset classes",
                        inputs: {
                            planningType: "couple",
                            currentAge: 50,
                            partnerCurrentAge: 48,
                            retirementAge: 65,
                            partnerRetirementAge: 65,
                            country: "israel",
                            partner1Salary: 50000,
                            partner2Salary: 40000,
                            currency: "ILS",
                            currentPensionSavings: 1500000,
                            partnerCurrentSavings: 1200000,
                            currentPersonalPortfolio: 800000,
                            partnerPersonalPortfolio: 600000,
                            currentRealEstate: 3000000,
                            currentCrypto: 200000,
                            emergencyFund: 500000,
                            expenses: 50000,
                            pensionEmployeeRate: 7,
                            pensionEmployerRate: 14.33,
                            riskTolerance: "moderate"
                        },
                        expectedRange: { min: 85, max: 95 }
                    },
                    {
                        name: "18. Debt-Heavy Couple",
                        description: "High debt-to-income",
                        inputs: {
                            planningType: "couple",
                            currentAge: 35,
                            partnerCurrentAge: 33,
                            retirementAge: 67,
                            partnerRetirementAge: 67,
                            country: "israel",
                            partner1Salary: 15000,
                            partner2Salary: 12000,
                            currency: "ILS",
                            currentPensionSavings: 80000,
                            partnerCurrentSavings: 60000,
                            emergencyFund: 10000,
                            expenses: 25000,
                            monthlyDebt: 12000,
                            totalDebt: 500000,
                            pensionEmployeeRate: 7,
                            pensionEmployerRate: 14.33
                        },
                        expectedRange: { min: 25, max: 35 }
                    },
                    {
                        name: "19. Minimal Couple Data",
                        description: "Basic fields only",
                        inputs: {
                            planningType: "couple",
                            currentAge: 40,
                            partnerCurrentAge: 38,
                            retirementAge: 67,
                            partnerRetirementAge: 67,
                            partner1Salary: 15000,
                            partner2Salary: 12000,
                            currency: "ILS"
                        },
                        expectedRange: { min: 20, max: 30 }
                    },
                    {
                        name: "20. Complex Portfolio Couple",
                        description: "All asset types",
                        inputs: {
                            planningType: "couple",
                            currentAge: 45,
                            partnerCurrentAge: 43,
                            retirementAge: 65,
                            partnerRetirementAge: 65,
                            country: "israel",
                            partner1Salary: 35000,
                            partner2Salary: 30000,
                            currency: "ILS",
                            currentPensionSavings: 1000000,
                            partnerCurrentSavings: 800000,
                            currentTrainingFund: 300000,
                            partnerTrainingFund: 250000,
                            current401k: 200000,
                            partner401k: 150000,
                            currentIRA: 100000,
                            partnerIRA: 80000,
                            currentPersonalPortfolio: 600000,
                            partnerPersonalPortfolio: 400000,
                            currentRealEstate: 2000000,
                            currentCrypto: 150000,
                            partnerCrypto: 100000,
                            emergencyFund: 400000,
                            monthlyAdditionalSavings: 8000,
                            expenses: 40000,
                            pensionEmployeeRate: 7,
                            pensionEmployerRate: 14.33,
                            trainingFundEmployeeRate: 2.5,
                            trainingFundEmployerRate: 7.5,
                            riskTolerance: "moderate"
                        },
                        expectedRange: { min: 90, max: 100 }
                    }
                ];
            },
            
            populateScenarioSelect() {
                const select = document.getElementById('scenarioSelect');
                select.innerHTML = '<option value="">Select a scenario...</option>';
                
                this.scenarios.forEach((scenario, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = scenario.name;
                    select.appendChild(option);
                });
            },
            
            clearLogs() {
                this.logs = {
                    all: [],
                    warnings: [],
                    errors: [],
                    fallbacks: [],
                    fieldSearches: []
                };
            },
            
            async runScenario(scenario, index) {
                this.currentScenario = scenario.name;
                this.clearLogs();
                
                const startTime = Date.now();
                let result = null;
                let error = null;
                
                try {
                    // Run the financial health calculation
                    result = window.calculateFinancialHealthScore(scenario.inputs);
                } catch (e) {
                    error = e;
                    this.originalConsole.error('Calculation error:', e);
                }
                
                const endTime = Date.now();
                
                // Analyze results
                const fallbackCount = this.logs.fallbacks.length;
                const warningCount = this.logs.warnings.length;
                const errorCount = this.logs.errors.length;
                
                let status = 'pass';
                if (error || errorCount > 0) {
                    status = 'fail';
                } else if (fallbackCount > 0) {
                    status = 'warning';
                }
                
                const testResult = {
                    scenario: scenario.name,
                    description: scenario.description,
                    status,
                    score: result ? result.totalScore : 0,
                    expectedRange: scenario.expectedRange,
                    executionTime: endTime - startTime,
                    fallbackCount,
                    warningCount,
                    errorCount,
                    logs: JSON.parse(JSON.stringify(this.logs)),
                    result,
                    error,
                    inputs: scenario.inputs
                };
                
                this.results.push(testResult);
                this.displayResult(testResult, index);
                
                return testResult;
            },
            
            displayResult(result, index) {
                const container = document.getElementById('testResults');
                
                const testDiv = document.createElement('div');
                testDiv.className = 'test-container';
                testDiv.innerHTML = `
                    <div class="test-header">
                        <div class="test-title">${result.scenario}</div>
                        <div class="test-status status-${result.status}">${result.status.toUpperCase()}</div>
                    </div>
                    <div class="test-info">
                        <div class="info-item">
                            <div class="info-label">Score</div>
                            <div class="info-value">${result.score}/100</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Expected Range</div>
                            <div class="info-value">${result.expectedRange.min}-${result.expectedRange.max}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Execution Time</div>
                            <div class="info-value">${result.executionTime}ms</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Fallbacks</div>
                            <div class="info-value" style="color: ${result.fallbackCount > 0 ? '#e53e3e' : '#38a169'}">${result.fallbackCount}</div>
                        </div>
                    </div>
                    ${result.fallbackCount > 0 ? this.renderFallbacks(result) : ''}
                    ${result.error ? `<div class="error-message">Error: ${result.error.message}</div>` : ''}
                    <details>
                        <summary>View Logs</summary>
                        <div class="log-viewer">${this.renderLogs(result.logs)}</div>
                    </details>
                `;
                
                container.appendChild(testDiv);
            },
            
            renderFallbacks(result) {
                const fallbacks = result.logs.fallbacks;
                const uniqueFields = new Set();
                
                fallbacks.forEach(f => f.fields.forEach(field => uniqueFields.add(field)));
                
                return `
                    <div class="fallback-section">
                        <div class="fallback-header">
                            ‚ö†Ô∏è Fallback Warnings
                            <span class="fallback-count">${fallbacks.length}</span>
                        </div>
                        ${fallbacks.map(f => `
                            <div class="fallback-item">
                                Missing fields: [${f.fields.join(', ')}]
                            </div>
                        `).join('')}
                    </div>
                `;
            },
            
            renderLogs(logs) {
                return logs.all.map(log => {
                    const className = `log-${log.type}`;
                    return `<div class="log-entry ${className}">[${log.type.toUpperCase()}] ${this.escapeHtml(log.message)}</div>`;
                }).join('');
            },
            
            escapeHtml(text) {
                const map = {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#039;'
                };
                return text.replace(/[&<>"']/g, m => map[m]);
            },
            
            updateStatistics() {
                const total = this.results.length;
                const passed = this.results.filter(r => r.status === 'pass').length;
                const warnings = this.results.filter(r => r.status === 'warning').length;
                const failed = this.results.filter(r => r.status === 'fail').length;
                
                document.getElementById('totalScenarios').textContent = total;
                document.getElementById('passedTests').textContent = passed;
                document.getElementById('warningTests').textContent = warnings;
                document.getElementById('failedTests').textContent = failed;
                
                const progress = total > 0 ? Math.round((total / this.scenarios.length) * 100) : 0;
                const progressBar = document.getElementById('progressBar');
                progressBar.style.width = `${progress}%`;
                progressBar.textContent = `${progress}%`;
            },
            
            async runAllTests() {
                this.results = [];
                this.fallbackAnalysis = {};
                document.getElementById('testResults').innerHTML = '';
                document.getElementById('summarySection').classList.add('hidden');
                
                for (let i = 0; i < this.scenarios.length; i++) {
                    await this.runScenario(this.scenarios[i], i);
                    this.updateStatistics();
                    
                    // Small delay to allow UI updates
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                this.showSummary();
            },
            
            async runSelectedTest() {
                const select = document.getElementById('scenarioSelect');
                const index = parseInt(select.value);
                
                if (isNaN(index)) {
                    alert('Please select a scenario');
                    return;
                }
                
                await this.runScenario(this.scenarios[index], index);
                this.updateStatistics();
                
                if (this.results.length === this.scenarios.length) {
                    this.showSummary();
                }
            },
            
            showSummary() {
                document.getElementById('summarySection').classList.remove('hidden');
                
                // Show most common fallback fields
                const sortedFallbacks = Object.entries(this.fallbackAnalysis)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 10);
                
                const fallbacksHtml = sortedFallbacks.map(([field, count]) => 
                    `${field}: <strong>${count} occurrences</strong>`
                ).join('<br>');
                
                document.getElementById('commonFallbacks').innerHTML = fallbacksHtml || 'No fallbacks detected! üéâ';
                
                // Generate field mapping recommendations
                const recommendations = sortedFallbacks.map(([field, count]) => {
                    const severity = count > 10 ? 'CRITICAL' : count > 5 ? 'HIGH' : 'MEDIUM';
                    return `<span style="color: ${severity === 'CRITICAL' ? '#e53e3e' : severity === 'HIGH' ? '#dd6b20' : '#d69e2e'}">[${severity}]</span> Add mapping for: ${field}`;
                }).join('<br>');
                
                document.getElementById('fieldRecommendations').innerHTML = recommendations || 'All fields properly mapped! ‚úÖ';
            },
            
            clearResults() {
                this.results = [];
                this.fallbackAnalysis = {};
                document.getElementById('testResults').innerHTML = '';
                document.getElementById('summarySection').classList.add('hidden');
                this.updateStatistics();
            },
            
            exportLogs() {
                const exportData = {
                    testRun: {
                        timestamp: new Date().toISOString(),
                        scenarioCount: this.scenarios.length,
                        resultsCount: this.results.length
                    },
                    results: this.results,
                    fallbackAnalysis: this.fallbackAnalysis,
                    summary: {
                        totalFallbacks: this.results.reduce((sum, r) => sum + r.fallbackCount, 0),
                        totalWarnings: this.results.reduce((sum, r) => sum + r.warningCount, 0),
                        totalErrors: this.results.reduce((sum, r) => sum + r.errorCount, 0),
                        passRate: (this.results.filter(r => r.status === 'pass').length / this.results.length * 100).toFixed(2) + '%'
                    }
                };
                
                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `financial-health-test-logs-${Date.now()}.json`;
                a.click();
            },
            
            exportReport() {
                const reportHtml = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Financial Health Test Report</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; }
                            h1 { color: #2d3748; }
                            .summary { background: #f7fafc; padding: 20px; border-radius: 8px; margin: 20px 0; }
                            .test-result { margin: 20px 0; padding: 15px; border: 1px solid #e2e8f0; border-radius: 5px; }
                            .pass { border-left: 4px solid #48bb78; }
                            .warning { border-left: 4px solid #ed8936; }
                            .fail { border-left: 4px solid #f56565; }
                        </style>
                    </head>
                    <body>
                        <h1>Financial Health Test Report</h1>
                        <div class="summary">
                            <h2>Summary</h2>
                            <p>Test Date: ${new Date().toLocaleString()}</p>
                            <p>Total Scenarios: ${this.results.length}</p>
                            <p>Passed: ${this.results.filter(r => r.status === 'pass').length}</p>
                            <p>Warnings: ${this.results.filter(r => r.status === 'warning').length}</p>
                            <p>Failed: ${this.results.filter(r => r.status === 'fail').length}</p>
                            <p>Total Fallbacks: ${this.results.reduce((sum, r) => sum + r.fallbackCount, 0)}</p>
                        </div>
                        ${this.results.map(r => `
                            <div class="test-result ${r.status}">
                                <h3>${r.scenario}</h3>
                                <p>Status: <strong>${r.status.toUpperCase()}</strong></p>
                                <p>Score: ${r.score}/100 (Expected: ${r.expectedRange.min}-${r.expectedRange.max})</p>
                                <p>Fallbacks: ${r.fallbackCount}</p>
                                ${r.fallbackCount > 0 ? `<p>Missing Fields: ${[...new Set(r.logs.fallbacks.flatMap(f => f.fields))].join(', ')}</p>` : ''}
                            </div>
                        `).join('')}
                    </body>
                    </html>
                `;
                
                const blob = new Blob([reportHtml], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `financial-health-test-report-${Date.now()}.html`;
                a.click();
            },
            
            exportFieldMappings() {
                const mappings = {};
                
                // Analyze all fallbacks to create mapping suggestions
                this.results.forEach(result => {
                    result.logs.fallbacks.forEach(fallback => {
                        fallback.fields.forEach(field => {
                            if (!mappings[field]) {
                                mappings[field] = {
                                    occurrences: 0,
                                    scenarios: [],
                                    suggestedMappings: []
                                };
                            }
                            mappings[field].occurrences++;
                            if (!mappings[field].scenarios.includes(result.scenario)) {
                                mappings[field].scenarios.push(result.scenario);
                            }
                        });
                    });
                });
                
                // Generate mapping suggestions
                Object.keys(mappings).forEach(field => {
                    const suggestions = this.generateFieldSuggestions(field);
                    mappings[field].suggestedMappings = suggestions;
                });
                
                const blob = new Blob([JSON.stringify(mappings, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `field-mapping-analysis-${Date.now()}.json`;
                a.click();
            },
            
            generateFieldSuggestions(field) {
                // Simple heuristic for field mapping suggestions
                const suggestions = [];
                const fieldLower = field.toLowerCase();
                
                if (fieldLower.includes('training') && fieldLower.includes('fund')) {
                    suggestions.push('trainingFundEmployeeRate', 'trainingFundEmployerRate', 'currentTrainingFund');
                }
                if (fieldLower.includes('pension')) {
                    suggestions.push('pensionEmployeeRate', 'pensionEmployerRate', 'currentPensionSavings');
                }
                if (fieldLower.includes('salary') || fieldLower.includes('income')) {
                    suggestions.push('currentMonthlySalary', 'monthlySalary', 'monthlyIncome');
                }
                if (fieldLower.includes('portfolio')) {
                    suggestions.push('currentPersonalPortfolio', 'personalPortfolio', 'stockPortfolio');
                }
                
                return suggestions;
            }
        };
        
        // Initialize on load
        window.addEventListener('load', () => {
            testRunner.init();
            testRunner.updateStatistics();
        });
        
        // Global functions for buttons
        function runAllTests() {
            testRunner.runAllTests();
        }
        
        function runSelectedTest() {
            testRunner.runSelectedTest();
        }
        
        function clearResults() {
            testRunner.clearResults();
        }
        
        function exportLogs() {
            testRunner.exportLogs();
        }
        
        function exportReport() {
            testRunner.exportReport();
        }
        
        function exportFieldMappings() {
            testRunner.exportFieldMappings();
        }
    </script>
</body>
</html>