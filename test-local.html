<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local Testing - Advanced Retirement Planner</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .test-pass { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .test-fail { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .test-info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .loading { color: #666; }
        #test-results { max-height: 500px; overflow-y: auto; }
        iframe { width: 100%; height: 600px; border: 1px solid #ccc; margin-top: 20px; }
    </style>
</head>
<body>
    <h1>ğŸ§ª Local Testing Dashboard</h1>
    <p>This page tests the retirement planner locally to catch issues before deployment.</p>
    
    <div>
        <button onclick="runAllTests()" id="run-tests-btn">ğŸš€ Run All Tests</button>
        <button onclick="clearResults()">ğŸ—‘ï¸ Clear Results</button>
        <button onclick="testInIframe()">ğŸ“± Test in Frame</button>
    </div>
    
    <div id="test-results"></div>
    
    <div id="iframe-container" style="display: none;">
        <h3>Live App Test:</h3>
        <iframe id="app-iframe" src="index.html"></iframe>
    </div>

    <script>
        let testResults = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const result = { timestamp, message, type };
            testResults.push(result);
            updateDisplay();
            console.log(`[${timestamp}] ${type.toUpperCase()}: ${message}`);
        }
        
        function updateDisplay() {
            const container = document.getElementById('test-results');
            container.innerHTML = testResults.map(result => 
                `<div class="test-result test-${result.type}">
                    <strong>[${result.timestamp}]</strong> ${result.message}
                </div>`
            ).join('');
            container.scrollTop = container.scrollHeight;
        }
        
        function clearResults() {
            testResults = [];
            updateDisplay();
        }
        
        async function runAllTests() {
            clearResults();
            log('ğŸ§ª Starting comprehensive test suite...', 'info');
            
            const tests = [
                testFileExists,
                testBasicSyntax,
                testModuleLoading,
                testReactComponents,
                testCalculationEngine,
                testUserInterface,
                testResponsiveness,
                testErrorHandling
            ];
            
            let passed = 0;
            let failed = 0;
            
            for (const test of tests) {
                try {
                    await test();
                    passed++;
                } catch (error) {
                    log(`âŒ Test failed: ${error.message}`, 'fail');
                    failed++;
                }
            }
            
            log(`ğŸ“Š Test Summary: ${passed} passed, ${failed} failed`, 
                failed === 0 ? 'pass' : 'fail');
                
            if (failed === 0) {
                log('ğŸ‰ All tests passed! App is ready for deployment.', 'pass');
            } else {
                log('âš ï¸ Some tests failed. Please fix issues before deployment.', 'fail');
            }
        }
        
        async function testFileExists() {
            log('ğŸ“ Testing file existence...', 'info');
            
            const files = [
                'index.html',
                'src/translations/multiLanguage.js',
                'src/data/marketConstants.js',
                'src/utils/retirementCalculations.js',
                'src/components/RetirementPlannerApp.js',
                'src/components/RetirementBasicForm.js',
                'src/components/RetirementAdvancedForm.js',
                'src/components/RetirementResultsPanel.js'
            ];
            
            for (const file of files) {
                try {
                    const response = await fetch(file);
                    if (response.ok) {
                        log(`âœ… File exists: ${file}`, 'pass');
                    } else {
                        throw new Error(`File not found: ${file} (${response.status})`);
                    }
                } catch (error) {
                    throw new Error(`File check failed: ${file} - ${error.message}`);
                }
            }
        }
        
        async function testBasicSyntax() {
            log('ğŸ” Testing JavaScript syntax...', 'info');
            
            const jsFiles = [
                'src/utils/retirementCalculations.js',
                'src/components/RetirementPlannerApp.js',
                'src/components/RetirementBasicForm.js'
            ];
            
            for (const file of jsFiles) {
                try {
                    const response = await fetch(file);
                    const content = await response.text();
                    
                    // Check for common syntax issues
                    if (content.includes('export ') && content.includes('import ')) {
                        throw new Error(`${file} contains ES6 modules that won't work with script tags`);
                    }
                    
                    if (content.includes('const { useState') || content.includes('const { createElement')) {
                        throw new Error(`${file} contains destructuring that causes redeclaration errors`);
                    }
                    
                    log(`âœ… Syntax check passed: ${file}`, 'pass');
                } catch (error) {
                    throw new Error(`Syntax error in ${file}: ${error.message}`);
                }
            }
        }
        
        async function testModuleLoading() {
            log('ğŸ”„ Testing module loading...', 'info');
            
            return new Promise((resolve, reject) => {
                const iframe = document.createElement('iframe');
                iframe.style.display = 'none';
                iframe.src = 'index.html';
                
                iframe.onload = () => {
                    setTimeout(() => {
                        try {
                            const iframeWindow = iframe.contentWindow;
                            
                            const requiredModules = [
                                'RetirementPlannerApp',
                                'BasicInputs',
                                'AdvancedInputs', 
                                'ResultsPanel',
                                'calculateRetirement',
                                'multiLanguage',
                                'countryData',
                                'formatCurrency'
                            ];
                            
                            const missing = requiredModules.filter(module => !iframeWindow[module]);
                            
                            if (missing.length === 0) {
                                log('âœ… All modules loaded successfully', 'pass');
                                resolve();
                            } else {
                                reject(new Error(`Missing modules: ${missing.join(', ')}`));
                            }
                        } catch (error) {
                            reject(new Error(`Module loading test failed: ${error.message}`));
                        } finally {
                            document.body.removeChild(iframe);
                        }
                    }, 3000); // Wait 3 seconds for loading
                };
                
                iframe.onerror = () => {
                    document.body.removeChild(iframe);
                    reject(new Error('Failed to load iframe'));
                };
                
                document.body.appendChild(iframe);
            });
        }
        
        async function testReactComponents() {
            log('âš›ï¸ Testing React components...', 'info');
            
            return new Promise((resolve, reject) => {
                const iframe = document.createElement('iframe');
                iframe.style.display = 'none';
                iframe.src = 'index.html';
                
                iframe.onload = () => {
                    setTimeout(() => {
                        try {
                            const iframeDoc = iframe.contentDocument;
                            const errors = iframeDoc.querySelectorAll('.test-fail, [class*="error"]');
                            
                            if (errors.length === 0) {
                                log('âœ… No React errors detected', 'pass');
                                resolve();
                            } else {
                                reject(new Error(`React errors found: ${errors.length} error elements`));
                            }
                        } catch (error) {
                            reject(new Error(`React component test failed: ${error.message}`));
                        } finally {
                            document.body.removeChild(iframe);
                        }
                    }, 5000);
                };
                
                document.body.appendChild(iframe);
            });
        }
        
        async function testCalculationEngine() {
            log('ğŸ§® Testing calculation engine...', 'info');
            
            // Load the calculation script directly
            const script = document.createElement('script');
            script.src = 'src/utils/retirementCalculations.js';
            
            return new Promise((resolve, reject) => {
                script.onload = () => {
                    try {
                        if (typeof window.calculateRetirement === 'function') {
                            // Test basic calculation
                            const testInputs = {
                                currentAge: 30,
                                retirementAge: 65,
                                currentSavings: 100000,
                                inflationRate: 3
                            };
                            
                            const testWorkPeriods = [{
                                startAge: 30,
                                endAge: 65,
                                monthlyContribution: 2000,
                                salary: 15000,
                                pensionReturn: 7.0
                            }];
                            
                            const result = window.calculateRetirement(testInputs, testWorkPeriods, [], []);
                            
                            if (result && typeof result.totalSavings === 'number') {
                                log('âœ… Calculation engine works correctly', 'pass');
                                resolve();
                            } else {
                                reject(new Error('Calculation engine returned invalid result'));
                            }
                        } else {
                            reject(new Error('calculateRetirement function not found'));
                        }
                    } catch (error) {
                        reject(new Error(`Calculation test failed: ${error.message}`));
                    }
                };
                
                script.onerror = () => {
                    reject(new Error('Failed to load calculation script'));
                };
                
                document.head.appendChild(script);
            });
        }
        
        async function testUserInterface() {
            log('ğŸ–±ï¸ Testing user interface...', 'info');
            
            return new Promise((resolve, reject) => {
                const iframe = document.createElement('iframe');
                iframe.style.display = 'none';
                iframe.src = 'index.html';
                
                iframe.onload = () => {
                    setTimeout(() => {
                        try {
                            const iframeDoc = iframe.contentDocument;
                            
                            // Check for essential UI elements
                            const title = iframeDoc.querySelector('h1');
                            const inputs = iframeDoc.querySelectorAll('input');
                            const buttons = iframeDoc.querySelectorAll('button');
                            
                            if (title && inputs.length > 0 && buttons.length > 0) {
                                log(`âœ… UI elements found: ${inputs.length} inputs, ${buttons.length} buttons`, 'pass');
                                resolve();
                            } else {
                                reject(new Error(`Missing UI elements: title=${!!title}, inputs=${inputs.length}, buttons=${buttons.length}`));
                            }
                        } catch (error) {
                            reject(new Error(`UI test failed: ${error.message}`));
                        } finally {
                            document.body.removeChild(iframe);
                        }
                    }, 4000);
                };
                
                document.body.appendChild(iframe);
            });
        }
        
        async function testResponsiveness() {
            log('ğŸ“± Testing responsiveness...', 'info');
            
            // Basic check - just verify CSS classes exist
            try {
                const response = await fetch('index.html');
                const content = await response.text();
                
                const responsiveClasses = ['lg:col-span', 'md:text', 'grid-cols'];
                const hasResponsive = responsiveClasses.some(cls => content.includes(cls));
                
                if (hasResponsive) {
                    log('âœ… Responsive CSS classes found', 'pass');
                } else {
                    throw new Error('No responsive CSS classes detected');
                }
            } catch (error) {
                throw new Error(`Responsiveness test failed: ${error.message}`);
            }
        }
        
        async function testErrorHandling() {
            log('ğŸ›¡ï¸ Testing error handling...', 'info');
            
            return new Promise((resolve, reject) => {
                const iframe = document.createElement('iframe');
                iframe.style.display = 'none';
                iframe.src = 'index.html';
                
                iframe.onload = () => {
                    setTimeout(() => {
                        try {
                            const iframeWindow = iframe.contentWindow;
                            
                            // Check if error boundary exists
                            if (typeof iframeWindow.ErrorBoundary !== 'undefined' || 
                                iframeDoc.querySelector('[class*="error"]') !== null) {
                                log('âœ… Error handling mechanisms detected', 'pass');
                                resolve();
                            } else {
                                // This is okay - just log info
                                log('â„¹ï¸ No specific error boundaries found (may be okay)', 'info');
                                resolve();
                            }
                        } catch (error) {
                            // Don't fail on this test
                            log(`â„¹ï¸ Error handling test inconclusive: ${error.message}`, 'info');
                            resolve();
                        } finally {
                            document.body.removeChild(iframe);
                        }
                    }, 3000);
                };
                
                document.body.appendChild(iframe);
            });
        }
        
        function testInIframe() {
            const container = document.getElementById('iframe-container');
            const iframe = document.getElementById('app-iframe');
            
            // Reload iframe with cache busting
            iframe.src = `index.html?t=${Date.now()}`;
            container.style.display = 'block';
            
            log('ğŸ“± Loading app in iframe for manual testing...', 'info');
        }
        
        // Auto-run tests when page loads
        window.addEventListener('load', () => {
            log('ğŸš€ Local testing dashboard ready. Click "Run All Tests" to start.', 'info');
        });
    </script>
</body>
</html>