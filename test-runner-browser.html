<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Retirement Planner - Browser Test Runner</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React and ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <style>
        .test-pass { background-color: #d4edda; border-left: 4px solid #28a745; }
        .test-fail { background-color: #f8d7da; border-left: 4px solid #dc3545; }
        .test-pending { background-color: #fff3cd; border-left: 4px solid #ffc107; }
        .test-running { background-color: #d1ecf1; border-left: 4px solid #17a2b8; }
        .console-log { font-family: monospace; font-size: 12px; }
        .test-category { cursor: pointer; user-select: none; }
        .test-category.collapsed .test-list { display: none; }
        .test-category.collapsed .collapse-icon { transform: rotate(-90deg); }
        .collapse-icon { transition: transform 0.2s; display: inline-block; }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8">
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Advanced Retirement Planner - Browser Test Runner</h1>
            <p class="text-gray-600">Run tests directly in the browser to catch runtime errors and validate component behavior</p>
        </header>
        
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">Test Controls</h2>
                <div class="space-x-2">
                    <button id="run-all-tests" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                        Run All Tests
                    </button>
                    <button id="run-e2e-tests" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                        Run E2E Tests
                    </button>
                    <button id="clear-results" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                        Clear Results
                    </button>
                </div>
            </div>
            
            <div class="grid grid-cols-3 gap-4 mb-4">
                <div class="text-center">
                    <div class="text-3xl font-bold text-green-600" id="passed-count">0</div>
                    <div class="text-sm text-gray-600">Passed</div>
                </div>
                <div class="text-center">
                    <div class="text-3xl font-bold text-red-600" id="failed-count">0</div>
                    <div class="text-sm text-gray-600">Failed</div>
                </div>
                <div class="text-center">
                    <div class="text-3xl font-bold text-gray-600" id="total-count">0</div>
                    <div class="text-sm text-gray-600">Total</div>
                </div>
            </div>
            
            <div class="w-full bg-gray-200 rounded-full h-4">
                <div id="progress-bar" class="bg-blue-500 h-4 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-semibold mb-4">Test Results</h2>
                <div id="test-results" class="space-y-2 max-h-96 overflow-y-auto">
                    <p class="text-gray-500">No tests run yet</p>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-semibold mb-4">Console Output</h2>
                <div id="console-output" class="bg-gray-900 text-green-400 p-4 rounded max-h-96 overflow-y-auto console-log">
                    <p>Console output will appear here...</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow-lg p-6 mt-6">
            <h2 class="text-xl font-semibold mb-4">Test Categories</h2>
            <div id="test-categories" class="space-y-4">
                <!-- Test categories will be dynamically added here -->
            </div>
        </div>
    </div>
    
    <!-- Hidden iframe for E2E testing -->
    <iframe id="test-iframe" style="display: none; width: 100%; height: 600px; border: 1px solid #ccc;"></iframe>
    
    <!-- Hidden root element for app tests -->
    <div id="root" style="display: none;"></div>
    
    <!-- Load all required scripts first in correct dependency order -->
    <!-- Core data and translations -->
    <script src="src/data/marketConstants.js"></script>
    <script src="src/translations/multiLanguage.js"></script>
    
    <!-- Core utilities -->
    <script src="src/utils/retirementCalculations.js"></script>
    <script src="src/utils/currencyAPI.js"></script>
    <script src="src/utils/financialHealthEngine.js"></script>
    <script src="src/utils/financialHealthValidation.js"></script>
    <script src="src/utils/financialHealthMessages.js"></script>
    <script src="src/utils/coupleValidation.js"></script>
    <script src="src/utils/performanceOptimizer.js"></script>
    <script src="src/utils/exportFunctions.js"></script>
    <script src="src/utils/performanceMonitor.js"></script>
    <script src="src/utils/inputValidation.js"></script>
    
    <!-- Components -->
    <script src="src/components/shared/ErrorBoundary.js"></script>
    <script src="src/components/forms/BasicInputs.js"></script>
    <script src="src/components/forms/RetirementAdvancedForm.js"></script>
    <script src="src/components/shared/EnhancedRSUCompanySelector.js"></script>
    <script src="src/components/shared/PartnerRSUSelector.js"></script>
    <script src="src/components/shared/ExportControls.js"></script>
    
    <!-- Wizard components -->
    <script src="src/components/wizard/WizardStep.js"></script>
    <script src="src/components/wizard/RetirementWizard.js"></script>
    <script src="src/components/wizard/steps/WizardStepPersonal.js"></script>
    <script src="src/components/wizard/steps/WizardStepSalary.js"></script>
    <script src="src/components/wizard/steps/WizardStepSavings.js"></script>
    
    <!-- Panel components -->
    <script src="src/components/panels/RetirementResultsPanel.js"></script>
    <script src="src/components/panels/summary/SavingsSummaryPanel.js"></script>
    <script src="src/components/shared/FinancialHealthScoreEnhanced.js"></script>
    
    <!-- Core app component -->
    <script src="src/components/core/RetirementPlannerApp.js"></script>
    
    <!-- Risk scenarios data -->
    <script>
        // Provide risk scenarios if not loaded
        window.riskScenarios = window.riskScenarios || {
            conservative: { returnRate: 5, name: 'Conservative' },
            moderate: { returnRate: 7, name: 'Moderate' },
            aggressive: { returnRate: 10, name: 'Aggressive' }
        };
        
        // Add validate function for test compatibility
        window.validate = window.InputValidation || {
            validateAge: (age) => age >= 18 && age <= 120,
            validateCurrency: (value) => !isNaN(value) && value >= 0
        };
        
        // Also expose validateAge directly for tests
        window.validateAge = window.validate.validateAge;
        
        // Ensure performanceMonitor is available
        if (!window.performanceMonitor) {
            window.performanceMonitor = {
                start: () => {},
                end: () => {},
                getMetrics: () => ({ totalTime: 0, callCount: 0 })
            };
        }
        
        // Initialize app for tests
        window.addEventListener('DOMContentLoaded', () => {
            const root = document.getElementById('root');
            if (root && window.React && window.ReactDOM && window.RetirementPlannerApp) {
                const container = document.createElement('div');
                container.className = 'app-container';
                root.appendChild(container);
            }
            
            // Patch calculateRetirement for test compatibility after DOM loaded
            const originalCalculateRetirement = window.calculateRetirement;
            if (originalCalculateRetirement) {
                window.calculateRetirement = function(inputs) {
                    // Add default pension contributions if missing
                    const enhancedInputs = {
                        ...inputs,
                        pensionEmployeeRate: inputs.pensionEmployeeRate || 6.5,
                        pensionEmployerRate: inputs.pensionEmployerRate || 6.5,
                        monthlyContribution: inputs.monthlyContribution || (inputs.monthlySalary * 0.13) || 0
                    };
                    return originalCalculateRetirement(enhancedInputs);
                };
                
                // Also add monthlyRetirementIncome alias for backward compatibility
                window.monthlyRetirementIncome = function(inputs) {
                    const result = window.calculateRetirement(inputs);
                    return result ? result.monthlyRetirementIncome || 0 : 0;
                };
            }
        });
    </script>
    
    <!-- Load the browser test framework -->
    <script src="tests/browser/test-framework.js"></script>
    
    <script>
        // Initialize test runner UI BEFORE loading tests
        const testRunner = new BrowserTestRunner({
            resultsElement: document.getElementById('test-results'),
            consoleElement: document.getElementById('console-output'),
            categoriesElement: document.getElementById('test-categories'),
            passedElement: document.getElementById('passed-count'),
            failedElement: document.getElementById('failed-count'),
            totalElement: document.getElementById('total-count'),
            progressElement: document.getElementById('progress-bar')
        });
        
        // Button event handlers
        document.getElementById('run-all-tests').addEventListener('click', () => {
            testRunner.runAllTests();
        });
        
        document.getElementById('run-e2e-tests').addEventListener('click', () => {
            testRunner.runCategory('e2e');
        });
        
        document.getElementById('clear-results').addEventListener('click', () => {
            testRunner.clearResults();
        });
        
        // Load test suites AFTER runner is initialized
        const loadScript = (src) => {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = reject;
                document.body.appendChild(script);
            });
        };
        
        // Load tests sequentially
        (async () => {
            try {
                console.log('Loading test suites...');
                await loadScript('tests/browser/component-tests.js');
                await loadScript('tests/browser/integration-tests.js');
                await loadScript('tests/browser/e2e-tests.js');
                await loadScript('tests/browser/comprehensive-e2e-scenarios.js');
                console.log(`Total tests loaded: ${testRunner.tests.length}`);
                
                // Auto-run tests if specified in URL
                const params = new URLSearchParams(window.location.search);
                if (params.get('autorun') === 'true') {
                    setTimeout(() => testRunner.runAllTests(), 1000);
                }
            } catch (error) {
                console.error('Failed to load test suites:', error);
            }
        })();
    </script>
</body>
</html>