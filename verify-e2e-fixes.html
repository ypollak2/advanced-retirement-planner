<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verify E2E Test Fixes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React and ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Load all required scripts -->
    <script src="src/data/marketConstants.js"></script>
    <script src="src/translations/multiLanguage.js"></script>
    <script src="src/utils/retirementCalculations.js"></script>
    <script src="src/utils/currencyAPI.js"></script>
    <script src="src/utils/financialHealthEngine.js"></script>
    <script src="src/utils/financialHealthValidation.js"></script>
    <script src="src/utils/financialHealthMessages.js"></script>
    <script src="src/utils/coupleValidation.js"></script>
    <script src="src/utils/performanceOptimizer.js"></script>
    <script src="src/utils/exportFunctions.js"></script>
    <script src="src/utils/performanceMonitor.js"></script>
    <script src="src/utils/inputValidation.js"></script>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold mb-8">E2E Test Fix Verification</h1>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Test 1: calculateRetirement with proper inputs -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-semibold mb-4">Test 1: Calculate Retirement</h2>
                <button onclick="testCalculateRetirement()" class="bg-blue-500 text-white px-4 py-2 rounded mb-4">
                    Run Test
                </button>
                <div id="calc-result" class="space-y-2"></div>
            </div>
            
            <!-- Test 2: formatCurrency -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-semibold mb-4">Test 2: Format Currency</h2>
                <button onclick="testFormatCurrency()" class="bg-blue-500 text-white px-4 py-2 rounded mb-4">
                    Run Test
                </button>
                <div id="format-result" class="space-y-2"></div>
            </div>
            
            <!-- Test 3: Export Functions -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-semibold mb-4">Test 3: Export Functions</h2>
                <button onclick="testExportFunctions()" class="bg-blue-500 text-white px-4 py-2 rounded mb-4">
                    Run Test
                </button>
                <div id="export-result" class="space-y-2"></div>
            </div>
            
            <!-- Test 4: Field Mapping -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-semibold mb-4">Test 4: Field Mapping</h2>
                <button onclick="testFieldMapping()" class="bg-blue-500 text-white px-4 py-2 rounded mb-4">
                    Run Test
                </button>
                <div id="field-result" class="space-y-2"></div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow-lg p-6 mt-6">
            <h2 class="text-xl font-semibold mb-4">Console Output</h2>
            <div id="console-output" class="bg-gray-900 text-green-400 p-4 rounded font-mono text-sm max-h-64 overflow-y-auto">
                Console output will appear here...
            </div>
        </div>
    </div>
    
    <script>
        // Capture console output
        const consoleOutput = [];
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        
        console.log = (...args) => {
            originalLog(...args);
            addToConsole('LOG', args);
        };
        
        console.error = (...args) => {
            originalError(...args);
            addToConsole('ERROR', args);
        };
        
        console.warn = (...args) => {
            originalWarn(...args);
            addToConsole('WARN', args);
        };
        
        function addToConsole(type, args) {
            const message = args.map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
            ).join(' ');
            
            consoleOutput.push({ type, message });
            updateConsoleDisplay();
        }
        
        function updateConsoleDisplay() {
            const consoleDiv = document.getElementById('console-output');
            consoleDiv.innerHTML = consoleOutput.slice(-20).map(entry => {
                const color = entry.type === 'ERROR' ? 'text-red-400' : 
                             entry.type === 'WARN' ? 'text-yellow-400' : 'text-green-400';
                return `<div class="${color}">[${entry.type}] ${entry.message}</div>`;
            }).join('');
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }
        
        function testCalculateRetirement() {
            const resultDiv = document.getElementById('calc-result');
            resultDiv.innerHTML = '<p class="text-blue-600">Running test...</p>';
            
            try {
                const inputs = {
                    currentAge: 30,
                    retirementAge: 65,
                    currentSavings: 100000,
                    monthlySalary: 10000,
                    monthlyExpenses: 6000,
                    inflationRate: 3,
                    returnRate: 7,
                    pensionEmployeeRate: 6.5,
                    pensionEmployerRate: 6.5,
                    monthlyContribution: 1300,
                    pensionSavings: 50000,
                    trainingFundValue: 30000
                };
                
                console.log('Testing calculateRetirement with inputs:', inputs);
                const result = window.calculateRetirement(inputs);
                
                if (result && result.monthlyRetirementIncome > 0) {
                    resultDiv.innerHTML = `
                        <div class="text-green-600">✓ Test Passed!</div>
                        <div>Total Savings: ${window.formatCurrency(result.totalSavings)}</div>
                        <div>Monthly Retirement Income: ${window.formatCurrency(result.monthlyRetirementIncome)}</div>
                        <div>Years to Retirement: ${result.yearsToRetirement || 35}</div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="text-red-600">✗ Test Failed</div>
                        <div>Result: ${JSON.stringify(result)}</div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="text-red-600">✗ Error: ${error.message}</div>
                `;
                console.error('Test error:', error);
            }
        }
        
        function testFormatCurrency() {
            const resultDiv = document.getElementById('format-result');
            resultDiv.innerHTML = '<p class="text-blue-600">Running test...</p>';
            
            try {
                const testCases = [
                    { value: 1234567, expected: '1,234,567' },
                    { value: 100, currency: 'USD', expected: '$' },
                    { value: 1000000, expected: '1,000,000' }
                ];
                
                let allPassed = true;
                let results = [];
                
                testCases.forEach(test => {
                    const formatted = window.formatCurrency(test.value, test.currency);
                    const passed = formatted.includes(test.expected);
                    allPassed = allPassed && passed;
                    
                    results.push({
                        input: `${test.value} ${test.currency || 'ILS'}`,
                        output: formatted,
                        expected: test.expected,
                        passed
                    });
                    
                    console.log(`formatCurrency(${test.value}, ${test.currency || 'ILS'}) = ${formatted}`);
                });
                
                resultDiv.innerHTML = `
                    <div class="${allPassed ? 'text-green-600' : 'text-red-600'}">
                        ${allPassed ? '✓ All Tests Passed!' : '✗ Some Tests Failed'}
                    </div>
                    ${results.map(r => `
                        <div class="text-sm ${r.passed ? 'text-green-600' : 'text-red-600'}">
                            ${r.input} → ${r.output} ${r.passed ? '✓' : '✗ (expected: ' + r.expected + ')'}
                        </div>
                    `).join('')}
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="text-red-600">✗ Error: ${error.message}</div>
                `;
                console.error('Test error:', error);
            }
        }
        
        function testExportFunctions() {
            const resultDiv = document.getElementById('export-result');
            resultDiv.innerHTML = '<p class="text-blue-600">Running test...</p>';
            
            try {
                const checks = [
                    { name: 'window.exportFunctions', exists: !!window.exportFunctions },
                    { name: 'exportAsImage', exists: !!window.exportFunctions?.exportAsImage },
                    { name: 'exportForLLMAnalysis', exists: !!window.exportFunctions?.exportForLLMAnalysis },
                    { name: 'copyClaudePromptToClipboard', exists: !!window.exportFunctions?.copyClaudePromptToClipboard }
                ];
                
                const allExist = checks.every(c => c.exists);
                
                // Test copyClaudePromptToClipboard
                let promptTest = { passed: false, error: null };
                if (window.exportFunctions?.copyClaudePromptToClipboard) {
                    try {
                        const testData = {
                            metadata: { version: '7.2.0' },
                            inputs: { currentAge: 35 },
                            results: { totalSavings: 1000000 }
                        };
                        const prompt = window.exportFunctions.generateClaudeRecommendationsPrompt?.(testData) || 
                                      window.exportFunctions.copyClaudePromptToClipboard(testData);
                        promptTest.passed = !!prompt && prompt.includes('Advanced Retirement Planner');
                    } catch (e) {
                        promptTest.error = e.message;
                    }
                }
                
                resultDiv.innerHTML = `
                    <div class="${allExist ? 'text-green-600' : 'text-red-600'}">
                        ${allExist ? '✓ All Export Functions Available!' : '✗ Missing Export Functions'}
                    </div>
                    ${checks.map(c => `
                        <div class="text-sm ${c.exists ? 'text-green-600' : 'text-red-600'}">
                            ${c.name}: ${c.exists ? '✓ Available' : '✗ Missing'}
                        </div>
                    `).join('')}
                    <div class="text-sm ${promptTest.passed ? 'text-green-600' : 'text-red-600'} mt-2">
                        Prompt Generation: ${promptTest.passed ? '✓ Working' : '✗ Failed' + (promptTest.error ? ': ' + promptTest.error : '')}
                    </div>
                `;
                
                console.log('Export functions test:', { checks, promptTest });
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="text-red-600">✗ Error: ${error.message}</div>
                `;
                console.error('Test error:', error);
            }
        }
        
        function testFieldMapping() {
            const resultDiv = document.getElementById('field-result');
            resultDiv.innerHTML = '<p class="text-blue-600">Running test...</p>';
            
            try {
                const testInputs = {
                    planningType: 'individual',
                    currentAge: 35,
                    monthlySalary: 15000,
                    pensionEmployeeRate: 6.5,
                    pensionEmployerRate: 6.5,
                    monthlyContribution: 1950
                };
                
                console.log('Testing field mapping with inputs:', testInputs);
                
                // Test getFieldValue
                const fieldTests = [];
                if (window.getFieldValue) {
                    fieldTests.push({
                        field: 'monthlySalary',
                        value: window.getFieldValue(testInputs, ['monthlySalary', 'salary']),
                        expected: 15000
                    });
                    fieldTests.push({
                        field: 'pensionEmployeeRate',
                        value: window.getFieldValue(testInputs, ['pensionEmployeeRate', 'pensionContributionRate']),
                        expected: 6.5
                    });
                }
                
                // Test health score calculation
                let healthScore = null;
                try {
                    healthScore = window.calculateFinancialHealthScore(testInputs);
                } catch (e) {
                    console.error('Health score calculation error:', e);
                }
                
                const allFieldsPassed = fieldTests.every(t => t.value === t.expected);
                
                resultDiv.innerHTML = `
                    <div class="${allFieldsPassed && healthScore ? 'text-green-600' : 'text-red-600'}">
                        ${allFieldsPassed && healthScore ? '✓ Field Mapping Working!' : '✗ Field Mapping Issues'}
                    </div>
                    ${fieldTests.map(t => `
                        <div class="text-sm ${t.value === t.expected ? 'text-green-600' : 'text-red-600'}">
                            ${t.field}: ${t.value} ${t.value === t.expected ? '✓' : '✗ (expected: ' + t.expected + ')'}
                        </div>
                    `).join('')}
                    <div class="text-sm ${healthScore ? 'text-green-600' : 'text-red-600'} mt-2">
                        Health Score: ${healthScore ? healthScore.totalScore + '/100 ✓' : '✗ Failed'}
                    </div>
                `;
                
                // Check console for CRITICAL warnings
                const criticalWarnings = consoleOutput.filter(o => 
                    o.type === 'WARN' && o.message.includes('CRITICAL')
                ).length;
                
                if (criticalWarnings > 0) {
                    resultDiv.innerHTML += `
                        <div class="text-yellow-600 text-sm mt-2">
                            ⚠ ${criticalWarnings} critical field warnings in console
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="text-red-600">✗ Error: ${error.message}</div>
                `;
                console.error('Test error:', error);
            }
        }
        
        // Run all tests on load
        window.addEventListener('load', () => {
            setTimeout(() => {
                console.log('Running all verification tests...');
                testCalculateRetirement();
                testFormatCurrency();
                testExportFunctions();
                testFieldMapping();
            }, 1000);
        });
    </script>
</body>
</html>