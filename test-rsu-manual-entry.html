<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test RSU Manual Entry Fix</title>
    <script crossorigin src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #4f46e5;
            padding-bottom: 10px;
        }
        .test-section {
            margin: 30px 0;
            padding: 20px;
            background: #f9fafb;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
        .component-container {
            margin: 20px 0;
            padding: 20px;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
        }
        .success {
            background: #d1fae5;
            color: #065f46;
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .info {
            background: #dbeafe;
            color: #1e40af;
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .warning {
            background: #fed7aa;
            color: #92400e;
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
        }
        button {
            background: #4f46e5;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #4338ca;
        }
        .instructions {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }
        .instructions h3 {
            color: #92400e;
            margin-top: 0;
        }
        .instructions ol {
            margin: 10px 0;
        }
        .state-display {
            background: #f3f4f6;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧪 RSU Manual Entry Test Suite</h1>
        
        <div class="instructions">
            <h3>📋 Test Instructions</h3>
            <p><strong>Expected Behavior (FIXED):</strong></p>
            <ol>
                <li>Click "Load RSU Component" below</li>
                <li>Search for a company that doesn't exist (e.g., "XYZABC")</li>
                <li>Click "Can't find your company?" in the dropdown</li>
                <li>You should now see FOUR input fields:
                    <ul>
                        <li>✅ Stock Ticker Symbol</li>
                        <li>✅ Company Name (Optional)</li>
                        <li>✅ <strong>Stock Price (NEW)</strong></li>
                        <li>✅ <strong>Number of RSU Units (NEW)</strong></li>
                    </ul>
                </li>
                <li>Enter all fields and click "Use This Stock"</li>
                <li>The values should be saved and displayed</li>
            </ol>
        </div>

        <div class="test-section">
            <h2>Test 1: Main RSU Selector</h2>
            <button onclick="loadMainRSUComponent()">Load RSU Component</button>
            <div id="mainRSUContainer" class="component-container"></div>
            <div id="mainState" class="state-display"></div>
        </div>

        <div class="test-section">
            <h2>Test 2: Partner RSU Selector (Couple Mode)</h2>
            <button onclick="loadPartnerRSUComponent()">Load Partner RSU Component</button>
            <div id="partnerRSUContainer" class="component-container"></div>
            <div id="partnerState" class="state-display"></div>
        </div>

        <div class="test-section">
            <h2>Test 3: Verification</h2>
            <button onclick="verifyFix()">Verify Fix is Applied</button>
            <div id="verificationResult"></div>
        </div>
    </div>

    <script>
        // Test state
        let mainInputs = {
            rsuCompany: '',
            rsuUnits: 0,
            rsuCurrentStockPrice: 0,
            rsuFrequency: 'quarterly'
        };

        let partnerInputs = {
            partnerRsuCompany: '',
            partnerRsuUnits: 0,
            partnerRsuCurrentStockPrice: 0,
            partnerRsuFrequency: 'quarterly'
        };

        // Load Main RSU Component
        async function loadMainRSUComponent() {
            const container = document.getElementById('mainRSUContainer');
            container.innerHTML = '<div class="info">Loading RSU component...</div>';
            
            try {
                // Load dependencies
                await loadScript('src/data/stockCompanies.js');
                await loadScript('src/utils/stockPriceAPI.js');
                await loadScript('src/utils/currencyAPI.js');
                await loadScript('src/components/shared/EnhancedRSUCompanySelector.js');
                
                if (window.EnhancedRSUCompanySelector) {
                    const element = React.createElement(window.EnhancedRSUCompanySelector, {
                        inputs: mainInputs,
                        setInputs: (newInputs) => {
                            console.log('Main RSU inputs updated:', newInputs);
                            mainInputs = newInputs;
                            updateStateDisplay('mainState', mainInputs);
                        },
                        language: 'en',
                        workingCurrency: 'USD'
                    });
                    
                    ReactDOM.render(
                        React.createElement('div', null, [
                            React.createElement('div', { key: 'info', className: 'success' }, 
                                '✅ Component loaded. Try searching for "XYZABC" then click "Can\'t find your company?"'),
                            element
                        ]),
                        container
                    );
                    
                    updateStateDisplay('mainState', mainInputs);
                } else {
                    throw new Error('EnhancedRSUCompanySelector not loaded');
                }
            } catch (error) {
                container.innerHTML = `<div class="warning">Error: ${error.message}</div>`;
            }
        }

        // Load Partner RSU Component
        async function loadPartnerRSUComponent() {
            const container = document.getElementById('partnerRSUContainer');
            container.innerHTML = '<div class="info">Loading Partner RSU component...</div>';
            
            try {
                // Load dependencies
                await loadScript('src/data/stockCompanies.js');
                await loadScript('src/utils/stockPriceAPI.js');
                await loadScript('src/utils/currencyAPI.js');
                await loadScript('src/components/shared/PartnerRSUSelector.js');
                
                if (window.PartnerRSUSelector) {
                    const element = React.createElement(window.PartnerRSUSelector, {
                        inputs: partnerInputs,
                        setInputs: (newInputs) => {
                            console.log('Partner RSU inputs updated:', newInputs);
                            partnerInputs = newInputs;
                            updateStateDisplay('partnerState', partnerInputs);
                        },
                        language: 'en',
                        workingCurrency: 'USD',
                        partnerKey: 'partner'
                    });
                    
                    ReactDOM.render(
                        React.createElement('div', null, [
                            React.createElement('div', { key: 'info', className: 'success' }, 
                                '✅ Partner component loaded. Test the same flow as above.'),
                            element
                        ]),
                        container
                    );
                    
                    updateStateDisplay('partnerState', partnerInputs);
                } else {
                    throw new Error('PartnerRSUSelector not loaded');
                }
            } catch (error) {
                container.innerHTML = `<div class="warning">Error: ${error.message}</div>`;
            }
        }

        // Update state display
        function updateStateDisplay(elementId, state) {
            const display = document.getElementById(elementId);
            if (display) {
                display.innerHTML = `<strong>Current State:</strong><br>${JSON.stringify(state, null, 2)}`;
            }
        }

        // Verify the fix
        async function verifyFix() {
            const resultDiv = document.getElementById('verificationResult');
            resultDiv.innerHTML = '<div class="info">Checking implementation...</div>';
            
            try {
                // Load the component files
                const response1 = await fetch('src/components/shared/EnhancedRSUCompanySelector.js');
                const content1 = await response1.text();
                
                const response2 = await fetch('src/components/shared/PartnerRSUSelector.js');
                const content2 = await response2.text();
                
                // Check for the new fields
                const hasStockPriceField = content1.includes("'Stock Price") && content2.includes("'Stock Price");
                const hasUnitsField = content1.includes("'Number of RSU Units'") && content2.includes("'Number of RSU Units'");
                const hasManualPriceHandling = content1.includes("parseFloat(manualPrice)") && content2.includes("parseFloat(manualPrice)");
                
                let html = '<h3>Verification Results:</h3>';
                
                if (hasStockPriceField && hasUnitsField && hasManualPriceHandling) {
                    html += `
                        <div class="success">
                            <strong>✅ FIX CONFIRMED!</strong><br>
                            Both RSU selectors now have:
                            <ul>
                                <li>✅ Stock Price manual input field</li>
                                <li>✅ RSU Units input field in custom mode</li>
                                <li>✅ Manual price handling in save logic</li>
                            </ul>
                        </div>
                    `;
                } else {
                    html += `
                        <div class="warning">
                            <strong>⚠️ Partial Fix Detected</strong><br>
                            <ul>
                                <li>${hasStockPriceField ? '✅' : '❌'} Stock Price field</li>
                                <li>${hasUnitsField ? '✅' : '❌'} RSU Units field</li>
                                <li>${hasManualPriceHandling ? '✅' : '❌'} Manual price handling</li>
                            </ul>
                        </div>
                    `;
                }
                
                html += `
                    <div class="info">
                        <strong>Manual Entry Flow:</strong>
                        <ol>
                            <li>Search for non-existent ticker</li>
                            <li>Click "Can't find your company?"</li>
                            <li>Enter: Ticker, Company Name, <strong>Stock Price</strong>, <strong>RSU Units</strong></li>
                            <li>Click "Use This Stock"</li>
                            <li>Values are saved to state</li>
                        </ol>
                    </div>
                `;
                
                resultDiv.innerHTML = html;
            } catch (error) {
                resultDiv.innerHTML = `<div class="warning">Error verifying: ${error.message}</div>`;
            }
        }

        // Helper function to load scripts
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const existing = document.querySelector(`script[src="${src}"]`);
                if (existing) {
                    resolve();
                    return;
                }
                
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = () => reject(new Error(`Failed to load ${src}`));
                document.head.appendChild(script);
            });
        }
    </script>
</body>
</html>