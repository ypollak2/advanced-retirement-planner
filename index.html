<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Retirement Planner - Professional Pension Planning Tool</title>
    <meta name="description" content="Advanced retirement planning tool with index returns, risk levels, and accurate tax calculations">
    <meta name="keywords" content="retirement, pension planning, retirement calculator, pension savings, training fund, investment planning">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM from CDN with integrity -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Chart.js - More reliable charting library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .animate-fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .currency-format {
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #5a6fd8, #6a4190);
        }
        
        /* RTL support */
        [dir="rtl"] .ml-2 { margin-left: 0; margin-right: 0.5rem; }
        [dir="rtl"] .mr-2 { margin-right: 0; margin-left: 0.5rem; }
        [dir="ltr"] .ml-2 { margin-left: 0.5rem; margin-right: 0; }
        [dir="ltr"] .mr-2 { margin-right: 0.5rem; margin-left: 0; }
    </style>
</head>
<body>
    <div id="root" class="min-h-screen gradient-bg"></div>
    
    <script>
        // Loading indicator while dependencies load
        document.addEventListener('DOMContentLoaded', function() {
            const root = document.getElementById('root');
            root.innerHTML = `
                <div class="min-h-screen bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50 flex items-center justify-center">
                    <div class="text-center">
                        <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-purple-600 mx-auto mb-4"></div>
                        <p class="text-gray-600 text-lg">Loading Advanced Retirement Planner...</p>
                        <p class="text-gray-500 text-sm mt-2">Please wait while we load the application</p>
                    </div>
                </div>
            `;
        });

        // Global utility functions
        const safeValue = (value) => isNaN(value) || !isFinite(value) ? 0 : Math.max(0, value);

        // Check if dependencies are loaded
        function checkDependencies() {
            console.log('Checking dependencies...');
            console.log('React:', typeof React);
            console.log('ReactDOM:', typeof ReactDOM);
            console.log('Chart:', typeof Chart);
            
            const missing = [];
            if (typeof React === 'undefined') missing.push('React');
            if (typeof ReactDOM === 'undefined') missing.push('ReactDOM');
            if (typeof Chart === 'undefined') missing.push('Chart.js');
            
            if (missing.length > 0) {
                console.error('Missing dependencies:', missing);
                document.getElementById('root').innerHTML = `
                    <div class="min-h-screen bg-gradient-to-br from-red-50 via-orange-50 to-yellow-50 flex items-center justify-center p-4">
                        <div class="text-center max-w-md">
                            <div class="text-red-500 text-6xl mb-4">âš ï¸</div>
                            <h2 class="text-2xl font-bold text-red-700 mb-4">Loading Error</h2>
                            <p class="text-gray-700 mb-4">
                                Missing dependencies: <strong>${missing.join(', ')}</strong>
                            </p>
                            <p class="text-gray-700 mb-4">
                                This might be due to:
                            </p>
                            <ul class="text-left text-gray-600 mb-4 space-y-1">
                                <li>â€¢ Internet connectivity issues</li>
                                <li>â€¢ CDN service interruption</li>
                                <li>â€¢ Browser compatibility issues</li>
                            </ul>
                            <button onclick="location.reload()" class="bg-red-500 text-white px-6 py-2 rounded-lg hover:bg-red-600 transition-colors">
                                Retry Loading
                            </button>
                        </div>
                    </div>
                `;
                return false;
            }
            console.log('All dependencies loaded successfully!');
            return true;
        }

        // Wait for all dependencies to load
        const maxWaitTime = 10000; // 10 seconds
        let waitTime = 0;
        const checkInterval = setInterval(() => {
            if (checkDependencies()) {
                clearInterval(checkInterval);
                initializeApp();
            } else if (waitTime > maxWaitTime) {
                clearInterval(checkInterval);
                // Error message already shown by checkDependencies
            }
            waitTime += 100;
        }, 100);

        function initializeApp() {
            try {
                const { useState, useEffect } = React;
        
        // Enhanced Chart component with multiple datasets
        const SimpleChart = ({ data, type = 'line', language = 'he' }) => {
            const chartRef = React.useRef(null);
            const chartInstance = React.useRef(null);
            
            React.useEffect(() => {
                if (chartRef.current && data && data.length > 0) {
                    const ctx = chartRef.current.getContext('2d');
                    
                    // Destroy existing chart
                    if (chartInstance.current) {
                        chartInstance.current.destroy();
                    }
                    
                    let chartData;
                    
                    // Use language prop instead of global variable
                    const isHebrew = language === 'he';
                    
                    // Check chart type: accumulation, index, stress comparison, or crisis timeline
                    if (type === 'crisisTimeline') {
                        // Crisis timeline chart showing normal vs stressed progression over years
                        chartData = {
                            labels: data.map(d => isHebrew ? `×’×™×œ ${d.age}` : `Age ${d.age}`),
                            datasets: [
                                {
                                    label: isHebrew ? '×¦×‘×™×¨×” ×¨×’×™×œ×”' : 'Normal Accumulation',
                                    data: data.map(d => d.normalAccumulation),
                                    borderColor: 'rgb(34, 197, 94)',
                                    backgroundColor: 'rgba(34, 197, 94, 0.1)',
                                    fill: false,
                                    tension: 0.4,
                                    borderWidth: 3
                                },
                                {
                                    label: isHebrew ? '×¦×‘×™×¨×” ×‘××©×‘×¨' : 'Crisis Accumulation',
                                    data: data.map(d => d.stressedAccumulation),
                                    borderColor: 'rgb(239, 68, 68)',
                                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                    fill: false,
                                    tension: 0.4,
                                    borderWidth: 3
                                }
                            ]
                        };
                    } else if (type === 'stressComparison') {
                        // Stress test comparison chart
                        chartData = {
                            labels: data.map(d => d.scenario),
                            datasets: [
                                {
                                    label: isHebrew ? '×”×›× ×¡×” ×—×•×“×©×™×ª (â‚ª)' : 'Monthly Income (â‚ª)',
                                    data: data.map(d => d.monthlyIncome),
                                    backgroundColor: ['rgba(34, 197, 94, 0.8)', 'rgba(239, 68, 68, 0.8)'],
                                    borderColor: ['rgb(34, 197, 94)', 'rgb(239, 68, 68)'],
                                    borderWidth: 2,
                                    yAxisID: 'y'
                                },
                                {
                                    label: isHebrew ? '×¦×‘×™×¨×” ×›×•×œ×œ×ª (â‚ª ××™×œ×™×•× ×™×)' : 'Total Accumulation (â‚ª millions)',
                                    data: data.map(d => d.totalAccumulation / 1000000),
                                    backgroundColor: ['rgba(59, 130, 246, 0.8)', 'rgba(147, 51, 234, 0.8)'],
                                    borderColor: ['rgb(59, 130, 246)', 'rgb(147, 51, 234)'],
                                    borderWidth: 2,
                                    yAxisID: 'y1'
                                }
                            ]
                        };
                    } else if (data[0] && data[0].pensionSavings !== undefined) {
                        // Accumulation chart with multiple lines
                        chartData = {
                            labels: data.map(d => isHebrew ? `×’×™×œ ${d.age}` : `Age ${d.age}`),
                            datasets: [
                                {
                                    label: isHebrew ? '×¤× ×¡×™×” (× ×•××™× ×œ×™)' : 'Pension (Nominal)',
                                    data: data.map(d => d.pensionSavings),
                                    borderColor: '#3B82F6',
                                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                    fill: false,
                                    tension: 0.4
                                },
                                {
                                    label: isHebrew ? '×§×¨×Ÿ ×”×©×ª×œ××•×ª (× ×•××™× ×œ×™)' : 'Training Fund (Nominal)',
                                    data: data.map(d => d.trainingFund),
                                    borderColor: '#10B981',
                                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                    fill: false,
                                    tension: 0.4
                                },
                                {
                                    label: isHebrew ? '×ª×™×§ ××™×©×™ (× ×•××™× ×œ×™)' : 'Personal Portfolio (Nominal)',
                                    data: data.map(d => d.personalPortfolio || 0),
                                    borderColor: '#8B5CF6',
                                    backgroundColor: 'rgba(139, 92, 246, 0.1)',
                                    fill: false,
                                    tension: 0.4
                                },
                                {
                                    label: isHebrew ? '×§×¨×™×¤×˜×• (× ×•××™× ×œ×™)' : 'Crypto (Nominal)',
                                    data: data.map(d => d.crypto || 0),
                                    borderColor: '#F97316',
                                    backgroundColor: 'rgba(249, 115, 22, 0.1)',
                                    fill: false,
                                    tension: 0.4
                                },
                                {
                                    label: isHebrew ? '× ×“×œ×´×Ÿ (× ×•××™× ×œ×™)' : 'Real Estate (Nominal)',
                                    data: data.map(d => d.realEstate || 0),
                                    borderColor: '#059669',
                                    backgroundColor: 'rgba(5, 150, 105, 0.1)',
                                    fill: false,
                                    tension: 0.4
                                },
                                {
                                    label: isHebrew ? '×¡×”"×› ×¦×‘×™×¨×” (× ×•××™× ×œ×™)' : 'Total Accumulation (Nominal)',
                                    data: data.map(d => d.totalSavings),
                                    borderColor: '#DC2626',
                                    backgroundColor: 'rgba(220, 38, 38, 0.1)',
                                    fill: false,
                                    tension: 0.4,
                                    borderWidth: 3
                                },
                                {
                                    label: isHebrew ? '×¢×¨×š ×××™×ª×™ (××•×ª×× ××™× ×¤×œ×¦×™×”)' : 'Real Value (Inflation Adjusted)',
                                    data: data.map(d => d.inflationAdjusted),
                                    borderColor: '#F59E0B',
                                    backgroundColor: 'rgba(245, 158, 11, 0.1)',
                                    fill: false,
                                    tension: 0.4,
                                    borderDash: [5, 5]
                                }
                            ]
                        };
                    } else {
                        // Index returns chart (single dataset)
                        chartData = {
                            labels: data.map(d => d.name),
                            datasets: [{
                                label: isHebrew ? '×ª×©×•××” ×©× ×ª×™×ª ×××•×¦×¢×ª (%)' : 'Average Annual Return (%)',
                                data: data.map(d => d.value),
                                borderColor: '#8B5CF6',
                                backgroundColor: 'rgba(139, 92, 246, 0.6)',
                                fill: true
                            }]
                        };
                    }
                    
                    chartInstance.current = new Chart(ctx, {
                        type: type === 'stressComparison' ? 'bar' : type,
                        data: chartData,
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                title: {
                                    display: true,
                                    text: type === 'crisisTimeline' 
                                        ? (isHebrew ? '×”×©×¤×¢×ª ×”××©×‘×¨ ×¢×œ ×”×¦×‘×™×¨×” ×œ××•×¨×š ×”×©× ×™×' : 'Crisis Impact on Accumulation Over Years')
                                        : type === 'stressComparison' 
                                        ? (isHebrew ? '×”×©×•×•××”: ××¦×‘ ×¨×’×™×œ ××•×œ ××©×‘×¨' : 'Comparison: Normal vs Crisis')
                                        : data[0] && data[0].pensionSavings !== undefined 
                                        ? (isHebrew ? '×”×ª×¤×ª×—×•×ª ×”×¦×‘×™×¨×” ×œ××•×¨×š ×”×©× ×™×' : 'Accumulation Progress Over Years')
                                        : (isHebrew ? '×ª×©×•××•×ª ×”×™×¡×˜×•×¨×™×•×ª ×‘××“×“×™×' : 'Historical Index Returns'),
                                    font: {
                                        size: 16,
                                        weight: 'bold'
                                    }
                                },
                                legend: {
                                    display: true,
                                    position: 'top',
                                    labels: {
                                        usePointStyle: true,
                                        padding: 20
                                    }
                                }
                            },
                            scales: type === 'stressComparison' ? {
                                y: {
                                    type: 'linear',
                                    display: true,
                                    position: 'left',
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: isHebrew ? '×”×›× ×¡×” ×—×•×“×©×™×ª (â‚ª)' : 'Monthly Income (â‚ª)'
                                    },
                                    ticks: {
                                        callback: function(value) {
                                            if (value >= 1000) {
                                                return 'â‚ª' + (value / 1000).toFixed(0) + 'K';
                                            } else {
                                                return 'â‚ª' + value.toFixed(0);
                                            }
                                        }
                                    }
                                },
                                y1: {
                                    type: 'linear',
                                    display: true,
                                    position: 'right',
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: isHebrew ? '×¦×‘×™×¨×” (××™×œ×™×•× ×™ â‚ª)' : 'Accumulation (â‚ª millions)'
                                    },
                                    grid: {
                                        drawOnChartArea: false,
                                    },
                                    ticks: {
                                        callback: function(value) {
                                            return value.toFixed(1) + 'M';
                                        }
                                    }
                                },
                                x: {
                                    grid: {
                                        display: true,
                                        color: 'rgba(0, 0, 0, 0.1)'
                                    }
                                }
                            } : {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function(value) {
                                            if (data[0] && data[0].pensionSavings !== undefined) {
                                                // Accumulation chart - show currency
                                                if (value >= 1000000) {
                                                    return 'â‚ª' + (value / 1000000).toFixed(1) + 'M';
                                                } else if (value >= 1000) {
                                                    return 'â‚ª' + (value / 1000).toFixed(0) + 'K';
                                                } else {
                                                    return 'â‚ª' + value.toFixed(0);
                                                }
                                            } else {
                                                // Index chart - show percentage
                                                return value.toFixed(1) + '%';
                                            }
                                        }
                                    }
                                },
                                x: {
                                    grid: {
                                        display: true,
                                        color: 'rgba(0, 0, 0, 0.1)'
                                    }
                                }
                            },
                            interaction: {
                                intersect: false,
                                mode: 'index'
                            },
                            elements: {
                                point: {
                                    radius: 4,
                                    hoverRadius: 8
                                }
                            }
                        }
                    });
                }
            }, [data, type, language]);
            
            return React.createElement('canvas', { ref: chartRef, style: { maxHeight: '400px' } });
        };
        
        // Beautiful icon replacements with enhanced styling
        const Calculator = ({ size = 16, className = "" }) => React.createElement('span', { 
            className: className + " inline-flex items-center justify-center", 
            style: { fontSize: `${size}px` } 
        }, 'ğŸ“Š');
        const TrendingUp = ({ size = 16, className = "" }) => React.createElement('span', { 
            className: className + " inline-flex items-center justify-center", 
            style: { fontSize: `${size}px` } 
        }, 'ğŸ“ˆ');
        const Globe = ({ size = 16, className = "" }) => React.createElement('span', { 
            className: className + " inline-flex items-center justify-center", 
            style: { fontSize: `${size}px` } 
        }, 'ğŸŒ');
        const DollarSign = ({ size = 16, className = "" }) => React.createElement('span', { 
            className: className + " inline-flex items-center justify-center", 
            style: { fontSize: `${size}px` } 
        }, 'ğŸ’°');
        const PiggyBank = ({ size = 16, className = "" }) => React.createElement('span', { 
            className: className + " inline-flex items-center justify-center", 
            style: { fontSize: `${size}px` } 
        }, 'ğŸ·');
        const AlertCircle = ({ size = 16, className = "" }) => React.createElement('span', { 
            className: className + " inline-flex items-center justify-center", 
            style: { fontSize: `${size}px` } 
        }, 'âš ï¸');
        const Plus = ({ size = 16, className = "" }) => React.createElement('span', { 
            className: className + " inline-flex items-center justify-center", 
            style: { fontSize: `${size}px` } 
        }, 'â•');
        const Trash2 = ({ size = 16, className = "" }) => React.createElement('span', { 
            className: className + " inline-flex items-center justify-center", 
            style: { fontSize: `${size}px` } 
        }, 'ğŸ—‘ï¸');
        const Download = ({ size = 16, className = "" }) => React.createElement('span', { 
            className: className + " inline-flex items-center justify-center", 
            style: { fontSize: `${size}px` } 
        }, 'â¬‡ï¸');
        const Languages = ({ size = 16, className = "" }) => React.createElement('span', { 
            className: className + " inline-flex items-center justify-center", 
            style: { fontSize: `${size}px` } 
        }, 'ğŸŒ');
        const Settings = ({ size = 16, className = "" }) => React.createElement('span', { 
            className: className + " inline-flex items-center justify-center", 
            style: { fontSize: `${size}px` } 
        }, 'âš™ï¸');
        const Info = ({ size = 16, className = "" }) => React.createElement('span', { 
            className: className + " inline-flex items-center justify-center", 
            style: { fontSize: `${size}px` } 
        }, 'â„¹ï¸');
        const Target = ({ size = 16, className = "" }) => React.createElement('span', { 
            className: className + " inline-flex items-center justify-center", 
            style: { fontSize: `${size}px` } 
        }, 'ğŸ¯');
        const Shuffle = ({ size = 16, className = "" }) => React.createElement('span', { 
            className: className + " inline-flex items-center justify-center", 
            style: { fontSize: `${size}px` } 
        }, 'ğŸ”€');
        const BarChart3 = ({ size = 16, className = "" }) => React.createElement('span', { 
            className: className + " inline-flex items-center justify-center", 
            style: { fontSize: `${size}px` } 
        }, 'ğŸ“Š');
        const Building = ({ size = 16, className = "" }) => React.createElement('span', { 
            className: className + " inline-flex items-center justify-center", 
            style: { fontSize: `${size}px` } 
        }, 'ğŸ¢');
        const Percent = ({ size = 16, className = "" }) => React.createElement('span', { 
            className: className + " inline-flex items-center justify-center", 
            style: { fontSize: `${size}px` } 
        }, 'ğŸ“ˆ');
        const Zap = ({ size = 16, className = "" }) => React.createElement('span', { 
            className: className + " inline-flex items-center justify-center", 
            style: { fontSize: `${size}px` } 
        }, 'âš¡');

        // Analytics System for Usage Tracking
        const AnalyticsManager = {
            // Generate unique session ID
            generateSessionId() {
                return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            },

            // Get or create visitor ID (persistent across sessions)
            getVisitorId() {
                let visitorId = localStorage.getItem('retirement_planner_visitor_id');
                if (!visitorId) {
                    visitorId = 'visitor_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    localStorage.setItem('retirement_planner_visitor_id', visitorId);
                }
                return visitorId;
            },

            // Initialize analytics storage
            initializeStorage() {
                const storageKey = 'retirement_planner_analytics';
                let analytics = JSON.parse(localStorage.getItem(storageKey) || '{}');
                
                if (!analytics.visitors) analytics.visitors = {};
                if (!analytics.sessions) analytics.sessions = {};
                if (!analytics.conclusions) analytics.conclusions = [];
                if (!analytics.metadata) {
                    analytics.metadata = {
                        firstVisit: new Date().toISOString(),
                        totalSessions: 0,
                        totalVisitors: 0,
                        lastUpdated: new Date().toISOString(),
                        version: '2.2.3'
                    };
                }

                localStorage.setItem(storageKey, JSON.stringify(analytics));
                return analytics;
            },

            // Track visitor session
            trackVisitor(language = 'he') {
                const storageKey = 'retirement_planner_analytics';
                const analytics = this.initializeStorage();
                const visitorId = this.getVisitorId();
                const sessionId = this.generateSessionId();
                const timestamp = new Date().toISOString();

                // Track visitor
                if (!analytics.visitors[visitorId]) {
                    analytics.visitors[visitorId] = {
                        firstVisit: timestamp,
                        totalSessions: 0,
                        preferredLanguage: language,
                        lastActive: timestamp
                    };
                    analytics.metadata.totalVisitors++;
                }

                analytics.visitors[visitorId].totalSessions++;
                analytics.visitors[visitorId].lastActive = timestamp;
                analytics.visitors[visitorId].preferredLanguage = language;

                // Track session
                analytics.sessions[sessionId] = {
                    visitorId,
                    startTime: timestamp,
                    language,
                    actions: [],
                    conclusions: null,
                    endTime: null
                };

                analytics.metadata.totalSessions++;
                analytics.metadata.lastUpdated = timestamp;

                localStorage.setItem(storageKey, JSON.stringify(analytics));
                
                // Store current session ID for tracking actions
                sessionStorage.setItem('current_session_id', sessionId);
                
                return sessionId;
            },

            // Track user actions during session
            trackAction(actionType, actionData = {}) {
                const storageKey = 'retirement_planner_analytics';
                const sessionId = sessionStorage.getItem('current_session_id');
                
                if (!sessionId) return;

                const analytics = JSON.parse(localStorage.getItem(storageKey) || '{}');
                
                if (analytics.sessions && analytics.sessions[sessionId]) {
                    analytics.sessions[sessionId].actions.push({
                        type: actionType,
                        data: actionData,
                        timestamp: new Date().toISOString()
                    });

                    analytics.metadata.lastUpdated = new Date().toISOString();
                    localStorage.setItem(storageKey, JSON.stringify(analytics));
                }
            },

            // Track retirement plan conclusions
            trackConclusion(results, inputs, workPeriods, language = 'he') {
                const storageKey = 'retirement_planner_analytics';
                const sessionId = sessionStorage.getItem('current_session_id');
                
                if (!sessionId || !results) return;

                const analytics = JSON.parse(localStorage.getItem(storageKey) || '{}');
                
                // Anonymized conclusion data
                const conclusion = {
                    sessionId,
                    timestamp: new Date().toISOString(),
                    language,
                    // User profile (anonymized)
                    profile: {
                        ageRange: this.getAgeRange(inputs.currentAge),
                        yearsToRetirement: inputs.retirementAge - inputs.currentAge,
                        riskTolerance: inputs.riskTolerance,
                        targetReplacement: inputs.targetReplacement,
                        hasEmergencyFund: inputs.currentEmergencyFund > 0,
                        hasPersonalInvestments: inputs.currentPersonalPortfolio > 0,
                        hasCrypto: inputs.currentCrypto > 0,
                        hasRealEstate: inputs.currentRealEstate > 0
                    },
                    // Planning results (anonymized amounts)
                    results: {
                        achievesTarget: results.achievesTarget,
                        targetGapRange: this.getAmountRange(Math.abs(results.targetGap || 0)),
                        totalAccumulationRange: this.getAmountRange(results.totalNetIncome * 12),
                        emergencyFundCoverage: inputs.currentMonthlyExpenses > 0 ? 
                            Math.round(inputs.currentEmergencyFund / inputs.currentMonthlyExpenses) : 0,
                        savingsRate: this.calculateSavingsRate(inputs, workPeriods),
                        debtToIncomeRatio: this.calculateDebtRatio(inputs, workPeriods)
                    },
                    // Anonymized insights
                    insights: {
                        recommendationTypes: this.getRecommendationTypes(results, inputs, workPeriods),
                        riskAlignment: this.assessRiskAlignment(inputs.currentAge, inputs.riskTolerance),
                        planningScore: this.calculatePlanningScore(results, inputs)
                    }
                };

                // Store in conclusions array
                analytics.conclusions.push(conclusion);

                // Update session with conclusion
                if (analytics.sessions[sessionId]) {
                    analytics.sessions[sessionId].conclusions = {
                        achieved: results.achievesTarget,
                        timestamp: new Date().toISOString()
                    };
                }

                analytics.metadata.lastUpdated = new Date().toISOString();
                localStorage.setItem(storageKey, JSON.stringify(analytics));

                return conclusion;
            },

            // Helper methods for anonymization
            getAgeRange(age) {
                if (age < 25) return 'under25';
                if (age < 35) return '25-34';
                if (age < 45) return '35-44';
                if (age < 55) return '45-54';
                if (age < 65) return '55-64';
                return '65plus';
            },

            getAmountRange(amount) {
                if (amount < 100000) return 'under100k';
                if (amount < 500000) return '100k-500k';
                if (amount < 1000000) return '500k-1M';
                if (amount < 2000000) return '1M-2M';
                if (amount < 5000000) return '2M-5M';
                return 'over5M';
            },

            calculateSavingsRate(inputs, workPeriods) {
                const currentSalary = workPeriods[workPeriods.length - 1]?.salary || 0;
                if (currentSalary === 0) return 0;
                
                const totalMonthlySavings = (workPeriods[workPeriods.length - 1]?.monthlyContribution || 0) +
                    (workPeriods[workPeriods.length - 1]?.monthlyTrainingFund || 0) +
                    inputs.personalPortfolioMonthly +
                    inputs.cryptoMonthly +
                    inputs.realEstateMonthly +
                    inputs.emergencyFundMonthly;
                
                return Math.round((totalMonthlySavings / currentSalary) * 100);
            },

            calculateDebtRatio(inputs, workPeriods) {
                const currentSalary = workPeriods[workPeriods.length - 1]?.salary || 0;
                if (currentSalary === 0) return 0;
                
                const totalMonthlyDebt = inputs.mortgageMonthlyPayment +
                    inputs.personalLoansMonthly +
                    inputs.creditCardMonthly +
                    inputs.otherDebtsMonthly;
                
                return Math.round((totalMonthlyDebt / currentSalary) * 100);
            },

            getRecommendationTypes(results, inputs, workPeriods) {
                const types = [];
                const currentAge = inputs.currentAge;
                const savingsRate = this.calculateSavingsRate(inputs, workPeriods);
                const emergencyFundCoverage = inputs.currentMonthlyExpenses > 0 ? 
                    inputs.currentEmergencyFund / inputs.currentMonthlyExpenses : 0;

                if (emergencyFundCoverage < 3) types.push('emergency_fund_critical');
                else if (emergencyFundCoverage < 6) types.push('emergency_fund_warning');
                
                if (savingsRate < 10) types.push('savings_rate_low');
                else if (savingsRate >= 20) types.push('savings_rate_excellent');
                
                if (!results.achievesTarget) types.push('target_gap');
                
                if (currentAge > 55 && (inputs.riskTolerance === 'aggressive' || inputs.riskTolerance === 'veryAggressive')) {
                    types.push('risk_alignment');
                }

                return types;
            },

            assessRiskAlignment(age, riskTolerance) {
                if (age < 30 && riskTolerance === 'conservative') return 'too_conservative';
                if (age > 55 && (riskTolerance === 'aggressive' || riskTolerance === 'veryAggressive')) return 'too_aggressive';
                return 'appropriate';
            },

            calculatePlanningScore(results, inputs) {
                let score = 0;
                
                // Target achievement (30 points)
                if (results.achievesTarget) score += 30;
                else if (results.targetGap && results.targetGap < 5000) score += 20;
                else if (results.targetGap && results.targetGap < 10000) score += 10;
                
                // Emergency fund (25 points)
                const emergencyFundCoverage = inputs.currentMonthlyExpenses > 0 ? 
                    inputs.currentEmergencyFund / inputs.currentMonthlyExpenses : 0;
                if (emergencyFundCoverage >= 6) score += 25;
                else if (emergencyFundCoverage >= 3) score += 15;
                else if (emergencyFundCoverage >= 1) score += 5;
                
                // Diversification (20 points)
                let diversificationScore = 0;
                if (inputs.currentPersonalPortfolio > 0 || inputs.personalPortfolioMonthly > 0) diversificationScore += 7;
                if (inputs.currentCrypto > 0 || inputs.cryptoMonthly > 0) diversificationScore += 3;
                if (inputs.currentRealEstate > 0 || inputs.realEstateMonthly > 0) diversificationScore += 10;
                score += Math.min(diversificationScore, 20);
                
                // Planning horizon (15 points)
                const yearsToRetirement = inputs.retirementAge - inputs.currentAge;
                if (yearsToRetirement >= 25) score += 15;
                else if (yearsToRetirement >= 15) score += 10;
                else if (yearsToRetirement >= 5) score += 5;
                
                // Risk appropriateness (10 points)
                const riskAlignment = this.assessRiskAlignment(inputs.currentAge, inputs.riskTolerance);
                if (riskAlignment === 'appropriate') score += 10;
                else if (riskAlignment === 'too_conservative' && inputs.currentAge < 35) score += 5;
                
                return Math.min(score, 100);
            },

            // Get analytics summary
            getAnalyticsSummary() {
                const storageKey = 'retirement_planner_analytics';
                const analytics = JSON.parse(localStorage.getItem(storageKey) || '{}');
                
                if (!analytics.metadata) return null;

                const now = new Date();
                const sessionsToday = Object.values(analytics.sessions || {}).filter(session => {
                    const sessionDate = new Date(session.startTime);
                    return sessionDate.toDateString() === now.toDateString();
                }).length;

                const conclusionsToday = analytics.conclusions.filter(conclusion => {
                    const conclusionDate = new Date(conclusion.timestamp);
                    return conclusionDate.toDateString() === now.toDateString();
                }).length;

                return {
                    totalVisitors: analytics.metadata.totalVisitors || 0,
                    totalSessions: analytics.metadata.totalSessions || 0,
                    totalConclusions: analytics.conclusions.length || 0,
                    sessionsToday,
                    conclusionsToday,
                    lastUpdated: analytics.metadata.lastUpdated,
                    version: analytics.metadata.version
                };
            },

            // Export analytics data
            exportAnalytics() {
                const storageKey = 'retirement_planner_analytics';
                const analytics = JSON.parse(localStorage.getItem(storageKey) || '{}');
                return analytics;
            },

            // End session tracking
            endSession() {
                const sessionId = sessionStorage.getItem('current_session_id');
                if (!sessionId) return;

                const storageKey = 'retirement_planner_analytics';
                const analytics = JSON.parse(localStorage.getItem(storageKey) || '{}');
                
                if (analytics.sessions && analytics.sessions[sessionId]) {
                    analytics.sessions[sessionId].endTime = new Date().toISOString();
                    localStorage.setItem(storageKey, JSON.stringify(analytics));
                }

                sessionStorage.removeItem('current_session_id');
            }
        };

        const RetirementPlanner = () => {
            const [language, setLanguage] = useState('he');
            
            // Update global language for chart component
            React.useEffect(() => {
                window.currentLanguage = language;
            }, [language]);
            const [activeTab, setActiveTab] = useState('basic');
            const [inputs, setInputs] = useState({
                currentAge: 30,
                retirementAge: 67,
                currentSavings: 50000,
                inflationRate: 3,
                currentMonthlyExpenses: 12000,
                targetReplacement: 75,
                riskTolerance: 'moderate',
                currentTrainingFund: 25000,
                trainingFundReturn: 6.5,
                trainingFundManagementFee: 0.5,
                // Personal investment portfolio (no tax benefits)
                currentPersonalPortfolio: 0,
                personalPortfolioMonthly: 0,
                personalPortfolioReturn: 8.0,
                personalPortfolioTaxRate: 25, // Capital gains tax
                // Cryptocurrency portfolio
                currentCrypto: 0,
                cryptoMonthly: 0,
                cryptoReturn: 15.0, // High volatility expected return
                cryptoTaxRate: 25,
                // FIRE calculation
                fireTargetAge: 50,
                fireMonthlyExpenses: 15000, // Expenses for FIRE lifestyle
                fireSafeWithdrawlRate: 4.0, // 4% rule
                // Real Estate Investment
                currentRealEstate: 0,
                realEstateMonthly: 0,
                realEstateReturn: 6.0, // Property appreciation
                realEstateRentalYield: 4.0, // Annual rental yield
                realEstateTaxRate: 10, // Property tax and expenses
                // Debts and Liabilities for FIRE calculation
                mortgageBalance: 0, // Current mortgage balance
                mortgageMonthlyPayment: 0, // Monthly mortgage payment
                mortgageRemainingYears: 0, // Years left on mortgage
                personalLoans: 0, // Total personal loans balance
                personalLoansMonthly: 0, // Monthly personal loan payments
                creditCardDebt: 0, // Current credit card debt
                creditCardMonthly: 0, // Monthly credit card payments
                otherDebts: 0, // Other debts (car loans, etc.)
                otherDebtsMonthly: 0, // Monthly payments for other debts
                // Emergency Fund
                currentEmergencyFund: 0, // Current emergency fund balance
                emergencyFundTarget: 6, // Target months of expenses to cover
                emergencyFundMonthly: 0 // Monthly contribution to emergency fund
            });

            const [pensionIndexAllocation, setPensionIndexAllocation] = useState([
                { index: 'S&P 500', percentage: 60, customReturn: null },
                { index: 'Government Bonds', percentage: 40, customReturn: null }
            ]);

            const [trainingFundIndexAllocation, setTrainingFundIndexAllocation] = useState([
                { index: 'Tel Aviv 35', percentage: 100, customReturn: null }
            ]);

            const [workPeriods, setWorkPeriods] = useState([
                {
                    id: 1,
                    country: 'israel',
                    startAge: 30,
                    endAge: 67,
                    monthlyContribution: 2000,
                    salary: 15000,
                    pensionReturn: 7.0,
                    pensionDepositFee: 0.5,
                    pensionAnnualFee: 0.8,
                    monthlyTrainingFund: 500
                }
            ]);

            const [results, setResults] = useState(null);
            const [chartData, setChartData] = useState(null);
            const [showChart, setShowChart] = useState(false);
            const [claudeInsights, setClaudeInsights] = useState(null);
            const [selectedTimeHorizon, setSelectedTimeHorizon] = useState(20);
            const [stressTestResults, setStressTestResults] = useState(null);
            const [aiScenarioLoading, setAiScenarioLoading] = useState(false);

            // Real-time index data state - starts with fallback, then updated from APIs
            const [historicalReturns, setHistoricalReturns] = useState({
                5: {
                    '×ª"× 35': 8.2, '×ª"× 125': 7.5, 'S&P 500': 10.5, 'NASDAQ': 12.1,
                    'MSCI World': 8.8, '×™×•×¨×• ×¡×˜×•×§×¡ 50': 6.4, 'FTSE 100': 5.9,
                    '× ×™×§×™×™ 225': 7.2, '××’×´×— ×××©×œ×ª×™×•×ª': 3.8, '××’×´×— ×§×•× ×¦×¨× ×™×•×ª': 4.5,
                    '× ×“×œ×´×Ÿ ××¨×”×´×‘': 7.8, '× ×“×œ×´×Ÿ ×™×©×¨××œ': 9.2, '× ×“×œ×´×Ÿ ××™×¨×•×¤×”': 6.5, 
                    '× ×“×œ×´×Ÿ ×¢×•×œ××™': 7.3, '× ×“×œ×´×Ÿ ××¡×™×”': 8.1
                },
                10: {
                    '×ª"× 35': 7.1, '×ª"× 125': 6.8, 'S&P 500': 9.8, 'NASDAQ': 11.2,
                    'MSCI World': 8.1, '×™×•×¨×• ×¡×˜×•×§×¡ 50': 5.9, 'FTSE 100': 5.2,
                    '× ×™×§×™×™ 225': 6.8, '××’×´×— ×××©×œ×ª×™×•×ª': 3.2, '××’×´×— ×§×•× ×¦×¨× ×™×•×ª': 4.1,
                    '× ×“×œ×´×Ÿ ××¨×”×´×‘': 7.2, '× ×“×œ×´×Ÿ ×™×©×¨××œ': 8.5, '× ×“×œ×´×Ÿ ××™×¨×•×¤×”': 5.8,
                    '× ×“×œ×´×Ÿ ×¢×•×œ××™': 6.9, '× ×“×œ×´×Ÿ ××¡×™×”': 7.4
                },
                15: {
                    '×ª"× 35': 6.8, '×ª"× 125': 6.5, 'S&P 500': 9.4, 'NASDAQ': 10.2,
                    'MSCI World': 7.8, '×™×•×¨×• ×¡×˜×•×§×¡ 50': 5.8, 'FTSE 100': 5.3,
                    '× ×™×§×™×™ 225': 6.2, '××’×´×— ×××©×œ×ª×™×•×ª': 3.5, '××’×´×— ×§×•× ×¦×¨× ×™×•×ª': 4.1,
                    '× ×“×œ×´×Ÿ ××¨×”×´×‘': 6.8, '× ×“×œ×´×Ÿ ×™×©×¨××œ': 8.0, '× ×“×œ×´×Ÿ ××™×¨×•×¤×”': 5.5,
                    '× ×“×œ×´×Ÿ ×¢×•×œ××™': 6.5, '× ×“×œ×´×Ÿ ××¡×™×”': 7.0
                },
                20: {
                    '×ª"× 35': 6.5, '×ª"× 125': 6.1, 'S&P 500': 8.8, 'NASDAQ': 9.9,
                    'MSCI World': 7.2, '×™×•×¨×• ×¡×˜×•×§×¡ 50': 5.1, 'FTSE 100': 4.4,
                    '× ×™×§×™×™ 225': 4.2, '××’×´×— ×××©×œ×ª×™×•×ª': 2.5, '××’×´×— ×§×•× ×¦×¨× ×™×•×ª': 3.5,
                    '× ×“×œ×´×Ÿ ××¨×”×´×‘': 6.5, '× ×“×œ×´×Ÿ ×™×©×¨××œ': 7.8, '× ×“×œ×´×Ÿ ××™×¨×•×¤×”': 5.2,
                    '× ×“×œ×´×Ÿ ×¢×•×œ××™': 6.1, '× ×“×œ×´×Ÿ ××¡×™×”': 6.7
                },
                25: {
                    '×ª"× 35': 5.8, '×ª"× 125': 5.7, 'S&P 500': 8.6, 'NASDAQ': 9.4,
                    'MSCI World': 7.0, '×™×•×¨×• ×¡×˜×•×§×¡ 50': 5.1, 'FTSE 100': 4.6,
                    '× ×™×§×™×™ 225': 5.5, '××’×´×— ×××©×œ×ª×™×•×ª': 2.9, '××’×´×— ×§×•× ×¦×¨× ×™×•×ª': 3.6,
                    '× ×“×œ×´×Ÿ ××¨×”×´×‘': 6.0, '× ×“×œ×´×Ÿ ×™×©×¨××œ': 7.5, '× ×“×œ×´×Ÿ ××™×¨×•×¤×”': 5.0,
                    '× ×“×œ×´×Ÿ ×¢×•×œ××™': 5.8, '× ×“×œ×´×Ÿ ××¡×™×”': 6.3
                },
                30: {
                    '×ª"× 35': 5.5, '×ª"× 125': 5.4, 'S&P 500': 8.3, 'NASDAQ': 9.1,
                    'MSCI World': 6.8, '×™×•×¨×• ×¡×˜×•×§×¡ 50': 4.9, 'FTSE 100': 4.4,
                    '× ×™×§×™×™ 225': 5.2, '××’×´×— ×××©×œ×ª×™×•×ª': 2.7, '××’×´×— ×§×•× ×¦×¨× ×™×•×ª': 3.4,
                    '× ×“×œ×´×Ÿ ××¨×”×´×‘': 5.7, '× ×“×œ×´×Ÿ ×™×©×¨××œ': 7.2, '× ×“×œ×´×Ÿ ××™×¨×•×¤×”': 4.8,
                    '× ×“×œ×´×Ÿ ×¢×•×œ××™': 5.5, '× ×“×œ×´×Ÿ ××¡×™×”': 6.0
                }
            });
            
            // Exchange rates state
            const [exchangeRates, setExchangeRates] = useState({
                USD: 3.37, // Fallback values - ILS per currency unit
                GBP: 4.60,
                EUR: 3.65  // Updated EUR exchange rate
            });
            const [exchangeRatesLoading, setExchangeRatesLoading] = useState(false);
            const [exchangeRatesLastUpdated, setExchangeRatesLastUpdated] = useState(null);
            
            // Cryptocurrency prices state (in USD)
            const [cryptoPrices, setCryptoPrices] = useState({
                bitcoin: 50000, // Fallback values in USD
                ethereum: 3000,
                binancecoin: 300
            });
            const [cryptoPricesLoading, setCryptoPricesLoading] = useState(false);
            const [cryptoPricesLastUpdated, setCryptoPricesLastUpdated] = useState(null);
            const [indexDataLoading, setIndexDataLoading] = useState(false);
            const [lastUpdated, setLastUpdated] = useState(null);

            // Index symbols for API calls (Yahoo Finance format)
            const indexSymbols = {
                '×ª"× 35': 'TA35.TA',
                '×ª"× 125': 'TA125.TA', 
                'S&P 500': '^GSPC',
                'NASDAQ': '^IXIC',
                'MSCI World': 'URTH',
                '×™×•×¨×• ×¡×˜×•×§×¡ 50': '^STOXX50E',
                'FTSE 100': '^FTSE',
                '× ×™×§×™×™ 225': '^N225',
                '××’×´×— ×××©×œ×ª×™×•×ª': 'IEF',
                '××’×´×— ×§×•× ×¦×¨× ×™×•×ª': 'LQD',
                '× ×“×œ×´×Ÿ ××¨×”×´×‘': 'VNQ',
                '× ×“×œ×´×Ÿ ×™×©×¨××œ': 'TASE:TARE',
                '× ×“×œ×´×Ÿ ××™×¨×•×¤×”': 'VGK',
                '× ×“×œ×´×Ÿ ×¢×•×œ××™': 'VNQI',
                '× ×“×œ×´×Ÿ ××¡×™×”': 'VPL'
            };

            // Bilingual index names mapping
            const indexNames = {
                '×ª"× 35': { he: '×ª"× 35', en: 'Tel Aviv 35' },
                '×ª"× 125': { he: '×ª"× 125', en: 'Tel Aviv 125' },
                'S&P 500': { he: 'S&P 500', en: 'S&P 500' },
                'NASDAQ': { he: '× ××¡×“"×§', en: 'NASDAQ' },
                'MSCI World': { he: 'MSCI ×¢×•×œ××™', en: 'MSCI World' },
                '×™×•×¨×• ×¡×˜×•×§×¡ 50': { he: '×™×•×¨×• ×¡×˜×•×§×¡ 50', en: 'Euro Stoxx 50' },
                'FTSE 100': { he: 'FTSE 100', en: 'FTSE 100' },
                '× ×™×§×™×™ 225': { he: '× ×™×§×™×™ 225', en: 'Nikkei 225' },
                '××’×´×— ×××©×œ×ª×™×•×ª': { he: '××’×´×— ×××©×œ×ª×™×•×ª', en: 'Government Bonds' },
                '××’×´×— ×§×•× ×¦×¨× ×™×•×ª': { he: '××’×´×— ×§×•× ×¦×¨× ×™×•×ª', en: 'Corporate Bonds' },
                '× ×“×œ×´×Ÿ ××¨×”×´×‘': { he: '× ×“×œ×´×Ÿ ××¨×”×´×‘', en: 'US Real Estate' },
                '× ×“×œ×´×Ÿ ×™×©×¨××œ': { he: '× ×“×œ×´×Ÿ ×™×©×¨××œ', en: 'Israel Real Estate' },
                '× ×“×œ×´×Ÿ ××™×¨×•×¤×”': { he: '× ×“×œ×´×Ÿ ××™×¨×•×¤×”', en: 'Europe Real Estate' },
                '× ×“×œ×´×Ÿ ×¢×•×œ××™': { he: '× ×“×œ×´×Ÿ ×¢×•×œ××™', en: 'Global Real Estate' },
                '× ×“×œ×´×Ÿ ××¡×™×”': { he: '× ×“×œ×´×Ÿ ××¡×™×”', en: 'Asia Real Estate' }
            };

            // Function to fetch exchange rates
            const fetchExchangeRates = async () => {
                setExchangeRatesLoading(true);
                try {
                    // Try multiple API providers with fallbacks
                    let response;
                    let data;
                    
                    try {
                        // Primary: Exchange Rates API (free tier)
                        response = await fetch('https://api.exchangerate-api.com/v4/latest/ILS');
                        if (response.ok) {
                            data = await response.json();
                            setExchangeRates({
                                USD: 1 / data.rates.USD,
                                GBP: 1 / data.rates.GBP,
                                EUR: 1 / data.rates.EUR
                            });
                            setExchangeRatesLastUpdated(new Date());
                            console.log('Exchange rates updated from Exchange Rates API');
                            return;
                        }
                    } catch (error) {
                        console.warn('Exchange Rates API failed:', error);
                    }
                    
                    try {
                        // Fallback: Fixer.io (requires API key, using demo endpoint)
                        response = await fetch('https://api.fixer.io/latest?base=ILS&symbols=USD,GBP,EUR');
                        if (response.ok) {
                            data = await response.json();
                            setExchangeRates({
                                USD: 1 / data.rates.USD,
                                GBP: 1 / data.rates.GBP,
                                EUR: 1 / data.rates.EUR
                            });
                            setExchangeRatesLastUpdated(new Date());
                            console.log('Exchange rates updated from Fixer.io');
                            return;
                        }
                    } catch (error) {
                        console.warn('Fixer.io API failed:', error);
                    }
                    
                    // If all APIs fail, keep fallback values
                    console.log('Using fallback exchange rates');
                    
                } catch (error) {
                    console.error('Failed to fetch exchange rates:', error);
                } finally {
                    setExchangeRatesLoading(false);
                }
            };

            // Function to fetch cryptocurrency prices
            const fetchCryptoPrices = async () => {
                setCryptoPricesLoading(true);
                try {
                    // CoinGecko API (free, no API key required)
                    const response = await fetch(
                        'https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,ethereum,binancecoin&vs_currencies=usd'
                    );
                    
                    if (response.ok) {
                        const data = await response.json();
                        setCryptoPrices({
                            bitcoin: data.bitcoin?.usd || 50000,
                            ethereum: data.ethereum?.usd || 3000,
                            binancecoin: data.binancecoin?.usd || 300
                        });
                        setCryptoPricesLastUpdated(new Date());
                        console.log('Cryptocurrency prices updated from CoinGecko');
                    } else {
                        console.warn('CoinGecko API response not OK, using fallback prices');
                    }
                    
                } catch (error) {
                    console.error('Failed to fetch cryptocurrency prices:', error);
                    console.log('Using fallback cryptocurrency prices');
                } finally {
                    setCryptoPricesLoading(false);
                }
            };

            // Session-based data fetching - updates only once per browser session

            // Function to fetch real-time index data
            const fetchIndexData = async () => {
                setIndexDataLoading(true);
                try {
                    // Enhanced index data with multiple API sources for reliability
                    const fetchWithFallback = async (name, symbol) => {
                        // First try: Google Finance API (most reliable)
                        try {
                            // Convert symbol to Google Finance format
                            const googleSymbol = symbol.replace('^', 'INDEXSP:');
                            const response = await fetch(`https://query2.finance.yahoo.com/v1/finance/search?q=${googleSymbol}&lang=en-US&region=US&quotesCount=1&newsCount=0`);
                            const data = await response.json();
                            
                            if (data.quotes && data.quotes.length > 0) {
                                const quote = data.quotes[0];
                                // Get historical data from multiple years for better accuracy
                                const historicalResponse = await fetch(`https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?interval=1mo&range=5y`);
                                const historicalData = await historicalResponse.json();
                                
                                if (historicalData.chart && historicalData.chart.result && historicalData.chart.result[0]) {
                                    const result = historicalData.chart.result[0];
                                    const closes = result.indicators.quote[0].close.filter(p => p !== null);
                                    
                                    if (closes.length > 24) { // Need at least 2 years of data
                                        // Calculate multi-year average returns
                                        const periodsToCalculate = [
                                            { years: 1, months: 12 },
                                            { years: 2, months: 24 },
                                            { years: 3, months: 36 },
                                            { years: 5, months: 60 }
                                        ];
                                        
                                        let averageReturns = [];
                                        
                                        periodsToCalculate.forEach(period => {
                                            if (closes.length >= period.months) {
                                                const startPrice = closes[closes.length - period.months];
                                                const endPrice = closes[closes.length - 1];
                                                const annualReturn = ((endPrice / startPrice) ** (1 / period.years) - 1) * 100;
                                                averageReturns.push(Math.max(0.5, annualReturn)); // Minimum 0.5%
                                            }
                                        });
                                        
                                        // Calculate weighted average with recent performance having more weight
                                        const weightedAverage = averageReturns.length > 0 
                                            ? averageReturns.reduce((sum, ret, index) => sum + ret * (index + 1), 0) / averageReturns.reduce((sum, _, index) => sum + index + 1, 0)
                                            : 5; // Default 5% if no data
                                        
                                        // Apply market-specific adjustments
                                        const marketAdjustments = {
                                            '×ª"× 35': -1.5,    // Israeli market discount
                                            '×ª"× 125': -1.8,   // Broader Israeli market
                                            'S&P 500': 1.2,    // US market premium
                                            'NASDAQ': 2.0,     // Tech premium
                                            'MSCI World': 0.5, // Global diversification
                                            '×™×•×¨×• ×¡×˜×•×§×¡ 50': -1.0, // European market
                                            'FTSE 100': -1.5,  // UK market
                                            '× ×™×§×™×™ 225': -0.5,  // Japanese market
                                            '××’×´×— ×××©×œ×ª×™×•×ª': -4.0, // Government bonds
                                            '××’×´×— ×§×•× ×¦×¨× ×™×•×ª': -3.0, // Corporate bonds
                                            '× ×“×œ×´×Ÿ ××¨×”×´×‘': 0.8,     // US Real Estate
                                            '× ×“×œ×´×Ÿ ×™×©×¨××œ': 1.5,     // Israel Real Estate
                                            '× ×“×œ×´×Ÿ ××™×¨×•×¤×”': 0.2,    // Europe Real Estate
                                            '× ×“×œ×´×Ÿ ×¢×•×œ××™': 0.5,     // Global Real Estate
                                            '× ×“×œ×´×Ÿ ××¡×™×”': 0.7       // Asia Real Estate
                                        };
                                        
                                        const adjustment = marketAdjustments[name] || 0;
                                        const baseReturn = Math.max(1, weightedAverage + adjustment);
                                        
                                        return {
                                            name,
                                            returns: {
                                                5: Math.max(1, baseReturn * 1.1),  // Short term higher volatility
                                                10: Math.max(1, baseReturn * 1.05), // Medium term
                                                15: Math.max(1, baseReturn),        // Base return
                                                20: Math.max(1, baseReturn * 0.95), // Long term more conservative
                                                25: Math.max(1, baseReturn * 0.9),  // Very long term
                                                30: Math.max(1, baseReturn * 0.85)  // Ultra long term
                                            },
                                            source: 'Google Finance + Historical Analysis',
                                            actualReturn: weightedAverage.toFixed(2)
                                        };
                                    }
                                }
                            }
                        } catch (error) {
                            console.warn(`Google Finance failed for ${name}:`, error);
                        }
                        
                        // Second try: Yahoo Finance API (free)
                        try {
                            const response = await fetch(`https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?interval=1d&range=2y`);
                            const data = await response.json();
                            
                            if (data.chart && data.chart.result && data.chart.result[0]) {
                                const result = data.chart.result[0];
                                const closes = result.indicators.quote[0].close;
                                const recent = closes.slice(-504).filter(p => p !== null); // Last 2 years of trading days
                                
                                if (recent.length > 100) {
                                    // Calculate actual annualized returns from historical data
                                    const twoYearReturn = Math.pow(recent[recent.length - 1] / recent[0], 1/2) - 1;
                                    const annualizedReturn = twoYearReturn * 100;
                                    const volatilityAdjusted = Math.max(1, annualizedReturn * 0.85); // Conservative adjustment
                                    
                                    return {
                                        name,
                                        returns: {
                                            5: Math.max(1, volatilityAdjusted * 1.0 + (name.includes('×ª"×') ? 2 : name.includes('S&P') ? 3 : 1)),
                                            10: Math.max(1, volatilityAdjusted * 0.9 + (name.includes('×ª"×') ? 1.5 : name.includes('S&P') ? 2.5 : 1)),
                                            15: Math.max(1, volatilityAdjusted * 0.8 + (name.includes('×ª"×') ? 1 : name.includes('S&P') ? 2 : 0.5)),
                                            20: Math.max(1, volatilityAdjusted * 0.7 + (name.includes('×ª"×') ? 0.5 : name.includes('S&P') ? 1.5 : 0.5)),
                                            25: Math.max(1, volatilityAdjusted * 0.6 + (name.includes('×ª"×') ? 0.5 : name.includes('S&P') ? 1 : 0.5)),
                                            30: Math.max(1, volatilityAdjusted * 0.5 + (name.includes('×ª"×') ? 0.5 : name.includes('S&P') ? 1 : 0.5))
                                        },
                                        source: 'Yahoo Finance (2Y Analysis)',
                                        actualReturn: annualizedReturn.toFixed(2)
                                    };
                                }
                            }
                        } catch (error) {
                            console.warn(`Yahoo Finance failed for ${name}:`, error);
                        }
                        
                        // Second try: Alpha Vantage API
                        try {
                            const response = await fetch(`https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${symbol}&apikey=demo`);
                            const data = await response.json();
                            
                            if (data['Global Quote'] && data['Global Quote']['05. price']) {
                                const changePercent = parseFloat(data['Global Quote']['10. change percent']?.replace('%', '') || 0);
                                
                                return {
                                    name,
                                    returns: {
                                        5: Math.max(1, changePercent * 0.8 + (name.includes('×ª"×') ? 6 : name.includes('S&P') ? 8 : 4)),
                                        10: Math.max(1, changePercent * 0.7 + (name.includes('×ª"×') ? 5.5 : name.includes('S&P') ? 7.5 : 4)),
                                        15: Math.max(1, changePercent * 0.6 + (name.includes('×ª"×') ? 5 : name.includes('S&P') ? 7 : 3.5)),
                                        20: Math.max(1, changePercent * 0.5 + (name.includes('×ª"×') ? 4.5 : name.includes('S&P') ? 6.5 : 3)),
                                        25: Math.max(1, changePercent * 0.4 + (name.includes('×ª"×') ? 4 : name.includes('S&P') ? 6 : 2.5)),
                                        30: Math.max(1, changePercent * 0.3 + (name.includes('×ª"×') ? 3.5 : name.includes('S&P') ? 5.5 : 2))
                                    },
                                    source: 'Alpha Vantage'
                                };
                            }
                        } catch (error) {
                            console.warn(`Alpha Vantage failed for ${name}:`, error);
                        }
                        
                        // Fallback to enhanced historical data based on recent market analysis
                        const fallbackReturns = {
                            '×ª"× 35': { 5: 8.5, 10: 7.3, 15: 6.8, 20: 6.2, 25: 5.8, 30: 5.5 },
                            '×ª"× 125': { 5: 7.8, 10: 6.9, 15: 6.5, 20: 6.0, 25: 5.7, 30: 5.4 },
                            'S&P 500': { 5: 11.2, 10: 10.1, 15: 9.4, 20: 8.9, 25: 8.6, 30: 8.3 },
                            'NASDAQ': { 5: 12.8, 10: 11.5, 15: 10.2, 20: 9.8, 25: 9.4, 30: 9.1 },
                            'MSCI World': { 5: 9.2, 10: 8.4, 15: 7.8, 20: 7.3, 25: 7.0, 30: 6.8 },
                            '×™×•×¨×• ×¡×˜×•×§×¡ 50': { 5: 6.8, 10: 6.2, 15: 5.8, 20: 5.4, 25: 5.1, 30: 4.9 },
                            'FTSE 100': { 5: 6.2, 10: 5.7, 15: 5.3, 20: 4.9, 25: 4.6, 30: 4.4 },
                            '× ×™×§×™×™ 225': { 5: 7.5, 10: 6.8, 15: 6.2, 20: 5.8, 25: 5.5, 30: 5.2 },
                            '××’×´×— ×××©×œ×ª×™×•×ª': { 5: 4.2, 10: 3.8, 15: 3.5, 20: 3.2, 25: 2.9, 30: 2.7 },
                            '××’×´×— ×§×•× ×¦×¨× ×™×•×ª': { 5: 4.8, 10: 4.4, 15: 4.1, 20: 3.8, 25: 3.6, 30: 3.4 },
                            '× ×“×œ×´×Ÿ': { 5: 8.1, 10: 7.4, 15: 6.8, 20: 6.3, 25: 6.0, 30: 5.7 }
                        };
                        
                        return {
                            name,
                            returns: fallbackReturns[name] || { 5: 5, 10: 4.5, 15: 4, 20: 3.5, 25: 3, 30: 2.5 },
                            source: 'Historical Average'
                        };
                    };

                    // Fetch data for all indices
                    const responses = await Promise.all(
                        Object.entries(indexSymbols).map(async ([name, symbol]) => {
                            return await fetchWithFallback(name, symbol);
                        })
                    );

                    // Convert responses to the expected format
                    const newHistoricalReturns = {
                        5: {}, 10: {}, 15: {}, 20: {}, 25: {}, 30: {}
                    };
                    
                    responses.forEach(({ name, returns }) => {
                        Object.keys(newHistoricalReturns).forEach(timeframe => {
                            newHistoricalReturns[timeframe][name] = returns[timeframe];
                        });
                    });

                    setHistoricalReturns(newHistoricalReturns);
                    setLastUpdated(new Date());
                    
                    // Log successful fetches
                    console.log('Successfully updated index data from:', responses.map(r => `${r.name} (${r.source})`).join(', '));
                    
                } catch (error) {
                    console.error('Failed to fetch index data:', error);
                    // Use fallback data
                    setHistoricalReturns({
                        5: {
                            '×ª"× 35': 8.2, '×ª"× 125': 7.5, 'S&P 500': 10.5, 'NASDAQ': 12.1,
                            'MSCI World': 8.8, '×™×•×¨×• ×¡×˜×•×§×¡ 50': 6.4, 'FTSE 100': 5.9,
                            '× ×™×§×™×™ 225': 7.2, '××’×´×— ×××©×œ×ª×™×•×ª': 3.8, '××’×´×— ×§×•× ×¦×¨× ×™×•×ª': 4.5,
                            '× ×“×œ×´×Ÿ ××¨×”×´×‘': 7.8, '× ×“×œ×´×Ÿ ×™×©×¨××œ': 9.2, '× ×“×œ×´×Ÿ ××™×¨×•×¤×”': 6.5, 
                            '× ×“×œ×´×Ÿ ×¢×•×œ××™': 7.3, '× ×“×œ×´×Ÿ ××¡×™×”': 8.1
                        },
                        10: {
                            '×ª"× 35': 7.1, '×ª"× 125': 6.8, 'S&P 500': 9.8, 'NASDAQ': 11.2,
                            'MSCI World': 8.1, '×™×•×¨×• ×¡×˜×•×§×¡ 50': 5.9, 'FTSE 100': 5.2,
                            '× ×™×§×™×™ 225': 6.8, '××’×´×— ×××©×œ×ª×™×•×ª': 3.2, '××’×´×— ×§×•× ×¦×¨× ×™×•×ª': 4.1,
                            '× ×“×œ×´×Ÿ ××¨×”×´×‘': 7.2, '× ×“×œ×´×Ÿ ×™×©×¨××œ': 8.5, '× ×“×œ×´×Ÿ ××™×¨×•×¤×”': 5.8,
                            '× ×“×œ×´×Ÿ ×¢×•×œ××™': 6.9, '× ×“×œ×´×Ÿ ××¡×™×”': 7.4
                        },
                        20: {
                            '×ª"× 35': 6.5, '×ª"× 125': 6.1, 'S&P 500': 8.8, 'NASDAQ': 9.9,
                            'MSCI World': 7.2, '×™×•×¨×• ×¡×˜×•×§×¡ 50': 5.1, 'FTSE 100': 4.4,
                            '× ×™×§×™×™ 225': 4.2, '××’×´×— ×××©×œ×ª×™×•×ª': 2.5, '××’×´×— ×§×•× ×¦×¨× ×™×•×ª': 3.5,
                            '× ×“×œ×´×Ÿ ××¨×”×´×‘': 6.5, '× ×“×œ×´×Ÿ ×™×©×¨××œ': 7.8, '× ×“×œ×´×Ÿ ××™×¨×•×¤×”': 5.2,
                            '× ×“×œ×´×Ÿ ×¢×•×œ××™': 6.1, '× ×“×œ×´×Ÿ ××¡×™×”': 6.7
                        }
                    });
                } finally {
                    setIndexDataLoading(false);
                }
            };

            // Load all financial data once on component mount
            useEffect(() => {
                console.log('Loading financial data...');
                
                // Always fetch data on component mount to ensure we have current data
                fetchIndexData();
                fetchExchangeRates();
                fetchCryptoPrices();
                
                console.log('Financial data fetch initiated');
            }, []);

            // Risk scenarios
            const riskScenarios = {
                veryConservative: { 
                    multiplier: 0.7, 
                    name: { he: '×©××¨× ×™ ×××•×“', en: 'Very Conservative' },
                    description: { he: '×¡×™×›×•×Ÿ × ××•×š ×××•×“, ×ª×©×•××” × ××•×›×”', en: 'Very low risk, low return' }
                },
                conservative: { 
                    multiplier: 0.85, 
                    name: { he: '×©××¨× ×™', en: 'Conservative' },
                    description: { he: '×¡×™×›×•×Ÿ × ××•×š, ×ª×©×•××” ××ª×•× ×”', en: 'Low risk, moderate return' }
                },
                moderate: { 
                    multiplier: 1.0, 
                    name: { he: '××ª×•×Ÿ', en: 'Moderate' },
                    description: { he: '×¡×™×›×•×Ÿ ××ª×•×Ÿ, ×ª×©×•××” ×××•×¦×¢×ª', en: 'Moderate risk, average return' }
                },
                aggressive: { 
                    multiplier: 1.15, 
                    name: { he: '××’×¨×¡×™×‘×™', en: 'Aggressive' },
                    description: { he: '×¡×™×›×•×Ÿ ×’×‘×•×”, ×ª×©×•××” ×’×‘×•×”×”', en: 'High risk, high return' }
                },
                veryAggressive: { 
                    multiplier: 1.3, 
                    name: { he: '××’×¨×¡×™×‘×™ ×××•×“', en: 'Very Aggressive' },
                    description: { he: '×¡×™×›×•×Ÿ ×’×‘×•×” ×××•×“, ×ª×©×•××” ×’×‘×•×”×” ×××•×“', en: 'Very high risk, very high return' }
                }
            };

            // Translations
            const translations = {
                en: {
                    title: "ğŸ“Š Advanced Retirement Planner",
                    subtitle: "Professional retirement planning tool with flexible returns and management fees",
                    basic: "Basic Data",
                    advanced: "Advanced Settings",
                    analysis: "Index Analysis",
                    scenarios: "Scenarios",
                    indexAllocation: "Index Allocation",
                    currentAge: "Current Age",
                    retirementAge: "Retirement Age",
                    currentSavings: "Current Pension Savings (â‚ª)",
                    inflationRate: "Annual Inflation (%)",
                    currentMonthlyExpenses: "Current Monthly Expenses (â‚ª)",
                    targetReplacement: "Target: Replace % of Salary",
                    riskTolerance: "Risk Level",
                    conservative: "Conservative",
                    moderate: "Moderate",
                    aggressive: "Aggressive",
                    workPeriods: "Work Periods ğŸŒ",
                    addPeriod: "Add Period",
                    monthlyIncome: "Monthly Retirement Income",
                    showChart: "Show Chart",
                    totalMonthly: "Total Monthly Income",
                    fromPension: "From Pension (After Tax)",
                    socialSecurity: "Social Security",
                    fromTrainingFund: "From Training Fund",
                    withInflation: "With Inflation:",
                    purchasingPower: "Today's Purchasing Power",
                    progressChart: "Savings Progress Over the Years ğŸ“Š",
                    historicalReturns: "ğŸ“ˆ Historical Average Returns in Leading Indices",
                    timeHorizon: "Time Horizon (years):",
                    useThisReturn: "Use This Return",
                    years: "years",
                    // Personal Portfolio
                    personalPortfolio: "Personal Investment Portfolio",
                    currentPersonalPortfolio: "Current Personal Portfolio (â‚ª)",
                    personalPortfolioMonthly: "Monthly Investment (â‚ª)",
                    personalPortfolioReturn: "Expected Annual Return (%)",
                    personalPortfolioTax: "Capital Gains Tax (%)",
                    // Cryptocurrency
                    cryptocurrency: "Cryptocurrency Portfolio",
                    currentCrypto: "Current Crypto Holdings (â‚ª)",
                    cryptoMonthly: "Monthly Crypto Investment (â‚ª)",
                    cryptoReturn: "Expected Annual Return (%)",
                    cryptoTax: "Crypto Tax Rate (%)",
                    // FIRE
                    fireCalculator: "FIRE Calculator - Early Retirement",
                    fireTargetAge: "Target Early Retirement Age",
                    fireMonthlyExpenses: "Monthly FIRE Expenses (â‚ª)",
                    fireSafeWithdrawlRate: "Safe Withdrawal Rate (%)",
                    fireTarget: "FIRE Target",
                    fireProgress: "FIRE Progress",
                    // Real Estate
                    realEstate: "Real Estate Investment",
                    currentRealEstate: "Current Real Estate (â‚ª)",
                    realEstateMonthly: "Monthly Real Estate Investment (â‚ª)",
                    realEstateReturn: "Annual Appreciation (%)",
                    realEstateRentalYield: "Annual Rental Yield (%)",
                    realEstateTax: "Property Tax & Expenses (%)",
                    // Debts and Liabilities
                    debtsAndLiabilities: "Debts & Liabilities",
                    mortgageBalance: "Mortgage Balance (â‚ª)",
                    mortgageMonthlyPayment: "Monthly Mortgage Payment (â‚ª)",
                    mortgageRemainingYears: "Mortgage Years Remaining",
                    personalLoans: "Personal Loans (â‚ª)",
                    personalLoansMonthly: "Monthly Loan Payments (â‚ª)",
                    creditCardDebt: "Credit Card Debt (â‚ª)",
                    creditCardMonthly: "Monthly Credit Card Payments (â‚ª)",
                    otherDebts: "Other Debts (â‚ª)",
                    otherDebtsMonthly: "Monthly Other Debt Payments (â‚ª)",
                    totalDebts: "Total Debts",
                    totalMonthlyDebtPayments: "Total Monthly Debt Payments",
                    netWorthAfterDebts: "Net Worth (After Debts)"
                },
                he: {
                    title: "ğŸ“Š ××ª×›× ×Ÿ ×”×¤× ×¡×™×” ×”××ª×§×“×",
                    subtitle: "×›×œ×™ ×ª×›× ×•×Ÿ ×¤× ×¡×™×” ××§×¦×•×¢×™ ×¢× ×ª×©×•××•×ª ×—×•×¤×©×™×•×ª ×•×“××™ × ×™×”×•×œ",
                    basic: "× ×ª×•× ×™× ×‘×¡×™×¡×™×™×",
                    advanced: "×”×’×“×¨×•×ª ××ª×§×“××•×ª",
                    analysis: "× ×™×ª×•×— ××“×“×™×",
                    scenarios: "×ª×¨×—×™×©×™×",
                    indexAllocation: "×”×§×¦××ª ××“×“×™×",
                    currentAge: "×’×™×œ × ×•×›×—×™",
                    retirementAge: "×’×™×œ ×¤×¨×™×©×”",
                    currentSavings: "×—×™×¡×›×•×Ÿ × ×•×›×—×™ ×‘×¤× ×¡×™×” (â‚ª)",
                    inflationRate: "××™× ×¤×œ×¦×™×” ×©× ×ª×™×ª (%)",
                    currentMonthlyExpenses: "×”×•×¦××•×ª ×—×•×“×©×™×•×ª × ×•×›×—×™×•×ª (â‚ª)",
                    targetReplacement: "×™×¢×“: ×”×—×œ×¤×ª % ××”××©×›×•×¨×ª",
                    riskTolerance: "×¨××ª ×¡×™×›×•×Ÿ",
                    conservative: "×©××¨× ×™",
                    moderate: "××ª×•×Ÿ",
                    aggressive: "××’×¨×¡×™×‘×™",
                    workPeriods: "×ª×§×•×¤×•×ª ×¢×‘×•×“×” ğŸŒ",
                    addPeriod: "×”×•×¡×£ ×ª×§×•×¤×”",
                    monthlyIncome: "×”×›× ×¡×” ×‘×™×“ ×‘×¤× ×¡×™×”",
                    showChart: "×”×¦×’ ×’×¨×£",
                    totalMonthly: "×¡×”×´×› ×‘×™×“ ×›×œ ×—×•×“×©",
                    fromPension: "××”×¤× ×¡×™×” (××—×¨×™ ××¡)",
                    socialSecurity: "×‘×™×˜×•×— ×œ××•××™",
                    fromTrainingFund: "××§×¨×Ÿ ×”×©×ª×œ××•×ª",
                    withInflation: "×¢× ××™× ×¤×œ×¦×™×”:",
                    purchasingPower: "×›×•×— ×§× ×™×™×” ×©×œ ×”×™×•×",
                    progressChart: "×”×ª×§×“××•×ª ×”×—×™×¡×›×•×Ÿ ×œ××•×¨×š ×”×©× ×™× ğŸ“Š",
                    historicalReturns: "ğŸ“ˆ ×××•×¦×¢ ×ª×©×•××•×ª ×”×™×¡×˜×•×¨×™×•×ª ×‘××“×“×™× ××•×‘×™×œ×™×",
                    timeHorizon: "××•×¤×§ ×–××Ÿ (×©× ×™×):",
                    useThisReturn: "×”×©×ª××© ×‘×ª×©×•××” ×–×•",
                    years: "×©× ×™×",
                    // Personal Portfolio
                    personalPortfolio: "×ª×™×§ ×”×©×§×¢×•×ª ××™×©×™",
                    currentPersonalPortfolio: "×ª×™×§ ××™×©×™ × ×•×›×—×™ (â‚ª)",
                    personalPortfolioMonthly: "×”×©×§×¢×” ×—×•×“×©×™×ª (â‚ª)",
                    personalPortfolioReturn: "×ª×©×•××” ×©× ×ª×™×ª ×¦×¤×•×™×” (%)",
                    personalPortfolioTax: "××¡ ×¨×•×•×—×™ ×”×•×Ÿ (%)",
                    // Cryptocurrency
                    cryptocurrency: "×ª×™×§ ×§×¨×™×¤×˜×•",
                    currentCrypto: "×§×¨×™×¤×˜×• × ×•×›×—×™ (â‚ª)",
                    cryptoMonthly: "×”×©×§×¢×” ×—×•×“×©×™×ª ×‘×§×¨×™×¤×˜×• (â‚ª)",
                    cryptoReturn: "×ª×©×•××” ×©× ×ª×™×ª ×¦×¤×•×™×” (%)",
                    cryptoTax: "××¡ ×¢×œ ×§×¨×™×¤×˜×• (%)",
                    // FIRE
                    fireCalculator: "××—×©×‘×•×Ÿ FIRE - ×¤×¨×™×©×” ××•×§×“××ª",
                    fireTargetAge: "×’×™×œ ×™×¢×“ ×œ×¤×¨×™×©×” ××•×§×“××ª",
                    fireMonthlyExpenses: "×”×•×¦××•×ª ×—×•×“×©×™×•×ª ×‘-FIRE (â‚ª)",
                    fireSafeWithdrawlRate: "×©×™×¢×•×¨ ××©×™×›×” ×‘×˜×•×— (%)",
                    fireTarget: "×™×¢×“ FIRE",
                    fireProgress: "×”×ª×§×“××•×ª ×œ-FIRE",
                    // Real Estate
                    realEstate: "× ×“×œ×´×Ÿ ×”×©×§×¢×”",
                    currentRealEstate: "× ×“×œ×´×Ÿ × ×•×›×—×™ (â‚ª)",
                    realEstateMonthly: "×”×©×§×¢×” ×—×•×“×©×™×ª ×‘× ×“×œ×´×Ÿ (â‚ª)",
                    realEstateReturn: "×¢×œ×™×™×ª ×¢×¨×š ×©× ×ª×™×ª (%)",
                    realEstateRentalYield: "×ª×©×•××ª ×©×›×™×¨×•×ª ×©× ×ª×™×ª (%)",
                    realEstateTax: "××¡ ×•×¢×œ×•×™×•×ª × ×“×œ×´×Ÿ (%)",
                    // Debts and Liabilities
                    debtsAndLiabilities: "×”×ª×—×™×™×‘×•×™×•×ª ×•×”×œ×•×•××•×ª",
                    mortgageBalance: "×™×ª×¨×ª ××©×›× ×ª× (â‚ª)",
                    mortgageMonthlyPayment: "×ª×©×œ×•× ×—×•×“×©×™ ××©×›× ×ª× (â‚ª)",
                    mortgageRemainingYears: "×©× ×™× × ×•×ª×¨×•×ª ×œ××©×›× ×ª×",
                    personalLoans: "×”×œ×•×•××•×ª ××™×©×™×•×ª (â‚ª)",
                    personalLoansMonthly: "×ª×©×œ×•× ×—×•×“×©×™ ×”×œ×•×•××•×ª (â‚ª)",
                    creditCardDebt: "×—×•×‘ ×›×¨×˜×™×¡×™ ××©×¨××™ (â‚ª)",
                    creditCardMonthly: "×ª×©×œ×•× ×—×•×“×©×™ ×›×¨×˜×™×¡×™ ××©×¨××™ (â‚ª)",
                    otherDebts: "×—×•×‘×•×ª ××—×¨×™× (â‚ª)",
                    otherDebtsMonthly: "×ª×©×œ×•× ×—×•×“×©×™ ×—×•×‘×•×ª ××—×¨×™× (â‚ª)",
                    totalDebts: "×¡×”×´×› ×—×•×‘×•×ª",
                    totalMonthlyDebtPayments: "×¡×”×´×› ×ª×©×œ×•××™× ×—×•×“×©×™×™×",
                    netWorthAfterDebts: "×©×•×•×™ × ×˜×• (×œ××—×¨ ×—×•×‘×•×ª)"
                }
            };

            const t = translations[language];

            // Exchange rates
            // Exchange rates will be fetched dynamically

            // Country data
            const countryData = {
                israel: {
                    name: 'Israel',
                    pensionTax: 0.15,
                    socialSecurity: 2500,
                    flag: 'ğŸ‡®ğŸ‡±'
                },
                usa: {
                    name: 'USA',
                    pensionTax: 0.12,
                    socialSecurity: 1800,
                    flag: 'ğŸ‡ºğŸ‡¸'
                },
                uk: {
                    name: 'UK',
                    pensionTax: 0.20,
                    socialSecurity: 1400,
                    flag: 'ğŸ‡¬ğŸ‡§'
                },
                germany: {
                    name: 'Germany',
                    pensionTax: 0.22,
                    socialSecurity: 1500,
                    flag: 'ğŸ‡©ğŸ‡ª'
                },
                france: {
                    name: 'France',
                    pensionTax: 0.18,
                    socialSecurity: 1600,
                    flag: 'ğŸ‡«ğŸ‡·'
                }
            };

            // Helper functions
            const formatCurrency = (amount) => {
                return new Intl.NumberFormat('he-IL', {
                    style: 'currency',
                    currency: 'ILS',
                    minimumFractionDigits: 0
                }).format(amount);
            };

            const convertCurrency = (amount, currency) => {
                const convertedAmount = amount / exchangeRates[currency];
                const formatters = {
                    USD: new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0 }),
                    GBP: new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP', minimumFractionDigits: 0 }),
                    EUR: new Intl.NumberFormat('en-US', { style: 'currency', currency: 'EUR', minimumFractionDigits: 0 }) // Use en-US for consistent dot notation
                };
                return formatters[currency].format(convertedAmount);
            };

            const getNetReturn = (grossReturn, managementFee) => {
                return grossReturn - managementFee;
            };

            const calculateWeightedReturn = (allocations, timeHorizon = 20) => {
                let totalReturn = 0;
                let totalPercentage = 0;
                
                const availableTimeHorizons = [5, 10, 15, 20, 25, 30];
                const closestTimeHorizon = availableTimeHorizons.reduce((prev, curr) => 
                    Math.abs(curr - timeHorizon) < Math.abs(prev - timeHorizon) ? curr : prev
                );
                
                allocations.forEach(allocation => {
                    if (allocation.percentage > 0) {
                        const returnRate = allocation.customReturn !== null 
                            ? allocation.customReturn 
                            : (historicalReturns[closestTimeHorizon] && historicalReturns[closestTimeHorizon][allocation.index]) || 0;
                        
                        totalReturn += (returnRate * allocation.percentage / 100);
                        totalPercentage += allocation.percentage;
                    }
                });
                
                return totalPercentage > 0 ? totalReturn : 0;
            };

            const getAdjustedReturn = (baseReturn, riskLevel = inputs.riskTolerance) => {
                const riskMultiplier = riskScenarios[riskLevel]?.multiplier || 1.0;
                return baseReturn * riskMultiplier;
            };

            // Retirement calculation
            const calculateRetirement = () => {
                const yearsToRetirement = inputs.retirementAge - inputs.currentAge;
                
                if (yearsToRetirement <= 0) {
                    setResults(null);
                    return;
                }

                const basePensionWeightedReturn = calculateWeightedReturn(pensionIndexAllocation, yearsToRetirement);
                const baseTrainingFundWeightedReturn = calculateWeightedReturn(trainingFundIndexAllocation, yearsToRetirement);
                
                const pensionWeightedReturn = getAdjustedReturn(basePensionWeightedReturn);
                const trainingFundWeightedReturn = getAdjustedReturn(baseTrainingFundWeightedReturn);

                let totalPensionSavings = inputs.currentSavings;
                let totalTrainingFund = inputs.currentTrainingFund;
                let totalPersonalPortfolio = inputs.currentPersonalPortfolio;
                let totalCrypto = inputs.currentCrypto;
                let totalRealEstate = inputs.currentRealEstate;
                let periodResults = [];
                
                const sortedPeriods = [...workPeriods].sort((a, b) => a.startAge - b.startAge);
                
                for (const period of sortedPeriods) {
                    const country = countryData[period.country];
                    const periodYears = Math.max(0, Math.min(period.endAge, inputs.retirementAge) - Math.max(period.startAge, inputs.currentAge));
                    
                    if (periodYears > 0) {
                        const adjustedPensionReturn = getAdjustedReturn(period.pensionReturn);
                        const effectiveReturn = adjustedPensionReturn - period.pensionAnnualFee;
                        const monthlyReturn = effectiveReturn / 100 / 12;
                        const periodMonths = periodYears * 12;
                        
                        const existingGrowth = totalPensionSavings * Math.pow(1 + monthlyReturn, periodMonths);
                        
                        const netMonthlyContribution = period.monthlyContribution * (1 - period.pensionDepositFee / 100);
                        const contributionsValue = netMonthlyContribution * (Math.pow(1 + monthlyReturn, periodMonths) - 1) / monthlyReturn;
                        
                        const newTotal = existingGrowth + contributionsValue;
                        
                        periodResults.push({
                            country: period.country,
                            countryName: country.name,
                            flag: country.flag,
                            years: periodYears,
                            contributions: period.monthlyContribution * periodMonths,
                            netContributions: netMonthlyContribution * periodMonths,
                            growth: newTotal - totalPensionSavings,
                            pensionReturn: adjustedPensionReturn,
                            pensionDepositFee: period.pensionDepositFee,
                            pensionAnnualFee: period.pensionAnnualFee,
                            pensionEffectiveReturn: effectiveReturn,
                            monthlyTrainingFund: period.monthlyTrainingFund
                        });
                        
                        totalPensionSavings = newTotal;
                    }
                }

                const adjustedTrainingFundReturn = getAdjustedReturn(inputs.trainingFundReturn);
                const trainingFundNetReturn = adjustedTrainingFundReturn - inputs.trainingFundManagementFee;
                
                totalTrainingFund = totalTrainingFund * Math.pow(1 + trainingFundNetReturn / 100, yearsToRetirement);
                
                for (const period of sortedPeriods) {
                    const periodYears = Math.max(0, Math.min(period.endAge, inputs.retirementAge) - Math.max(period.startAge, inputs.currentAge));
                    if (periodYears > 0) {
                        const monthlyReturn = trainingFundNetReturn / 100 / 12;
                        const periodMonths = periodYears * 12;
                        const contributionsValue = period.monthlyTrainingFund * (Math.pow(1 + monthlyReturn, periodMonths) - 1) / monthlyReturn;
                        totalTrainingFund += contributionsValue;
                    }
                }

                // Calculate Personal Portfolio
                const adjustedPersonalPortfolioReturn = getAdjustedReturn(inputs.personalPortfolioReturn);
                const personalPortfolioMonthlyReturn = adjustedPersonalPortfolioReturn / 100 / 12;
                const personalPortfolioMonths = yearsToRetirement * 12;
                
                const personalPortfolioGrowth = totalPersonalPortfolio * Math.pow(1 + personalPortfolioMonthlyReturn, personalPortfolioMonths);
                const personalPortfolioContributions = inputs.personalPortfolioMonthly * (Math.pow(1 + personalPortfolioMonthlyReturn, personalPortfolioMonths) - 1) / personalPortfolioMonthlyReturn;
                totalPersonalPortfolio = personalPortfolioGrowth + personalPortfolioContributions;

                // Calculate Cryptocurrency
                const adjustedCryptoReturn = getAdjustedReturn(inputs.cryptoReturn);
                const cryptoMonthlyReturn = adjustedCryptoReturn / 100 / 12;
                const cryptoMonths = yearsToRetirement * 12;
                
                const cryptoGrowth = totalCrypto * Math.pow(1 + cryptoMonthlyReturn, cryptoMonths);
                const cryptoContributions = inputs.cryptoMonthly * (Math.pow(1 + cryptoMonthlyReturn, cryptoMonths) - 1) / cryptoMonthlyReturn;
                totalCrypto = cryptoGrowth + cryptoContributions;

                // Calculate Real Estate
                const adjustedRealEstateReturn = getAdjustedReturn(inputs.realEstateReturn);
                const realEstateMonthlyReturn = adjustedRealEstateReturn / 100 / 12;
                const realEstateMonths = yearsToRetirement * 12;
                
                const realEstateGrowth = totalRealEstate * Math.pow(1 + realEstateMonthlyReturn, realEstateMonths);
                const realEstateContributions = inputs.realEstateMonthly * (Math.pow(1 + realEstateMonthlyReturn, realEstateMonths) - 1) / realEstateMonthlyReturn;
                totalRealEstate = realEstateGrowth + realEstateContributions;

                // Calculate Real Estate Rental Income
                const realEstateRentalIncome = totalRealEstate * (inputs.realEstateRentalYield / 100) / 12;
                
                const monthlyPension = totalPensionSavings * 0.04 / 12;
                const monthlyTrainingFundIncome = totalTrainingFund * 0.05 / 12;
                
                // Calculate monthly income from new investment types
                const monthlyPersonalPortfolioIncome = totalPersonalPortfolio * 0.04 / 12;
                const monthlyCryptoIncome = totalCrypto * 0.04 / 12;
                const monthlyRealEstateIncome = totalRealEstate * 0.04 / 12; // Capital gains withdrawal
                
                // Apply taxes to new investment types
                const personalPortfolioTax = monthlyPersonalPortfolioIncome * (inputs.personalPortfolioTaxRate / 100);
                const cryptoTax = monthlyCryptoIncome * (inputs.cryptoTaxRate / 100);
                const realEstateTax = monthlyRealEstateIncome * (inputs.realEstateTaxRate / 100);
                
                const netPersonalPortfolioIncome = monthlyPersonalPortfolioIncome - personalPortfolioTax;
                const netCryptoIncome = monthlyCryptoIncome - cryptoTax;
                const netRealEstateIncome = monthlyRealEstateIncome - realEstateTax + realEstateRentalIncome;
                
                let weightedTaxRate = 0;
                let totalWeight = 0;
                
                for (const result of periodResults) {
                    const country = countryData[result.country];
                    weightedTaxRate += country.pensionTax * result.growth;
                    totalWeight += result.growth;
                }
                
                if (totalWeight > 0) {
                    weightedTaxRate = weightedTaxRate / totalWeight;
                } else {
                    weightedTaxRate = countryData[workPeriods[0].country].pensionTax;
                }
                
                const pensionTax = monthlyPension * weightedTaxRate;
                const netPension = monthlyPension - pensionTax;
                const netTrainingFundIncome = monthlyTrainingFundIncome;
                
                const lastCountry = countryData[sortedPeriods[sortedPeriods.length - 1].country];
                const socialSecurity = lastCountry.socialSecurity;
                const totalNetIncome = netPension + netTrainingFundIncome + socialSecurity + netPersonalPortfolioIncome + netCryptoIncome + netRealEstateIncome;

                const futureMonthlyExpenses = inputs.currentMonthlyExpenses * Math.pow(1 + inputs.inflationRate / 100, yearsToRetirement);
                const remainingAfterExpenses = totalNetIncome - futureMonthlyExpenses;

                const currentSalary = workPeriods.length > 0 ? workPeriods[workPeriods.length - 1].salary : 0;
                const futureTargetSalary = currentSalary * Math.pow(1 + inputs.inflationRate / 100, yearsToRetirement);
                const targetMonthlyIncome = (futureTargetSalary * inputs.targetReplacement) / 100;
                const achievesTarget = totalNetIncome >= targetMonthlyIncome;

                setResults({
                    totalSavings: Math.round(totalPensionSavings),
                    trainingFundValue: Math.round(totalTrainingFund),
                    personalPortfolioValue: Math.round(totalPersonalPortfolio),
                    cryptoValue: Math.round(totalCrypto),
                    realEstateValue: Math.round(totalRealEstate),
                    monthlyPension: Math.round(monthlyPension),
                    monthlyTrainingFundIncome: Math.round(monthlyTrainingFundIncome),
                    monthlyPersonalPortfolioIncome: Math.round(monthlyPersonalPortfolioIncome),
                    monthlyCryptoIncome: Math.round(monthlyCryptoIncome),
                    monthlyRealEstateIncome: Math.round(monthlyRealEstateIncome),
                    realEstateRentalIncome: Math.round(realEstateRentalIncome),
                    pensionTax: Math.round(pensionTax),
                    personalPortfolioTax: Math.round(personalPortfolioTax),
                    cryptoTax: Math.round(cryptoTax),
                    realEstateTax: Math.round(realEstateTax),
                    netPension: Math.round(netPension),
                    netTrainingFundIncome: Math.round(netTrainingFundIncome),
                    netPersonalPortfolioIncome: Math.round(netPersonalPortfolioIncome),
                    netCryptoIncome: Math.round(netCryptoIncome),
                    netRealEstateIncome: Math.round(netRealEstateIncome),
                    socialSecurity: socialSecurity,
                    totalNetIncome: Math.round(totalNetIncome),
                    periodResults,
                    lastCountry,
                    weightedTaxRate: Math.round(weightedTaxRate * 100),
                    inflationAdjustedIncome: Math.round(totalNetIncome / Math.pow(1 + inputs.inflationRate / 100, yearsToRetirement)),
                    trainingFundNetReturn: trainingFundNetReturn,
                    pensionWeightedReturn: pensionWeightedReturn,
                    trainingFundWeightedReturn: trainingFundWeightedReturn,
                    futureMonthlyExpenses: Math.round(futureMonthlyExpenses),
                    remainingAfterExpenses: Math.round(remainingAfterExpenses),
                    remainingAfterExpensesInflationAdjusted: Math.round(remainingAfterExpenses / Math.pow(1 + inputs.inflationRate / 100, yearsToRetirement)),
                    targetMonthlyIncome: Math.round(targetMonthlyIncome),
                    targetMonthlyIncomeInflationAdjusted: Math.round(targetMonthlyIncome / Math.pow(1 + inputs.inflationRate / 100, yearsToRetirement)),
                    achievesTarget: achievesTarget,
                    targetGap: Math.round(targetMonthlyIncome - totalNetIncome),
                    targetGapInflationAdjusted: Math.round((targetMonthlyIncome - totalNetIncome) / Math.pow(1 + inputs.inflationRate / 100, yearsToRetirement)),
                    riskLevel: inputs.riskTolerance,
                    riskMultiplier: riskScenarios[inputs.riskTolerance]?.multiplier || 1.0
                });
            };

            // Chart generation
            const generateChartData = () => {
                const yearsToRetirement = inputs.retirementAge - inputs.currentAge;
                
                if (yearsToRetirement <= 0) {
                    setChartData([]);
                    setShowChart(false);
                    return;
                }

                const basePensionWeightedReturn = calculateWeightedReturn(pensionIndexAllocation, yearsToRetirement);
                const baseTrainingFundWeightedReturn = calculateWeightedReturn(trainingFundIndexAllocation, yearsToRetirement);
                
                const pensionWeightedReturn = getAdjustedReturn(basePensionWeightedReturn);
                const trainingFundWeightedReturn = getAdjustedReturn(baseTrainingFundWeightedReturn);

                const chartPoints = [];
                let accumulatedPensionSavings = inputs.currentSavings;
                let accumulatedTrainingFund = inputs.currentTrainingFund;
                let accumulatedPersonalPortfolio = inputs.currentPersonalPortfolio;
                let accumulatedCrypto = inputs.currentCrypto;
                let accumulatedRealEstate = inputs.currentRealEstate;
                
                const totalInitialSavings = accumulatedPensionSavings + accumulatedTrainingFund + accumulatedPersonalPortfolio + accumulatedCrypto + accumulatedRealEstate;
                
                chartPoints.push({
                    year: inputs.currentAge,
                    age: inputs.currentAge,
                    pensionSavings: accumulatedPensionSavings,
                    trainingFund: accumulatedTrainingFund,
                    personalPortfolio: accumulatedPersonalPortfolio,
                    crypto: accumulatedCrypto,
                    realEstate: accumulatedRealEstate,
                    totalSavings: totalInitialSavings,
                    inflationAdjusted: totalInitialSavings,
                    yearLabel: `Age ${inputs.currentAge}`
                });

                for (let yearOffset = 1; yearOffset <= yearsToRetirement; yearOffset++) {
                    const currentAge = inputs.currentAge + yearOffset;
                    
                    const activePeriod = workPeriods.find(period => 
                        currentAge > period.startAge && currentAge <= period.endAge
                    );
                    
                    if (activePeriod) {
                        const adjustedPensionReturn = getAdjustedReturn(activePeriod.pensionReturn);
                        const pensionEffectiveReturn = adjustedPensionReturn - activePeriod.pensionAnnualFee;
                        const netMonthlyContribution = activePeriod.monthlyContribution * (1 - activePeriod.pensionDepositFee / 100);
                        accumulatedPensionSavings = accumulatedPensionSavings * (1 + pensionEffectiveReturn / 100) + (netMonthlyContribution * 12);
                        
                        const adjustedTrainingFundReturn = getAdjustedReturn(inputs.trainingFundReturn);
                        const trainingFundNetReturn = (adjustedTrainingFundReturn - inputs.trainingFundManagementFee) / 100;
                        accumulatedTrainingFund = accumulatedTrainingFund * (1 + trainingFundNetReturn) + (activePeriod.monthlyTrainingFund * 12);
                    } else {
                        const adjustedBasicReturn = getAdjustedReturn(3);
                        accumulatedPensionSavings = accumulatedPensionSavings * (1 + adjustedBasicReturn / 100);
                        const adjustedTrainingFundReturn = getAdjustedReturn(inputs.trainingFundReturn);
                        const trainingFundNetReturn = (adjustedTrainingFundReturn - inputs.trainingFundManagementFee) / 100;
                        accumulatedTrainingFund = accumulatedTrainingFund * (1 + trainingFundNetReturn);
                    }

                    // Update new investment types annually
                    const adjustedPersonalPortfolioReturn = getAdjustedReturn(inputs.personalPortfolioReturn);
                    accumulatedPersonalPortfolio = accumulatedPersonalPortfolio * (1 + adjustedPersonalPortfolioReturn / 100) + (inputs.personalPortfolioMonthly * 12);
                    
                    const adjustedCryptoReturn = getAdjustedReturn(inputs.cryptoReturn);
                    accumulatedCrypto = accumulatedCrypto * (1 + adjustedCryptoReturn / 100) + (inputs.cryptoMonthly * 12);
                    
                    const adjustedRealEstateReturn = getAdjustedReturn(inputs.realEstateReturn);
                    accumulatedRealEstate = accumulatedRealEstate * (1 + adjustedRealEstateReturn / 100) + (inputs.realEstateMonthly * 12);
                    
                    const totalSavings = accumulatedPensionSavings + accumulatedTrainingFund + accumulatedPersonalPortfolio + accumulatedCrypto + accumulatedRealEstate;
                    const inflationAdjustedValue = totalSavings / Math.pow(1 + inputs.inflationRate / 100, yearOffset);
                    
                    chartPoints.push({
                        year: currentAge,
                        age: currentAge,
                        pensionSavings: Math.round(accumulatedPensionSavings),
                        trainingFund: Math.round(accumulatedTrainingFund),
                        personalPortfolio: Math.round(accumulatedPersonalPortfolio),
                        crypto: Math.round(accumulatedCrypto),
                        realEstate: Math.round(accumulatedRealEstate),
                        totalSavings: Math.round(totalSavings),
                        inflationAdjusted: Math.round(inflationAdjustedValue),
                        yearLabel: `Age ${currentAge}`
                    });
                }

                setChartData(chartPoints);
                setShowChart(true);
            };

            // Update functions
            const addWorkPeriod = () => {
                const lastPeriod = workPeriods[workPeriods.length - 1];
                const newPeriod = {
                    id: Date.now(),
                    country: 'usa',
                    startAge: lastPeriod.endAge,
                    endAge: inputs.retirementAge,
                    monthlyContribution: 2000,
                    salary: 15000,
                    pensionReturn: 7.0,
                    pensionDepositFee: 0.5,
                    pensionAnnualFee: 0.8,
                    monthlyTrainingFund: 500
                };
                setWorkPeriods([...workPeriods, newPeriod]);
            };

            const removeWorkPeriod = (id) => {
                if (workPeriods.length > 1) {
                    setWorkPeriods(workPeriods.filter(period => period.id !== id));
                }
            };

            const updateWorkPeriod = (id, field, value) => {
                setWorkPeriods(workPeriods.map(period => 
                    period.id === id ? { ...period, [field]: value } : period
                ));
            };

            // Export retirement summary for sharing
            const exportRetirementSummary = async () => {
                try {
                    const summaryText = generateSummaryText();
                    
                    // Try to use Web Share API if available (mobile)
                    if (navigator.share) {
                        await navigator.share({
                            title: language === 'he' ? '×ª×›× ×™×ª ×”×¤× ×¡×™×” ×©×œ×™' : 'My Retirement Plan',
                            text: summaryText
                        });
                    } else {
                        // Fallback: Copy to clipboard
                        await navigator.clipboard.writeText(summaryText);
                        alert(language === 'he' 
                            ? '×”×¡×™×›×•× ×”×•×¢×ª×§ ×œ×œ×•×—! × ×™×ª×Ÿ ×œ×”×“×‘×™×§ ×‘×•×•××˜×¡××¤' 
                            : 'Summary copied to clipboard! You can paste it in WhatsApp');
                    }
                } catch (error) {
                    console.error('Export failed:', error);
                    // Final fallback: Show in alert for manual copy
                    const summaryText = generateSummaryText();
                    prompt(
                        language === 'he' 
                            ? '×”×¢×ª×§ ××ª ×”×˜×§×¡×˜ ×”×‘×:' 
                            : 'Copy the following text:', 
                        summaryText
                    );
                }
            };

            // Generate formatted summary text
            const generateSummaryText = () => {
                if (!results) return '';
                
                const title = language === 'he' 
                    ? 'ğŸ“Š ×ª×›× ×™×ª ×”×¤× ×¡×™×” ×©×œ×™ - ×¡×™×›×•×'
                    : 'ğŸ“Š My Retirement Plan - Summary';
                
                const totalAccumulation = results.totalSavings + results.trainingFundValue + 
                    results.personalPortfolioValue + results.cryptoValue + results.realEstateValue;
                
                const breakdown = language === 'he' 
                    ? `ğŸ’° ×¦×‘×™×¨×” ×¦×¤×•×™×”: ${formatCurrency(totalAccumulation)}
ğŸ“ˆ ×”×›× ×¡×” ×—×•×“×©×™×ª × ×˜×•: ${formatCurrency(results.totalNetIncome)}
ğŸ¯ ×™×¢×“ ×”×—×œ×¤×”: ${inputs.targetReplacement}% (${results.achievesTarget ? 'âœ… ××•×©×’' : 'âš ï¸ ×œ× ××•×©×’'})
ğŸ“Š ×™×ª×¨×” ×œ××—×¨ ×”×•×¦××•×ª: ${formatCurrency(results.remainingAfterExpenses)}`
                    : `ğŸ’° Expected Accumulation: ${formatCurrency(totalAccumulation)}
ğŸ“ˆ Net Monthly Income: ${formatCurrency(results.totalNetIncome)}
ğŸ¯ Replacement Target: ${inputs.targetReplacement}% (${results.achievesTarget ? 'âœ… Achieved' : 'âš ï¸ Not Achieved'})
ğŸ“Š Surplus After Expenses: ${formatCurrency(results.remainingAfterExpenses)}`;

                const insights = claudeInsights 
                    ? (language === 'he' ? '\nğŸ¤– ××¡×§× ×•×ª ×§×œ××•×“:\n' : '\nğŸ¤– Claude\'s Insights:\n') + 
                      claudeInsights.map(insight => `â€¢ ${insight}`).join('\n')
                    : '';
                
                const footer = language === 'he'
                    ? '\n\nğŸ“± × ×•×¦×¨ ×¢× ××ª×›× ×Ÿ ×”×¤× ×¡×™×” ×”××ª×§×“×'
                    : '\n\nğŸ“± Generated with Advanced Retirement Planner';
                
                return `${title}\n\n${breakdown}${insights}${footer}`;
            };

            // Export results as image
            const exportAsImage = async () => {
                try {
                    // Create a temporary canvas to draw the summary
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // Set canvas dimensions for mobile sharing
                    canvas.width = 800;
                    canvas.height = 1200;
                    
                    // Set background gradient
                    const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
                    gradient.addColorStop(0, '#667eea');
                    gradient.addColorStop(1, '#764ba2');
                    ctx.fillStyle = gradient;
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    
                    // Set text properties
                    ctx.textAlign = language === 'he' ? 'right' : 'left';
                    const margin = 40;
                    let y = margin + 40;
                    
                    // Title
                    ctx.fillStyle = '#ffffff';
                    ctx.font = 'bold 32px Arial';
                    const title = language === 'he' ? 'ğŸ“Š ×ª×›× ×™×ª ×”×¤× ×¡×™×” ×©×œ×™' : 'ğŸ“Š My Retirement Plan';
                    ctx.fillText(title, language === 'he' ? canvas.width - margin : margin, y);
                    y += 80;
                    
                    // White background for content
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.95)';
                    ctx.fillRect(margin, y - 20, canvas.width - (margin * 2), canvas.height - y - margin);
                    
                    // Content
                    ctx.fillStyle = '#1f2937';
                    ctx.font = 'bold 24px Arial';
                    
                    const totalAccumulation = results.totalSavings + results.trainingFundValue + 
                        results.personalPortfolioValue + results.cryptoValue + results.realEstateValue;
                    
                    const lines = [
                        language === 'he' ? `ğŸ’° ×¦×‘×™×¨×” ×¦×¤×•×™×”: ${formatCurrency(totalAccumulation)}` : `ğŸ’° Expected: ${formatCurrency(totalAccumulation)}`,
                        language === 'he' ? `ğŸ“ˆ ×”×›× ×¡×” ×—×•×“×©×™×ª: ${formatCurrency(results.totalNetIncome)}` : `ğŸ“ˆ Monthly Income: ${formatCurrency(results.totalNetIncome)}`,
                        language === 'he' ? `ğŸ¯ ×™×¢×“ ×”×—×œ×¤×”: ${inputs.targetReplacement}% ${results.achievesTarget ? 'âœ…' : 'âš ï¸'}` : `ğŸ¯ Target: ${inputs.targetReplacement}% ${results.achievesTarget ? 'âœ…' : 'âš ï¸'}`,
                        language === 'he' ? `ğŸ“Š ×™×ª×¨×”: ${formatCurrency(results.remainingAfterExpenses)}` : `ğŸ“Š Surplus: ${formatCurrency(results.remainingAfterExpenses)}`
                    ];
                    
                    lines.forEach(line => {
                        y += 50;
                        ctx.fillText(line, language === 'he' ? canvas.width - margin - 20 : margin + 20, y);
                    });
                    
                    // Add key insights
                    if (claudeInsights && claudeInsights.length > 0) {
                        y += 60;
                        ctx.fillStyle = '#4f46e5';
                        ctx.font = 'bold 20px Arial';
                        ctx.fillText(language === 'he' ? 'ğŸ¤– ××¡×§× ×•×ª ××¨×›×–×™×•×ª:' : 'ğŸ¤– Key Insights:', 
                            language === 'he' ? canvas.width - margin - 20 : margin + 20, y);
                        
                        ctx.fillStyle = '#1f2937';
                        ctx.font = '16px Arial';
                        
                        claudeInsights.slice(0, 3).forEach(insight => {
                            y += 40;
                            // Wrap long text
                            const maxWidth = canvas.width - (margin * 2) - 40;
                            const shortInsight = insight.length > 60 ? insight.substring(0, 60) + '...' : insight;
                            ctx.fillText(`â€¢ ${shortInsight}`, language === 'he' ? canvas.width - margin - 20 : margin + 20, y);
                        });
                    }
                    
                    // Footer
                    y = canvas.height - 60;
                    ctx.fillStyle = '#6b7280';
                    ctx.font = '14px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(language === 'he' ? '× ×•×¦×¨ ×¢× ××ª×›× ×Ÿ ×”×¤× ×¡×™×” ×”××ª×§×“×' : 'Generated with Advanced Retirement Planner', 
                        canvas.width / 2, y);
                    
                    // Convert to blob and download
                    canvas.toBlob(blob => {
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = language === 'he' ? '×ª×›× ×™×ª-×¤× ×¡×™×”.png' : 'retirement-plan.png';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                        
                        alert(language === 'he' ? 
                            '×”×ª××•× ×” × ×©××¨×”! × ×™×ª×Ÿ ×œ×©×œ×•×— ××•×ª×” ×‘×•×•××˜×¡××¤' : 
                            'Image saved! You can share it on WhatsApp');
                    }, 'image/png');
                    
                } catch (error) {
                    console.error('Image export failed:', error);
                    alert(language === 'he' ? 
                        '×©×’×™××” ×‘×™×¦×™×¨×ª ×”×ª××•× ×”. × ×¡×” ××ª ×©×™×ª×•×£ ×”×˜×§×¡×˜' : 
                        'Failed to create image. Try text sharing instead');
                }
            };

            // Generate Claude AI insights
            const generateClaudeInsights = () => {
                if (!results) {
                    setClaudeInsights(null);
                    return;
                }

                const insights = [];

                // Insight 1: Target achievement analysis
                if (results.achievesTarget) {
                    insights.push(
                        language === 'he' 
                            ? `ğŸ¯ ×ª×›× ×™×ª ×”×¤× ×¡×™×” ×©×œ×š × ×¨××™×ª ×—×–×§×”! ××ª×” ×¦×¤×•×™ ×œ×”×©×™×’ ${Math.round((results.totalNetIncome / (workPeriods[workPeriods.length - 1]?.salary || 1)) * 100)}% ×”×—×œ×¤×ª ×©×›×¨, ×©×–×” ××¢×œ ×”×™×¢×“ ×©×œ ${inputs.targetReplacement}%.`
                            : `ğŸ¯ Your retirement plan looks strong! You're projected to achieve ${Math.round((results.totalNetIncome / (workPeriods[workPeriods.length - 1]?.salary || 1)) * 100)}% salary replacement, which exceeds your ${inputs.targetReplacement}% target.`
                    );
                } else {
                    insights.push(
                        language === 'he' 
                            ? `âš ï¸ ×™×© ×¤×¢×¨ ×©×œ ${formatCurrency(results.targetGap)} (${formatCurrency(results.targetGapInflationAdjusted)} ×‘×›×•×— ×§× ×™×™×” ×©×œ ×”×™×•×) ××”×™×¢×“ ×”×—×•×“×©×™ ×©×œ×š. ×©×§×•×œ ×œ×”×’×“×™×œ ×”×¤×§×“×•×ª ××• ×œ×“×—×•×ª ××ª ×’×™×œ ×”×¤×¨×™×©×”.`
                            : `âš ï¸ There's a ${formatCurrency(results.targetGap)} (${formatCurrency(results.targetGapInflationAdjusted)} in today's purchasing power) monthly gap from your target. Consider increasing contributions or delaying retirement age.`
                    );
                }

                // Insight 2: Monthly surplus/deficit analysis
                if (results.remainingAfterExpenses >= 0) {
                    insights.push(
                        language === 'he' 
                            ? `ğŸ’° ××—×¨×™ ×›×™×¡×•×™ ×”×”×•×¦××•×ª ×”×¦×¤×•×™×•×ª, ×ª×™×©××¨ ×¢× ×¢×•×“×£ ×—×•×“×©×™ ×©×œ ${formatCurrency(results.remainingAfterExpenses)} (${formatCurrency(results.remainingAfterExpensesInflationAdjusted)} ×‘×›×•×— ×§× ×™×™×” ×©×œ ×”×™×•×), ×©×××¤×©×¨ ×’××™×©×•×ª ×¤×™× × ×¡×™×ª ×‘×™×˜×—×•×Ÿ × ×•×¡×£.`
                            : `ğŸ’° After covering expected expenses, you'll have a monthly surplus of ${formatCurrency(results.remainingAfterExpenses)} (${formatCurrency(results.remainingAfterExpensesInflationAdjusted)} in today's purchasing power), providing financial flexibility and extra security.`
                    );
                } else {
                    insights.push(
                        language === 'he' 
                            ? `ğŸ”´ ×”×”×•×¦××•×ª ×”×¦×¤×•×™×•×ª ×¢×•×œ×•×ª ×¢×œ ×”×”×›× ×¡×” ×”×¦×¤×•×™×” ×‘-${formatCurrency(Math.abs(results.remainingAfterExpenses))} (${formatCurrency(Math.abs(results.remainingAfterExpensesInflationAdjusted))} ×‘×›×•×— ×§× ×™×™×” ×©×œ ×”×™×•×) ×œ×—×•×“×©. ×—×©×•×‘ ×œ×ª×›× ×Ÿ ××—×“×©.`
                            : `ğŸ”´ Expected expenses exceed projected income by ${formatCurrency(Math.abs(results.remainingAfterExpenses))} (${formatCurrency(Math.abs(results.remainingAfterExpensesInflationAdjusted))} in today's purchasing power) monthly. Important to replan.`
                    );
                }

                // Insight 3: Inflation impact
                insights.push(
                    language === 'he' 
                        ? `ğŸ“Š ×”××™× ×¤×œ×¦×™×” ×ª×©×¤×™×¢ ××©××¢×•×ª×™×ª ×¢×œ ×›×•×— ×”×§× ×™×™×” - ×‘×›×¡×£ ×©×œ ×”×™×•×, ×”×¦×‘×™×¨×” ×©×œ×š ×ª×”×™×” ×©×•×•×” ${formatCurrency(results.inflationAdjustedIncome)} ×œ×—×•×“×©.`
                        : `ğŸ“Š Inflation will significantly impact purchasing power - in today's money, your accumulation will be worth ${formatCurrency(results.inflationAdjustedIncome)} monthly.`
                );

                // Insight 4: Portfolio diversification
                if (inputs.currentPersonalPortfolio > 0 || inputs.currentCrypto > 0 || inputs.currentRealEstate > 0) {
                    insights.push(
                        language === 'he' 
                            ? `ğŸŒŸ ×”×ª×™×§ ×”××’×•×•×Ÿ ×©×œ×š (×¤× ×¡×™×”, ×”×©×§×¢×•×ª ××™×©×™×•×ª, ×§×¨×™×¤×˜×• ×•× ×“×œ"×Ÿ) ××¡×¤×§ ×¤×™×–×•×¨ ×¡×™×›×•× ×™× ×˜×•×‘ ×•×¤×•×˜× ×¦×™××œ ×œ×ª×©×•××•×ª ×’×‘×•×”×•×ª ×™×•×ª×¨.`
                            : `ğŸŒŸ Your diversified portfolio (pension, personal investments, crypto, and real estate) provides good risk diversification and potential for higher returns.`
                    );
                } else {
                    insights.push(
                        language === 'he' 
                            ? `ğŸ’¡ ×©×§×•×œ ×œ×”×•×¡×™×£ ×”×©×§×¢×•×ª × ×•×¡×¤×•×ª ×›××• ×ª×™×§ ×× ×™×•×ª ××™×©×™ ××• × ×“×œ"×Ÿ ×œ×¤×™×–×•×¨ ×¡×™×›×•× ×™× ×•×¤×•×˜× ×¦×™××œ ×ª×©×•××” ×’×‘×•×” ×™×•×ª×¨.`
                            : `ğŸ’¡ Consider adding additional investments like personal stocks or real estate for risk diversification and higher return potential.`
                    );
                }

                // Insight 5: Final recommendation
                insights.push(
                    language === 'he' 
                        ? `ğŸ“ ×”××œ×¦×”: ×‘×“×•×§ ××ª ×”×ª×›× ×™×ª ××—×ª ×œ×©× ×”, ×”×ª×× ×œ×©×™× ×•×™×™× ×‘×©×›×¨ ×•×‘××˜×¨×•×ª, ×•×©××•×¨ ×¢×œ ×ª×›× ×•×Ÿ ×©××¨× ×™ ××š ××•×¤×˜×™××œ×™.`
                        : `ğŸ“ Recommendation: Review your plan annually, adjust for salary and goal changes, and maintain conservative yet optimal planning.`
                );

                setClaudeInsights(insights);
            };

            // Initialize analytics on component mount
            useEffect(() => {
                const sessionId = AnalyticsManager.trackVisitor(language);
                console.log('Analytics session started:', sessionId);
                
                // Track page load
                AnalyticsManager.trackAction('page_load', { 
                    language,
                    timestamp: new Date().toISOString()
                });

                // Cleanup on unmount
                return () => {
                    AnalyticsManager.endSession();
                };
            }, []);

            // Track language changes
            useEffect(() => {
                AnalyticsManager.trackAction('language_change', { 
                    newLanguage: language,
                    timestamp: new Date().toISOString()
                });
            }, [language]);

            // Auto calculation
            useEffect(() => {
                calculateRetirement();
            }, [inputs, workPeriods, pensionIndexAllocation, trainingFundIndexAllocation]);

            // Track retirement conclusions when results change
            useEffect(() => {
                if (results) {
                    const conclusion = AnalyticsManager.trackConclusion(results, inputs, workPeriods, language);
                    console.log('Retirement conclusion tracked:', conclusion);
                }
            }, [results]);

            // Update Claude insights when results or language change
            useEffect(() => {
                generateClaudeInsights();
            }, [results, language]);

            useEffect(() => {
                if (showChart) {
                    generateChartData();
                }
            }, [inputs, workPeriods, showChart, pensionIndexAllocation, trainingFundIndexAllocation]);

            // Stress Testing Functions
            const runStressTest = (scenarioType) => {
                console.log('runStressTest called with:', scenarioType);
                console.log('results state:', results);
                console.log('language state:', language);
                
                if (!results) {
                    console.log('No results found, showing alert');
                    alert(language === 'he' ? '×™×© ×œ×—×©×‘ ×ª×›× ×™×ª ×¤×¨×™×©×” ×ª×—×™×œ×”' : 'Please calculate retirement plan first');
                    return;
                }

                // Track stress test action
                AnalyticsManager.trackAction('stress_test_run', { 
                    scenarioType,
                    userAge: inputs.currentAge,
                    timestamp: new Date().toISOString()
                });

                const scenarios = {
                    financial_crisis_2008: {
                        name: language === 'he' ? "××©×‘×¨ ×¤×™× × ×¡×™ 2008" : "2008 Financial Crisis",
                        description: language === 'he' 
                            ? "×™×¨×™×“×” ×©×œ 40% ×‘×× ×™×•×ª, 30% ×‘× ×“×œ×´×Ÿ, ×¢×œ×™×™×” ×‘××‘×˜×œ×” ×•×ª×©×•××•×ª × ××•×›×•×ª ×œ××©×š 3 ×©× ×™×"
                            : "40% stock decline, 30% real estate decline, unemployment rise, low returns for 3 years",
                        incomeReduction: 15,
                        portfolioDecline: 40,
                        realEstateDecline: 30,
                        inflationIncrease: 1,
                        duration: 3,
                        recoveryYears: 5
                    },
                    covid_pandemic: {
                        name: language === 'he' ? "××©×‘×¨ ×§×•×¨×•× ×” 2020" : "COVID-19 Pandemic 2020",
                        description: language === 'he' 
                            ? "×™×¨×™×“×ª ×”×›× ×¡×” ×©×œ 25%, ×ª× ×•×“×ª×™×•×ª ×’×‘×•×”×”, ×¢×œ×™×™×” ×‘×”×•×¦××•×ª ×¨×¤×•××™×•×ª ×•×”×ª××•×©×©×•×ª ×‘××©×š ×©× ×ª×™×™×"
                            : "25% income reduction, high volatility, increased medical expenses, recovery over two years",
                        incomeReduction: 25,
                        portfolioDecline: 25,
                        realEstateDecline: 10,
                        inflationIncrease: 3,
                        duration: 2,
                        recoveryYears: 3
                    },
                    high_inflation: {
                        name: language === 'he' ? "××™× ×¤×œ×¦×™×” ×’×‘×•×”×”" : "High Inflation Scenario",
                        description: language === 'he' 
                            ? "××™× ×¤×œ×¦×™×” ×©×œ 15% ×œ×©× ×”, ×¢×œ×™×™×ª ××—×™×¨×™ ××–×•×Ÿ ×•×“×œ×§, ×™×¨×™×“×” ×‘×›×•×— ×”×§× ×™×™×” ×œ××©×š 5 ×©× ×™×"
                            : "15% annual inflation, rising food & fuel prices, decreased purchasing power for 5 years",
                        incomeReduction: 5,
                        portfolioDecline: 15,
                        realEstateDecline: 5,
                        inflationIncrease: 12,
                        duration: 5,
                        recoveryYears: 7
                    }
                };

                console.log('Available scenarios:', Object.keys(scenarios));
                const scenario = {...scenarios[scenarioType], name: scenarioType};
                
                if (!scenario || !scenarios[scenarioType]) {
                    console.error('Unknown scenario type:', scenarioType);
                    console.error('Available scenarios:', Object.keys(scenarios));
                    alert(language === 'he' ? '×©×’×™××”: ×ª×¨×—×™×© ×œ× ××•×›×¨' : 'Error: Unknown scenario');
                    return;
                }

                console.log('Selected scenario:', scenario);
                console.log('Calling calculateStressedResults...');
                const stressedResults = calculateStressedResults(scenario);
                console.log('Stressed results:', stressedResults);
                
                console.log('Generating recommendations...');
                const recommendations = generateStressTestRecommendations(scenario, stressedResults);
                console.log('Recommendations:', recommendations);

                console.log('Setting stress test results...');
                const normalAccumulation = results.totalSavings + results.trainingFundValue + results.personalPortfolioValue + results.cryptoValue + results.realEstateValue;
                
                const stressTestData = {
                    scenarioName: scenario.name,
                    scenarioDescription: scenario.description,
                    scenario: scenario, // Store the full scenario object
                    normal: {
                        monthlyIncome: results.totalNetIncome,
                        totalAccumulation: normalAccumulation,
                        achievesTarget: results.achievesTarget
                    },
                    stressed: stressedResults,
                    recoveryYears: scenario.recoveryYears,
                    recommendations
                };
                
                console.log('Stress test data to set:', stressTestData);
                setStressTestResults(stressTestData);

                // Scroll to results
                setTimeout(() => {
                    console.log('Attempting to scroll to results...');
                    const resultsElement = document.querySelector('#stress-test-results');
                    console.log('Results element found:', !!resultsElement);
                    if (resultsElement) {
                        resultsElement.scrollIntoView({ behavior: 'smooth' });
                        console.log('Scrolled to results');
                    }
                }, 100);
                
                console.log('runStressTest completed successfully');
            };

            const runCustomStressTest = () => {
                if (!results) {
                    alert(language === 'he' ? '×™×© ×œ×—×©×‘ ×ª×›× ×™×ª ×¤×¨×™×©×” ×ª×—×™×œ×”' : 'Please calculate retirement plan first');
                    return;
                }

                // Input validation with bounds checking
                const incomeReduction = Math.max(0, Math.min(80, parseFloat(document.getElementById('custom-income-reduction')?.value || 20)));
                const portfolioDecline = Math.max(0, Math.min(90, parseFloat(document.getElementById('custom-portfolio-decline')?.value || 30)));
                const inflationIncrease = Math.max(0, Math.min(50, parseFloat(document.getElementById('custom-inflation-increase')?.value || 8)));
                const duration = Math.max(1, Math.min(15, parseFloat(document.getElementById('custom-crisis-duration')?.value || 3)));

                // Track custom stress test
                AnalyticsManager.trackAction('custom_stress_test', { 
                    incomeReduction,
                    portfolioDecline,
                    inflationIncrease,
                    duration,
                    userAge: inputs.currentAge
                });

                const customScenario = {
                    name: language === 'he' ? "×ª×¨×—×™×© ××•×ª×× ××™×©×™×ª" : "Custom Scenario",
                    description: language === 'he' 
                        ? `×™×¨×™×“×ª ×”×›× ×¡×” ×©×œ ${incomeReduction}%, ×™×¨×™×“×” ×‘×ª×™×§ ×”×©×§×¢×•×ª ×©×œ ${portfolioDecline}%, ×¢×œ×™×™×” ×‘××™× ×¤×œ×¦×™×” ×©×œ ${inflationIncrease}% ×œ××©×š ${duration} ×©× ×™×`
                        : `${incomeReduction}% income reduction, ${portfolioDecline}% portfolio decline, ${inflationIncrease}% inflation increase for ${duration} years`,
                    incomeReduction,
                    portfolioDecline,
                    realEstateDecline: portfolioDecline * 0.7,
                    inflationIncrease,
                    duration,
                    recoveryYears: Math.ceil(duration * 1.5)
                };

                const stressedResults = calculateStressedResults({...customScenario, name: 'custom'});
                const recommendations = generateStressTestRecommendations(customScenario, stressedResults);

                setStressTestResults({
                    scenarioName: customScenario.name,
                    scenarioDescription: customScenario.description,
                    scenario: customScenario, // Store the full scenario object
                    normal: {
                        monthlyIncome: results.totalNetIncome,
                        totalAccumulation: results.totalSavings + results.trainingFundValue + results.personalPortfolioValue + results.cryptoValue + results.realEstateValue,
                        achievesTarget: results.achievesTarget
                    },
                    stressed: stressedResults,
                    recoveryYears: customScenario.recoveryYears,
                    recommendations
                });
            };

            const generateAIScenario = () => {
                // Track AI scenario generation
                AnalyticsManager.trackAction('ai_scenario_generation', { 
                    userAge: inputs.currentAge,
                    riskTolerance: inputs.riskTolerance,
                    hasEmergencyFund: inputs.currentEmergencyFund > 0
                });

                // Generate AI-powered scenario based on user profile
                const userProfile = {
                    age: inputs.currentAge,
                    yearsToRetirement: inputs.retirementAge - inputs.currentAge,
                    riskTolerance: inputs.riskTolerance,
                    hasEmergencyFund: inputs.currentEmergencyFund > 0,
                    savingsRate: calculateUserSavingsRate(),
                    diversification: calculateDiversificationScore()
                };

                const aiScenario = generateAIBasedScenario(userProfile);
                
                // Show AI scenario in custom fields
                document.getElementById('custom-income-reduction').value = aiScenario.incomeReduction;
                document.getElementById('custom-portfolio-decline').value = aiScenario.portfolioDecline;
                document.getElementById('custom-inflation-increase').value = aiScenario.inflationIncrease;
                document.getElementById('custom-crisis-duration').value = aiScenario.duration;

                alert(language === 'he' 
                    ? `×ª×¨×—×™×© AI × ×•×¦×¨: ${aiScenario.description}`
                    : `AI Scenario Created: ${aiScenario.description}`);
            };

            const calculateStressedResults = (scenario) => {
                try {
                    console.log('Calculating stressed results with scenario:', scenario);
                    
                    // Validate inputs
                    if (!scenario || typeof scenario !== 'object') {
                        throw new Error('Invalid scenario provided');
                    }
                    
                    if (!inputs || !workPeriods || workPeriods.length === 0) {
                        throw new Error('Invalid inputs or work periods');
                    }
                    
                    // **××¦×™××•×ª×™×•×ª ×‘××‘×—×Ÿ ×¢××™×“×•×ª - ×’×™×©×” ×¤×©×•×˜×” ×™×•×ª×¨**
                    
                    // Use global safe value function
                
                // 1. ×”×©×¤×¢×” ×™×©×™×¨×” ×¢×œ ×”×›× ×¡×•×ª (×¨×§ ×‘××©×š ×ª×§×•×¤×ª ×”××©×‘×¨)
                const incomeReduction = Math.min(80, Math.max(0, safeValue(scenario.incomeReduction || 0))) / 100;
                const portfolioDecline = Math.min(90, Math.max(0, safeValue(scenario.portfolioDecline || 0))) / 100;
                
                const stressedWorkPeriods = workPeriods.map(period => ({
                    ...period,
                    salary: safeValue(period.salary || 0) * (1 - incomeReduction),
                    monthlyContribution: safeValue(period.monthlyContribution || 0) * (1 - incomeReduction),
                    monthlyTrainingFund: safeValue(period.monthlyTrainingFund || 0) * (1 - incomeReduction)
                }));

                // 2. ×”×©×¤×¢×” ×—×“-×¤×¢××™×ª ×¢×œ ×¦×‘×™×¨×” ×§×™×™××ª (×™×¨×™×“×” ×‘×©×•×§)
                const currentSavingsAfterCrash = safeValue(inputs.currentSavings || 0) * (1 - portfolioDecline);
                const currentPersonalPortfolioAfterCrash = safeValue(inputs.currentPersonalPortfolio || 0) * (1 - portfolioDecline);
                const currentCryptoAfterCrash = safeValue(inputs.currentCrypto || 0) * (1 - portfolioDecline);
                const realEstateDecline = Math.min(portfolioDecline, portfolioDecline * 0.6); // × ×“×œ"×Ÿ ×¤×—×•×ª ×ª× ×•×“×ª×™
                const currentRealEstateAfterCrash = safeValue(inputs.currentRealEstate || 0) * (1 - realEstateDecline);
                const currentTrainingFundAfterCrash = safeValue(inputs.currentTrainingFund || 0) * (1 - portfolioDecline);

                console.log(`Portfolio impact: ${scenario.portfolioDecline}% decline`);
                console.log(`Income impact: ${scenario.incomeReduction}% reduction for ${scenario.duration} years`);
                console.log(`Inflation impact: +${scenario.inflationIncrease}% for calculation period`);

                // 3. ×—×™×©×•×‘ ×¤×©×•×˜ - ×¨×•×‘ ×©× ×•×ª ×”×¤×¨×™×©×” ×œ×œ× ××©×‘×¨
                const yearsToRetirement = inputs.retirementAge - inputs.currentAge;
                if (yearsToRetirement <= 0) {
                    return { monthlyIncome: 0, totalAccumulation: 0, achievesTarget: false };
                }

                // 4. ×—×™×©×•×‘ ×¦×‘×™×¨×” ×¤×©×•×˜ ×‘×©× ×™ ×©×œ×‘×™×:
                // ×©×œ×‘ 1: ×©× ×•×ª ×”××©×‘×¨ (×”×¤×§×“×•×ª ××•×¤×—×ª×•×ª, ×ª×©×•××•×ª × ××•×›×•×ª)
                // ×©×œ×‘ 2: ×©× ×•×ª ×”×”×ª××•×©×©×•×ª (×—×–×¨×” ×œ× ×•×¨××œ×™)

                let totalPensionSavings = currentSavingsAfterCrash;
                let totalTrainingFund = currentTrainingFundAfterCrash;
                let totalPersonalPortfolio = currentPersonalPortfolioAfterCrash;
                let totalCrypto = currentCryptoAfterCrash;
                let totalRealEstate = currentRealEstateAfterCrash;

                // ×©× ×•×ª ×”××©×‘×¨ (×ª×©×•××•×ª × ××•×›×•×ª, ×”×¤×§×“×•×ª ××•×¤×—×ª×•×ª)
                const crisisYears = Math.min(scenario.duration, yearsToRetirement);
                for (let year = 0; year < crisisYears; year++) {
                    const currentAge = inputs.currentAge + year;
                    const activePeriod = stressedWorkPeriods.find(period => 
                        currentAge >= period.startAge && currentAge < period.endAge
                    );

                    if (activePeriod) {
                        // ×ª×©×•××•×ª ××•×¤×—×ª×•×ª ×‘××”×œ×š ×”××©×‘×¨ (×œ× ×“×¨××˜×™×•×ª)
                        const pensionCrisisReturn = Math.max((activePeriod.pensionReturn || 6) - 3, 1); // 3% ×¤×—×•×ª ××”×¨×’×™×œ
                        const netReturn = (pensionCrisisReturn - (activePeriod.pensionAnnualFee || 0)) / 100;
                        const netContribution = (activePeriod.monthlyContribution || 0) * (1 - (activePeriod.pensionDepositFee || 0) / 100);
                        
                        totalPensionSavings = totalPensionSavings * (1 + netReturn) + (netContribution * 12);
                        
                        // ×§×¨×Ÿ ×”×©×ª×œ××•×ª - ×’× ×¤×—×•×ª ×ª×©×•××”
                        const trainingCrisisReturn = Math.max((inputs.trainingFundReturn || 6) - 2, 1); // 2% ×¤×—×•×ª
                        const trainingNetReturn = (trainingCrisisReturn - (inputs.trainingFundManagementFee || 0)) / 100;
                        totalTrainingFund = totalTrainingFund * (1 + trainingNetReturn) + ((activePeriod.monthlyTrainingFund || 0) * 12);
                    } else {
                        // ×× ××™×Ÿ ×ª×§×•×¤×ª ×¢×‘×•×“×” ×¤×¢×™×œ×”, ×¨×§ ×¦××™×—×” ×©×œ ×”×›×¡×¤×™× ×”×§×™×™××™×
                        const defaultReturn = Math.max(6 - 3, 1); // 3% ×ª×©×•××” ×‘×¨×™×¨×ª ××—×“×œ ×‘××©×‘×¨
                        totalPensionSavings = totalPensionSavings * (1 + defaultReturn / 100);
                        totalTrainingFund = totalTrainingFund * (1 + defaultReturn / 100);
                    }

                    // ×”×©×§×¢×•×ª ××™×©×™×•×ª - ×”×¤×§×“×•×ª ××•×¤×—×ª×•×ª, ×ª×©×•××•×ª × ××•×›×•×ª ×™×•×ª×¨
                    const personalCrisisReturn = Math.max(inputs.personalPortfolioReturn - 4, 0); // 4% ×¤×—×•×ª
                    const cryptoCrisisReturn = Math.max(inputs.cryptoReturn - 8, -5); // ×™×•×ª×¨ ×ª× ×•×“×ª×™
                    const realEstateCrisisReturn = Math.max(inputs.realEstateReturn - 2, 1); // ×¤×—×•×ª ××•×©×¤×¢

                    totalPersonalPortfolio = totalPersonalPortfolio * (1 + personalCrisisReturn / 100) + 
                        (inputs.personalPortfolioMonthly * (1 - scenario.incomeReduction / 100) * 12);
                    
                    totalCrypto = totalCrypto * (1 + cryptoCrisisReturn / 100) + 
                        (inputs.cryptoMonthly * (1 - scenario.incomeReduction / 100) * 12);
                    
                    totalRealEstate = totalRealEstate * (1 + realEstateCrisisReturn / 100) + 
                        (inputs.realEstateMonthly * (1 - scenario.incomeReduction / 100) * 12);
                }

                // ×©× ×•×ª ×”×”×ª××•×©×©×•×ª (×—×–×¨×” ×œ×ª×©×•××•×ª ×¨×’×™×œ×•×ª)
                const recoveryYears = yearsToRetirement - crisisYears;
                for (let year = 0; year < recoveryYears; year++) {
                    const currentAge = inputs.currentAge + crisisYears + year;
                    const activePeriod = workPeriods.find(period => 
                        currentAge >= period.startAge && currentAge < period.endAge
                    );

                    if (activePeriod) {
                        // ×—×–×¨×” ×œ×ª×©×•××•×ª ×¨×’×™×œ×•×ª
                        const pensionReturn = activePeriod.pensionReturn || 6;
                        const netReturn = (pensionReturn - activePeriod.pensionAnnualFee) / 100;
                        const netContribution = activePeriod.monthlyContribution * (1 - activePeriod.pensionDepositFee / 100);
                        
                        totalPensionSavings = totalPensionSavings * (1 + netReturn) + (netContribution * 12);
                        
                        const trainingNetReturn = (inputs.trainingFundReturn - inputs.trainingFundManagementFee) / 100;
                        totalTrainingFund = totalTrainingFund * (1 + trainingNetReturn) + (activePeriod.monthlyTrainingFund * 12);
                    }

                    // ×”×©×§×¢×•×ª ××™×©×™×•×ª ×—×•×–×¨×•×ª ×œ×¨×’×™×œ
                    totalPersonalPortfolio = totalPersonalPortfolio * (1 + inputs.personalPortfolioReturn / 100) + 
                        (inputs.personalPortfolioMonthly * 12);
                    
                    totalCrypto = totalCrypto * (1 + inputs.cryptoReturn / 100) + 
                        (inputs.cryptoMonthly * 12);
                    
                    totalRealEstate = totalRealEstate * (1 + inputs.realEstateReturn / 100) + 
                        (inputs.realEstateMonthly * 12);
                }

                // ×—×™×©×•×‘ ×”×›× ×¡×” ×—×•×“×©×™×ª (×¨×’×™×œ) - ×¢× ×”×’× ×” ××¤× ×™ ×¢×¨×›×™× ×œ× ×ª×§×™× ×™×
                
                const monthlyPension = safeValue(totalPensionSavings * 0.045) / 12;
                const monthlyTrainingFund = safeValue(totalTrainingFund * 0.045) / 12;
                const monthlyPersonalPortfolio = safeValue(totalPersonalPortfolio * 0.04) / 12;
                const monthlyCrypto = safeValue(totalCrypto * 0.04) / 12;
                const monthlyRealEstate = safeValue(totalRealEstate * 0.04) / 12;

                // ××™×¡×™× (××¢×˜ ×’×‘×•×”×™× ×™×•×ª×¨ ×‘×’×œ×œ ××™× ×¤×œ×¦×™×”) - ×¢× ×”×’× ×” ××¤× ×™ ×¢×¨×›×™× ×œ× ×ª×§×™× ×™×
                const safeInflationIncrease = safeValue(scenario?.inflationIncrease || 0);
                const inflationTaxMultiplier = 1 + (safeInflationIncrease / 100) * 0.3; // ×”×©×¤×¢×” ××ª×•× ×”
                const pensionTax = safeValue(monthlyPension * 0.15 * inflationTaxMultiplier);
                const personalTax = safeValue(monthlyPersonalPortfolio * (safeValue(inputs.personalPortfolioTaxRate) / 100) * inflationTaxMultiplier);
                const cryptoTax = safeValue(monthlyCrypto * (safeValue(inputs.cryptoTaxRate) / 100) * inflationTaxMultiplier);
                const realEstateTax = safeValue(monthlyRealEstate * (safeValue(inputs.realEstateTaxRate) / 100) * inflationTaxMultiplier);

                const totalMonthlyIncome = safeValue(
                    Math.max(0, monthlyPension - pensionTax) +
                    monthlyTrainingFund +
                    Math.max(0, monthlyPersonalPortfolio - personalTax) +
                    Math.max(0, monthlyCrypto - cryptoTax) +
                    Math.max(0, monthlyRealEstate - realEstateTax)
                );

                const totalAccumulation = safeValue(totalPensionSavings + totalTrainingFund + totalPersonalPortfolio + totalCrypto + totalRealEstate);
                
                // ×‘×“×™×§×ª ×™×¢×“ (×¢× ××™× ×¤×œ×¦×™×” ××•×’×‘×¨×ª)
                const currentSalary = safeValue(workPeriods[workPeriods.length - 1]?.salary || 0);
                const adjustedInflationRate = safeValue(inputs.inflationRate || 0) + safeInflationIncrease;
                const futureTargetSalary = currentSalary * Math.pow(1 + Math.max(0, adjustedInflationRate) / 100, Math.max(0, yearsToRetirement));
                const targetMonthlyIncome = safeValue((futureTargetSalary * safeValue(inputs.targetReplacement || 75)) / 100);
                const achievesTarget = totalMonthlyIncome >= targetMonthlyIncome;

                const result = {
                    monthlyIncome: Math.round(safeValue(totalMonthlyIncome)),
                    totalAccumulation: Math.round(safeValue(totalAccumulation)),
                    achievesTarget: Boolean(achievesTarget)
                };

                console.log('Crisis impact calculation:');
                console.log('- Portfolio decline:', `${scenario.portfolioDecline}% immediate loss`);
                console.log('- Income reduction:', `${scenario.incomeReduction}% for ${scenario.duration} years`);
                console.log('- Inflation increase:', `+${scenario.inflationIncrease}% affects target calculation`);
                console.log('Final stressed results:', result);
                
                return result;
                
                } catch (error) {
                    console.error('Error in calculateStressedResults:', error);
                    // Return safe default results based on current inputs
                    const fallbackIncome = safeValue(inputs?.currentSavings || 0) * 0.045 / 12 * 0.7; // Estimate based on current savings
                    const fallbackAccumulation = safeValue(inputs?.currentSavings || 0) * 0.8;
                    
                    return {
                        monthlyIncome: Math.round(fallbackIncome),
                        totalAccumulation: Math.round(fallbackAccumulation),
                        achievesTarget: false
                    };
                }
            };

            // Generate dynamic crisis explanations based on scenario parameters
            const generateDynamicCrisisExplanation = (scenario, inputs, language) => {
                const yearsToRetirement = inputs.retirementAge - inputs.currentAge;
                const recoveryYears = Math.max(0, yearsToRetirement - (scenario?.duration || 0));
                
                // Crisis severity classification
                const getSeverity = (portfolioDecline) => {
                    if (portfolioDecline >= 40) return language === 'he' ? '××©×‘×¨ ×§×©×”' : 'severe crisis';
                    if (portfolioDecline >= 25) return language === 'he' ? '××©×‘×¨ ×‘×™× ×•× ×™' : 'moderate crisis';
                    return language === 'he' ? '××©×‘×¨ ×§×œ' : 'mild crisis';
                };

                // Duration description
                const getDurationDescription = (duration) => {
                    if (duration <= 1) return language === 'he' ? '×§×¦×¨ ××•×¢×“' : 'short-term';
                    if (duration <= 3) return language === 'he' ? '×‘×™× ×•× ×™' : 'medium-term';
                    return language === 'he' ? '×××•×©×š' : 'long-term';
                };

                const explanations = {
                    methodology: [
                        {
                            phase: language === 'he' ? "×©×œ×‘ ×¨××©×•×Ÿ - ×”×©×¤×¢×” ××™×™×“×™×ª:" : "Phase 1 - Immediate Impact:",
                            description: language === 'he' 
                                ? `×™×¨×™×“×” ×—×“-×¤×¢××™×ª ×©×œ ${scenario?.portfolioDecline || 0}% ×‘×¦×‘×™×¨×” ×”×§×™×™××ª (${getSeverity(scenario?.portfolioDecline || 0)}, ${getDurationDescription(scenario?.duration || 0)})`
                                : `One-time ${scenario?.portfolioDecline || 0}% decline in existing accumulation (${getSeverity(scenario?.portfolioDecline || 0)}, ${getDurationDescription(scenario?.duration || 0)})`
                        },
                        {
                            phase: language === 'he' ? "×©×œ×‘ ×©× ×™ - ×©× ×•×ª ×”××©×‘×¨:" : "Phase 2 - Crisis Years:",
                            description: language === 'he' 
                                ? `×‘××©×š ${scenario?.duration || 0} ×©× ×™×: ×ª×©×•××•×ª ××•×¤×—×ª×•×ª ×‘-3-4%, ×”×¤×§×“×•×ª ××•×¤×—×ª×•×ª ×‘-${scenario?.incomeReduction || 0}%${scenario?.inflationIncrease > 0 ? `, ××™× ×¤×œ×¦×™×” ××•×’×‘×¨×ª ×‘-${scenario.inflationIncrease}%` : ''}`
                                : `For ${scenario?.duration || 0} years: 3-4% reduced returns, ${scenario?.incomeReduction || 0}% reduced contributions${scenario?.inflationIncrease > 0 ? `, +${scenario.inflationIncrease}% inflation` : ''}`
                        },
                        {
                            phase: language === 'he' ? "×©×œ×‘ ×©×œ×™×©×™ - ×”×ª××•×©×©×•×ª:" : "Phase 3 - Recovery:",
                            description: language === 'he' 
                                ? `×”×©× ×™× ×”× ×•×ª×¨×•×ª (${recoveryYears} ×©× ×™×): ×—×–×¨×” ×œ×ª×©×•××•×ª ×•×ª×¨×•××•×ª ×¨×’×™×œ×•×ª`
                                : `Remaining years (${recoveryYears} years): return to normal returns and contributions`
                        }
                    ],
                    historicalContext: getHistoricalContext(scenario, language)
                };

                return explanations;
            };

            // Generate historical context based on scenario type
            const getHistoricalContext = (scenario, language) => {
                if (!scenario?.name) {
                    return language === 'he' ? 
                        "×”×ª×¨×—×™×© ×©×‘×“×§×ª× ××‘×•×¡×¡ ×¢×œ ×¤×¨××˜×¨×™× ×›×œ×›×œ×™×™× ××¦×™××•×ª×™×™× ×•×œ×•×§×— ×‘×—×©×‘×•×Ÿ ×“×¤×•×¡×™ ×”×ª××•×©×©×•×ª ×”×™×¡×˜×•×¨×™×™× ×©×œ ×”×©×•×•×§×™× ×•×”×›×œ×›×œ×”." :
                        "The scenario you tested is based on realistic economic parameters and takes into account historical recovery patterns of markets and the economy.";
                }

                const contextMap = {
                    'financial_crisis_2008': language === 'he' ? 
                        "××©×‘×¨ 2008 ×”×—×œ ×¢× ×§×¨×™×¡×ª ×‘× ×§ ×œ×™×”××Ÿ ×‘×¨×“×¨×¡, ×”×•×‘×™×œ ×œ×™×¨×™×“×” ×©×œ 57% ×‘-S&P 500, ×¢×œ×™×™×” ×‘××‘×˜×œ×” ×œ-10%, ×•××™×œ×¥ ×‘× ×§×™× ××¨×›×–×™×™× ×œ×”×•×¨×™×“ ×¨×™×‘×™×ª ×›××¢×˜ ×œ××¤×¡. ×”×”×ª××•×©×©×•×ª ××¨×›×” ×›-6 ×©× ×™× ×¢×“ ×©×”×©×•×•×§×™× ×—×–×¨×• ×œ×©×™××™×." :
                        "The 2008 crisis began with Lehman Brothers collapse, led to 57% S&P 500 decline, unemployment rising to 10%, and forced central banks to cut rates near zero. Recovery took about 6 years for markets to reach new highs.",
                    'covid_pandemic': language === 'he' ? 
                        "××©×‘×¨ ×§×•×¨×•× ×” 2020 ×’×¨× ×œ×¡×’×™×¨×•×ª ×›×œ×›×œ×™×•×ª × ×¨×—×‘×•×ª, ×™×¨×™×“×” ×©×œ 34% ×‘-S&P 500 ×‘××¨×¥, ××š ×”×ª××•×©×©×•×ª ××”×™×¨×” ×”×•×“×•×ª ×œ×ª××™×›×” ×××©×œ×ª×™×ª ×•×—×“×©× ×•×ª ×¨×¤×•××™×ª. ×”×©×•×•×§×™× ×”×’×™×¢×• ×œ×©×™××™× ×—×“×©×™× ×ª×•×š ×©× ×”." :
                        "COVID-19 crisis caused widespread economic shutdowns, 34% S&P 500 decline in March, but rapid recovery due to government support and medical innovation. Markets reached new highs within a year.",
                    'high_inflation': language === 'he' ? 
                        "××™× ×¤×œ×¦×™×” ×’×‘×•×”×” ×‘×©× ×•×ª ×”-70 ×”×’×™×¢×” ×œ-14% ×‘××¨×”\"×‘, × ×’×¨××” ×××©×‘×¨ ×”× ×¤×˜ ×•××“×™× ×™×•×ª ××•× ×™×˜×¨×™×ª ×¨×•×¤×¤×”. ×”×¤×ª×¨×•×Ÿ ×“×¨×© ×”×¢×œ××•×ª ×¨×™×‘×™×ª ×“×¨××˜×™×•×ª ×œ-20% ×•×”×ª××•×“×“×•×ª ×¢× ××™×ª×•×Ÿ ×¢××•×§." :
                        "High inflation in the 1970s reached 14% in the US, caused by oil crisis and loose monetary policy. Solution required dramatic interest rate hikes to 20% and dealing with deep recession."
                };

                return contextMap[scenario.name] || (language === 'he' ? 
                    "×”×ª×¨×—×™×© ×©×‘×“×§×ª× ××‘×•×¡×¡ ×¢×œ ×¤×¨××˜×¨×™× ×›×œ×›×œ×™×™× ××¦×™××•×ª×™×™× ×•×œ×•×§×— ×‘×—×©×‘×•×Ÿ ×“×¤×•×¡×™ ×”×ª××•×©×©×•×ª ×”×™×¡×˜×•×¨×™×™× ×©×œ ×”×©×•×•×§×™× ×•×”×›×œ×›×œ×”." :
                    "The scenario you tested is based on realistic economic parameters and takes into account historical recovery patterns of markets and the economy.");
            };

            // Generate timeline data for crisis impact visualization
            const generateCrisisTimelineData = (scenario, inputs, workPeriods) => {
                const currentAge = inputs.currentAge;
                const retirementAge = inputs.retirementAge;
                const yearsToRetirement = retirementAge - currentAge;
                
                if (yearsToRetirement <= 0) return [];
                
                const crisisYears = Math.min(scenario?.duration || 0, yearsToRetirement);
                const timelineData = [];
                
                // Get current work period or use latest period
                const currentPeriod = workPeriods.find(period => 
                    currentAge >= period.startAge && currentAge < period.endAge
                ) || workPeriods[workPeriods.length - 1];
                
                // Calculate initial values including all investment types
                let normalPensionSavings = inputs.currentSavings;
                let normalTrainingFund = inputs.currentTrainingFund;
                let normalPersonalPortfolio = inputs.currentPersonalPortfolio;
                let normalCrypto = inputs.currentCrypto;
                let normalRealEstate = inputs.currentRealEstate;
                
                // Apply immediate portfolio decline for stressed scenario
                let stressedPensionSavings = normalPensionSavings * (1 - (scenario?.portfolioDecline || 0) / 100);
                let stressedTrainingFund = normalTrainingFund * (1 - (scenario?.portfolioDecline || 0) / 100);
                let stressedPersonalPortfolio = normalPersonalPortfolio * (1 - (scenario?.portfolioDecline || 0) / 100);
                let stressedCrypto = normalCrypto * (1 - (scenario?.portfolioDecline || 0) / 100);
                let stressedRealEstate = normalRealEstate * (1 - (scenario?.portfolioDecline || 0) / 100);
                
                for (let year = 0; year < yearsToRetirement; year++) {
                    const age = currentAge + year;
                    const activePeriod = workPeriods.find(period => 
                        age >= period.startAge && age < period.endAge
                    ) || currentPeriod;
                    
                    if (activePeriod) {
                        // Normal progression
                        const pensionReturn = (activePeriod.pensionReturn || 6) / 100;
                        const pensionContribution = activePeriod.monthlyContribution * 12;
                        const trainingContribution = activePeriod.monthlyTrainingFund * 12;
                        
                        normalPensionSavings = normalPensionSavings * (1 + pensionReturn) + pensionContribution;
                        normalTrainingFund = normalTrainingFund * (1 + (inputs.trainingFundReturn - inputs.trainingFundManagementFee) / 100) + trainingContribution;
                        normalPersonalPortfolio = normalPersonalPortfolio * (1 + inputs.personalPortfolioReturn / 100) + (inputs.personalPortfolioMonthly * 12);
                        normalCrypto = normalCrypto * (1 + inputs.cryptoReturn / 100) + (inputs.cryptoMonthly * 12);
                        normalRealEstate = normalRealEstate * (1 + inputs.realEstateReturn / 100) + (inputs.realEstateMonthly * 12);
                        
                        // Stressed progression
                        if (year < crisisYears) {
                            // Crisis years: reduced returns and contributions
                            const crisisReturn = Math.max(pensionReturn - 0.03, 0.01); // 3% less
                            const crisisContribution = pensionContribution * (1 - (scenario?.incomeReduction || 0) / 100);
                            const crisisTrainingContribution = trainingContribution * (1 - (scenario?.incomeReduction || 0) / 100);
                            
                            stressedPensionSavings = stressedPensionSavings * (1 + crisisReturn) + crisisContribution;
                            stressedTrainingFund = stressedTrainingFund * (1 + Math.max((inputs.trainingFundReturn - inputs.trainingFundManagementFee) / 100 - 0.02, 0.01)) + crisisTrainingContribution;
                            stressedPersonalPortfolio = stressedPersonalPortfolio * (1 + Math.max(inputs.personalPortfolioReturn / 100 - 0.04, 0)) + (inputs.personalPortfolioMonthly * (1 - (scenario?.incomeReduction || 0) / 100) * 12);
                            stressedCrypto = stressedCrypto * (1 + Math.max(inputs.cryptoReturn / 100 - 0.08, -0.05)) + (inputs.cryptoMonthly * (1 - (scenario?.incomeReduction || 0) / 100) * 12);
                            stressedRealEstate = stressedRealEstate * (1 + Math.max(inputs.realEstateReturn / 100 - 0.02, 0.01)) + (inputs.realEstateMonthly * (1 - (scenario?.incomeReduction || 0) / 100) * 12);
                        } else {
                            // Recovery years: normal returns and contributions
                            stressedPensionSavings = stressedPensionSavings * (1 + pensionReturn) + pensionContribution;
                            stressedTrainingFund = stressedTrainingFund * (1 + (inputs.trainingFundReturn - inputs.trainingFundManagementFee) / 100) + trainingContribution;
                            stressedPersonalPortfolio = stressedPersonalPortfolio * (1 + inputs.personalPortfolioReturn / 100) + (inputs.personalPortfolioMonthly * 12);
                            stressedCrypto = stressedCrypto * (1 + inputs.cryptoReturn / 100) + (inputs.cryptoMonthly * 12);
                            stressedRealEstate = stressedRealEstate * (1 + inputs.realEstateReturn / 100) + (inputs.realEstateMonthly * 12);
                        }
                    }
                    
                    const normalTotal = normalPensionSavings + normalTrainingFund + normalPersonalPortfolio + normalCrypto + normalRealEstate;
                    const stressedTotal = stressedPensionSavings + stressedTrainingFund + stressedPersonalPortfolio + stressedCrypto + stressedRealEstate;
                    
                    timelineData.push({
                        year: year,
                        age: age,
                        normalAccumulation: Math.round(normalTotal),
                        stressedAccumulation: Math.round(stressedTotal),
                        isCrisisYear: year < crisisYears,
                        phase: year < crisisYears ? 'crisis' : 'recovery',
                        // Breakdown for detailed view
                        normal: {
                            pension: Math.round(normalPensionSavings),
                            training: Math.round(normalTrainingFund),
                            personal: Math.round(normalPersonalPortfolio),
                            crypto: Math.round(normalCrypto),
                            realEstate: Math.round(normalRealEstate)
                        },
                        stressed: {
                            pension: Math.round(stressedPensionSavings),
                            training: Math.round(stressedTrainingFund),
                            personal: Math.round(stressedPersonalPortfolio),
                            crypto: Math.round(stressedCrypto),
                            realEstate: Math.round(stressedRealEstate)
                        }
                    });
                }
                
                return timelineData;
            };

            const generateStressTestRecommendations = (scenario, stressedResults) => {
                const recommendations = [];
                
                if (!stressedResults.achievesTarget) {
                    recommendations.push(
                        language === 'he' 
                            ? "×”×’×“×œ ××ª ×§×¨×Ÿ ×”×—×™×¨×•× ×œ×›×™×¡×•×™ ×©×œ ×œ×¤×—×•×ª 6-12 ×—×•×“×©×™× ×”×•×¦××•×ª"
                            : "Increase emergency fund to cover 6-12 months of expenses"
                    );
                    
                    recommendations.push(
                        language === 'he' 
                            ? "×©×§×•×œ ×œ×”×’×“×™×œ ××ª ×©×™×¢×•×¨ ×”×—×™×¡×›×•×Ÿ ×”×—×•×“×©×™ ×‘-20-30%"
                            : "Consider increasing monthly savings rate by 20-30%"
                    );
                }

                if (scenario.portfolioDecline > 30) {
                    recommendations.push(
                        language === 'he' 
                            ? "×¤×–×¨ ×”×©×§×¢×•×ª ×¢×œ ×¤× ×™ ×™×•×ª×¨ ×¡×•×’×™ × ×›×¡×™× ×œ×”×¤×—×ª×ª ×¡×™×›×•×Ÿ"
                            : "Diversify investments across more asset classes to reduce risk"
                    );
                }

                if (scenario.inflationIncrease > 5) {
                    recommendations.push(
                        language === 'he' 
                            ? "×”×©×§×¢ ×‘× ×›×¡×™× ×”××•×’× ×™× ××¤× ×™ ××™× ×¤×œ×¦×™×” (× ×“×œ×´×Ÿ, ×× ×™×•×ª)"
                            : "Invest in inflation-protected assets (real estate, stocks)"
                    );
                }

                recommendations.push(
                    language === 'he' 
                        ? "×‘×“×•×§ ×•×¢×“×›×Ÿ ××ª ×”×ª×›× ×™×ª ×”×¤×™× × ×¡×™×ª ××—×ª ×œ×©× ×”"
                        : "Review and update financial plan annually"
                );

                recommendations.push(
                    language === 'he' 
                        ? "×©××•×¨ ×¢×œ ×‘×™×˜×•×— × ×›×•×ª ×•×”×›× ×¡×” ××§×™×£"
                        : "Maintain comprehensive disability and income insurance"
                );

                return recommendations;
            };

            const calculateUserSavingsRate = () => {
                const currentSalary = workPeriods[workPeriods.length - 1]?.salary || 0;
                if (currentSalary === 0) return 0;
                
                const totalMonthlySavings = (workPeriods[workPeriods.length - 1]?.monthlyContribution || 0) +
                    (workPeriods[workPeriods.length - 1]?.monthlyTrainingFund || 0) +
                    inputs.personalPortfolioMonthly +
                    inputs.cryptoMonthly +
                    inputs.realEstateMonthly +
                    inputs.emergencyFundMonthly;
                
                return (totalMonthlySavings / currentSalary) * 100;
            };

            const calculateDiversificationScore = () => {
                let score = 0;
                if (inputs.currentPersonalPortfolio > 0 || inputs.personalPortfolioMonthly > 0) score += 25;
                if (inputs.currentCrypto > 0 || inputs.cryptoMonthly > 0) score += 15;
                if (inputs.currentRealEstate > 0 || inputs.realEstateMonthly > 0) score += 35;
                if (inputs.currentEmergencyFund > 0) score += 25;
                return score;
            };

            const generateAIBasedScenario = (userProfile) => {
                // AI logic to generate personalized stress test scenarios
                let incomeReduction = 20;
                let portfolioDecline = 30;
                let inflationIncrease = 5;
                let duration = 3;
                let description = "";

                // Adjust based on age
                if (userProfile.age < 35) {
                    portfolioDecline += 10; // Young people can handle more volatility
                    incomeReduction += 5;
                    description += language === 'he' ? "×ª×¨×—×™×© ××’×¨×¡×™×‘×™ ×œ×’×™×œ ×¦×¢×™×¨" : "Aggressive scenario for young age";
                } else if (userProfile.age > 55) {
                    portfolioDecline -= 10; // Older people need more conservative scenarios
                    incomeReduction -= 5;
                    duration += 1;
                    description += language === 'he' ? "×ª×¨×—×™×© ××•×ª×× ×œ×’×™×œ ××ª×§×“×" : "Scenario adapted for advanced age";
                } else {
                    description += language === 'he' ? "×ª×¨×—×™×© ×××•×–×Ÿ ×œ×’×™×œ ×‘×•×’×¨" : "Balanced scenario for middle age";
                }

                // Adjust based on risk tolerance
                if (userProfile.riskTolerance === 'conservative') {
                    portfolioDecline -= 5;
                    incomeReduction -= 5;
                } else if (userProfile.riskTolerance === 'aggressive') {
                    portfolioDecline += 10;
                    incomeReduction += 5;
                }

                // Adjust based on emergency fund
                if (!userProfile.hasEmergencyFund) {
                    incomeReduction += 10; // No safety net = higher income risk
                    description += language === 'he' ? " + ×—×•×¡×¨ ×§×¨×Ÿ ×—×™×¨×•×" : " + no emergency fund";
                }

                // Adjust based on diversification
                if (userProfile.diversification < 50) {
                    portfolioDecline += 5; // Concentrated portfolio = higher risk
                    description += language === 'he' ? " + ×¨×™×›×•×– ×”×©×§×¢×•×ª" : " + concentrated investments";
                }

                return {
                    incomeReduction: Math.min(incomeReduction, 50),
                    portfolioDecline: Math.min(portfolioDecline, 60),
                    inflationIncrease: Math.min(inflationIncrease, 15),
                    duration: Math.min(duration, 5),
                    description
                };
            };

            // Enhanced AI Scenario Generation Functions
            const generateAIScenarioFromDescription = async () => {
                const textarea = document.getElementById('ai-scenario-description');
                const description = textarea?.value?.trim();
                
                if (!description) {
                    alert(language === 'he' ? '×× × ×”×–×Ÿ ×ª×™××•×¨ ×ª×¨×—×™×©' : 'Please enter a scenario description');
                    return;
                }
                
                if (!results) {
                    alert(language === 'he' ? '×™×© ×œ×—×©×‘ ×ª×›× ×™×ª ×¤×¨×™×©×” ×ª×—×™×œ×”' : 'Please calculate retirement plan first');
                    return;
                }
                
                setAiScenarioLoading(true);
                
                try {
                    // Track AI scenario usage
                    AnalyticsManager.trackAction('ai_scenario_from_description', { 
                        descriptionLength: description.length,
                        userAge: inputs.currentAge,
                        language
                    });
                    
                    // AI-powered natural language processing to extract parameters
                    const scenario = parseScenarioDescription(description);
                    
                    // Validate scenario parameters
                    if (!scenario || typeof scenario !== 'object') {
                        throw new Error('Failed to parse scenario description');
                    }
                    
                    // Apply bounds checking to AI-generated parameters
                    scenario.incomeReduction = Math.max(0, Math.min(80, scenario.incomeReduction || 20));
                    scenario.portfolioDecline = Math.max(0, Math.min(90, scenario.portfolioDecline || 30));
                    scenario.inflationIncrease = Math.max(0, Math.min(50, scenario.inflationIncrease || 8));
                    scenario.duration = Math.max(1, Math.min(15, scenario.duration || 3));
                    
                    // Fill the custom scenario builder with AI-generated parameters
                    document.getElementById('custom-income-reduction').value = scenario.incomeReduction;
                    document.getElementById('custom-portfolio-decline').value = scenario.portfolioDecline;
                    document.getElementById('custom-inflation-increase').value = scenario.inflationIncrease;
                    document.getElementById('custom-crisis-duration').value = scenario.duration;
                    
                    // Show a preview of the extracted parameters
                    const previewMessage = language === 'he' 
                        ? `âœ… AI ×–×™×”×”: ×™×¨×™×“×” ×©×œ ${scenario.incomeReduction}% ×‘×”×›× ×¡×•×ª, ${scenario.portfolioDecline}% ×‘×ª×™×§×™ ×”×©×§×¢×•×ª, ${scenario.inflationIncrease}% ×¢×œ×™×™×” ×‘××™× ×¤×œ×¦×™×” ×œ××©×š ${scenario.duration} ×©× ×™×\n\nğŸ”„ ××¨×™×¥ ×—×™×©×•×‘ ××‘×—×Ÿ ×¢××™×“×•×ª...`
                        : `âœ… AI detected: ${scenario.incomeReduction}% income reduction, ${scenario.portfolioDecline}% portfolio decline, ${scenario.inflationIncrease}% inflation increase for ${scenario.duration} years\n\nğŸ”„ Running stress test calculation...`;
                    
                    alert(previewMessage);
                    
                    console.log('AI extracted scenario parameters:', scenario);
                    
                    // Run the stress test automatically
                    setTimeout(() => {
                        const customScenario = {
                            name: language === 'he' ? '×ª×¨×—×™×© AI ××•×ª××' : 'AI Custom Scenario',
                            description: scenario.explanation || `${language === 'he' ? '××‘×•×¡×¡ ×¢×œ:' : 'Based on:'} "${description.substring(0, 100)}${description.length > 100 ? '...' : ''}"`,
                            incomeReduction: scenario.incomeReduction,
                            portfolioDecline: scenario.portfolioDecline,
                            realEstateDecline: scenario.portfolioDecline * 0.7,
                            inflationIncrease: scenario.inflationIncrease,
                            duration: scenario.duration,
                            recoveryYears: Math.ceil(scenario.duration * 1.5)
                        };
                        
                        const stressedResults = calculateStressedResults({...customScenario, name: 'custom'});
                        const recommendations = generateStressTestRecommendations(customScenario, stressedResults);
                        
                        const normalTotalAccumulation = results.totalSavings + results.trainingFundValue + results.personalPortfolioValue + results.cryptoValue + results.realEstateValue;
                        
                        // Validate that stress test actually changed the results
                        const incomeChange = Math.abs(stressedResults.monthlyIncome - results.totalNetIncome);
                        const accumulationChange = Math.abs(stressedResults.totalAccumulation - normalTotalAccumulation);
                        
                        if (incomeChange < 100 && accumulationChange < 10000) {
                            console.warn('Warning: Stress test results are very similar to normal results');
                            console.log('Normal income:', results.totalNetIncome, 'Stressed income:', stressedResults.monthlyIncome);
                            console.log('Normal accumulation:', normalTotalAccumulation, 'Stressed accumulation:', stressedResults.totalAccumulation);
                        }
                        
                        setStressTestResults({
                            scenarioName: customScenario.name,
                            scenarioDescription: customScenario.description,
                            scenario: customScenario, // Store the full scenario object
                            normal: {
                                monthlyIncome: results.totalNetIncome,
                                totalAccumulation: normalTotalAccumulation,
                                achievesTarget: results.achievesTarget
                            },
                            stressed: stressedResults,
                            recoveryYears: customScenario.recoveryYears,
                            recommendations
                        });
                        
                        setAiScenarioLoading(false);
                        
                        // Clear the textarea
                        textarea.value = '';
                        
                        // Scroll to results
                        setTimeout(() => {
                            const resultsElement = document.querySelector('#stress-test-results');
                            if (resultsElement) {
                                resultsElement.scrollIntoView({ behavior: 'smooth' });
                            }
                        }, 100);
                    }, 1000); // Small delay to show loading state
                    
                } catch (error) {
                    console.error('AI scenario generation error:', error);
                    setAiScenarioLoading(false);
                    alert(language === 'he' 
                        ? '×©×’×™××” ×‘×™×¦×™×¨×ª ×”×ª×¨×—×™×©. × ×¡×” ×ª×™××•×¨ ××—×¨ ××• ×”×©×ª××© ×‘××‘× ×” ×”××•×ª×× ×™×“× ×™×ª'
                        : 'Error creating scenario. Try a different description or use manual custom builder');
                }
            };
            
            const fillExampleScenario = () => {
                const textarea = document.getElementById('ai-scenario-description');
                const examples = {
                    he: [
                        '×™×¨×™×“×” ×‘×”×›× ×¡×•×ª ×©×œ 5% ×œ××©×š ×©× ×ª×™×™×',
                        '×”×›× ×¡×ª×™ ×ª×™×¨×“ ×‘-15% ×•×”×©×•×§ ×™×§×¨×•×¡ ×‘-25% ×œ××©×š 3 ×©× ×™×',
                        '××” ×™×§×¨×” ×× ×™×”×™×” ××©×‘×¨ ×¢× ××™× ×¤×œ×¦×™×” ×©×œ 8% ×œ××©×š ×©× ×ª×™×™×?',
                        '×ª×¨×—×™×© ×©×œ ××œ×—××” - ×”×›× ×¡×•×ª ×™×¨×“×• ×‘-30% ×•×”×©×§×¢×•×ª ×‘-40% ×œ××©×š 4 ×©× ×™×',
                        '×™×¨×™×“×” ×§×˜× ×” ×‘×”×›× ×¡×•×ª ×©×œ 3% ×¢× ××™× ×¤×œ×¦×™×” ×©×œ 6% ×œ××©×š ×©× ×” ××—×ª'
                    ],
                    en: [
                        'Income reduction of 5% for two years',
                        'My income drops 15% and market crashes 25% for 3 years',
                        'What if there\'s a crisis with 8% inflation for two years?',
                        'War scenario - income drops 30% and investments 40% for 4 years',
                        'Small income drop of 3% with 6% inflation for one year'
                    ]
                };
                
                const langExamples = examples[language];
                const randomExample = langExamples[Math.floor(Math.random() * langExamples.length)];
                
                if (textarea) {
                    textarea.value = randomExample;
                    textarea.focus();
                }
            };
            
            const parseScenarioDescription = (description) => {
                try {
                    // Advanced NLP-like parsing to extract economic parameters from natural language
                    if (!description || typeof description !== 'string') {
                        throw new Error('Invalid description provided');
                    }
                    
                    const text = description.toLowerCase();
                    const originalText = description;
                    
                    // Start with minimal default values - only use if no numbers found
                    let incomeReduction = 0;
                    let portfolioDecline = 0;
                    let inflationIncrease = 0;
                    let duration = 1;
                    let explanationParts = [];
                    let foundNumbers = false;
                
                console.log('Parsing scenario:', text); // Debug log
                
                // Extract specific numbers first - be more precise
                const allNumbers = text.match(/\d+/g); // Find all numbers
                const percentageMatches = text.match(/(\d+)%/g);
                const yearMatches = text.match(/(\d+)\s*(year|years|×©× )/g);
                const monthMatches = text.match(/(\d+)\s*(month|months|×—×•×“×©)/g);
                
                console.log('All numbers found:', allNumbers);
                console.log('Percentage matches:', percentageMatches);
                console.log('Year matches:', yearMatches);
                console.log('Month matches:', monthMatches);
                
                // Extract income reduction clues with better Hebrew support
                const incomeKeywords = [
                    'income', 'salary', 'wage', '×”×›× ×¡', '××©×›×•×¨×ª', '×©×›×¨',
                    'drop', 'fall', 'reduce', 'decrease', '×™×¨×“', '×™×¤×œ', '×™×§×˜×Ÿ', '×™×¨×™×“×”',
                    'unemployment', 'job loss', 'layoff', '××‘×˜×œ×”', '×¤×™×˜×•×¨×™×Ÿ'
                ];
                
                const marketKeywords = [
                    'stock', 'market', 'portfolio', 'shares', '×× ×™×•×ª', '×©×•×§', '×ª×™×§', '××“×“',
                    'crash', 'collapse', '×§×¨×™×¡×”', '× ×¤×™×œ×”', 'real estate', 'property', '× ×“×œ×Ÿ'
                ];
                
                const inflationKeywords = [
                    'inflation', '××™× ×¤×œ×¦×™×”', 'price', 'cost', '××—×™×¨', '×™×•×§×¨', '×¢×œ×•×ª'
                ];
                
                // Check for specific crisis scenarios
                if (text.includes('2008') || text.includes('financial crisis') || text.includes('××©×‘×¨ ×¤×™× × ×¡×™')) {
                    portfolioDecline = Math.max(portfolioDecline, 40);
                    incomeReduction = Math.max(incomeReduction, 15);
                    inflationIncrease = Math.max(inflationIncrease, 2);
                    duration = 3;
                    explanationParts.push(language === 'he' 
                        ? '××‘×•×¡×¡ ×¢×œ ××©×‘×¨ 2008: ×™×¨×™×“×•×ª ×—×“×•×ª ×‘×©×•×§ ×”×”×•×Ÿ ×•××‘×˜×œ×” ×’×‘×•×”×”'
                        : 'Based on 2008 crisis: sharp market declines and high unemployment');
                }
                
                if (text.includes('covid') || text.includes('pandemic') || text.includes('×§×•×¨×•× ×”') || text.includes('××’×¤×”')) {
                    incomeReduction = Math.max(incomeReduction, 25);
                    portfolioDecline = Math.max(portfolioDecline, 25);
                    inflationIncrease = Math.max(inflationIncrease, 3);
                    duration = 2;
                    explanationParts.push(language === 'he' 
                        ? '×ª×¨×—×™×© ×“××•×™ ×§×•×¨×•× ×”: ×”×’×‘×œ×•×ª, ×™×¨×™×“×” ×‘×”×›× ×¡×•×ª ×•×ª× ×•×“×ª×™×•×ª ×’×‘×•×”×”'
                        : 'COVID-like scenario: lockdowns, income reduction and high volatility');
                }
                
                if (text.includes('war') || text.includes('conflict') || text.includes('××œ×—××”') || text.includes('×§×•× ×¤×œ×™×§×˜')) {
                    incomeReduction = Math.max(incomeReduction, 30);
                    portfolioDecline = Math.max(portfolioDecline, 35);
                    inflationIncrease = Math.max(inflationIncrease, 8);
                    duration = Math.max(duration, 2);
                    explanationParts.push(language === 'he' 
                        ? '×ª×¨×—×™×© ××œ×—××”: ×—×•×¡×¨ ×™×¦×™×‘×•×ª ×›×œ×›×œ×™×ª, ×™×¨×™×“×” ×‘×”×©×§×¢×•×ª ×•××™× ×¤×œ×¦×™×”'
                        : 'War scenario: economic instability, investment decline and inflation');
                }
                
                if (text.includes('recession') || text.includes('depression') || text.includes('××™×ª×•×Ÿ') || text.includes('×©×¤×œ')) {
                    incomeReduction = Math.max(incomeReduction, 20);
                    portfolioDecline = Math.max(portfolioDecline, 30);
                    duration = Math.max(duration, 2);
                    explanationParts.push(language === 'he' 
                        ? '×ª×¨×—×™×© ××™×ª×•×Ÿ: ×¦××™×—×” ×©×œ×™×œ×™×ª, ××‘×˜×œ×” ×•×¢×œ×™×” ×‘×¢×œ×•×™×•×ª ××™××•×Ÿ'
                        : 'Recession scenario: negative growth, unemployment and rising financing costs');
                }
                
                // More accurate extraction - look for explicit patterns first
                if (percentageMatches) {
                    percentageMatches.forEach((match, index) => {
                        const num = parseInt(match.replace('%', ''));
                        foundNumbers = true;
                        
                        // Get larger context around the percentage
                        const matchIndex = text.indexOf(match);
                        const beforeMatch = text.substring(Math.max(0, matchIndex - 80), matchIndex);
                        const afterMatch = text.substring(matchIndex + match.length, Math.min(text.length, matchIndex + match.length + 80));
                        const fullContext = beforeMatch + match + afterMatch;
                        
                        console.log(`Processing ${match} with full context: "${fullContext}"`);
                        
                        // Look for explicit income/salary keywords near this percentage
                        const incomePattern = /(×”×›× ×¡|××©×›×•×¨×ª|×©×›×¨|income|salary|wage).{0,30}(×™×¨×“|×™×§×˜×Ÿ|×ª×™×¨×“|×ª×§×˜×Ÿ|drop|fall|reduce|decrease).{0,30}(\d+)%|(\d+)%.{0,30}(×”×›× ×¡|××©×›×•×¨×ª|×©×›×¨|income|salary|wage).{0,30}(×™×¨×“|×™×§×˜×Ÿ|×ª×™×¨×“|×ª×§×˜×Ÿ|drop|fall|reduce|decrease)/;
                        
                        const marketPattern = /(×©×•×§|×× ×™×•×ª|×ª×™×§|×”×©×§×¢×•×ª|× ×“×œ×Ÿ|market|stock|portfolio|investment|real estate).{0,30}(×™×¨×“|×™×§×¨×•×¡|×™×¤×•×œ|crash|fall|drop|decline).{0,30}(\d+)%|(\d+)%.{0,30}(×©×•×§|×× ×™×•×ª|×ª×™×§|×”×©×§×¢×•×ª|× ×“×œ×Ÿ|market|stock|portfolio|investment|real estate).{0,30}(×™×¨×“|×™×§×¨×•×¡|×™×¤×•×œ|crash|fall|drop|decline)/;
                        
                        const inflationPattern = /(××™× ×¤×œ×¦×™×”|××—×™×¨|×™×•×§×¨|inflation|price).{0,30}(×¢×œ×™|×¢×œ×™×™×”|×’×“×œ|increase|rise).{0,30}(\d+)%|(\d+)%.{0,30}(××™× ×¤×œ×¦×™×”|××—×™×¨|×™×•×§×¨|inflation|price).{0,30}(×¢×œ×™|×¢×œ×™×™×”|×’×“×œ|increase|rise)/;
                        
                        // Check for income reduction patterns
                        if (incomePattern.test(fullContext)) {
                            incomeReduction = num;
                            explanationParts.push(language === 'he' 
                                ? `×™×¨×™×“×” ×‘×”×›× ×¡×•×ª ×©×œ ${num}% ×›×¤×™ ×©×¦×•×™×Ÿ ×‘×ª×¨×—×™×©`
                                : `${num}% income reduction as specified in scenario`);
                            console.log(`âœ… Found explicit income reduction: ${num}%`);
                        }
                        // Check for market/portfolio patterns
                        else if (marketPattern.test(fullContext)) {
                            portfolioDecline = num;
                            explanationParts.push(language === 'he' 
                                ? `×™×¨×™×“×” ×‘×ª×™×§×™ ×”×©×§×¢×•×ª ×©×œ ${num}% ×›×¤×™ ×©×¦×•×™×Ÿ ×‘×ª×¨×—×™×©`
                                : `${num}% portfolio decline as specified in scenario`);
                            console.log(`âœ… Found explicit portfolio decline: ${num}%`);
                        }
                        // Check for inflation patterns
                        else if (inflationPattern.test(fullContext)) {
                            inflationIncrease = num;
                            explanationParts.push(language === 'he' 
                                ? `×¢×œ×™×™×” ×‘××™× ×¤×œ×¦×™×” ×©×œ ${num}% ×›×¤×™ ×©×¦×•×™×Ÿ ×‘×ª×¨×—×™×©`
                                : `${num}% inflation increase as specified in scenario`);
                            console.log(`âœ… Found explicit inflation increase: ${num}%`);
                        }
                        // If only one percentage mentioned, try to infer from context
                        else if (percentageMatches.length === 1) {
                            // Look at surrounding words to determine type
                            if (fullContext.includes('×”×›× ×¡') || fullContext.includes('××©×›×•×¨×ª') || fullContext.includes('×©×›×¨') || 
                                fullContext.includes('income') || fullContext.includes('salary') || fullContext.includes('wage')) {
                                incomeReduction = num;
                                explanationParts.push(language === 'he' 
                                    ? `×™×¨×™×“×” ×‘×”×›× ×¡×•×ª ×©×œ ${num}% ×‘×”×ª×‘×¡×¡ ×¢×œ ×”×§×©×¨ ×”×ª×¨×—×™×©`
                                    : `${num}% income reduction based on scenario context`);
                                console.log(`ğŸ“ Inferred income reduction from single percentage: ${num}%`);
                            }
                            else if (fullContext.includes('×©×•×§') || fullContext.includes('×× ×™×•×ª') || fullContext.includes('×ª×™×§') ||
                                     fullContext.includes('market') || fullContext.includes('stock') || fullContext.includes('portfolio')) {
                                portfolioDecline = num;
                                explanationParts.push(language === 'he' 
                                    ? `×™×¨×™×“×” ×‘×ª×™×§ ×”×©×§×¢×•×ª ×©×œ ${num}% ×‘×”×ª×‘×¡×¡ ×¢×œ ×”×§×©×¨ ×”×ª×¨×—×™×©`
                                    : `${num}% portfolio decline based on scenario context`);
                                console.log(`ğŸ“ Inferred portfolio decline from single percentage: ${num}%`);
                            }
                            // If it's a small number (<=10), probably income or inflation
                            else if (num <= 10) {
                                incomeReduction = num;
                                explanationParts.push(language === 'he' 
                                    ? `×™×¨×™×“×” ×‘×”×›× ×¡×•×ª ×©×œ ${num}% (××¡×¤×¨ ×§×˜×Ÿ ×©××ª××™× ×œ×©×™× ×•×™ ×‘×”×›× ×¡×•×ª)`
                                    : `${num}% income reduction (small number suitable for income change)`);
                                console.log(`ğŸ“ Small percentage assigned to income: ${num}%`);
                            }
                            // If it's a large number (>15), probably portfolio decline
                            else {
                                portfolioDecline = num;
                                explanationParts.push(language === 'he' 
                                    ? `×™×¨×™×“×” ×‘×ª×™×§ ×”×©×§×¢×•×ª ×©×œ ${num}% (××¡×¤×¨ ×’×“×•×œ ×©××ª××™× ×œ×©×™× ×•×™ ×‘×©×•×§)`
                                    : `${num}% portfolio decline (large number suitable for market change)`);
                                console.log(`ğŸ“ Large percentage assigned to portfolio: ${num}%`);
                            }
                        }
                    });
                }
                
                // Extract duration
                if (yearMatches) {
                    const years = parseInt(yearMatches[0].match(/\d+/)[0]);
                    duration = Math.max(duration, Math.min(years, 8));
                    explanationParts.push(language === 'he' 
                        ? `××©×š ×”××©×‘×¨ ×¦×¤×•×™ ×œ×”×™×•×ª ${years} ×©× ×™×`
                        : `Crisis duration expected to be ${years} years`);
                    console.log(`Set duration to ${duration} years`); // Debug log
                }
                
                if (monthMatches && !yearMatches) {
                    const months = parseInt(monthMatches[0].match(/\d+/)[0]);
                    duration = Math.max(1, Math.min(Math.ceil(months / 12), 5));
                    explanationParts.push(language === 'he' 
                        ? `××©×š ×”××©×‘×¨ ×¦×¤×•×™ ×œ×”×™×•×ª ${months} ×—×•×“×©×™×`
                        : `Crisis duration expected to be ${months} months`);
                }
                
                // If no specific numbers were found, use minimal assumptions
                if (!foundNumbers) {
                    console.log('âš ï¸ No explicit percentages found, using minimal assumptions');
                    explanationParts.push(language === 'he' 
                        ? '×œ× × ××¦××• ××¡×¤×¨×™× ×¡×¤×¦×™×¤×™×™× ×‘×ª×™××•×¨ - ××©×ª××© ×‘×”×©×¤×¢×•×ª ××™× ×™××œ×™×•×ª'
                        : 'No specific numbers found in description - using minimal impact assumptions');
                    
                    // Set very minimal values if no numbers specified
                    if (incomeReduction === 0) incomeReduction = 5;
                    if (portfolioDecline === 0) portfolioDecline = 10;
                    if (inflationIncrease === 0) inflationIncrease = 2;
                }
                
                // Ensure we don't have all zeros
                if (incomeReduction === 0 && portfolioDecline === 0 && inflationIncrease === 0) {
                    console.log('âš ï¸ All parameters are zero, setting minimal crisis values');
                    incomeReduction = 5;
                    portfolioDecline = 10;
                    inflationIncrease = 2;
                    explanationParts.push(language === 'he' 
                        ? '×ª×¨×—×™×© ××©×‘×¨ ××™× ×™××œ×™ - ×œ×œ× × ×ª×•× ×™× ×¡×¤×¦×™×¤×™×™×'
                        : 'Minimal crisis scenario - no specific data provided');
                }
                
                // Add comprehensive impact explanation
                const impactLevel = incomeReduction <= 5 && portfolioDecline <= 10 ? 
                    (language === 'he' ? '×§×œ' : 'mild') :
                    incomeReduction <= 20 && portfolioDecline <= 30 ? 
                    (language === 'he' ? '×‘×™× ×•× ×™' : 'moderate') :
                    (language === 'he' ? '×—××•×¨' : 'severe');
                
                explanationParts.push(language === 'he' 
                    ? `××©×‘×¨ ${impactLevel}: ×™×¨×™×“×” ×©×œ ${incomeReduction}% ×‘×”×›× ×¡×•×ª, ${portfolioDecline}% ×‘×ª×™×§×™ ×”×©×§×¢×•×ª, ×¢×œ×™×™×” ×©×œ ${inflationIncrease}% ×‘××™× ×¤×œ×¦×™×” ×œ××©×š ${duration} ×©× ×™×`
                    : `${impactLevel} crisis: ${incomeReduction}% income decline, ${portfolioDecline}% portfolio decline, ${inflationIncrease}% inflation increase for ${duration} years`);
                
                const scenario = {
                    incomeReduction: Math.round(Math.max(0, incomeReduction)),
                    portfolioDecline: Math.round(Math.max(0, portfolioDecline)),
                    inflationIncrease: Math.round(Math.max(0, inflationIncrease)),
                    duration: Math.round(Math.max(1, duration)),
                    explanation: explanationParts.join('. ') || '×ª×¨×—×™×© ××•×ª×× ××™×©×™×ª'
                };
                
                console.log('Final scenario:', scenario); // Debug log
                return scenario;
                
                } catch (error) {
                    console.error('Error parsing scenario description:', error);
                    // Return default scenario if parsing fails
                    return {
                        incomeReduction: 20,
                        portfolioDecline: 30,
                        inflationIncrease: 8,
                        duration: 3,
                        explanation: '×ª×¨×—×™×© ×‘×¨×™×¨×ª ××—×“×œ ×‘×©×œ ×©×’×™××” ×‘×¤×¢× ×•×—'
                    };
                }
            };

            return React.createElement('div', {
                className: `min-h-screen bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50 p-4 ${language === 'he' ? 'dir-rtl' : 'dir-ltr'}`,
                dir: language === 'he' ? 'rtl' : 'ltr'
            }, [
                React.createElement('div', { className: "max-w-7xl mx-auto" }, [
                    // Header - Refined Elegant Design
                    React.createElement('div', { className: "relative text-center mb-10 animate-fade-in" }, [
                        // Subtle background glow
                        React.createElement('div', { 
                            className: "absolute inset-0 bg-gradient-to-r from-slate-100/20 via-blue-50/30 to-slate-100/20 rounded-2xl blur-2xl -z-10 transform scale-110" 
                        }),
                        
                        // Main header container - more refined
                        React.createElement('div', { className: "relative bg-white/95 backdrop-blur-md rounded-xl shadow-lg border border-slate-200/50 p-6 mx-auto max-w-3xl" }, [
                            // Language toggle - minimalist top right
                            React.createElement('button', {
                                onClick: () => setLanguage(language === 'he' ? 'en' : 'he'),
                                className: "absolute top-3 right-3 bg-slate-100 hover:bg-slate-200 text-slate-700 px-2 py-1 rounded-md text-xs font-medium transition-all duration-200 border border-slate-300/50"
                            }, [
                                React.createElement(Languages, { size: 12, className: "mr-1" }),
                                language === 'he' ? 'EN' : '×¢×‘'
                            ]),
                            
                            // Refined title section
                            React.createElement('div', { className: "mb-4" }, [
                                React.createElement('h1', { 
                                    className: "text-3xl md:text-4xl font-bold tracking-tight mb-3 text-slate-800",
                                    style: { 
                                        fontFamily: "'SF Pro Display', 'Inter', system-ui, sans-serif",
                                        letterSpacing: '-0.025em'
                                    }
                                }, t.title),
                                
                                // Subtle accent line
                                React.createElement('div', { className: "w-16 h-px bg-gradient-to-r from-transparent via-slate-400 to-transparent mx-auto" })
                            ]),
                            
                            // Refined subtitle
                            React.createElement('p', { 
                                className: "text-base text-slate-600 font-normal leading-relaxed max-w-lg mx-auto mb-4",
                                style: { fontFamily: "'Inter', 'Segoe UI', sans-serif" }
                            }, t.subtitle),
                            
                            // Minimal professional indicator
                            React.createElement('div', { className: "inline-flex items-center px-3 py-1.5 bg-slate-50 rounded-md border border-slate-200/70" }, [
                                React.createElement('div', { className: "w-1.5 h-1.5 bg-emerald-500 rounded-full mr-2" }),
                                React.createElement('span', { className: "text-xs font-medium text-slate-600" }, 
                                    language === 'he' ? "×ª×›× ×•×Ÿ ×¤×™× × ×¡×™ ××ª×§×“×" : "Advanced Financial Planning")
                            ])
                        ]),
                        
                        // Tabs - Improved spacing and design
                        React.createElement('div', { className: "flex justify-center space-x-2 bg-white/80 backdrop-blur-sm rounded-2xl p-2 shadow-lg border border-slate-200/50 max-w-4xl mx-auto" }, [
                            { id: 'basic', icon: 'â—ˆ', label: t.basic },
                            { id: 'advanced', icon: 'âš™', label: t.advanced },
                            { id: 'analysis', icon: 'â– ', label: t.analysis },
                            { id: 'scenarios', icon: 'â—‰', label: t.scenarios },
                            { id: 'stresstest', icon: 'âš¡', label: language === 'he' ? '××‘×—× ×™ ×¢××™×“×•×ª' : 'Stress Tests' },
                            { id: 'fire', icon: 'â——', label: t.fireCalculator }
                        ].map(tab => 
                            React.createElement('button', {
                                key: tab.id,
                                onClick: () => setActiveTab(tab.id),
                                className: `flex items-center px-5 py-3 rounded-xl transition-all duration-300 font-medium ${
                                    activeTab === tab.id
                                        ? 'bg-gradient-to-r from-slate-700 to-slate-800 text-white shadow-lg transform scale-105 border border-slate-600'
                                        : 'text-slate-600 hover:text-slate-800 hover:bg-slate-100/70 border border-transparent'
                                }`
                            }, [
                                React.createElement('span', { className: "text-lg mr-3" }, tab.icon),
                                React.createElement('span', { className: "text-sm font-medium" }, tab.label)
                            ])
                        ))
                    ]),

                    // Main Content
                    React.createElement('div', { className: "grid lg:grid-cols-3 gap-8" }, [
                        // Left Column - Input Forms
                        React.createElement('div', { className: "lg:col-span-2 space-y-6" }, [
                            activeTab === 'basic' && React.createElement('div', { className: "space-y-6" }, [
                                // Basic Data
                                React.createElement('div', { className: "glass-effect rounded-2xl shadow-xl p-6 border border-white/20 animate-fade-in" }, [
                                    React.createElement('h2', { className: "text-2xl font-bold text-purple-700 mb-6 flex items-center" }, [
                                        React.createElement(Calculator, { className: "mr-2" }),
                                        t.basic
                                    ]),
                                    React.createElement('div', { className: "space-y-4" }, [
                                        React.createElement('div', { className: "grid grid-cols-2 gap-4" }, [
                                            React.createElement('div', null, [
                                                React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-1" }, t.currentAge),
                                                React.createElement('input', {
                                                    type: 'number',
                                                    value: inputs.currentAge,
                                                    onChange: (e) => setInputs({...inputs, currentAge: parseInt(e.target.value) || 0}),
                                                    className: "w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all"
                                                })
                                            ]),
                                            React.createElement('div', null, [
                                                React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-1" }, t.retirementAge),
                                                React.createElement('input', {
                                                    type: 'number',
                                                    value: inputs.retirementAge,
                                                    onChange: (e) => setInputs({...inputs, retirementAge: parseInt(e.target.value) || 0}),
                                                    className: "w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all"
                                                })
                                            ])
                                        ]),
                                        React.createElement('div', { className: "grid grid-cols-2 gap-4" }, [
                                            React.createElement('div', null, [
                                                React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-1" }, 
                                                    language === 'he' ? "×—×™×¡×›×•×Ÿ × ×•×›×—×™ ×‘×¤× ×¡×™×” (â‚ª)" : "Current Pension Savings (â‚ª)"),
                                                React.createElement('input', {
                                                    type: 'number',
                                                    value: inputs.currentSavings,
                                                    onChange: (e) => setInputs({...inputs, currentSavings: parseInt(e.target.value) || 0}),
                                                    className: "w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all"
                                                })
                                            ]),
                                            React.createElement('div', null, [
                                                React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-1" }, 
                                                    language === 'he' ? "××™× ×¤×œ×¦×™×” ×©× ×ª×™×ª (%)" : "Annual Inflation (%)"),
                                                React.createElement('input', {
                                                    type: 'number',
                                                    step: '0.1',
                                                    value: inputs.inflationRate,
                                                    onChange: (e) => setInputs({...inputs, inflationRate: parseFloat(e.target.value) || 0}),
                                                    className: "w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all"
                                                })
                                            ])
                                        ])
                                    ])
                                ]),
                                
                                // Training Fund Section
                                React.createElement('div', { className: "glass-effect rounded-2xl shadow-xl p-6 border border-white/20 animate-fade-in" }, [
                                    React.createElement('h2', { className: "text-2xl font-bold text-green-700 mb-6 flex items-center" }, [
                                        React.createElement(PiggyBank, { className: "mr-2" }),
                                        language === 'he' ? "×§×¨×Ÿ ×”×©×ª×œ××•×ª" : "Training Fund"
                                    ]),
                                    React.createElement('div', { className: "space-y-4" }, [
                                        React.createElement('div', { className: "grid grid-cols-2 gap-4" }, [
                                            React.createElement('div', null, [
                                                React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-1" }, 
                                                    language === 'he' ? "×™×ª×¨×” × ×•×›×—×™×ª ×‘×§×¨×Ÿ ×”×©×ª×œ××•×ª (â‚ª)" : "Current Training Fund Balance (â‚ª)"),
                                                React.createElement('input', {
                                                    type: 'number',
                                                    value: inputs.currentTrainingFund,
                                                    onChange: (e) => setInputs({...inputs, currentTrainingFund: parseInt(e.target.value) || 0}),
                                                    className: "w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all"
                                                })
                                            ]),
                                            React.createElement('div', null, [
                                                React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-1" }, 
                                                    language === 'he' ? "×ª×©×•××” ×©× ×ª×™×ª ×§×¨×Ÿ ×”×©×ª×œ××•×ª (%)" : "Training Fund Annual Return (%)"),
                                                React.createElement('input', {
                                                    type: 'number',
                                                    step: '0.1',
                                                    value: inputs.trainingFundReturn,
                                                    onChange: (e) => setInputs({...inputs, trainingFundReturn: parseFloat(e.target.value) || 0}),
                                                    className: "w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all"
                                                })
                                            ])
                                        ]),
                                        React.createElement('div', null, [
                                            React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-1" }, 
                                                language === 'he' ? "×“××™ × ×™×”×•×œ ×¢×œ ×”×¦×‘×™×¨×” (%)" : "Management Fee on Accumulation (%)"),
                                            React.createElement('input', {
                                                type: 'number',
                                                step: '0.1',
                                                value: inputs.trainingFundManagementFee,
                                                onChange: (e) => setInputs({...inputs, trainingFundManagementFee: parseFloat(e.target.value) || 0}),
                                                className: "w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all"
                                            })
                                        ]),
                                        React.createElement('div', { className: "bg-green-50 rounded-lg p-3 border border-green-200" }, [
                                            React.createElement('div', { className: "text-sm text-green-700" }, [
                                                React.createElement('strong', null, 
                                                    language === 'he' ? "×ª×©×•××” × ×˜×•:" : "Net Return:"),
                                                React.createElement('span', { className: "ml-2 font-bold text-lg" }, 
                                                    `${(inputs.trainingFundReturn - inputs.trainingFundManagementFee).toFixed(2)}%`)
                                            ])
                                        ])
                                    ])
                                ]),
                                
                                // Personal Portfolio (No Tax Benefits)
                                React.createElement('div', { className: "glass-effect rounded-2xl shadow-xl p-6 border border-white/20 animate-fade-in" }, [
                                    React.createElement('h2', { className: "text-2xl font-bold text-purple-700 mb-6 flex items-center" }, [
                                        React.createElement(DollarSign, { className: "mr-2" }),
                                        language === 'he' ? "×ª×™×§ ×”×©×§×¢×•×ª ××™×©×™" : "Personal Investment Portfolio"
                                    ]),
                                    React.createElement('div', { className: "bg-purple-50 rounded-lg p-4 mb-6 border border-purple-200" }, [
                                        React.createElement('p', { className: "text-sm text-purple-700 mb-2" }, [
                                            React.createElement('strong', null, 
                                                language === 'he' ? "×—×©×•×‘ ×œ×“×¢×ª:" : "Important to Know:"),
                                            React.createElement('span', { className: "block mt-1" }, 
                                                language === 'he' ? "×”×©×§×¢×•×ª ××™×©×™×•×ª ××™× ×Ÿ ×–×•×›×•×ª ×œ×”×˜×‘×•×ª ××¡ ×›××• ×¤× ×¡×™×” ×•×§×¨×Ÿ ×”×©×ª×œ××•×ª" : "Personal investments don't receive tax benefits like pension and training funds")
                                        ])
                                    ]),
                                    React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-2 gap-6" }, [
                                        React.createElement('div', null, [
                                            React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-1" }, 
                                                language === 'he' ? "×¦×‘×™×¨×” × ×•×›×—×™×ª (â‚ª)" : "Current Accumulation (â‚ª)"),
                                            React.createElement('input', {
                                                type: 'number',
                                                value: inputs.currentPersonalPortfolio,
                                                onChange: (e) => setInputs({...inputs, currentPersonalPortfolio: parseInt(e.target.value) || 0}),
                                                className: "w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all"
                                            })
                                        ]),
                                        React.createElement('div', null, [
                                            React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-1" }, 
                                                language === 'he' ? "×”×©×§×¢×” ×—×•×“×©×™×ª (â‚ª)" : "Monthly Investment (â‚ª)"),
                                            React.createElement('input', {
                                                type: 'number',
                                                value: inputs.personalPortfolioMonthly,
                                                onChange: (e) => setInputs({...inputs, personalPortfolioMonthly: parseInt(e.target.value) || 0}),
                                                className: "w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all"
                                            })
                                        ]),
                                        React.createElement('div', null, [
                                            React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-1" }, 
                                                language === 'he' ? "×ª×©×•××” ××•×¢×¨×›×ª (%)" : "Expected Return (%)"),
                                            React.createElement('input', {
                                                type: 'number',
                                                step: '0.1',
                                                value: inputs.personalPortfolioReturn,
                                                onChange: (e) => setInputs({...inputs, personalPortfolioReturn: parseFloat(e.target.value) || 0}),
                                                className: "w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all"
                                            })
                                        ]),
                                        React.createElement('div', null, [
                                            React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-1" }, 
                                                language === 'he' ? "××¡ ×¨×•×•×—×™ ×”×•×Ÿ (%)" : "Capital Gains Tax (%)"),
                                            React.createElement('input', {
                                                type: 'number',
                                                step: '0.1',
                                                value: inputs.personalPortfolioTaxRate,
                                                onChange: (e) => setInputs({...inputs, personalPortfolioTaxRate: parseFloat(e.target.value) || 0}),
                                                className: "w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all"
                                            })
                                        ])
                                    ])
                                ]),
                                
                                // Cryptocurrency Portfolio
                                React.createElement('div', { className: "glass-effect rounded-2xl shadow-xl p-6 border border-white/20 animate-fade-in" }, [
                                    React.createElement('h2', { className: "text-2xl font-bold text-orange-700 mb-6 flex items-center" }, [
                                        React.createElement(TrendingUp, { className: "mr-2" }),
                                        language === 'he' ? "×ª×™×§ ××˜×‘×¢×•×ª ×“×™×’×™×˜×œ×™×™×" : "Cryptocurrency Portfolio"
                                    ]),
                                    React.createElement('div', { className: "bg-orange-50 rounded-lg p-4 mb-6 border border-orange-200" }, [
                                        React.createElement('p', { className: "text-sm text-orange-700 mb-2" }, [
                                            React.createElement('strong', null, 
                                                language === 'he' ? "×©×™× ×œ×‘:" : "Important:"),
                                            React.createElement('span', { className: "block mt-1" }, 
                                                language === 'he' ? "×”×©×§×¢×•×ª ×‘×§×¨×™×¤×˜×• ×”×Ÿ ×‘×¡×™×›×•×Ÿ ×’×‘×•×” ×•×¢×œ×•×œ×•×ª ×œ×—×•×•×ª ×ª× ×•×“×ª×™×•×ª ×§×™×¦×•× ×™×ª" : "Crypto investments are high risk and may experience extreme volatility")
                                        ])
                                    ]),
                                    React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-2 gap-6" }, [
                                        React.createElement('div', null, [
                                            React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-1" }, 
                                                language === 'he' ? "×¦×‘×™×¨×” × ×•×›×—×™×ª (â‚ª)" : "Current Holdings (â‚ª)"),
                                            React.createElement('input', {
                                                type: 'number',
                                                value: inputs.currentCrypto,
                                                onChange: (e) => setInputs({...inputs, currentCrypto: parseInt(e.target.value) || 0}),
                                                className: "w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all"
                                            })
                                        ]),
                                        React.createElement('div', null, [
                                            React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-1" }, 
                                                language === 'he' ? "×”×©×§×¢×” ×—×•×“×©×™×ª (â‚ª)" : "Monthly Investment (â‚ª)"),
                                            React.createElement('input', {
                                                type: 'number',
                                                value: inputs.cryptoMonthly,
                                                onChange: (e) => setInputs({...inputs, cryptoMonthly: parseInt(e.target.value) || 0}),
                                                className: "w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all"
                                            })
                                        ]),
                                        React.createElement('div', null, [
                                            React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-1" }, 
                                                language === 'he' ? "×ª×©×•××” ××•×¢×¨×›×ª (%)" : "Expected Return (%)"),
                                            React.createElement('input', {
                                                type: 'number',
                                                step: '0.1',
                                                value: inputs.cryptoReturn,
                                                onChange: (e) => setInputs({...inputs, cryptoReturn: parseFloat(e.target.value) || 0}),
                                                className: "w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all"
                                            })
                                        ]),
                                        React.createElement('div', null, [
                                            React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-1" }, 
                                                language === 'he' ? "××¡ ×¨×•×•×—×™ ×”×•×Ÿ (%)" : "Capital Gains Tax (%)"),
                                            React.createElement('input', {
                                                type: 'number',
                                                step: '0.1',
                                                value: inputs.cryptoTaxRate,
                                                onChange: (e) => setInputs({...inputs, cryptoTaxRate: parseFloat(e.target.value) || 0}),
                                                className: "w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all"
                                            })
                                        ])
                                    ])
                                ]),
                                
                                // Real Estate Investment
                                React.createElement('div', { className: "glass-effect rounded-2xl shadow-xl p-6 border border-white/20 animate-fade-in" }, [
                                    React.createElement('h2', { className: "text-2xl font-bold text-emerald-700 mb-6 flex items-center" }, [
                                        React.createElement(Building, { className: "mr-2" }),
                                        language === 'he' ? "×”×©×§×¢×•×ª × ×“×œ\"×Ÿ" : "Real Estate Investment"
                                    ]),
                                    React.createElement('div', { className: "bg-emerald-50 rounded-lg p-4 mb-6 border border-emerald-200" }, [
                                        React.createElement('p', { className: "text-sm text-emerald-700 mb-2" }, [
                                            React.createElement('strong', null, 
                                                language === 'he' ? "×›×•×œ×œ:" : "Includes:"),
                                            React.createElement('span', { className: "block mt-1" }, 
                                                language === 'he' ? "×¢×œ×™×™×ª ×¢×¨×š ×”× ×›×¡ ×•×“××™ ×©×›×™×¨×•×ª ×—×•×“×©×™×™×" : "Property appreciation and monthly rental income")
                                        ])
                                    ]),
                                    React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-2 gap-6" }, [
                                        React.createElement('div', null, [
                                            React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-1" }, 
                                                language === 'he' ? "×”×©×§×¢×” × ×•×›×—×™×ª (â‚ª)" : "Current Investment (â‚ª)"),
                                            React.createElement('input', {
                                                type: 'number',
                                                value: inputs.currentRealEstate,
                                                onChange: (e) => setInputs({...inputs, currentRealEstate: parseInt(e.target.value) || 0}),
                                                className: "w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition-all"
                                            })
                                        ]),
                                        React.createElement('div', null, [
                                            React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-1" }, 
                                                language === 'he' ? "×”×©×§×¢×” ×—×•×“×©×™×ª (â‚ª)" : "Monthly Investment (â‚ª)"),
                                            React.createElement('input', {
                                                type: 'number',
                                                value: inputs.realEstateMonthly,
                                                onChange: (e) => setInputs({...inputs, realEstateMonthly: parseInt(e.target.value) || 0}),
                                                className: "w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition-all"
                                            })
                                        ]),
                                        React.createElement('div', null, [
                                            React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-1" }, 
                                                language === 'he' ? "×¢×œ×™×™×ª ×¢×¨×š ×©× ×ª×™×ª (%)" : "Annual Appreciation (%)"),
                                            React.createElement('input', {
                                                type: 'number',
                                                step: '0.1',
                                                value: inputs.realEstateReturn,
                                                onChange: (e) => setInputs({...inputs, realEstateReturn: parseFloat(e.target.value) || 0}),
                                                className: "w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition-all"
                                            })
                                        ]),
                                        React.createElement('div', null, [
                                            React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-1" }, 
                                                language === 'he' ? "×ª×©×•××ª ×”×©×›×¨×” (%)" : "Rental Yield (%)"),
                                            React.createElement('input', {
                                                type: 'number',
                                                step: '0.1',
                                                value: inputs.realEstateRentalYield,
                                                onChange: (e) => setInputs({...inputs, realEstateRentalYield: parseFloat(e.target.value) || 0}),
                                                className: "w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition-all"
                                            })
                                        ]),
                                        React.createElement('div', null, [
                                            React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-1" }, 
                                                language === 'he' ? "××¡ ×¨×•×•×—×™ ×”×•×Ÿ (%)" : "Capital Gains Tax (%)"),
                                            React.createElement('input', {
                                                type: 'number',
                                                step: '0.1',
                                                value: inputs.realEstateTaxRate,
                                                onChange: (e) => setInputs({...inputs, realEstateTaxRate: parseFloat(e.target.value) || 0}),
                                                className: "w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition-all"
                                            })
                                        ])
                                    ])
                                ]),
                                
                                // Emergency Fund Section
                                React.createElement('div', { className: "glass-effect rounded-2xl shadow-xl p-6 border border-white/20 animate-fade-in" }, [
                                    React.createElement('h2', { className: "text-2xl font-bold text-red-600 mb-6 flex items-center" }, [
                                        React.createElement('span', { className: "mr-2 text-2xl" }, "ğŸ›¡ï¸"),
                                        language === 'he' ? "×§×¨×Ÿ ×—×™×¨×•×" : "Emergency Fund"
                                    ]),
                                    React.createElement('div', { className: "bg-red-50 rounded-lg p-4 mb-6 border border-red-200" }, [
                                        React.createElement('p', { className: "text-sm text-red-700 mb-2" }, [
                                            React.createElement('strong', null, 
                                                language === 'he' ? "×—×©×™×‘×•×ª ×§×¨×Ÿ ×”×—×™×¨×•×:" : "Importance of Emergency Fund:"),
                                            React.createElement('span', { className: "block mt-1" }, 
                                                language === 'he' ? "×§×¨×Ÿ ×—×™×¨×•× ××¡×¤×§×ª ×‘×™×˜×—×•×Ÿ ×¤×™× × ×¡×™ ×‘××§×¨×” ×©×œ ××•×‘×“×Ÿ ×”×›× ×¡×” ××• ×”×•×¦××•×ª ×‘×œ×ª×™ ×¦×¤×•×™×•×ª" : "Emergency fund provides financial security in case of income loss or unexpected expenses")
                                        ])
                                    ]),
                                    React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-3 gap-4 mb-4" }, [
                                        React.createElement('div', null, [
                                            React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-1" }, 
                                                language === 'he' ? "×§×¨×Ÿ ×—×™×¨×•× × ×•×›×—×™×ª (â‚ª)" : "Current Emergency Fund (â‚ª)"),
                                            React.createElement('input', {
                                                type: 'number',
                                                value: inputs.currentEmergencyFund,
                                                onChange: (e) => setInputs({...inputs, currentEmergencyFund: parseInt(e.target.value) || 0}),
                                                className: "w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent transition-all"
                                            })
                                        ]),
                                        React.createElement('div', null, [
                                            React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-1" }, 
                                                language === 'he' ? "×™×¢×“ ×—×•×“×©×™ ×”×•×¦××•×ª" : "Target Months Coverage"),
                                            React.createElement('select', {
                                                value: inputs.emergencyFundTarget,
                                                onChange: (e) => setInputs({...inputs, emergencyFundTarget: parseInt(e.target.value)}),
                                                className: "w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent transition-all"
                                            }, [
                                                React.createElement('option', { value: 3 }, language === 'he' ? "3 ×—×•×“×©×™× (××™× ×™××•×)" : "3 months (minimum)"),
                                                React.createElement('option', { value: 6 }, language === 'he' ? "6 ×—×•×“×©×™× (××•××œ×¥)" : "6 months (recommended)"),
                                                React.createElement('option', { value: 9 }, language === 'he' ? "9 ×—×•×“×©×™× (×©××¨× ×™)" : "9 months (conservative)"),
                                                React.createElement('option', { value: 12 }, language === 'he' ? "12 ×—×•×“×©×™× (×××•×“ ×©××¨× ×™)" : "12 months (very conservative)")
                                            ])
                                        ]),
                                        React.createElement('div', null, [
                                            React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-1" }, 
                                                language === 'he' ? "×”×¤×§×“×” ×—×•×“×©×™×ª (â‚ª)" : "Monthly Contribution (â‚ª)"),
                                            React.createElement('input', {
                                                type: 'number',
                                                value: inputs.emergencyFundMonthly,
                                                onChange: (e) => setInputs({...inputs, emergencyFundMonthly: parseInt(e.target.value) || 0}),
                                                className: "w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent transition-all"
                                            })
                                        ])
                                    ]),
                                    // Emergency Fund Analysis
                                    React.createElement('div', { className: "bg-gray-50 rounded-lg p-4" }, [
                                        React.createElement('h4', { className: "font-semibold text-gray-800 mb-3" }, 
                                            language === 'he' ? "× ×™×ª×•×— ×§×¨×Ÿ ×”×—×™×¨×•×:" : "Emergency Fund Analysis:"),
                                        (() => {
                                            const targetAmount = inputs.currentMonthlyExpenses * inputs.emergencyFundTarget;
                                            const currentCoverage = inputs.currentMonthlyExpenses > 0 ? 
                                                (inputs.currentEmergencyFund / inputs.currentMonthlyExpenses).toFixed(1) : 0;
                                            const gap = Math.max(0, targetAmount - inputs.currentEmergencyFund);
                                            const monthsToTarget = inputs.emergencyFundMonthly > 0 ? 
                                                Math.ceil(gap / inputs.emergencyFundMonthly) : 0;
                                            
                                            return React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-2 gap-4 text-sm" }, [
                                                React.createElement('div', { className: "space-y-2" }, [
                                                    React.createElement('div', { className: "flex justify-between" }, [
                                                        React.createElement('span', null, language === 'he' ? "×™×¢×“ ×”×§×¨×Ÿ:" : "Target Fund:"),
                                                        React.createElement('span', { className: "font-semibold" }, formatCurrency(targetAmount))
                                                    ]),
                                                    React.createElement('div', { className: "flex justify-between" }, [
                                                        React.createElement('span', null, language === 'he' ? "×›×™×¡×•×™ × ×•×›×—×™:" : "Current Coverage:"),
                                                        React.createElement('span', { 
                                                            className: `font-semibold ${currentCoverage >= inputs.emergencyFundTarget ? 'text-green-600' : 'text-red-600'}`
                                                        }, `${currentCoverage} ${language === 'he' ? '×—×•×“×©×™×' : 'months'}`)
                                                    ])
                                                ]),
                                                React.createElement('div', { className: "space-y-2" }, [
                                                    React.createElement('div', { className: "flex justify-between" }, [
                                                        React.createElement('span', null, language === 'he' ? "×¤×¢×¨ ×œ×›×™×¡×•×™:" : "Gap to Cover:"),
                                                        React.createElement('span', { className: "font-semibold" }, formatCurrency(gap))
                                                    ]),
                                                    gap > 0 && inputs.emergencyFundMonthly > 0 && React.createElement('div', { className: "flex justify-between" }, [
                                                        React.createElement('span', null, language === 'he' ? "×–××Ÿ ×œ×”×©×’×ª ×™×¢×“:" : "Time to Target:"),
                                                        React.createElement('span', { className: "font-semibold text-blue-600" }, 
                                                            `${monthsToTarget} ${language === 'he' ? '×—×•×“×©×™×' : 'months'}`)
                                                    ])
                                                ])
                                            ]);
                                        })()
                                    ])
                                ]),
                                
                                // Work Periods
                                React.createElement('div', { className: "glass-effect rounded-2xl shadow-xl p-6 border border-white/20 animate-fade-in" }, [
                                    React.createElement('div', { className: "flex justify-between items-center mb-6" }, [
                                        React.createElement('h2', { className: "text-2xl font-bold text-blue-700 flex items-center" }, [
                                            React.createElement(Globe, { className: "mr-2" }),
                                            t.workPeriods
                                        ]),
                                        React.createElement('button', {
                                            onClick: addWorkPeriod,
                                            className: "bg-gradient-to-r from-blue-500 to-cyan-500 text-white px-4 py-2 rounded-lg flex items-center hover:from-blue-600 hover:to-cyan-600 transition-all shadow-lg"
                                        }, [
                                            React.createElement(Plus, { size: 16, className: "mr-1" }),
                                            t.addPeriod
                                        ])
                                    ]),
                                    React.createElement('div', { className: "space-y-4" }, 
                                        workPeriods.map((period, index) =>
                                            React.createElement('div', {
                                                key: period.id,
                                                className: "border border-gray-200 rounded-xl p-4 bg-gradient-to-r from-gray-50 to-blue-50 animate-fade-in"
                                            }, [
                                                React.createElement('div', { className: "flex justify-between items-center mb-3" }, [
                                                    React.createElement('h3', { className: "font-bold text-gray-800" }, 
                                                        language === 'he' ? `×ª×§×•×¤×” ${index + 1}` : `Period ${index + 1}`),
                                                    workPeriods.length > 1 && React.createElement('button', {
                                                        onClick: () => removeWorkPeriod(period.id),
                                                        className: "text-red-500 hover:text-red-700 hover:bg-red-100 p-1 rounded transition-all"
                                                    }, React.createElement(Trash2, { size: 16 }))
                                                ]),
                                                React.createElement('div', { className: "grid grid-cols-2 gap-3 mb-3" }, [
                                                    React.createElement('div', null, [
                                                        React.createElement('label', { className: "block text-xs font-medium text-gray-600 mb-1" }, 
                                                            language === 'he' ? "××’×™×œ" : "From Age"),
                                                        React.createElement('input', {
                                                            type: 'number',
                                                            value: period.startAge,
                                                            onChange: (e) => updateWorkPeriod(period.id, 'startAge', parseInt(e.target.value) || 0),
                                                            className: "w-full p-2 border border-gray-300 rounded text-sm focus:ring-1 focus:ring-blue-500"
                                                        })
                                                    ]),
                                                    React.createElement('div', null, [
                                                        React.createElement('label', { className: "block text-xs font-medium text-gray-600 mb-1" }, 
                                                            language === 'he' ? "×¢×“ ×’×™×œ" : "To Age"),
                                                        React.createElement('input', {
                                                            type: 'number',
                                                            value: period.endAge,
                                                            onChange: (e) => updateWorkPeriod(period.id, 'endAge', parseInt(e.target.value) || 0),
                                                            className: "w-full p-2 border border-gray-300 rounded text-sm focus:ring-1 focus:ring-blue-500"
                                                        })
                                                    ])
                                                ]),
                                                React.createElement('div', { className: "mb-3" }, [
                                                    React.createElement('label', { className: "block text-xs font-medium text-gray-600 mb-1" }, 
                                                        language === 'he' ? "××“×™× ×”" : "Country"),
                                                    React.createElement('select', {
                                                        value: period.country,
                                                        onChange: (e) => updateWorkPeriod(period.id, 'country', e.target.value),
                                                        className: "w-full p-2 border border-gray-300 rounded text-sm focus:ring-1 focus:ring-blue-500"
                                                    }, Object.entries(countryData).map(([code, data]) =>
                                                        React.createElement('option', { key: code, value: code }, `${data.flag} ${data.name}`)
                                                    ))
                                                ]),
                                                React.createElement('div', { className: "grid grid-cols-2 gap-3" }, [
                                                    React.createElement('div', null, [
                                                        React.createElement('label', { className: "block text-xs font-medium text-gray-600 mb-1" }, 
                                                            language === 'he' ? "×”×¤×§×“×” ×—×•×“×©×™×ª ×œ×¤× ×¡×™×” (â‚ª)" : "Monthly Pension Contribution (â‚ª)"),
                                                        React.createElement('input', {
                                                            type: 'number',
                                                            value: period.monthlyContribution,
                                                            onChange: (e) => updateWorkPeriod(period.id, 'monthlyContribution', parseInt(e.target.value) || 0),
                                                            className: "w-full p-2 border border-gray-300 rounded text-sm focus:ring-1 focus:ring-blue-500"
                                                        })
                                                    ]),
                                                    React.createElement('div', null, [
                                                        React.createElement('label', { className: "block text-xs font-medium text-gray-600 mb-1" }, 
                                                            language === 'he' ? "××©×›×•×¨×ª (â‚ª)" : "Salary (â‚ª)"),
                                                        React.createElement('input', {
                                                            type: 'number',
                                                            value: period.salary,
                                                            onChange: (e) => updateWorkPeriod(period.id, 'salary', parseInt(e.target.value) || 0),
                                                            className: "w-full p-2 border border-gray-300 rounded text-sm focus:ring-1 focus:ring-blue-500"
                                                        })
                                                    ])
                                                ]),
                                                React.createElement('div', { className: "bg-blue-50 rounded-lg p-3 mt-3" }, [
                                                    React.createElement('h4', { className: "text-sm font-bold text-blue-800 mb-2" }, 
                                                        language === 'he' ? "×¤×¨×˜×™ ×¤× ×¡×™×”" : "Pension Details"),
                                                    React.createElement('div', { className: "grid grid-cols-2 gap-2" }, [
                                                        React.createElement('div', null, [
                                                            React.createElement('label', { className: "block text-xs font-medium text-gray-600 mb-1" }, 
                                                                language === 'he' ? "×ª×©×•××” ×©× ×ª×™×ª ×¤× ×¡×™×” (%)" : "Pension Annual Return (%)"),
                                                            React.createElement('input', {
                                                                type: 'number',
                                                                step: '0.1',
                                                                value: period.pensionReturn,
                                                                onChange: (e) => updateWorkPeriod(period.id, 'pensionReturn', parseFloat(e.target.value) || 0),
                                                                className: "w-full p-2 border border-gray-300 rounded text-sm focus:ring-1 focus:ring-blue-500"
                                                            })
                                                        ]),
                                                        React.createElement('div', null, [
                                                            React.createElement('label', { className: "block text-xs font-medium text-gray-600 mb-1" }, 
                                                                language === 'he' ? "×“××™ × ×™×”×•×œ ×¢×œ ×”×¤×§×“×•×ª (%)" : "Deposit Management Fee (%)"),
                                                            React.createElement('input', {
                                                                type: 'number',
                                                                step: '0.1',
                                                                value: period.pensionDepositFee,
                                                                onChange: (e) => updateWorkPeriod(period.id, 'pensionDepositFee', parseFloat(e.target.value) || 0),
                                                                className: "w-full p-2 border border-gray-300 rounded text-sm focus:ring-1 focus:ring-blue-500"
                                                            })
                                                        ]),
                                                        React.createElement('div', null, [
                                                            React.createElement('label', { className: "block text-xs font-medium text-gray-600 mb-1" }, 
                                                                language === 'he' ? "×“××™ × ×™×”×•×œ ×¢×œ ×¦×‘×™×¨×” (%)" : "Accumulation Management Fee (%)"),
                                                            React.createElement('input', {
                                                                type: 'number',
                                                                step: '0.1',
                                                                value: period.pensionAnnualFee,
                                                                onChange: (e) => updateWorkPeriod(period.id, 'pensionAnnualFee', parseFloat(e.target.value) || 0),
                                                                className: "w-full p-2 border border-gray-300 rounded text-sm focus:ring-1 focus:ring-blue-500"
                                                            })
                                                        ]),
                                                        React.createElement('div', null, [
                                                            React.createElement('label', { className: "block text-xs font-medium text-gray-600 mb-1" }, 
                                                                language === 'he' ? "×”×¤×§×“×” ×—×•×“×©×™×ª ×œ×§×¨×Ÿ ×”×©×ª×œ××•×ª (â‚ª)" : "Monthly Training Fund (â‚ª)"),
                                                            React.createElement('input', {
                                                                type: 'number',
                                                                value: period.monthlyTrainingFund,
                                                                onChange: (e) => updateWorkPeriod(period.id, 'monthlyTrainingFund', parseInt(e.target.value) || 0),
                                                                className: "w-full p-2 border border-gray-300 rounded text-sm focus:ring-1 focus:ring-blue-500"
                                                            })
                                                        ])
                                                    ]),
                                                    React.createElement('div', { className: "mt-2 p-2 bg-blue-100 rounded text-xs text-blue-700" }, [
                                                        React.createElement('strong', null, 
                                                            language === 'he' ? "×ª×©×•××” ××¤×§×˜×™×‘×™×ª: " : "Effective Return: "),
                                                        React.createElement('span', { className: "font-bold" }, 
                                                            `${(period.pensionReturn - period.pensionAnnualFee).toFixed(2)}%`)
                                                    ])
                                                ])
                                            ])
                                        )
                                    )
                                ])
                            ]),

                            activeTab === 'advanced' && React.createElement('div', { className: "space-y-6" }, [
                                // Advanced Settings
                                React.createElement('div', { className: "glass-effect rounded-2xl shadow-xl p-6 border border-white/20 animate-fade-in" }, [
                                    React.createElement('h2', { className: "text-2xl font-bold text-orange-700 mb-6 flex items-center" }, [
                                        React.createElement(Settings, { className: "mr-2" }),
                                        language === 'he' ? "×”×’×“×¨×•×ª ××ª×§×“××•×ª" : "Advanced Settings"
                                    ]),
                                    React.createElement('div', { className: "space-y-4" }, [
                                        React.createElement('div', { className: "grid grid-cols-2 gap-4" }, [
                                            React.createElement('div', null, [
                                                React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-1" }, 
                                                    language === 'he' ? "×”×•×¦××•×ª ×—×•×“×©×™×•×ª × ×•×›×—×™×•×ª (â‚ª)" : "Current Monthly Expenses (â‚ª)"),
                                                React.createElement('input', {
                                                    type: 'number',
                                                    value: inputs.currentMonthlyExpenses,
                                                    onChange: (e) => setInputs({...inputs, currentMonthlyExpenses: parseInt(e.target.value) || 0}),
                                                    className: "w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all"
                                                })
                                            ]),
                                            React.createElement('div', null, [
                                                React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-1" }, 
                                                    language === 'he' ? "×™×¢×“: ×”×—×œ×¤×ª % ×××©×›×•×¨×ª" : "Target: Replace % of Salary"),
                                                React.createElement('input', {
                                                    type: 'number',
                                                    value: inputs.targetReplacement,
                                                    onChange: (e) => setInputs({...inputs, targetReplacement: parseInt(e.target.value) || 0}),
                                                    className: "w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all"
                                                }),
                                                React.createElement('div', { className: "bg-blue-50 rounded-lg p-4 mt-3 border border-blue-200" }, [
                                                    React.createElement('h4', { className: "font-semibold text-blue-800 mb-2 text-sm flex items-center" }, [
                                                        React.createElement('span', { className: "mr-2" }, "ğŸ’¡"),
                                                        language === 'he' ? "××” ×–×” ××—×•×– ×™×¢×“ ×”×—×œ×¤×” ×××©×›×•×¨×ª?" : "What is Salary Replacement Percentage?"
                                                    ]),
                                                    React.createElement('div', { className: "text-sm text-blue-700 space-y-2" }, [
                                                        React.createElement('p', null, 
                                                            language === 'he' 
                                                                ? "×–×”×• ×”××—×•×– ××”××©×›×•×¨×ª ×”× ×•×›×—×™×ª ×©×œ×š ×©×ª×¨×¦×” ×œ×§×‘×œ ×›×”×›× ×¡×” ×—×•×“×©×™×ª ×‘×¤× ×¡×™×”."
                                                                : "This is the percentage of your current salary you want to receive as monthly income in retirement."
                                                        ),
                                                        React.createElement('div', { className: "bg-white/70 rounded p-3 mt-2" }, [
                                                            React.createElement('strong', { className: "text-blue-800" }, 
                                                                language === 'he' ? "×“×•×’××”:" : "Example:"),
                                                            React.createElement('br'),
                                                            React.createElement('span', null, 
                                                                language === 'he' 
                                                                    ? `â€¢ ××©×›×•×¨×ª × ×•×›×—×™×ª: â‚ª15,000 ×œ×—×•×“×©`
                                                                    : `â€¢ Current salary: â‚ª15,000 per month`),
                                                            React.createElement('br'),
                                                            React.createElement('span', null, 
                                                                language === 'he' 
                                                                    ? `â€¢ ×™×¢×“ ×”×—×œ×¤×” 75%: â‚ª11,250 ×œ×—×•×“×© ×‘×¤× ×¡×™×”`
                                                                    : `â€¢ 75% replacement target: â‚ª11,250 per month in retirement`)
                                                        ]),
                                                        React.createElement('div', { className: "mt-3" }, [
                                                            React.createElement('strong', { className: "text-blue-800" }, 
                                                                language === 'he' ? "×”××œ×¦×•×ª × ×¤×•×¦×•×ª:" : "Common Recommendations:"),
                                                            React.createElement('ul', { className: "list-disc list-inside mt-1 space-y-1" }, [
                                                                React.createElement('li', null, 
                                                                    language === 'he' ? "70-80% - ×¨××ª ×—×™×™× × ×•×—×”" : "70-80% - Comfortable lifestyle"),
                                                                React.createElement('li', null, 
                                                                    language === 'he' ? "60-70% - ×¨××ª ×—×™×™× ×‘×¡×™×¡×™×ª" : "60-70% - Basic lifestyle"),
                                                                React.createElement('li', null, 
                                                                    language === 'he' ? "80-100% - ×©××™×¨×” ×¢×œ ×¨××ª ×”×—×™×™× ×”× ×•×›×—×™×ª" : "80-100% - Maintain current lifestyle")
                                                            ])
                                                        ])
                                                    ])
                                                ])
                                            ])
                                        ]),
                                        React.createElement('div', null, [
                                            React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-3" }, 
                                                language === 'he' ? "×¨××ª ×¡×™×›×•×Ÿ" : "Risk Level"),
                                            React.createElement('div', { className: "grid grid-cols-5 gap-2" }, [
                                                'veryConservative', 'conservative', 'moderate', 'aggressive', 'veryAggressive'
                                            ].map(risk => {
                                                const labels = {
                                                    he: {
                                                        veryConservative: '×©××¨× ×™ ×××•×“',
                                                        conservative: '×©××¨× ×™',
                                                        moderate: '××ª×•×Ÿ',
                                                        aggressive: '××’×¨×¡×™×‘×™',
                                                        veryAggressive: '××’×¨×¡×™×‘×™ ×××•×“'
                                                    },
                                                    en: {
                                                        veryConservative: 'Very Conservative',
                                                        conservative: 'Conservative',
                                                        moderate: 'Moderate',
                                                        aggressive: 'Aggressive',
                                                        veryAggressive: 'Very Aggressive'
                                                    }
                                                };
                                                const multipliers = {
                                                    veryConservative: '-30%',
                                                    conservative: '-15%',
                                                    moderate: '0%',
                                                    aggressive: '+15%',
                                                    veryAggressive: '+30%'
                                                };
                                                return React.createElement('button', {
                                                    key: risk,
                                                    onClick: () => setInputs({...inputs, riskTolerance: risk}),
                                                    className: `p-3 rounded-lg border-2 transition-all text-center ${
                                                        inputs.riskTolerance === risk 
                                                            ? 'border-orange-500 bg-orange-50 text-orange-700' 
                                                            : 'border-gray-200 bg-white hover:border-orange-300'
                                                    }`
                                                }, [
                                                    React.createElement('div', { className: "font-medium text-sm" }, labels[language][risk]),
                                                    React.createElement('div', { className: "text-xs text-gray-500 mt-1" }, multipliers[risk])
                                                ]);
                                            }))
                                        ])
                                    ])
                                ])
                            ]),

                            activeTab === 'scenarios' && React.createElement('div', { className: "glass-effect rounded-2xl shadow-xl p-6 border border-white/20 animate-fade-in" }, [
                                React.createElement('h2', { className: "text-2xl font-bold text-green-700 mb-6 flex items-center" }, [
                                    React.createElement(Target, { className: "mr-2" }),
                                    language === 'he' ? "×ª×¨×—×™×©×™ ×¡×™×›×•×Ÿ" : "Risk Scenarios"
                                ]),
                                React.createElement('div', { className: "grid md:grid-cols-2 gap-6" }, 
                                    Object.entries(riskScenarios).map(([key, scenario]) =>
                                        React.createElement('div', {
                                            key: key,
                                            className: `p-4 rounded-xl border-2 transition-all cursor-pointer ${
                                                inputs.riskTolerance === key 
                                                    ? 'border-green-500 bg-green-50' 
                                                    : 'border-gray-200 bg-white hover:border-green-300'
                                            }`,
                                            onClick: () => setInputs({...inputs, riskTolerance: key})
                                        }, [
                                            React.createElement('h3', { className: "font-bold text-lg text-gray-800 mb-2" }, 
                                                scenario.name[language]),
                                            React.createElement('p', { className: "text-gray-600 mb-3" }, 
                                                language === 'he' ? `××›×¤×™×œ ×ª×©×•××”: ${scenario.multiplier}x` : `Return multiplier: ${scenario.multiplier}x`),
                                            React.createElement('div', { className: "text-sm text-gray-500" }, 
                                                scenario.description[language]
                                            )
                                        ])
                                    )
                                )
                            ]),

                            activeTab === 'fire' && React.createElement('div', { className: "glass-effect rounded-2xl shadow-xl p-6 border border-white/20 animate-fade-in" }, [
                                React.createElement('h2', { className: "text-2xl font-bold text-orange-600 mb-6 flex items-center" }, [
                                    React.createElement(TrendingUp, { className: "mr-2" }),
                                    t.fireCalculator
                                ]),
                                React.createElement('div', { className: "grid md:grid-cols-2 gap-6" }, [
                                    // FIRE Settings
                                    React.createElement('div', { className: "space-y-4" }, [
                                        React.createElement('h3', { className: "text-lg font-bold text-gray-800 mb-4" }, 
                                            language === 'he' ? "×”×’×“×¨×•×ª FIRE" : "FIRE Settings"),
                                        
                                        React.createElement('div', null, [
                                            React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-1" }, t.fireTargetAge),
                                            React.createElement('input', {
                                                type: 'number',
                                                value: inputs.fireTargetAge,
                                                onChange: (e) => setInputs({...inputs, fireTargetAge: parseInt(e.target.value) || 0}),
                                                className: "w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all"
                                            })
                                        ]),
                                        
                                        React.createElement('div', null, [
                                            React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-1" }, t.fireMonthlyExpenses),
                                            React.createElement('input', {
                                                type: 'number',
                                                value: inputs.fireMonthlyExpenses,
                                                onChange: (e) => setInputs({...inputs, fireMonthlyExpenses: parseInt(e.target.value) || 0}),
                                                className: "w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all"
                                            })
                                        ]),
                                        
                                        React.createElement('div', null, [
                                            React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-1" }, t.fireSafeWithdrawlRate),
                                            React.createElement('input', {
                                                type: 'number',
                                                step: '0.1',
                                                value: inputs.fireSafeWithdrawlRate,
                                                onChange: (e) => setInputs({...inputs, fireSafeWithdrawlRate: parseFloat(e.target.value) || 0}),
                                                className: "w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all"
                                            })
                                        ])
                                    ]),
                                    
                                    // FIRE Calculation Results
                                    React.createElement('div', { className: "space-y-4" }, [
                                        React.createElement('h3', { className: "text-lg font-bold text-gray-800 mb-4" }, 
                                            language === 'he' ? "×ª×•×¦××•×ª FIRE" : "FIRE Results"),
                                        
                                        React.createElement('div', { className: "bg-gradient-to-r from-orange-100 to-red-100 rounded-xl p-4 border border-orange-200" }, [
                                            React.createElement('div', { className: "text-center" }, [
                                                (() => {
                                                    const totalMonthlyDebtPayments = inputs.mortgageMonthlyPayment + inputs.personalLoansMonthly + inputs.creditCardMonthly + inputs.otherDebtsMonthly;
                                                    const fireMonthlyExpensesWithDebt = inputs.fireMonthlyExpenses + totalMonthlyDebtPayments;
                                                    const fireTarget = fireMonthlyExpensesWithDebt * 12 * (100 / inputs.fireSafeWithdrawlRate);
                                                    return [
                                                        React.createElement('div', { className: "text-2xl font-bold text-orange-700 currency-format" }, 
                                                            formatCurrency(fireTarget)),
                                                        React.createElement('div', { className: "text-sm text-gray-600" }, 
                                                            language === 'he' ? "×™×¢×“ FIRE ××•×ª×× (×›×•×œ×œ ×—×•×‘×•×ª)" : "Adjusted FIRE Target (Including Debts)"),
                                                        totalMonthlyDebtPayments > 0 && React.createElement('div', { className: "text-xs text-red-600 mt-2" }, 
                                                            `${language === 'he' ? '×›×•×œ×œ ×ª×©×œ×•××™ ×—×•×‘×•×ª ×—×•×“×©×™×™×:' : 'Including monthly debt payments:'} ${formatCurrency(totalMonthlyDebtPayments)}`)
                                                    ];
                                                })()
                                            ])
                                        ]),
                                        
                                        // Calculate years to FIRE based on current savings rate INCLUDING DEBTS
                                        (() => {
                                            const currentTotalAssets = inputs.currentSavings + inputs.currentTrainingFund + inputs.currentPersonalPortfolio + inputs.currentCrypto + inputs.currentRealEstate;
                                            const totalDebts = inputs.mortgageBalance + inputs.personalLoans + inputs.creditCardDebt + inputs.otherDebts;
                                            const currentNetWorth = currentTotalAssets - totalDebts;
                                            
                                            const monthlyTotalSavings = workPeriods.reduce((sum, period) => {
                                                if (inputs.currentAge >= period.startAge && inputs.currentAge <= period.endAge) {
                                                    return sum + period.monthlyContribution + period.monthlyTrainingFund;
                                                }
                                                return sum;
                                            }, 0) + inputs.personalPortfolioMonthly + inputs.cryptoMonthly + inputs.realEstateMonthly;
                                            
                                            const totalMonthlyDebtPayments = inputs.mortgageMonthlyPayment + inputs.personalLoansMonthly + inputs.creditCardMonthly + inputs.otherDebtsMonthly;
                                            const netMonthlySavings = monthlyTotalSavings - totalMonthlyDebtPayments;
                                            
                                            // FIRE target includes debt payoff + living expenses
                                            const fireMonthlyExpensesWithDebt = inputs.fireMonthlyExpenses + totalMonthlyDebtPayments;
                                            const fireTarget = fireMonthlyExpensesWithDebt * 12 * (100 / inputs.fireSafeWithdrawlRate);
                                            const remainingNeeded = Math.max(0, fireTarget - currentNetWorth);
                                            const yearsToFire = netMonthlySavings > 0 ? remainingNeeded / (netMonthlySavings * 12) : Infinity;
                                            const fireAge = inputs.currentAge + yearsToFire;
                                            
                                            return React.createElement('div', { className: "space-y-3" }, [
                                                React.createElement('div', { className: "bg-blue-50 rounded-lg p-3" }, [
                                                    React.createElement('div', { className: "text-lg font-bold text-blue-700 currency-format" }, 
                                                        formatCurrency(currentNetWorth)),
                                                    React.createElement('div', { className: "text-xs text-gray-600" }, 
                                                        language === 'he' ? "×©×•×•×™ × ×˜×• × ×•×›×—×™ (××—×¨×™ ×—×•×‘×•×ª)" : "Current Net Worth (After Debts)"),
                                                    totalDebts > 0 && React.createElement('div', { className: "text-xs text-red-600 mt-1" }, 
                                                        `${language === 'he' ? '×—×•×‘×•×ª:' : 'Debts:'} ${formatCurrency(totalDebts)}`)
                                                ]),
                                                
                                                React.createElement('div', { className: "bg-green-50 rounded-lg p-3" }, [
                                                    React.createElement('div', { className: "text-lg font-bold text-green-700 currency-format" }, 
                                                        formatCurrency(netMonthlySavings)),
                                                    React.createElement('div', { className: "text-xs text-gray-600" }, 
                                                        language === 'he' ? "×—×™×¡×›×•×Ÿ ×—×•×“×©×™ × ×˜×• (××—×¨×™ ×ª×©×œ×•××™ ×—×•×‘×•×ª)" : "Net Monthly Savings (After Debt Payments)"),
                                                    totalMonthlyDebtPayments > 0 && React.createElement('div', { className: "text-xs text-red-600 mt-1" }, 
                                                        `${language === 'he' ? '×ª×©×œ×•××™ ×—×•×‘×•×ª:' : 'Debt payments:'} ${formatCurrency(totalMonthlyDebtPayments)}`)
                                                ]),
                                                
                                                React.createElement('div', { 
                                                    className: `p-3 rounded-lg ${fireAge <= inputs.fireTargetAge ? 'bg-green-50 border-green-200' : 'bg-yellow-50 border-yellow-200'}` 
                                                }, [
                                                    React.createElement('div', { className: "font-bold text-lg" }, 
                                                        isFinite(yearsToFire) 
                                                            ? (language === 'he' ? `×’×™×œ FIRE ×¦×¤×•×™: ${Math.round(fireAge)}` : `Expected FIRE Age: ${Math.round(fireAge)}`)
                                                            : (language === 'he' ? "× ×“×¨×© ×œ×”×’×“×™×œ ×—×™×¡×›×•×Ÿ ×—×•×“×©×™" : "Need to increase monthly savings")),
                                                    React.createElement('div', { className: "text-sm text-gray-600" }, 
                                                        isFinite(yearsToFire) 
                                                            ? (language === 'he' ? `×¢×•×“ ${Math.round(yearsToFire)} ×©× ×™×` : `${Math.round(yearsToFire)} years to go`)
                                                            : (language === 'he' ? "×‘×§×¦×‘ ×”× ×•×›×—×™ ×œ× × ×™×ª×Ÿ ×œ×”×©×™×’ FIRE" : "Current rate won't achieve FIRE"))
                                                ])
                                            ]);
                                        })()
                                    ])
                                ]),
                                
                                // Debts and Liabilities Section
                                React.createElement('div', { className: "mt-8 space-y-4" }, [
                                    React.createElement('h3', { className: "text-xl font-bold text-red-700 mb-6 flex items-center" }, [
                                        React.createElement('span', { className: "mr-2" }, "ğŸ’³"),
                                        t.debtsAndLiabilities
                                    ]),
                                    
                                    React.createElement('div', { className: "bg-red-50 rounded-lg p-4 mb-6 border border-red-200" }, [
                                        React.createElement('p', { className: "text-sm text-red-700 mb-2" }, [
                                            React.createElement('strong', null, 
                                                language === 'he' ? "×—×©×•×‘ ×œ×–×›×•×¨:" : "Important to Remember:"),
                                            React.createElement('span', { className: "block mt-1" }, 
                                                language === 'he' ? "×”×ª×—×™×™×‘×•×™×•×ª ×•×”×œ×•×•××•×ª ××©×¤×™×¢×•×ª ×¢×œ ×™×›×•×œ×ª ×”×”×©×§×¢×” ×•×¢×œ ×”×—×™×©×•×‘ ×©×œ FIRE" : "Debts and liabilities affect investment capacity and FIRE calculations")
                                        ])
                                    ]),
                                    
                                    React.createElement('div', { className: "grid md:grid-cols-2 lg:grid-cols-3 gap-4" }, [
                                        // Mortgage
                                        React.createElement('div', { className: "bg-white rounded-lg p-4 border border-gray-200" }, [
                                            React.createElement('h4', { className: "font-bold text-gray-800 mb-3 flex items-center" }, [
                                                React.createElement('span', { className: "mr-2" }, "ğŸ "),
                                                language === 'he' ? "××©×›× ×ª×" : "Mortgage"
                                            ]),
                                            React.createElement('div', { className: "space-y-3" }, [
                                                React.createElement('div', null, [
                                                    React.createElement('label', { className: "block text-xs font-medium text-gray-600 mb-1" }, t.mortgageBalance),
                                                    React.createElement('input', {
                                                        type: 'number',
                                                        value: inputs.mortgageBalance,
                                                        onChange: (e) => setInputs({...inputs, mortgageBalance: parseInt(e.target.value) || 0}),
                                                        className: "w-full p-2 border border-gray-300 rounded text-sm focus:ring-1 focus:ring-red-500"
                                                    })
                                                ]),
                                                React.createElement('div', null, [
                                                    React.createElement('label', { className: "block text-xs font-medium text-gray-600 mb-1" }, t.mortgageMonthlyPayment),
                                                    React.createElement('input', {
                                                        type: 'number',
                                                        value: inputs.mortgageMonthlyPayment,
                                                        onChange: (e) => setInputs({...inputs, mortgageMonthlyPayment: parseInt(e.target.value) || 0}),
                                                        className: "w-full p-2 border border-gray-300 rounded text-sm focus:ring-1 focus:ring-red-500"
                                                    })
                                                ]),
                                                React.createElement('div', null, [
                                                    React.createElement('label', { className: "block text-xs font-medium text-gray-600 mb-1" }, t.mortgageRemainingYears),
                                                    React.createElement('input', {
                                                        type: 'number',
                                                        value: inputs.mortgageRemainingYears,
                                                        onChange: (e) => setInputs({...inputs, mortgageRemainingYears: parseInt(e.target.value) || 0}),
                                                        className: "w-full p-2 border border-gray-300 rounded text-sm focus:ring-1 focus:ring-red-500"
                                                    })
                                                ])
                                            ])
                                        ]),
                                        
                                        // Personal Loans
                                        React.createElement('div', { className: "bg-white rounded-lg p-4 border border-gray-200" }, [
                                            React.createElement('h4', { className: "font-bold text-gray-800 mb-3 flex items-center" }, [
                                                React.createElement('span', { className: "mr-2" }, "ğŸ’°"),
                                                language === 'he' ? "×”×œ×•×•××•×ª ××™×©×™×•×ª" : "Personal Loans"
                                            ]),
                                            React.createElement('div', { className: "space-y-3" }, [
                                                React.createElement('div', null, [
                                                    React.createElement('label', { className: "block text-xs font-medium text-gray-600 mb-1" }, t.personalLoans),
                                                    React.createElement('input', {
                                                        type: 'number',
                                                        value: inputs.personalLoans,
                                                        onChange: (e) => setInputs({...inputs, personalLoans: parseInt(e.target.value) || 0}),
                                                        className: "w-full p-2 border border-gray-300 rounded text-sm focus:ring-1 focus:ring-red-500"
                                                    })
                                                ]),
                                                React.createElement('div', null, [
                                                    React.createElement('label', { className: "block text-xs font-medium text-gray-600 mb-1" }, t.personalLoansMonthly),
                                                    React.createElement('input', {
                                                        type: 'number',
                                                        value: inputs.personalLoansMonthly,
                                                        onChange: (e) => setInputs({...inputs, personalLoansMonthly: parseInt(e.target.value) || 0}),
                                                        className: "w-full p-2 border border-gray-300 rounded text-sm focus:ring-1 focus:ring-red-500"
                                                    })
                                                ])
                                            ])
                                        ]),
                                        
                                        // Credit Cards & Other
                                        React.createElement('div', { className: "bg-white rounded-lg p-4 border border-gray-200" }, [
                                            React.createElement('h4', { className: "font-bold text-gray-800 mb-3 flex items-center" }, [
                                                React.createElement('span', { className: "mr-2" }, "ğŸ’³"),
                                                language === 'he' ? "××©×¨××™ ×•××—×¨×™×" : "Credit & Other"
                                            ]),
                                            React.createElement('div', { className: "space-y-3" }, [
                                                React.createElement('div', null, [
                                                    React.createElement('label', { className: "block text-xs font-medium text-gray-600 mb-1" }, t.creditCardDebt),
                                                    React.createElement('input', {
                                                        type: 'number',
                                                        value: inputs.creditCardDebt,
                                                        onChange: (e) => setInputs({...inputs, creditCardDebt: parseInt(e.target.value) || 0}),
                                                        className: "w-full p-2 border border-gray-300 rounded text-sm focus:ring-1 focus:ring-red-500"
                                                    })
                                                ]),
                                                React.createElement('div', null, [
                                                    React.createElement('label', { className: "block text-xs font-medium text-gray-600 mb-1" }, t.creditCardMonthly),
                                                    React.createElement('input', {
                                                        type: 'number',
                                                        value: inputs.creditCardMonthly,
                                                        onChange: (e) => setInputs({...inputs, creditCardMonthly: parseInt(e.target.value) || 0}),
                                                        className: "w-full p-2 border border-gray-300 rounded text-sm focus:ring-1 focus:ring-red-500"
                                                    })
                                                ]),
                                                React.createElement('div', null, [
                                                    React.createElement('label', { className: "block text-xs font-medium text-gray-600 mb-1" }, t.otherDebts),
                                                    React.createElement('input', {
                                                        type: 'number',
                                                        value: inputs.otherDebts,
                                                        onChange: (e) => setInputs({...inputs, otherDebts: parseInt(e.target.value) || 0}),
                                                        className: "w-full p-2 border border-gray-300 rounded text-sm focus:ring-1 focus:ring-red-500"
                                                    })
                                                ])
                                            ])
                                        ])
                                    ]),
                                    
                                    // Debt Summary
                                    React.createElement('div', { className: "bg-gradient-to-r from-red-100 to-orange-100 rounded-xl p-4 border border-red-200 mt-6" }, [
                                        React.createElement('h4', { className: "font-bold text-red-800 mb-3" }, 
                                            language === 'he' ? "×¡×™×›×•× ×”×ª×—×™×™×‘×•×™×•×ª" : "Debt Summary"),
                                        (() => {
                                            const totalDebts = inputs.mortgageBalance + inputs.personalLoans + inputs.creditCardDebt + inputs.otherDebts;
                                            const totalMonthlyPayments = inputs.mortgageMonthlyPayment + inputs.personalLoansMonthly + inputs.creditCardMonthly + inputs.otherDebtsMonthly;
                                            const currentTotalAssets = inputs.currentSavings + inputs.currentTrainingFund + inputs.currentPersonalPortfolio + inputs.currentCrypto + inputs.currentRealEstate;
                                            const netWorth = currentTotalAssets - totalDebts;
                                            
                                            return React.createElement('div', { className: "grid md:grid-cols-3 gap-4" }, [
                                                React.createElement('div', { className: "text-center" }, [
                                                    React.createElement('div', { className: "text-xl font-bold text-red-700 currency-format" }, 
                                                        formatCurrency(totalDebts)),
                                                    React.createElement('div', { className: "text-xs text-gray-600" }, t.totalDebts)
                                                ]),
                                                React.createElement('div', { className: "text-center" }, [
                                                    React.createElement('div', { className: "text-xl font-bold text-orange-700 currency-format" }, 
                                                        formatCurrency(totalMonthlyPayments)),
                                                    React.createElement('div', { className: "text-xs text-gray-600" }, t.totalMonthlyDebtPayments)
                                                ]),
                                                React.createElement('div', { className: "text-center" }, [
                                                    React.createElement('div', { 
                                                        className: `text-xl font-bold currency-format ${netWorth >= 0 ? 'text-green-700' : 'text-red-700'}` 
                                                    }, formatCurrency(netWorth)),
                                                    React.createElement('div', { className: "text-xs text-gray-600" }, t.netWorthAfterDebts)
                                                ])
                                            ]);
                                        })()
                                    ])
                                ])
                            ]),

                            // Stress Testing Tab
                            activeTab === 'stresstest' && React.createElement('div', { className: "space-y-6" }, [
                                React.createElement('div', { className: "glass-effect rounded-2xl shadow-xl p-6 border border-white/20 animate-fade-in" }, [
                                    React.createElement('h2', { className: "text-2xl font-bold text-red-600 mb-6 flex items-center" }, [
                                        React.createElement(Zap, { className: "mr-2" }),
                                        language === 'he' ? "××‘×—× ×™ ×¢××™×“×•×ª ×›×œ×›×œ×™×™×" : "Economic Stress Testing"
                                    ]),
                                    React.createElement('div', { className: "bg-red-50 rounded-lg p-4 mb-6 border border-red-200" }, [
                                        React.createElement('p', { className: "text-sm text-red-700 mb-2" }, [
                                            React.createElement('strong', null, 
                                                language === 'he' ? "××˜×¨×ª ×”××‘×—×Ÿ:" : "Purpose of Testing:"),
                                            React.createElement('span', { className: "block mt-1" }, 
                                                language === 'he' ? "×‘×—×™× ×ª ×—×•×¡×Ÿ ×”×ª×›× ×™×ª ×”×¤×™× × ×¡×™×ª ××•×œ ××©×‘×¨×™× ×›×œ×›×œ×™×™× ×•×ª×¨×—×™×©×™ ×§×™×¦×•×Ÿ" : "Evaluate financial plan resilience against economic crises and extreme scenarios")
                                        ])
                                    ]),

                                    // Predefined Stress Test Scenarios
                                    React.createElement('div', { className: "grid md:grid-cols-2 gap-6" }, [
                                        React.createElement('div', { className: "space-y-4" }, [
                                            React.createElement('h3', { className: "text-xl font-bold text-gray-800 mb-4" }, 
                                                language === 'he' ? "×ª×¨×—×™×©×™ ××©×‘×¨ ××•×’×“×¨×™× ××¨××©" : "Predefined Crisis Scenarios"),
                                            
                                            // Scenario 1: 2008-style Financial Crisis
                                            React.createElement('div', { className: "bg-white rounded-lg p-4 border border-gray-200 hover:shadow-md transition-shadow" }, [
                                                React.createElement('div', { className: "flex items-center mb-3" }, [
                                                    React.createElement('span', { className: "text-2xl mr-3" }, "ğŸ¦"),
                                                    React.createElement('h4', { className: "font-bold text-gray-800" }, 
                                                        language === 'he' ? "××©×‘×¨ ×¤×™× × ×¡×™ 2008" : "2008 Financial Crisis")
                                                ]),
                                                React.createElement('ul', { className: "text-sm text-gray-600 space-y-1 mb-3" }, [
                                                    React.createElement('li', null, language === 'he' ? "â€¢ ×™×¨×™×“×” ×©×œ 40% ×‘×× ×™×•×ª" : "â€¢ 40% stock market decline"),
                                                    React.createElement('li', null, language === 'he' ? "â€¢ ×™×¨×™×“×” ×©×œ 30% ×‘× ×“×œ×´×Ÿ" : "â€¢ 30% real estate decline"),
                                                    React.createElement('li', null, language === 'he' ? "â€¢ ×¢×œ×™×™×” ×‘××‘×˜×œ×” ×œ-10%" : "â€¢ Unemployment rises to 10%"),
                                                    React.createElement('li', null, language === 'he' ? "â€¢ ×ª×©×•××•×ª × ××•×›×•×ª ×œ××©×š 3 ×©× ×™×" : "â€¢ Low returns for 3 years")
                                                ]),
                                                React.createElement('button', {
                                                    onClick: () => {
                                                        console.log('Financial Crisis button clicked');
                                                        runStressTest('financial_crisis_2008');
                                                    },
                                                    className: "w-full bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors"
                                                }, language === 'he' ? "×”×¨×¥ ××‘×—×Ÿ" : "Run Test")
                                            ]),

                                            // Scenario 2: COVID-19 Pandemic
                                            React.createElement('div', { className: "bg-white rounded-lg p-4 border border-gray-200 hover:shadow-md transition-shadow" }, [
                                                React.createElement('div', { className: "flex items-center mb-3" }, [
                                                    React.createElement('span', { className: "text-2xl mr-3" }, "ğŸ¦ "),
                                                    React.createElement('h4', { className: "font-bold text-gray-800" }, 
                                                        language === 'he' ? "××©×‘×¨ ×§×•×¨×•× ×” 2020" : "COVID-19 Pandemic 2020")
                                                ]),
                                                React.createElement('ul', { className: "text-sm text-gray-600 space-y-1 mb-3" }, [
                                                    React.createElement('li', null, language === 'he' ? "â€¢ ×™×¨×™×“×ª ×”×›× ×¡×” ×©×œ 25%" : "â€¢ 25% income reduction"),
                                                    React.createElement('li', null, language === 'he' ? "â€¢ ×ª× ×•×“×ª×™×•×ª ×’×‘×•×”×” ×‘×©×•×•×§×™×" : "â€¢ High market volatility"),
                                                    React.createElement('li', null, language === 'he' ? "â€¢ ×¢×œ×™×™×” ×‘×”×•×¦××•×ª ×¨×¤×•××™×•×ª" : "â€¢ Increased medical expenses"),
                                                    React.createElement('li', null, language === 'he' ? "â€¢ ×”×ª××•×©×©×•×ª ×‘××©×š ×©× ×ª×™×™×" : "â€¢ Recovery over two years")
                                                ]),
                                                React.createElement('button', {
                                                    onClick: () => {
                                                        console.log('COVID Pandemic button clicked');
                                                        runStressTest('covid_pandemic');
                                                    },
                                                    className: "w-full bg-orange-500 text-white px-4 py-2 rounded-lg hover:bg-orange-600 transition-colors"
                                                }, language === 'he' ? "×”×¨×¥ ××‘×—×Ÿ" : "Run Test")
                                            ]),

                                            // Scenario 3: Hyperinflation
                                            React.createElement('div', { className: "bg-white rounded-lg p-4 border border-gray-200 hover:shadow-md transition-shadow" }, [
                                                React.createElement('div', { className: "flex items-center mb-3" }, [
                                                    React.createElement('span', { className: "text-2xl mr-3" }, "ğŸ“ˆ"),
                                                    React.createElement('h4', { className: "font-bold text-gray-800" }, 
                                                        language === 'he' ? "××™× ×¤×œ×¦×™×” ×’×‘×•×”×”" : "High Inflation Scenario")
                                                ]),
                                                React.createElement('ul', { className: "text-sm text-gray-600 space-y-1 mb-3" }, [
                                                    React.createElement('li', null, language === 'he' ? "â€¢ ××™× ×¤×œ×¦×™×” ×©×œ 15% ×œ×©× ×”" : "â€¢ 15% annual inflation"),
                                                    React.createElement('li', null, language === 'he' ? "â€¢ ×¢×œ×™×™×ª ××—×™×¨×™ ××–×•×Ÿ ×•×“×œ×§" : "â€¢ Rising food & fuel prices"),
                                                    React.createElement('li', null, language === 'he' ? "â€¢ ×™×¨×™×“×” ×‘×›×•×— ×”×§× ×™×™×”" : "â€¢ Decreased purchasing power"),
                                                    React.createElement('li', null, language === 'he' ? "â€¢ ×”×—××¨×” ×‘××©×š 5 ×©× ×™×" : "â€¢ Deterioration over 5 years")
                                                ]),
                                                React.createElement('button', {
                                                    onClick: () => {
                                                        console.log('High Inflation button clicked');
                                                        runStressTest('high_inflation');
                                                    },
                                                    className: "w-full bg-yellow-500 text-white px-4 py-2 rounded-lg hover:bg-yellow-600 transition-colors"
                                                }, language === 'he' ? "×”×¨×¥ ××‘×—×Ÿ" : "Run Test")
                                            ])
                                        ]),

                                        React.createElement('div', { className: "space-y-4" }, [
                                            React.createElement('h3', { className: "text-xl font-bold text-gray-800 mb-4" }, 
                                                language === 'he' ? "×ª×¨×—×™×© ××•×ª×× ××™×©×™×ª" : "Custom Scenario"),
                                            
                                            React.createElement('div', { className: "bg-white rounded-lg p-4 border border-gray-200" }, [
                                                React.createElement('div', { className: "space-y-4" }, [
                                                    React.createElement('div', null, [
                                                        React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-1" }, 
                                                            language === 'he' ? "×™×¨×™×“×ª ×”×›× ×¡×” (%)" : "Income Reduction (%)"),
                                                        React.createElement('input', {
                                                            type: 'number',
                                                            min: '0',
                                                            max: '100',
                                                            defaultValue: '20',
                                                            id: 'custom-income-reduction',
                                                            className: "w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent transition-all"
                                                        })
                                                    ]),
                                                    React.createElement('div', null, [
                                                        React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-1" }, 
                                                            language === 'he' ? "×™×¨×™×“×” ×‘×ª×™×§ ×”×©×§×¢×•×ª (%)" : "Investment Portfolio Decline (%)"),
                                                        React.createElement('input', {
                                                            type: 'number',
                                                            min: '0',
                                                            max: '100',
                                                            defaultValue: '30',
                                                            id: 'custom-portfolio-decline',
                                                            className: "w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent transition-all"
                                                        })
                                                    ]),
                                                    React.createElement('div', null, [
                                                        React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-1" }, 
                                                            language === 'he' ? "×¢×œ×™×™×” ×‘××™× ×¤×œ×¦×™×” (%)" : "Inflation Increase (%)"),
                                                        React.createElement('input', {
                                                            type: 'number',
                                                            min: '0',
                                                            max: '50',
                                                            defaultValue: '8',
                                                            id: 'custom-inflation-increase',
                                                            className: "w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent transition-all"
                                                        })
                                                    ]),
                                                    React.createElement('div', null, [
                                                        React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-1" }, 
                                                            language === 'he' ? "××©×š ×”××©×‘×¨ (×©× ×™×)" : "Crisis Duration (years)"),
                                                        React.createElement('input', {
                                                            type: 'number',
                                                            min: '1',
                                                            max: '10',
                                                            defaultValue: '3',
                                                            id: 'custom-crisis-duration',
                                                            className: "w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent transition-all"
                                                        })
                                                    ]),
                                                    React.createElement('button', {
                                                        onClick: () => runCustomStressTest(),
                                                        className: "w-full bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600 transition-colors mt-4"
                                                    }, language === 'he' ? "×”×¨×¥ ××‘×—×Ÿ ××•×ª××" : "Run Custom Test")
                                                ])
                                            ]),

                                            // Claude AI Scenario Generation
                                            React.createElement('div', { className: "bg-gradient-to-r from-indigo-50 to-purple-50 rounded-lg p-4 border border-indigo-200" }, [
                                                React.createElement('div', { className: "flex items-center mb-3" }, [
                                                    React.createElement('span', { className: "text-2xl mr-3" }, "ğŸ¤–"),
                                                    React.createElement('h4', { className: "font-bold text-indigo-800" }, 
                                                        language === 'he' ? "×ª×¨×—×™×© ×—×›× ××•×ª××" : "AI-Powered Custom Scenario")
                                                ]),
                                                React.createElement('p', { className: "text-sm text-indigo-700 mb-3" }, 
                                                    language === 'he' 
                                                        ? "×ª××¨ ×‘××™×œ×™× ×©×œ×š ×ª×¨×—×™×© ×›×œ×›×œ×™ ×©××¢× ×™×™×Ÿ ××•×ª×š, ×•×§×œ××•×“ ×™×”×¤×•×š ××•×ª×• ×œ×¤×¨××˜×¨×™× ×•×™×¨×™×¥ ××ª ×”××‘×—×Ÿ"
                                                        : "Describe in your own words an economic scenario you're concerned about, and Claude will convert it to parameters and run the test"),
                                                
                                                React.createElement('div', { className: "space-y-3" }, [
                                                    React.createElement('textarea', {
                                                        id: 'ai-scenario-description',
                                                        placeholder: language === 'he' 
                                                            ? "×œ×“×•×’××”: '×™×¨×™×“×” ×‘×”×›× ×¡×•×ª ×©×œ 5% ×œ××©×š ×©× ×ª×™×™×' ××• '×”×›× ×¡×ª×™ ×ª×™×¨×“ ×‘-10% ×•×”×©×•×§ ×‘-20% ×œ××©×š 3 ×©× ×™×'"
                                                            : "Example: 'Income reduction of 5% for two years' or 'My income drops 10% and market 20% for 3 years'",
                                                        rows: 3,
                                                        className: "w-full p-3 border border-indigo-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent resize-none text-sm",
                                                        style: { direction: language === 'he' ? 'rtl' : 'ltr' }
                                                    }),
                                                    
                                                    React.createElement('div', { className: "flex gap-2" }, [
                                                        React.createElement('button', {
                                                            onClick: () => generateAIScenarioFromDescription(),
                                                            className: "flex-1 bg-indigo-500 text-white px-4 py-2 rounded-lg hover:bg-indigo-600 transition-colors text-sm"
                                                        }, language === 'he' ? "×¦×•×¨ ×•×‘×¦×¢ ××‘×—×Ÿ" : "Create & Run Test"),
                                                        
                                                        React.createElement('button', {
                                                            onClick: () => fillExampleScenario(),
                                                            className: "px-3 py-2 bg-indigo-100 text-indigo-700 rounded-lg hover:bg-indigo-200 transition-colors text-sm"
                                                        }, language === 'he' ? "×“×•×’××”" : "Example")
                                                    ])
                                                ]),
                                                
                                                aiScenarioLoading && React.createElement('div', { className: "mt-3 flex items-center justify-center text-indigo-600" }, [
                                                    React.createElement('div', { className: "animate-spin rounded-full h-4 w-4 border-b-2 border-indigo-600 mr-2" }),
                                                    React.createElement('span', { className: "text-sm" }, 
                                                        language === 'he' ? "×§×œ××•×“ ×× ×ª×— ××ª ×”×ª×¨×—×™×©..." : "Claude is analyzing the scenario...")
                                                ])
                                            ])
                                        ])
                                    ])
                                ]),

                                // Stress Test Results Section (will appear after running tests)
                                stressTestResults && React.createElement('div', { id: "stress-test-results", className: "glass-effect rounded-2xl shadow-xl p-6 border border-white/20 animate-fade-in" }, [
                                    React.createElement('h3', { className: "text-xl font-bold text-red-700 mb-6 flex items-center" }, [
                                        React.createElement('span', { className: "mr-2" }, "ğŸ“Š"),
                                        language === 'he' ? "×ª×•×¦××•×ª ××‘×—×Ÿ ×”×¢××™×“×•×ª" : "Stress Test Results"
                                    ]),
                                    React.createElement('div', { className: "space-y-6" }, [
                                        // Detailed Crisis Explanation Section
                                        React.createElement('div', { className: "bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-6 mb-6 border border-blue-200" }, [
                                            React.createElement('h4', { className: "font-bold text-blue-800 mb-4 flex items-center" }, [
                                                React.createElement('span', { className: "mr-2" }, "ğŸ”"),
                                                language === 'he' ? "×”×¡×‘×¨ ××¤×•×¨×˜ ×¢×œ ×”××©×‘×¨ ×•×”×©×¤×¢×•×ª×™×•" : "Detailed Crisis Explanation and Impact"
                                            ]),
                                            (() => {
                                                // Generate dynamic explanations
                                                const dynamicExplanation = generateDynamicCrisisExplanation(stressTestResults.scenario, inputs, language);
                                                
                                                return React.createElement('div', { className: "space-y-4" }, [
                                                    // Crisis Methodology Explanation - Dynamic
                                                    React.createElement('div', { className: "bg-white rounded-lg p-4 border border-blue-100" }, [
                                                        React.createElement('h5', { className: "font-semibold text-blue-700 mb-2" }, 
                                                            language === 'he' ? "ğŸ“ˆ ××•×¤×Ÿ ×—×™×©×•×‘ ×”×©×¤×¢×•×ª ×”××©×‘×¨:" : "ğŸ“ˆ How Crisis Impacts Are Calculated:"),
                                                        React.createElement('ul', { className: "text-sm text-blue-600 space-y-2" }, 
                                                            dynamicExplanation.methodology.map((item, index) => 
                                                                React.createElement('li', { key: index, className: "flex items-start" }, [
                                                                    React.createElement('span', { className: "mr-2 text-blue-400" }, `${index + 1}.`),
                                                                    React.createElement('div', null, [
                                                                        React.createElement('strong', null, item.phase),
                                                                        React.createElement('span', { className: "block mt-1" }, item.description)
                                                                    ])
                                                                ])
                                                            )
                                                        )
                                                    ]),
                                                    
                                                    // Real World Context - Dynamic
                                                    React.createElement('div', { className: "bg-white rounded-lg p-4 border border-blue-100" }, [
                                                        React.createElement('h5', { className: "font-semibold text-blue-700 mb-2" }, 
                                                            language === 'he' ? "ğŸŒ ×”×§×©×¨ ×”×™×¡×˜×•×¨×™:" : "ğŸŒ Historical Context:"),
                                                        React.createElement('div', { className: "text-sm text-blue-600" }, dynamicExplanation.historicalContext)
                                                    ])
                                                ]);
                                            })()
                                        ]),
                                        
                                        // Scenario Overview
                                        React.createElement('div', { className: "bg-gray-50 rounded-lg p-4" }, [
                                            React.createElement('h4', { className: "font-bold text-gray-800 mb-2" }, 
                                                language === 'he' ? "×ª×¨×—×™×© ×©× ×‘×“×§:" : "Tested Scenario:"),
                                            React.createElement('p', { className: "text-gray-700" }, stressTestResults.scenarioDescription)
                                        ]),

                                        // Before vs After Comparison - Enhanced with difference indicators
                                        React.createElement('div', { className: "grid md:grid-cols-2 gap-6" }, [
                                            React.createElement('div', { className: "bg-green-50 rounded-lg p-4 border border-green-200" }, [
                                                React.createElement('h4', { className: "font-bold text-green-800 mb-3" }, 
                                                    language === 'he' ? "ğŸ“ˆ ××¦×‘ ×¨×’×™×œ" : "ğŸ“ˆ Normal Conditions"),
                                                React.createElement('div', { className: "space-y-2 text-sm" }, [
                                                    React.createElement('div', { className: "flex justify-between" }, [
                                                        React.createElement('span', null, language === 'he' ? "×”×›× ×¡×” ×—×•×“×©×™×ª:" : "Monthly Income:"),
                                                        React.createElement('span', { className: "font-semibold" }, formatCurrency(stressTestResults.normal.monthlyIncome))
                                                    ]),
                                                    React.createElement('div', { className: "flex justify-between" }, [
                                                        React.createElement('span', null, language === 'he' ? "×¦×‘×™×¨×” ×‘×¤×¨×™×©×”:" : "Retirement Accumulation:"),
                                                        React.createElement('span', { className: "font-semibold" }, formatCurrency(stressTestResults.normal.totalAccumulation))
                                                    ]),
                                                    React.createElement('div', { className: "flex justify-between" }, [
                                                        React.createElement('span', null, language === 'he' ? "×¢×•××“ ×‘×™×¢×“:" : "Meets Target:"),
                                                        React.createElement('span', { 
                                                            className: `font-semibold ${stressTestResults.normal.achievesTarget ? 'text-green-600' : 'text-red-600'}`
                                                        }, stressTestResults.normal.achievesTarget ? 'âœ…' : 'âŒ')
                                                    ])
                                                ])
                                            ]),
                                            React.createElement('div', { className: "bg-red-50 rounded-lg p-4 border border-red-200" }, [
                                                React.createElement('h4', { className: "font-bold text-red-800 mb-3" }, 
                                                    language === 'he' ? "âš ï¸ ×‘××©×‘×¨" : "âš ï¸ Under Stress"),
                                                React.createElement('div', { className: "space-y-2 text-sm" }, [
                                                    React.createElement('div', { className: "flex justify-between items-center" }, [
                                                        React.createElement('span', null, language === 'he' ? "×”×›× ×¡×” ×—×•×“×©×™×ª:" : "Monthly Income:"),
                                                        React.createElement('div', { className: "text-right" }, [
                                                            React.createElement('div', { className: "font-semibold" }, formatCurrency(stressTestResults.stressed.monthlyIncome)),
                                                            React.createElement('div', { className: "text-xs text-red-600" }, 
                                                                stressTestResults.normal.monthlyIncome > 0 ? 
                                                                `${((stressTestResults.stressed.monthlyIncome - stressTestResults.normal.monthlyIncome) / stressTestResults.normal.monthlyIncome * 100).toFixed(1)}%` : 
                                                                '0%')
                                                        ])
                                                    ]),
                                                    React.createElement('div', { className: "flex justify-between items-center" }, [
                                                        React.createElement('span', null, language === 'he' ? "×¦×‘×™×¨×” ×‘×¤×¨×™×©×”:" : "Retirement Accumulation:"),
                                                        React.createElement('div', { className: "text-right" }, [
                                                            React.createElement('div', { className: "font-semibold" }, formatCurrency(stressTestResults.stressed.totalAccumulation)),
                                                            React.createElement('div', { className: "text-xs text-red-600" }, 
                                                                stressTestResults.normal.totalAccumulation > 0 ? 
                                                                `${((stressTestResults.stressed.totalAccumulation - stressTestResults.normal.totalAccumulation) / stressTestResults.normal.totalAccumulation * 100).toFixed(1)}%` : 
                                                                '0%')
                                                        ])
                                                    ]),
                                                    React.createElement('div', { className: "flex justify-between" }, [
                                                        React.createElement('span', null, language === 'he' ? "×¢×•××“ ×‘×™×¢×“:" : "Meets Target:"),
                                                        React.createElement('span', { 
                                                            className: `font-semibold ${stressTestResults.stressed.achievesTarget ? 'text-green-600' : 'text-red-600'}`
                                                        }, stressTestResults.stressed.achievesTarget ? 'âœ…' : 'âŒ')
                                                    ])
                                                ])
                                            ])
                                        ]),

                                        // Impact Analysis
                                        React.createElement('div', { className: "bg-yellow-50 rounded-lg p-4 border border-yellow-200" }, [
                                            React.createElement('h4', { className: "font-bold text-yellow-800 mb-3" }, 
                                                language === 'he' ? "ğŸ“‰ ×”×©×¤×¢×ª ×”××©×‘×¨" : "ğŸ“‰ Crisis Impact"),
                                            React.createElement('div', { className: "grid md:grid-cols-3 gap-4 text-sm" }, [
                                                React.createElement('div', { className: "text-center" }, [
                                                    React.createElement('div', { className: "text-2xl font-bold text-red-600" }, 
                                                        `${((stressTestResults.normal.totalAccumulation - stressTestResults.stressed.totalAccumulation) / stressTestResults.normal.totalAccumulation * 100).toFixed(1)}%`),
                                                    React.createElement('div', { className: "text-gray-600" }, 
                                                        language === 'he' ? "×™×¨×™×“×” ×‘×¦×‘×™×¨×”" : "Accumulation Drop")
                                                ]),
                                                React.createElement('div', { className: "text-center" }, [
                                                    React.createElement('div', { className: "text-2xl font-bold text-orange-600" }, 
                                                        formatCurrency(stressTestResults.normal.totalAccumulation - stressTestResults.stressed.totalAccumulation)),
                                                    React.createElement('div', { className: "text-gray-600" }, 
                                                        language === 'he' ? "×”×¤×¡×“ ×›×¡×¤×™" : "Financial Loss")
                                                ]),
                                                React.createElement('div', { className: "text-center" }, [
                                                    React.createElement('div', { className: "text-2xl font-bold text-blue-600" }, 
                                                        `${stressTestResults.recoveryYears || 'N/A'}`),
                                                    React.createElement('div', { className: "text-gray-600" }, 
                                                        language === 'he' ? "×©× ×•×ª ×”×ª××•×©×©×•×ª" : "Recovery Years")
                                                ])
                                            ])
                                        ]),

                                        // Crisis Timeline Chart
                                        (() => {
                                            const timelineData = generateCrisisTimelineData(stressTestResults.scenario, inputs, workPeriods);
                                            
                                            return React.createElement('div', { className: "bg-white rounded-lg p-6 border border-gray-200" }, [
                                                React.createElement('h4', { className: "font-bold text-gray-800 mb-4 flex items-center" }, [
                                                    React.createElement('span', { className: "mr-2" }, "ğŸ“ˆ"),
                                                    language === 'he' ? "×”×©×¤×¢×ª ×”××©×‘×¨ ×œ××•×¨×š ×”×©× ×™×" : "Crisis Impact Over Years"
                                                ]),
                                                React.createElement('div', { className: "h-80 mb-4" },
                                                    React.createElement(SimpleChart, { 
                                                        data: timelineData,
                                                        type: 'crisisTimeline',
                                                        language: language
                                                    })
                                                ),
                                                React.createElement('div', { className: "grid grid-cols-3 gap-4 text-center text-sm" }, [
                                                    React.createElement('div', { className: "bg-green-50 p-3 rounded-lg" }, [
                                                        React.createElement('div', { className: "font-semibold text-green-800" }, 
                                                            language === 'he' ? "×§×• ×™×¨×•×§ - ××¦×‘ ×¨×’×™×œ" : "Green Line - Normal"),
                                                        React.createElement('div', { className: "text-xs text-green-600 mt-1" }, 
                                                            language === 'he' ? "×¦×‘×™×¨×” ×œ×œ× ××©×‘×¨" : "Accumulation without crisis")
                                                    ]),
                                                    React.createElement('div', { className: "bg-red-50 p-3 rounded-lg" }, [
                                                        React.createElement('div', { className: "font-semibold text-red-800" }, 
                                                            language === 'he' ? "×§×• ××“×•× - ××¦×‘ ××©×‘×¨" : "Red Line - Crisis"),
                                                        React.createElement('div', { className: "text-xs text-red-600 mt-1" }, 
                                                            language === 'he' ? "×¦×‘×™×¨×” ×¢× ×”×©×¤×¢×ª ×”××©×‘×¨" : "Accumulation with crisis impact")
                                                    ]),
                                                    React.createElement('div', { className: "bg-yellow-50 p-3 rounded-lg" }, [
                                                        React.createElement('div', { className: "font-semibold text-yellow-800" }, 
                                                            language === 'he' ? `×©× ×•×ª ××©×‘×¨: ${stressTestResults.scenario?.duration || 0}` : `Crisis Years: ${stressTestResults.scenario?.duration || 0}`),
                                                        React.createElement('div', { className: "text-xs text-yellow-600 mt-1" }, 
                                                            language === 'he' ? "×ª×§×•×¤×ª ×”×¤×’×™×¢×” ×”×™×©×™×¨×”" : "Direct impact period")
                                                    ])
                                                ])
                                            ]);
                                        })(),

                                        // Stress Test Comparison Chart
                                        React.createElement('div', { className: "bg-white rounded-lg p-6 border border-gray-200" }, [
                                            React.createElement('h4', { className: "font-bold text-gray-800 mb-4 flex items-center" }, [
                                                React.createElement('span', { className: "mr-2" }, "ğŸ“Š"),
                                                language === 'he' ? "×’×¨×£ ×”×©×•×•××”: ×¨×’×™×œ ××•×œ ××©×‘×¨" : "Comparison Chart: Normal vs Crisis"
                                            ]),
                                            React.createElement('div', { className: "h-80 mb-4" },
                                                React.createElement(SimpleChart, { 
                                                    data: [
                                                        {
                                                            scenario: language === 'he' ? '××¦×‘ ×¨×’×™×œ' : 'Normal',
                                                            monthlyIncome: stressTestResults.normal.monthlyIncome,
                                                            totalAccumulation: stressTestResults.normal.totalAccumulation,
                                                            achievesTarget: stressTestResults.normal.achievesTarget ? 100 : 0
                                                        },
                                                        {
                                                            scenario: language === 'he' ? '×‘××©×‘×¨' : 'Crisis',
                                                            monthlyIncome: stressTestResults.stressed.monthlyIncome,
                                                            totalAccumulation: stressTestResults.stressed.totalAccumulation,
                                                            achievesTarget: stressTestResults.stressed.achievesTarget ? 100 : 0
                                                        }
                                                    ],
                                                    type: 'stressComparison',
                                                    language: language
                                                })
                                            ),
                                            React.createElement('div', { className: "grid grid-cols-3 gap-4 text-center text-sm" }, [
                                                React.createElement('div', { className: "bg-blue-50 p-3 rounded-lg" }, [
                                                    React.createElement('div', { className: "font-semibold text-blue-800" }, 
                                                        language === 'he' ? "×”×›× ×¡×” ×—×•×“×©×™×ª" : "Monthly Income"),
                                                    React.createElement('div', { className: "text-xs text-blue-600 mt-1" }, 
                                                        language === 'he' ? "×”×›× ×¡×” ×¦×¤×•×™×” ×‘×¤×¨×™×©×”" : "Expected retirement income")
                                                ]),
                                                React.createElement('div', { className: "bg-green-50 p-3 rounded-lg" }, [
                                                    React.createElement('div', { className: "font-semibold text-green-800" }, 
                                                        language === 'he' ? "×¦×‘×™×¨×” ×›×•×œ×œ×ª" : "Total Accumulation"),
                                                    React.createElement('div', { className: "text-xs text-green-600 mt-1" }, 
                                                        language === 'he' ? "×›×œ ×”×›×¡×£ ×©×™×¦×˜×‘×¨ ×¢×“ ×”×¤×¨×™×©×”" : "Total money accumulated by retirement")
                                                ]),
                                                React.createElement('div', { className: "bg-purple-50 p-3 rounded-lg" }, [
                                                    React.createElement('div', { className: "font-semibold text-purple-800" }, 
                                                        language === 'he' ? "×”×©×’×ª ×™×¢×“" : "Target Achievement"),
                                                    React.createElement('div', { className: "text-xs text-purple-600 mt-1" }, 
                                                        language === 'he' ? "×¢××™×“×” ×‘×™×¢×“ ×”×—×œ×¤×ª ×”×”×›× ×¡×”" : "Meeting income replacement target")
                                                ])
                                            ])
                                        ]),

                                        // Recommendations
                                        React.createElement('div', { className: "bg-blue-50 rounded-lg p-4 border border-blue-200" }, [
                                            React.createElement('h4', { className: "font-bold text-blue-800 mb-3" }, 
                                                language === 'he' ? "ğŸ’¡ ×”××œ×¦×•×ª ×œ×—×™×–×•×§" : "ğŸ’¡ Strengthening Recommendations"),
                                            React.createElement('ul', { className: "space-y-2 text-sm text-blue-700" }, 
                                                stressTestResults.recommendations.map((rec, index) => 
                                                    React.createElement('li', { key: index, className: "flex items-start" }, [
                                                        React.createElement('span', { className: "mr-2 mt-0.5" }, "â€¢"),
                                                        rec
                                                    ])
                                                )
                                            )
                                        ])
                                    ])
                                ])
                            ]),

                            activeTab === 'analysis' && React.createElement('div', { className: "glass-effect rounded-2xl shadow-xl p-6 border border-white/20 animate-fade-in" }, [
                                React.createElement('div', { className: "flex justify-between items-center mb-6" }, [
                                    React.createElement('h2', { className: "text-2xl font-bold text-blue-700 flex items-center" }, [
                                        React.createElement(BarChart3, { className: "mr-2" }),
                                        language === 'he' ? "ğŸ“ˆ ×ª×©×•××•×ª ×”×™×¡×˜×•×¨×™×•×ª ×‘××“×“×™× ××•×‘×™×œ×™×" : "ğŸ“ˆ Historical Index Returns"
                                    ]),
                                    React.createElement('div', { className: "flex items-center gap-3" }, [
                                        (indexDataLoading || exchangeRatesLoading || cryptoPricesLoading) && 
                                        React.createElement('div', { className: "flex items-center text-blue-600" }, [
                                            React.createElement('div', { className: "animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600 mr-2" }),
                                            React.createElement('span', { className: "text-sm" }, 
                                                language === 'he' ? "××¢×“×›×Ÿ × ×ª×•× ×™×..." : "Updating data...")
                                        ]),
                                        lastUpdated && React.createElement('div', { className: "text-xs text-gray-500" }, [
                                            React.createElement('div', null, language === 'he' ? "×¢×“×›×•×Ÿ ××—×¨×•×Ÿ:" : "Last update:"),
                                            React.createElement('div', null, lastUpdated.toLocaleString())
                                        ])
                                    ])
                                ]),
                                React.createElement('div', { className: "mb-6" }, [
                                    React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-3" }, t.timeHorizon),
                                    React.createElement('div', { className: "flex flex-wrap gap-2" }, [5, 10, 15, 20, 25, 30].map(years =>
                                        React.createElement('button', {
                                            key: years,
                                            onClick: () => setSelectedTimeHorizon(years),
                                            className: `px-4 py-2 rounded-lg transition-all ${
                                                selectedTimeHorizon === years
                                                    ? 'bg-blue-500 text-white shadow-lg'
                                                    : 'bg-gray-100 hover:bg-blue-100'
                                            }`
                                        }, `${years} ${t.years}`)
                                    ))
                                ]),
                                
                                // API Data Source Indicator
                                !indexDataLoading && Object.keys(historicalReturns).length > 0 && React.createElement('div', { 
                                    className: "bg-gradient-to-r from-green-50 to-blue-50 rounded-lg p-3 mb-4 border border-green-200" 
                                }, [
                                    React.createElement('div', { className: "flex items-center text-green-800" }, [
                                        React.createElement('div', { className: "w-2 h-2 bg-green-500 rounded-full mr-2 animate-pulse" }),
                                        React.createElement('span', { className: "text-sm font-medium" }, 
                                            language === 'he' 
                                                ? (lastUpdated ? "ğŸ“Š × ×ª×•× ×™× ×¢×“×›× ×™×™× ×-API ×©×œ Google Finance ×•-Yahoo Finance" : "ğŸ“Š × ×ª×•× ×™× ×”×™×¡×˜×•×¨×™×™× (××ª×¢×“×›×Ÿ ×‘×¨×§×¢ ×-API)")
                                                : (lastUpdated ? "ğŸ“Š Live data from Google Finance & Yahoo Finance APIs" : "ğŸ“Š Historical data (updating from APIs in background)")),
                                        lastUpdated && React.createElement('span', { className: "text-xs text-gray-600 ml-2" }, 
                                            ` (${lastUpdated.toLocaleTimeString()})`)
                                    ])
                                ]),
                                
                                // Show loading or no data message
                                (!historicalReturns[selectedTimeHorizon] || Object.keys(historicalReturns[selectedTimeHorizon]).length === 0) ? 
                                React.createElement('div', { className: "text-center py-8" }, [
                                    indexDataLoading ? 
                                    React.createElement('div', { className: "flex flex-col items-center" }, [
                                        React.createElement('div', { className: "animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mb-4" }),
                                        React.createElement('p', { className: "text-gray-600" }, 
                                            language === 'he' ? "×˜×•×¢×Ÿ × ×ª×•× ×™× ×-API..." : "Loading data from APIs...")
                                    ]) :
                                    React.createElement('div', { className: "bg-yellow-50 border border-yellow-200 rounded-lg p-4" }, [
                                        React.createElement('p', { className: "text-yellow-800" }, 
                                            language === 'he' ? "âš ï¸ ××™×Ÿ × ×ª×•× ×™× ×–××™× ×™× ×œ×ª×§×•×¤×” ×–×•" : "âš ï¸ No data available for this time period")
                                    ])
                                ]) :
                                React.createElement('div', { className: "grid md:grid-cols-2 gap-4" }, 
                                    Object.entries(historicalReturns[selectedTimeHorizon]).map(([index, returnValue]) =>
                                        React.createElement('div', {
                                            key: index,
                                            className: "bg-gradient-to-r from-blue-50 to-cyan-50 rounded-xl p-4 border border-blue-200"
                                        }, [
                                            React.createElement('div', { className: "flex justify-between items-center mb-2" }, [
                                                React.createElement('h4', { className: "font-bold text-blue-800" }, 
                                                    indexNames[index] ? indexNames[index][language] : index),
                                                React.createElement('div', { className: "text-2xl font-bold text-green-600" }, `${returnValue.toFixed(1)}%`)
                                            ]),
                                            React.createElement('div', { className: "text-sm text-gray-600 mb-3" }, `Average annual return (${selectedTimeHorizon} years)`),
                                            React.createElement('button', {
                                                onClick: () => {
                                                    setInputs({...inputs, trainingFundReturn: returnValue});
                                                    alert(`Training fund return updated to ${returnValue}%`);
                                                },
                                                className: "text-xs bg-green-500 text-white px-2 py-1 rounded hover:bg-green-600 transition-colors"
                                            }, t.useThisReturn)
                                        ])
                                    )
                                ),
                                // Chart
                                React.createElement('div', { className: "mt-6 h-64" },
                                    React.createElement(SimpleChart, { 
                                        data: Object.entries(historicalReturns[selectedTimeHorizon]).map(([name, value]) => ({ 
                                            name: indexNames[name] ? indexNames[name][language] : name, 
                                            value 
                                        })),
                                        type: 'bar',
                                        language: language
                                    })
                                )
                            ])
                        ]),

                        // Right Column - Results
                        results && React.createElement('div', { className: "space-y-6" }, [
                            // Monthly Income
                            React.createElement('div', { className: "glass-effect rounded-2xl shadow-xl p-6 border border-white/20 animate-fade-in" }, [
                                React.createElement('div', { className: "flex justify-between items-center mb-6" }, [
                                    React.createElement('h2', { className: "text-2xl font-bold text-green-700 flex items-center" }, [
                                        React.createElement(PiggyBank, { className: "mr-2" }),
                                        t.monthlyIncome
                                    ]),
                                    React.createElement('button', {
                                        onClick: generateChartData,
                                        className: "bg-gradient-to-r from-green-500 to-teal-500 text-white px-4 py-2 rounded-lg flex items-center hover:from-green-600 hover:to-teal-600 transition-all shadow-lg"
                                    }, [
                                        React.createElement(TrendingUp, { size: 16, className: "mr-1" }),
                                        t.showChart
                                    ])
                                ]),
                                React.createElement('div', { className: "grid grid-cols-1 gap-4" }, [
                                    React.createElement('div', { className: "bg-gradient-to-r from-green-100 to-blue-100 rounded-xl p-4" }, [
                                        React.createElement('div', { className: "text-center" }, [
                                            React.createElement('div', { className: "text-3xl font-bold text-green-700 currency-format" }, formatCurrency(results.totalNetIncome)),
                                            React.createElement('div', { className: "text-sm text-gray-600" }, t.totalMonthly)
                                        ])
                                    ]),
                                    React.createElement('div', { className: "grid grid-cols-3 gap-2" }, [
                                        React.createElement('div', { className: "bg-blue-50 rounded-lg p-3" }, [
                                            React.createElement('div', { className: "text-lg font-bold text-blue-700 currency-format" }, formatCurrency(results.netPension)),
                                            React.createElement('div', { className: "text-xs text-gray-600" }, t.fromPension)
                                        ]),
                                        React.createElement('div', { className: "bg-green-50 rounded-lg p-3" }, [
                                            React.createElement('div', { className: "text-lg font-bold text-green-700 currency-format" }, formatCurrency(results.netTrainingFundIncome)),
                                            React.createElement('div', { className: "text-xs text-gray-600" }, t.fromTrainingFund)
                                        ]),
                                        React.createElement('div', { className: "bg-purple-50 rounded-lg p-3" }, [
                                            React.createElement('div', { className: "text-lg font-bold text-purple-700 currency-format" }, formatCurrency(results.socialSecurity)),
                                            React.createElement('div', { className: "text-xs text-gray-600" }, `${t.socialSecurity} ${results.lastCountry.flag}`)
                                        ])
                                    ]),
                                    React.createElement('div', { className: "bg-yellow-50 rounded-lg p-3 border-l-4 border-yellow-400" }, [
                                        React.createElement('div', { className: "flex items-center" }, [
                                            React.createElement(AlertCircle, { className: "text-yellow-600 mr-2", size: 16 }),
                                            React.createElement('div', null, [
                                                React.createElement('div', { className: "font-medium text-yellow-800" }, `${t.withInflation} ${formatCurrency(results.inflationAdjustedIncome)}`),
                                                React.createElement('div', { className: "text-xs text-yellow-600" }, t.purchasingPower)
                                            ])
                                        ])
                                    ]),
                                    // Currency conversion - compact version
                                    React.createElement('div', { className: "bg-gradient-to-r from-indigo-50 to-cyan-50 rounded-lg p-3 border border-indigo-200" }, [
                                        React.createElement('h4', { className: "font-semibold text-indigo-800 mb-3 text-center" }, 
                                            language === 'he' ? "ğŸŒ ×”××¨×ª ××˜×‘×¢×•×ª" : "ğŸŒ Currency Conversion"),
                                        React.createElement('div', { className: "grid grid-cols-3 gap-3" }, [
                                            React.createElement('div', { className: "text-center" }, [
                                                React.createElement('div', { className: "text-xs text-gray-600" }, 
                                                    language === 'he' ? "USD" : "USD"),
                                                React.createElement('div', { className: "font-bold text-green-700 currency-format" }, convertCurrency(results.totalNetIncome, 'USD'))
                                            ]),
                                            React.createElement('div', { className: "text-center" }, [
                                                React.createElement('div', { className: "text-xs text-gray-600" }, 
                                                    language === 'he' ? "GBP" : "GBP"),
                                                React.createElement('div', { className: "font-bold text-green-700 currency-format" }, convertCurrency(results.totalNetIncome, 'GBP'))
                                            ]),
                                            React.createElement('div', { className: "text-center" }, [
                                                React.createElement('div', { className: "text-xs text-gray-600" }, 
                                                    language === 'he' ? "EUR" : "EUR"),
                                                React.createElement('div', { className: "font-bold text-green-700 currency-format" }, convertCurrency(results.totalNetIncome, 'EUR'))
                                            ])
                                        ])
                                    ]),
                                ])
                            ]),

                            // Savings Breakdown
                            React.createElement('div', { className: "glass-effect rounded-2xl shadow-xl p-6 border border-white/20 animate-fade-in" }, [
                                React.createElement('h3', { className: "text-xl font-bold text-blue-700 mb-4 flex items-center" }, [
                                    React.createElement(Calculator, { className: "mr-2" }),
                                    language === 'he' ? "×¤×™×¨×•×˜ ×—×¡×›×•× ×•×ª" : "Savings Breakdown"
                                ]),
                                React.createElement('div', { className: "space-y-3" }, [
                                    React.createElement('div', { className: "flex justify-between p-3 bg-blue-50 rounded-lg" }, [
                                        React.createElement('span', null, 
                                            language === 'he' ? "×—×™×¡×›×•×Ÿ ×¤× ×¡×™×”:" : "Pension Savings:"),
                                        React.createElement('span', { className: "font-bold text-blue-700 currency-format" }, formatCurrency(results.totalSavings))
                                    ]),
                                    React.createElement('div', { className: "flex justify-between p-3 bg-green-50 rounded-lg" }, [
                                        React.createElement('span', null, 
                                            language === 'he' ? "×§×¨×Ÿ ×”×©×ª×œ××•×ª:" : "Training Fund:"),
                                        React.createElement('span', { className: "font-bold text-green-700 currency-format" }, formatCurrency(results.trainingFundValue))
                                    ]),
                                    React.createElement('div', { className: "flex justify-between p-3 bg-gray-50 rounded-lg border-2 border-gray-300" }, [
                                        React.createElement('span', { className: "font-bold" }, 
                                            language === 'he' ? "×¡×”×´×› ×—×¡×›×•× ×•×ª:" : "Total Savings:"),
                                        React.createElement('span', { className: "font-bold text-gray-800 currency-format" }, formatCurrency(results.totalSavings + results.trainingFundValue))
                                    ])
                                ])
                            ]),

                            // Comprehensive Savings Breakdown
                            React.createElement('div', { className: "glass-effect rounded-2xl shadow-xl p-6 border border-white/20 animate-fade-in" }, [
                                React.createElement('h3', { className: "text-xl font-bold text-purple-700 mb-4 flex items-center" }, [
                                    React.createElement('span', { className: "mr-2" }, "ğŸ’"),
                                    language === 'he' ? "×¤×™×¨×•×˜ ××œ× ×©×œ ×”×¦×‘×™×¨×”" : "Complete Accumulation Breakdown"
                                ]),
                                React.createElement('div', { className: "space-y-3" }, [
                                    // Pension Savings
                                    results.totalSavings > 0 && React.createElement('div', { className: "flex justify-between p-3 bg-blue-50 rounded-lg border border-blue-200" }, [
                                        React.createElement('span', { className: "flex items-center" }, [
                                            React.createElement('span', { className: "w-3 h-3 bg-blue-500 rounded-full mr-2" }),
                                            language === 'he' ? "×¤× ×¡×™×”:" : "Pension:"
                                        ]),
                                        React.createElement('span', { className: "font-bold text-blue-700 currency-format" }, formatCurrency(results.totalSavings))
                                    ]),
                                    // Training Fund
                                    results.trainingFundValue > 0 && React.createElement('div', { className: "flex justify-between p-3 bg-green-50 rounded-lg border border-green-200" }, [
                                        React.createElement('span', { className: "flex items-center" }, [
                                            React.createElement('span', { className: "w-3 h-3 bg-green-500 rounded-full mr-2" }),
                                            language === 'he' ? "×§×¨×Ÿ ×”×©×ª×œ××•×ª:" : "Training Fund:"
                                        ]),
                                        React.createElement('span', { className: "font-bold text-green-700 currency-format" }, formatCurrency(results.trainingFundValue))
                                    ]),
                                    // Personal Portfolio
                                    results.personalPortfolioValue > 0 && React.createElement('div', { className: "flex justify-between p-3 bg-purple-50 rounded-lg border border-purple-200" }, [
                                        React.createElement('span', { className: "flex items-center" }, [
                                            React.createElement('span', { className: "w-3 h-3 bg-purple-500 rounded-full mr-2" }),
                                            language === 'he' ? "×ª×™×§ ××™×©×™:" : "Personal Portfolio:"
                                        ]),
                                        React.createElement('span', { className: "font-bold text-purple-700 currency-format" }, formatCurrency(results.personalPortfolioValue))
                                    ]),
                                    // Cryptocurrency
                                    results.cryptoValue > 0 && React.createElement('div', { className: "flex justify-between p-3 bg-orange-50 rounded-lg border border-orange-200" }, [
                                        React.createElement('span', { className: "flex items-center" }, [
                                            React.createElement('span', { className: "w-3 h-3 bg-orange-500 rounded-full mr-2" }),
                                            language === 'he' ? "×§×¨×™×¤×˜×•:" : "Cryptocurrency:"
                                        ]),
                                        React.createElement('span', { className: "font-bold text-orange-700 currency-format" }, formatCurrency(results.cryptoValue))
                                    ]),
                                    // Real Estate
                                    results.realEstateValue > 0 && React.createElement('div', { className: "flex justify-between p-3 bg-emerald-50 rounded-lg border border-emerald-200" }, [
                                        React.createElement('span', { className: "flex items-center" }, [
                                            React.createElement('span', { className: "w-3 h-3 bg-emerald-500 rounded-full mr-2" }),
                                            language === 'he' ? "× ×“×œ×´×Ÿ:" : "Real Estate:"
                                        ]),
                                        React.createElement('span', { className: "font-bold text-emerald-700 currency-format" }, formatCurrency(results.realEstateValue))
                                    ]),
                                    // Total Line
                                    React.createElement('div', { className: "flex justify-between p-4 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-lg border-2 border-indigo-300" }, [
                                        React.createElement('span', { className: "font-bold text-lg flex items-center" }, [
                                            React.createElement('span', { className: "w-4 h-4 bg-gradient-to-r from-indigo-500 to-purple-500 rounded-full mr-2" }),
                                            language === 'he' ? "×¡×”×´×› ×¦×‘×™×¨×”:" : "Total Accumulation:"
                                        ]),
                                        React.createElement('span', { className: "font-bold text-xl text-indigo-700 currency-format" }, 
                                            formatCurrency(
                                                results.totalSavings + 
                                                results.trainingFundValue + 
                                                results.personalPortfolioValue + 
                                                results.cryptoValue + 
                                                results.realEstateValue
                                            ))
                                    ])
                                ])
                            ]),

                            // Tax Breakdown
                            React.createElement('div', { className: "glass-effect rounded-2xl shadow-xl p-6 border border-white/20 animate-fade-in" }, [
                                React.createElement('h3', { className: "text-xl font-bold text-red-700 mb-4 flex items-center" }, [
                                    React.createElement(DollarSign, { className: "mr-2" }),
                                    language === 'he' ? "×¤×™×¨×•×˜ ××™×¡×™×" : "Tax Breakdown"
                                ]),
                                React.createElement('div', { className: "space-y-3" }, [
                                    React.createElement('div', { className: "flex justify-between p-3 bg-gray-50 rounded-lg" }, [
                                        React.createElement('span', null, 
                                            language === 'he' ? "×¤× ×¡×™×” ×‘×¨×•×˜×•:" : "Gross Pension:"),
                                        React.createElement('span', { className: "font-bold currency-format" }, formatCurrency(results.monthlyPension))
                                    ]),
                                    React.createElement('div', { className: "flex justify-between p-3 bg-red-50 rounded-lg" }, [
                                        React.createElement('span', { className: "text-red-700" }, 
                                            language === 'he' ? `××¡ (${results.weightedTaxRate}%):` : `Tax (${results.weightedTaxRate}%):`),
                                        React.createElement('span', { className: "font-bold text-red-700 currency-format" }, `-${formatCurrency(results.pensionTax)}`)
                                    ]),
                                    React.createElement('div', { className: "flex justify-between p-3 bg-green-50 rounded-lg border-2 border-green-200" }, [
                                        React.createElement('span', { className: "text-green-700 font-bold" }, 
                                            language === 'he' ? "×¡×›×•× × ×˜×•:" : "Net Amount:"),
                                        React.createElement('span', { className: "font-bold text-green-700 currency-format" }, formatCurrency(results.netPension))
                                    ])
                                ])
                            ]),

                            // Expense Gap Analysis
                            React.createElement('div', { className: "glass-effect rounded-2xl shadow-xl p-6 border border-white/20 animate-fade-in" }, [
                                React.createElement('h3', { className: "text-xl font-bold text-orange-700 mb-4 flex items-center" }, [
                                    React.createElement(Target, { className: "mr-2" }),
                                    language === 'he' ? "ğŸ“Š × ×™×ª×•×— ×¤×¢×¨×™ ×”×•×¦××•×ª ×•×™×¢×“×™×" : "ğŸ“Š Expense Gap Analysis"
                                ]),
                                React.createElement('div', { className: "space-y-4" }, [
                                    // Current vs Future Expenses
                                    React.createElement('div', { className: "grid grid-cols-2 gap-3" }, [
                                        React.createElement('div', { className: "bg-blue-50 rounded-lg p-3" }, [
                                            React.createElement('div', { className: "text-sm text-gray-600" }, 
                                                language === 'he' ? "×”×•×¦××•×ª ×—×•×“×©×™×•×ª ×›×™×•×" : "Current Monthly Expenses"),
                                            React.createElement('div', { className: "font-bold text-blue-700 currency-format" }, 
                                                formatCurrency(inputs.currentMonthlyExpenses))
                                        ]),
                                        React.createElement('div', { className: "bg-orange-50 rounded-lg p-3" }, [
                                            React.createElement('div', { className: "text-sm text-gray-600" }, 
                                                language === 'he' ? "×”×•×¦××•×ª ×¢×ª×™×“×™×•×ª (×¢× ××™× ×¤×œ×¦×™×”)" : "Future Expenses (with inflation)"),
                                            React.createElement('div', { className: "font-bold text-orange-700 currency-format" }, 
                                                formatCurrency(results.futureMonthlyExpenses))
                                        ])
                                    ]),
                                    
                                    // Retirement Income vs Expenses
                                    React.createElement('div', { 
                                        className: `p-4 rounded-lg border-2 ${
                                            results.remainingAfterExpenses >= 0 
                                                ? 'bg-green-50 border-green-200' 
                                                : 'bg-red-50 border-red-200'
                                        }`
                                    }, [
                                        React.createElement('div', { className: "flex justify-between items-center mb-2" }, [
                                            React.createElement('span', { className: "font-medium" }, 
                                                language === 'he' ? "×”×›× ×¡×” × ×˜×• ×‘×¤× ×¡×™×”:" : "Net Retirement Income:"),
                                            React.createElement('span', { className: "font-bold currency-format" }, 
                                                formatCurrency(results.totalNetIncome))
                                        ]),
                                        React.createElement('div', { className: "flex justify-between items-center mb-2" }, [
                                            React.createElement('span', { className: "font-medium" }, 
                                                language === 'he' ? "×”×•×¦××•×ª ×¢×ª×™×“×™×•×ª:" : "Future Monthly Expenses:"),
                                            React.createElement('span', { className: "font-bold currency-format" }, 
                                                `-${formatCurrency(results.futureMonthlyExpenses)}`)
                                        ]),
                                        React.createElement('hr', { className: "my-2 border-gray-300" }),
                                        React.createElement('div', { className: "flex justify-between items-center" }, [
                                            React.createElement('span', { className: "font-bold text-lg" }, 
                                                language === 'he' ? "×™×ª×¨×” ×—×•×“×©×™×ª:" : "Monthly Surplus/Deficit:"),
                                            React.createElement('span', { 
                                                className: `font-bold text-xl currency-format ${
                                                    results.remainingAfterExpenses >= 0 ? 'text-green-700' : 'text-red-700'
                                                }`
                                            }, formatCurrency(results.remainingAfterExpenses))
                                        ])
                                    ]),
                                    
                                    // Target Analysis
                                    React.createElement('div', { 
                                        className: `p-4 rounded-lg border-2 ${
                                            results.achievesTarget 
                                                ? 'bg-green-50 border-green-200' 
                                                : 'bg-yellow-50 border-yellow-200'
                                        }`
                                    }, [
                                        React.createElement('div', { className: "space-y-1 mb-2" }, [
                                            React.createElement('div', { className: "flex justify-between items-center" }, [
                                                React.createElement('span', { className: "font-medium" }, 
                                                    language === 'he' ? `×™×¢×“ ×”×—×œ×¤×ª ${inputs.targetReplacement}% ×××©×›×•×¨×ª:` : `Target ${inputs.targetReplacement}% salary replacement:`),
                                                React.createElement('span', { className: "font-bold currency-format" }, 
                                                    formatCurrency(results.targetMonthlyIncome))
                                            ]),
                                            React.createElement('div', { className: "flex justify-between items-center text-sm text-gray-600" }, [
                                                React.createElement('span', null, 
                                                    language === 'he' ? "(×‘×›×•×— ×§× ×™×™×” ×©×œ ×”×™×•×):" : "(in today's purchasing power):"),
                                                React.createElement('span', { className: "font-semibold currency-format" }, 
                                                    formatCurrency(results.targetMonthlyIncomeInflationAdjusted))
                                            ])
                                        ]),
                                        React.createElement('div', { className: "flex justify-between items-center mb-2" }, [
                                            React.createElement('span', { className: "font-medium" }, 
                                                language === 'he' ? "×”×›× ×¡×” ×¦×¤×•×™×” ×‘×¤× ×¡×™×”:" : "Expected retirement income:"),
                                            React.createElement('span', { className: "font-bold currency-format" }, 
                                                formatCurrency(results.totalNetIncome))
                                        ]),
                                        React.createElement('hr', { className: "my-2 border-gray-300" }),
                                        React.createElement('div', { className: "space-y-1" }, [
                                            React.createElement('div', { className: "flex justify-between items-center" }, [
                                                React.createElement('span', { className: "font-bold text-lg" }, 
                                                    results.achievesTarget 
                                                        ? (language === 'he' ? "âœ… ×”×™×¢×“ ××•×©×’! ×¢×•×“×£:" : "âœ… Target achieved! Surplus:")
                                                        : (language === 'he' ? "âš ï¸ ×¤×¢×¨ ××”×™×¢×“:" : "âš ï¸ Gap from target:")),
                                                React.createElement('span', { 
                                                    className: `font-bold text-xl currency-format ${
                                                        results.achievesTarget ? 'text-green-700' : 'text-yellow-700'
                                                    }`
                                                }, results.achievesTarget 
                                                    ? formatCurrency(-results.targetGap)
                                                    : formatCurrency(results.targetGap))
                                            ]),
                                            React.createElement('div', { className: "flex justify-between items-center text-sm" }, [
                                                React.createElement('span', { className: "text-gray-600" }, 
                                                    language === 'he' ? "(×‘×›×•×— ×§× ×™×™×” ×©×œ ×”×™×•×):" : "(in today's purchasing power):"),
                                                React.createElement('span', { 
                                                    className: `font-semibold currency-format ${
                                                        results.achievesTarget ? 'text-green-600' : 'text-yellow-600'
                                                    }`
                                                }, results.achievesTarget 
                                                    ? formatCurrency(-results.targetGapInflationAdjusted)
                                                    : formatCurrency(results.targetGapInflationAdjusted))
                                            ])
                                        ])
                                    ]),
                                    
                                    // Summary insights
                                    React.createElement('div', { className: "bg-gray-50 rounded-lg p-4" }, [
                                        React.createElement('h4', { className: "font-bold text-gray-800 mb-2" }, 
                                            language === 'he' ? "ğŸ’¡ ×ª×•×‘× ×•×ª ××¨×›×–×™×•×ª:" : "ğŸ’¡ Key Insights:"),
                                        React.createElement('ul', { className: "space-y-2 text-sm text-gray-700" }, [
                                            React.createElement('li', { className: "bg-blue-50 p-2 rounded border-l-4 border-blue-400" }, 
                                                language === 'he' 
                                                    ? `ğŸ“Š ×”×©×¤×¢×ª ××™× ×¤×œ×¦×™×”: ×”×›× ×¡×” ×©×œ ${formatCurrency(results.totalNetIncome)} ×ª×”×™×” ×©×•×•×” ${formatCurrency(results.inflationAdjustedIncome)} ×‘×›×•×— ×§× ×™×™×” ×©×œ ×”×™×•×`
                                                    : `ğŸ“Š Inflation impact: Income of ${formatCurrency(results.totalNetIncome)} equals ${formatCurrency(results.inflationAdjustedIncome)} in today's purchasing power`),
                                            React.createElement('li', null, 
                                                language === 'he' 
                                                    ? `â€¢ ×¢×•×“×£/×’×™×¨×¢×•×Ÿ ××—×¨×™ ×”×•×¦××•×ª (×‘×›×•×— ×§× ×™×™×” ×©×œ ×”×™×•×): ${formatCurrency(results.remainingAfterExpensesInflationAdjusted)}`
                                                    : `â€¢ Surplus/deficit after expenses (today's purchasing power): ${formatCurrency(results.remainingAfterExpensesInflationAdjusted)}`),
                                            React.createElement('li', null, 
                                                language === 'he' 
                                                    ? `â€¢ ××—×•×– ×”×—×œ×¤×” × ×•××™× ×œ×™: ${Math.round((results.totalNetIncome / (workPeriods[workPeriods.length - 1]?.salary || 1)) * 100)}% | ×‘×›×•×— ×§× ×™×™×” ×©×œ ×”×™×•×: ${Math.round((results.inflationAdjustedIncome / (workPeriods[workPeriods.length - 1]?.salary || 1)) * 100)}%`
                                                    : `â€¢ Replacement ratio nominal: ${Math.round((results.totalNetIncome / (workPeriods[workPeriods.length - 1]?.salary || 1)) * 100)}% | Today's purchasing power: ${Math.round((results.inflationAdjustedIncome / (workPeriods[workPeriods.length - 1]?.salary || 1)) * 100)}%`),
                                            results.remainingAfterExpenses < 0 && React.createElement('li', { className: "text-red-600 font-medium bg-red-50 p-2 rounded" }, 
                                                language === 'he' 
                                                    ? "âš ï¸ × ×“×¨×© ×œ×”×’×“×™×œ ×”×¤×§×“×•×ª ××• ×œ×”×§×˜×™×Ÿ ×”×•×¦××•×ª ×¦×¤×•×™×•×ª"
                                                    : "âš ï¸ Consider increasing contributions or reducing expected expenses")
                                        ])
                                    ])
                                ])
                            ]),

                            // Claude AI Insights Section
                            claudeInsights && React.createElement('div', { className: "glass-effect rounded-2xl shadow-xl p-6 border border-white/20 animate-fade-in" }, [
                                React.createElement('h3', { className: "text-xl font-bold text-indigo-700 mb-4 flex items-center" }, [
                                    React.createElement('span', { className: "mr-2" }, "ğŸ¤–"),
                                    language === 'he' ? "××¡×§× ×•×ª ××¨×›×–×™×•×ª ××§×œ××•×“" : "Claude's Key Insights"
                                ]),
                                React.createElement('div', { className: "bg-gradient-to-r from-indigo-50 to-purple-50 rounded-lg p-5 border border-indigo-200" }, [
                                    claudeInsights && React.createElement('div', { className: "space-y-3 text-gray-700" }, 
                                        claudeInsights.map((insight, index) => 
                                            React.createElement('p', { 
                                                key: index,
                                                className: index === claudeInsights.length - 1 
                                                    ? "text-sm leading-relaxed font-medium text-indigo-800" 
                                                    : "text-sm leading-relaxed"
                                            }, insight)
                                        )
                                    )
                                ]),
                                
                                // Export Buttons
                                React.createElement('div', { className: "mt-4 pt-4 border-t border-indigo-200" }, [
                                    React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-2 gap-3" }, [
                                        React.createElement('button', {
                                            onClick: () => exportRetirementSummary(),
                                            className: "bg-gradient-to-r from-indigo-500 to-purple-500 text-white px-4 py-3 rounded-lg hover:from-indigo-600 hover:to-purple-600 transition-all duration-300 shadow-lg flex items-center justify-center font-medium"
                                        }, [
                                            React.createElement('span', { className: "mr-2" }, "ğŸ“±"),
                                            language === 'he' ? "×©×™×ª×•×£ ×˜×§×¡×˜" : "Share Text"
                                        ]),
                                        React.createElement('button', {
                                            onClick: () => exportAsImage(),
                                            className: "bg-gradient-to-r from-emerald-500 to-teal-500 text-white px-4 py-3 rounded-lg hover:from-emerald-600 hover:to-teal-600 transition-all duration-300 shadow-lg flex items-center justify-center font-medium"
                                        }, [
                                            React.createElement('span', { className: "mr-2" }, "ğŸ–¼ï¸"),
                                            language === 'he' ? "×©××™×¨×” ×›×ª××•× ×”" : "Save as Image"
                                        ])
                                    ])
                                ])
                            ]),

                            // General Recommendations Section
                            (() => {
                                const generateGeneralRecommendations = () => {
                                    if (!results) return [];
                                    
                                    const recommendations = [];
                                    const currentSalary = workPeriods[workPeriods.length - 1]?.salary || 0;
                                    const yearsToRetirement = inputs.retirementAge - inputs.currentAge;
                                    const currentAge = inputs.currentAge;
                                    
                                    // Emergency Fund Analysis
                                    const emergencyFundTarget = inputs.currentMonthlyExpenses * inputs.emergencyFundTarget;
                                    const emergencyFundGap = Math.max(0, emergencyFundTarget - inputs.currentEmergencyFund);
                                    const emergencyFundCoverage = inputs.currentMonthlyExpenses > 0 ? 
                                        inputs.currentEmergencyFund / inputs.currentMonthlyExpenses : 0;
                                    
                                    // Savings Rate Analysis
                                    const totalMonthlySavings = (workPeriods[workPeriods.length - 1]?.monthlyContribution || 0) +
                                        (workPeriods[workPeriods.length - 1]?.monthlyTrainingFund || 0) +
                                        inputs.personalPortfolioMonthly +
                                        inputs.cryptoMonthly +
                                        inputs.realEstateMonthly +
                                        inputs.emergencyFundMonthly;
                                    const savingsRate = currentSalary > 0 ? (totalMonthlySavings / currentSalary) * 100 : 0;
                                    
                                    // Debt-to-Income Ratio
                                    const totalMonthlyDebt = inputs.mortgageMonthlyPayment +
                                        inputs.personalLoansMonthly +
                                        inputs.creditCardMonthly +
                                        inputs.otherDebtsMonthly;
                                    const debtToIncomeRatio = currentSalary > 0 ? (totalMonthlyDebt / currentSalary) * 100 : 0;
                                    
                                    // Age-Based Recommendations
                                    if (currentAge < 30) {
                                        if (savingsRate < 10) {
                                            recommendations.push({
                                                type: 'warning',
                                                priority: 'high',
                                                title: language === 'he' ? 'ğŸ’¡ ×”×’×“×œ ×—×™×¡×›×•×Ÿ ×‘×’×™×œ ×¦×¢×™×¨' : 'ğŸ’¡ Increase Savings While Young',
                                                text: language === 'he' 
                                                    ? '×‘×’×™×œ ×¦×¢×™×¨, ×›×“××™ ×œ×—×¡×•×š ×œ×¤×—×•×ª 10-15% ××”×©×›×¨. ×™×© ×œ×š ×™×ª×¨×•×Ÿ ×–××Ÿ ×¨×‘ ×œ×”× ×“×¡ ×¢×œ×™×™×ª ×¢×¨×š.'
                                                    : 'At a young age, aim to save at least 10-15% of salary. You have the advantage of time for compound growth.'
                                            });
                                        }
                                        if (inputs.riskTolerance === 'conservative') {
                                            recommendations.push({
                                                type: 'suggestion',
                                                priority: 'medium',
                                                title: language === 'he' ? 'ğŸ“ˆ ×©×§×•×œ ×¡×™×›×•×Ÿ ×’×‘×•×” ×™×•×ª×¨' : 'ğŸ“ˆ Consider Higher Risk',
                                                text: language === 'he' 
                                                    ? '×‘×’×™×œ ×¦×¢×™×¨, ×ª×•×›×œ ×œ×§×—×ª ×™×•×ª×¨ ×¡×™×›×•×Ÿ ×‘×”×©×§×¢×•×ª ×¢×‘×•×¨ ×¤×•×˜× ×¦×™××œ ×ª×©×•××” ×’×‘×•×” ×™×•×ª×¨.'
                                                    : 'At a young age, you can take more investment risk for higher return potential.'
                                            });
                                        }
                                    } else if (currentAge >= 30 && currentAge < 45) {
                                        if (savingsRate < 15) {
                                            recommendations.push({
                                                type: 'warning',
                                                priority: 'high',
                                                title: language === 'he' ? 'âš¡ ×”×’×“×œ ×—×™×¡×›×•×Ÿ ×‘×’×™×œ ×”×¤×¨×™×™×' : 'âš¡ Increase Prime Years Savings',
                                                text: language === 'he' 
                                                    ? '×‘×©× ×•×ª ×”×¤×¨×™×™× ×©×œ×š (30-45), ×›×“××™ ×œ×—×¡×•×š 15-20% ××”×©×›×¨ ×›×“×™ ×œ××§×¡× ××ª ×”×¦×‘×™×¨×”.'
                                                    : 'In your prime years (30-45), aim to save 15-20% of salary to maximize accumulation.'
                                            });
                                        }
                                        if (!results.achievesTarget) {
                                            recommendations.push({
                                                type: 'warning',
                                                priority: 'high',
                                                title: language === 'he' ? 'ğŸ¯ ×¡×’×•×¨ ×¤×¢×¨×™× ×¢×›×©×™×•' : 'ğŸ¯ Close Gaps Now',
                                                text: language === 'he' 
                                                    ? `×™×© ×¤×¢×¨ ×©×œ ${formatCurrency(results.targetGap)} ××”×™×¢×“. ×–×” ×”×–××Ÿ ×”×˜×•×‘ ×‘×™×•×ª×¨ ×œ×¡×’×•×¨ ×¤×¢×¨×™×.`
                                                    : `There's a ${formatCurrency(results.targetGap)} gap from target. This is the best time to close gaps.`
                                            });
                                        }
                                    } else if (currentAge >= 45 && currentAge < 60) {
                                        if (inputs.riskTolerance === 'veryAggressive') {
                                            recommendations.push({
                                                type: 'caution',
                                                priority: 'medium',
                                                title: language === 'he' ? 'âš–ï¸ ×©×§×•×œ ×œ×”×¤×—×™×ª ×¡×™×›×•×Ÿ' : 'âš–ï¸ Consider Reducing Risk',
                                                text: language === 'he' 
                                                    ? '×‘×’×™×œ ××ª×§×“× ×™×•×ª×¨, ×›×“××™ ×œ×”×ª×—×™×œ ×œ×”×¤×—×™×ª ×¡×™×›×•×Ÿ ×•×œ×©××•×¨ ×¢×œ ×”×¦×‘×™×¨×”.'
                                                    : 'At a more advanced age, consider starting to reduce risk and preserve accumulation.'
                                            });
                                        }
                                        if (savingsRate < 20) {
                                            recommendations.push({
                                                type: 'warning',
                                                priority: 'high',
                                                title: language === 'he' ? 'ğŸƒâ€â™‚ï¸ ×”××¦×” ×œ×¤× ×™ ×¤×¨×™×©×”' : 'ğŸƒâ€â™‚ï¸ Accelerate Before Retirement',
                                                text: language === 'he' 
                                                    ? '×‘×©× ×™× ×œ×¤× ×™ ×”×¤×¨×™×©×”, ×›×“××™ ×œ×”×’×“×™×œ ×—×™×¡×›×•×Ÿ ×œ-20-25% ××”×©×›×¨.'
                                                    : 'In the years before retirement, consider increasing savings to 20-25% of salary.'
                                            });
                                        }
                                    } else if (currentAge >= 60) {
                                        if (inputs.riskTolerance === 'aggressive' || inputs.riskTolerance === 'veryAggressive') {
                                            recommendations.push({
                                                type: 'warning',
                                                priority: 'high',
                                                title: language === 'he' ? 'ğŸ›¡ï¸ ×©××•×¨ ×¢×œ ×”×¦×‘×™×¨×”' : 'ğŸ›¡ï¸ Preserve Accumulation',
                                                text: language === 'he' 
                                                    ? '×‘×§×¨×‘×ª ×”×¤×¨×™×©×”, ×›×“××™ ×œ×¢×‘×•×¨ ×œ××¡×˜×¨×˜×’×™×” ×©××¨× ×™×ª ×™×•×ª×¨ ×œ×©××™×¨×” ×¢×œ ×”×¦×‘×™×¨×”.'
                                                    : 'Near retirement, consider moving to a more conservative strategy to preserve accumulation.'
                                            });
                                        }
                                    }

                                    // Emergency Fund Recommendations
                                    if (emergencyFundCoverage < 3) {
                                        recommendations.push({
                                            type: 'critical',
                                            priority: 'critical',
                                            title: language === 'he' ? 'ğŸš¨ ×§×¨×Ÿ ×—×™×¨×•× ×“×—×•×¤×”' : 'ğŸš¨ Urgent Emergency Fund',
                                            text: language === 'he' 
                                                ? `×™×© ×œ×š ×›×™×¡×•×™ ×©×œ ${emergencyFundCoverage.toFixed(1)} ×—×•×“×©×™× ×‘×œ×‘×“. ×¦×¨×™×š ×œ×¤×—×•×ª 3-6 ×—×•×“×©×™×.`
                                                : `You have only ${emergencyFundCoverage.toFixed(1)} months coverage. Need at least 3-6 months.`
                                        });
                                    } else if (emergencyFundCoverage < 6) {
                                        recommendations.push({
                                            type: 'warning',
                                            priority: 'high',
                                            title: language === 'he' ? 'ğŸ›¡ï¸ ×”×©×œ× ×§×¨×Ÿ ×—×™×¨×•×' : 'ğŸ›¡ï¸ Complete Emergency Fund',
                                            text: language === 'he' 
                                                ? `×§×¨×Ÿ ×”×—×™×¨×•× ×©×œ×š ××›×¡×” ${emergencyFundCoverage.toFixed(1)} ×—×•×“×©×™×. ×›×“××™ ×œ×”×©×œ×™× ×œ-6 ×—×•×“×©×™×.`
                                                : `Your emergency fund covers ${emergencyFundCoverage.toFixed(1)} months. Consider completing to 6 months.`
                                        });
                                    }

                                    // Debt-to-Income Recommendations
                                    if (debtToIncomeRatio > 40) {
                                        recommendations.push({
                                            type: 'critical',
                                            priority: 'critical',
                                            title: language === 'he' ? 'ğŸ’³ ×—×•×‘×•×ª ×’×‘×•×”×™× ××“×™' : 'ğŸ’³ Debt Too High',
                                            text: language === 'he' 
                                                ? `×™×—×¡ ×”×—×•×‘×•×ª ×œ×”×›× ×¡×” ×©×œ×š ×”×•× ${debtToIncomeRatio.toFixed(1)}%. ×›×“××™ ×œ×”×•×¨×™×“ ××ª×—×ª ×œ-30%.`
                                                : `Your debt-to-income ratio is ${debtToIncomeRatio.toFixed(1)}%. Consider reducing below 30%.`
                                        });
                                    } else if (debtToIncomeRatio > 30) {
                                        recommendations.push({
                                            type: 'warning',
                                            priority: 'medium',
                                            title: language === 'he' ? 'âš ï¸ ×©××•×¨ ×¢×œ ×—×•×‘×•×ª' : 'âš ï¸ Monitor Debt',
                                            text: language === 'he' 
                                                ? `×™×—×¡ ×”×—×•×‘×•×ª ×œ×”×›× ×¡×” ×©×œ×š ×”×•× ${debtToIncomeRatio.toFixed(1)}%. ×›×“××™ ×œ× ×œ×¢×œ×•×ª ××¢×œ 30%.`
                                                : `Your debt-to-income ratio is ${debtToIncomeRatio.toFixed(1)}%. Consider not exceeding 30%.`
                                        });
                                    }

                                    // Savings Rate Recommendations
                                    if (savingsRate < 10) {
                                        recommendations.push({
                                            type: 'warning',
                                            priority: 'high',
                                            title: language === 'he' ? 'ğŸ“Š ×©×™×¢×•×¨ ×—×™×¡×›×•×Ÿ × ××•×š' : 'ğŸ“Š Low Savings Rate',
                                            text: language === 'he' 
                                                ? `×©×™×¢×•×¨ ×”×—×™×¡×›×•×Ÿ ×©×œ×š ×”×•× ${savingsRate.toFixed(1)}%. ××•××œ×¥ ×œ×¤×—×•×ª 10-15%.`
                                                : `Your savings rate is ${savingsRate.toFixed(1)}%. Recommended at least 10-15%.`
                                        });
                                    } else if (savingsRate >= 20) {
                                        recommendations.push({
                                            type: 'success',
                                            priority: 'low',
                                            title: language === 'he' ? 'ğŸ‰ ×©×™×¢×•×¨ ×—×™×¡×›×•×Ÿ ××¦×•×™×Ÿ' : 'ğŸ‰ Excellent Savings Rate',
                                            text: language === 'he' 
                                                ? `×©×™×¢×•×¨ ×”×—×™×¡×›×•×Ÿ ×©×œ×š ×”×•× ${savingsRate.toFixed(1)}%. ×–×” ××¦×•×™×Ÿ!`
                                                : `Your savings rate is ${savingsRate.toFixed(1)}%. This is excellent!`
                                        });
                                    }

                                    // Investment Diversification Recommendations
                                    const hasPersonalInvestments = inputs.currentPersonalPortfolio > 0 || inputs.personalPortfolioMonthly > 0;
                                    const hasCrypto = inputs.currentCrypto > 0 || inputs.cryptoMonthly > 0;
                                    const hasRealEstate = inputs.currentRealEstate > 0 || inputs.realEstateMonthly > 0;
                                    
                                    if (!hasPersonalInvestments && !hasCrypto && !hasRealEstate) {
                                        recommendations.push({
                                            type: 'suggestion',
                                            priority: 'medium',
                                            title: language === 'he' ? 'ğŸŒŸ ×¤×–×¨ ×”×©×§×¢×•×ª' : 'ğŸŒŸ Diversify Investments',
                                            text: language === 'he' 
                                                ? '×©×§×•×œ ×œ×”×•×¡×™×£ ×”×©×§×¢×•×ª ××™×©×™×•×ª × ×•×¡×¤×•×ª ×›××• ×× ×™×•×ª ××• × ×“×œ×´×Ÿ ×œ×¤×™×–×•×¨ ×¡×™×›×•× ×™×.'
                                                : 'Consider adding personal investments like stocks or real estate for risk diversification.'
                                        });
                                    }

                                    // Risk Tolerance vs Age Recommendations
                                    if (currentAge > 55 && (inputs.riskTolerance === 'aggressive' || inputs.riskTolerance === 'veryAggressive')) {
                                        recommendations.push({
                                            type: 'caution',
                                            priority: 'medium',
                                            title: language === 'he' ? 'âš–ï¸ ×”×ª×× ×¡×™×›×•×Ÿ ×œ×’×™×œ' : 'âš–ï¸ Adjust Risk to Age',
                                            text: language === 'he' 
                                                ? '×›×›×œ ×©××ª×§×¨×‘×™× ×œ×¤×¨×™×©×”, ×›×“××™ ×œ×”×¤×—×™×ª ×¡×™×›×•×Ÿ ×•×”×’×“×™×œ ×—×œ×§ ×©×œ ××’×´×—.'
                                                : 'As you approach retirement, consider reducing risk and increasing bond allocation.'
                                        });
                                    }

                                    // Positive Reinforcement for Good Planning
                                    if (results.achievesTarget && emergencyFundCoverage >= 6 && savingsRate >= 15) {
                                        recommendations.push({
                                            type: 'success',
                                            priority: 'low',
                                            title: language === 'he' ? 'ğŸ† ×ª×›× ×•×Ÿ ××¦×•×™×Ÿ' : 'ğŸ† Excellent Planning',
                                            text: language === 'he' 
                                                ? '×”×›×œ × ×¨××” × ×”×“×¨! ×™×© ×œ×š ×§×¨×Ÿ ×—×™×¨×•× ××¡×¤×§×ª, ×©×™×¢×•×¨ ×—×™×¡×›×•×Ÿ ×˜×•×‘ ×•××ª×” ×¢×•××“ ×œ×™×¢×“ ×”×¤×¨×™×©×”.'
                                                : 'Everything looks great! You have adequate emergency fund, good savings rate and meeting retirement target.'
                                        });
                                    }

                                    // Sort by priority
                                    const priorityOrder = { 'critical': 0, 'high': 1, 'medium': 2, 'low': 3 };
                                    return recommendations.sort((a, b) => priorityOrder[a.priority] - priorityOrder[b.priority]);
                                };

                                const recommendations = generateGeneralRecommendations();
                                
                                return recommendations.length > 0 ? React.createElement('div', { className: "glass-effect rounded-2xl shadow-xl p-6 border border-white/20 animate-fade-in" }, [
                                    React.createElement('h3', { className: "text-xl font-bold text-amber-700 mb-4 flex items-center" }, [
                                        React.createElement('span', { className: "mr-2" }, "ğŸ’¡"),
                                        language === 'he' ? "×”××œ×¦×•×ª ×›×œ×œ×™×•×ª ××•×ª×××•×ª ××™×©×™×ª" : "Personalized General Recommendations"
                                    ]),
                                    React.createElement('div', { className: "space-y-3" }, 
                                        recommendations.map((rec, index) => {
                                            const colors = {
                                                'critical': 'bg-red-50 border-red-200 text-red-800',
                                                'warning': 'bg-orange-50 border-orange-200 text-orange-800',
                                                'caution': 'bg-yellow-50 border-yellow-200 text-yellow-800',
                                                'suggestion': 'bg-blue-50 border-blue-200 text-blue-800',
                                                'success': 'bg-green-50 border-green-200 text-green-800'
                                            };
                                            
                                            const icons = {
                                                'critical': 'ğŸš¨',
                                                'warning': 'âš ï¸',
                                                'caution': 'âš–ï¸',
                                                'suggestion': 'ğŸ’¡',
                                                'success': 'âœ…'
                                            };
                                            
                                            return React.createElement('div', { 
                                                key: index,
                                                className: `rounded-lg p-4 border-l-4 ${colors[rec.type] || colors.suggestion}`
                                            }, [
                                                React.createElement('div', { className: "flex items-start" }, [
                                                    React.createElement('span', { className: "text-lg mr-3 mt-0.5" }, icons[rec.type] || 'ğŸ’¡'),
                                                    React.createElement('div', { className: "flex-1" }, [
                                                        React.createElement('h4', { className: "font-semibold mb-1" }, rec.title),
                                                        React.createElement('p', { className: "text-sm leading-relaxed" }, rec.text)
                                                    ])
                                                ])
                                            ]);
                                        })
                                    ),
                                    React.createElement('div', { className: "mt-4 pt-4 border-t border-amber-200 text-xs text-amber-600" }, 
                                        language === 'he' 
                                            ? "ğŸ’¡ ×”××œ×¦×•×ª ××œ×• ××‘×•×¡×¡×•×ª ×¢×œ ×”××™×“×¢ ×©×”×•×–×Ÿ ×•××™× ×Ÿ ××—×œ×™×¤×•×ª ×™×™×¢×•×¥ ×¤×™× × ×¡×™ ××§×¦×•×¢×™"
                                            : "ğŸ’¡ These recommendations are based on entered information and don't replace professional financial advice")
                                ]) : null;
                            })()
                        ])
                    ]),

                    // Chart Section
                    results && showChart && chartData && chartData.length > 1 && React.createElement('div', { 
                        className: "mt-8 glass-effect rounded-2xl shadow-xl p-6 border border-white/20 animate-fade-in" 
                    }, [
                        React.createElement('h3', { className: "text-2xl font-bold text-purple-700 mb-6 flex items-center" }, [
                            React.createElement(TrendingUp, { className: "mr-2" }),
                            t.progressChart
                        ]),
                        React.createElement('div', { className: "h-96 mb-4" },
                            React.createElement(SimpleChart, { 
                                data: chartData,
                                type: 'line',
                                language: language
                            })
                        ),
                        React.createElement('div', { className: "bg-gray-50 rounded-lg p-4" }, [
                            React.createElement('div', { className: "grid md:grid-cols-2 gap-4 text-sm" }, [
                                React.createElement('div', { className: "flex items-start" }, [
                                    React.createElement('div', { className: "w-4 h-4 bg-gradient-to-r from-blue-500 to-blue-700 rounded mr-2 mt-1" }),
                                    React.createElement('div', null, [
                                        React.createElement('div', { className: "font-bold text-blue-700" }, 
                                            language === 'he' ? "×¤× ×¡×™×”" : "Pension"),
                                        React.createElement('div', { className: "text-gray-600" }, 
                                            language === 'he' ? "×—×™×¡×›×•×Ÿ ×¤× ×¡×™×” ×‘×œ×‘×“" : "Pension savings only")
                                    ])
                                ]),
                                React.createElement('div', { className: "flex items-start" }, [
                                    React.createElement('div', { className: "w-4 h-4 bg-gradient-to-r from-green-500 to-green-700 rounded mr-2 mt-1" }),
                                    React.createElement('div', null, [
                                        React.createElement('div', { className: "font-bold text-green-700" }, 
                                            language === 'he' ? "×§×¨×Ÿ ×”×©×ª×œ××•×ª" : "Training Fund"),
                                        React.createElement('div', { className: "text-gray-600" }, 
                                            language === 'he' ? "×—×™×¡×›×•×Ÿ ×§×¨×Ÿ ×”×©×ª×œ××•×ª ×‘×œ×‘×“" : "Training fund savings only")
                                    ])
                                ]),
                                React.createElement('div', { className: "flex items-start" }, [
                                    React.createElement('div', { className: "w-4 h-4 bg-gradient-to-r from-purple-500 to-purple-700 rounded mr-2 mt-1" }),
                                    React.createElement('div', null, [
                                        React.createElement('div', { className: "font-bold text-purple-700" }, 
                                            language === 'he' ? "×¡×”×´×› × ×•××™× ×œ×™" : "Total Nominal"),
                                        React.createElement('div', { className: "text-gray-600" }, 
                                            language === 'he' ? "×”×¡×›×•× ×”× ×•××™× ×œ×™ ×©×™×¦×˜×‘×¨" : "Actual amount that will accumulate")
                                    ])
                                ]),
                                React.createElement('div', { className: "flex items-start" }, [
                                    React.createElement('div', { className: "w-4 h-4 bg-gradient-to-r from-orange-500 to-orange-700 rounded mr-2 mt-1 opacity-70" }),
                                    React.createElement('div', null, [
                                        React.createElement('div', { className: "font-bold text-orange-700" }, 
                                            language === 'he' ? "××•×ª×× ××™× ×¤×œ×¦×™×”" : "Inflation Adjusted"),
                                        React.createElement('div', { className: "text-gray-600" }, 
                                            language === 'he' ? "×›×•×— ×§× ×™×™×” ×××™×ª×™ ×©×œ ×”×›×¡×£" : "Real purchasing power of money")
                                    ])
                                ])
                            ])
                        ])
                    ]),

                    // Footer
                    React.createElement('footer', { className: "mt-12 text-center" }, [
                        React.createElement('div', { className: "glass-effect rounded-xl p-6 border border-white/20" }, [
                            React.createElement('p', { className: "text-gray-600 mb-2" }, 
                                language === 'he' 
                                    ? "ğŸ”§ ××ª×›× ×Ÿ ×”×¤× ×¡×™×” ×”××ª×§×“× - ×›×œ×™ ××§×¦×•×¢×™ ×œ×ª×›× ×•×Ÿ ×¤× ×¡×™×”" 
                                    : "ğŸ”§ Advanced Retirement Planner - Professional Pension Planning Tool"),
                            React.createElement('p', { className: "text-sm text-gray-500" }, 
                                language === 'he' 
                                    ? "âš ï¸ ×”××™×“×¢ ×”×–×” ××™×•×¢×“ ×œ×”××—×©×” ×‘×œ×‘×“ ×•××™× ×• ××”×•×•×” ×™×™×¢×•×¥ ×¤×™× × ×¡×™ ××§×¦×•×¢×™. ×”×ª×™×™×¢×¦×• ×¢× ×™×•×¢×¥ ×¤× ×¡×™×” ××•×¡××š." 
                                    : "âš ï¸ This information is for illustration purposes only and does not constitute professional financial advice. Consult with a qualified pension advisor."),
                            React.createElement('div', { className: "mt-4 flex justify-center items-center gap-4" }, [
                                React.createElement('a', {
                                    href: "https://github.com",
                                    target: "_blank",
                                    rel: "noopener noreferrer",
                                    className: "text-blue-600 hover:text-blue-800 transition-colors"
                                }, language === 'he' ? "ğŸ“ ×§×•×“ ×”××§×•×¨" : "ğŸ“ GitHub"),
                                React.createElement('span', { className: "text-gray-400" }, "|"),
                                React.createElement('span', { className: "text-gray-600" }, 
                                    language === 'he' 
                                        ? `Â© ${new Date().getFullYear()} ×™×”×œ×™ ×¤×•×œ×§ - ××ª×›× ×Ÿ ×”×¤× ×¡×™×” ×”××ª×§×“×` 
                                        : `Â© ${new Date().getFullYear()} Yali Pollak - Advanced Retirement Planner`),
                                React.createElement('span', { className: "text-gray-400" }, "|"),
                                React.createElement('span', { className: "text-xs text-gray-400 font-mono" }, "v2.2.3")
                            ])
                        ])
                    ])
                ])
            ]);
        };

        // Render the app
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(RetirementPlanner));
        
        } catch (error) {
            console.error('Error initializing app:', error);
            document.getElementById('root').innerHTML = `
                <div class="min-h-screen bg-gradient-to-br from-red-50 via-orange-50 to-yellow-50 flex items-center justify-center p-4">
                    <div class="text-center max-w-md">
                        <div class="text-red-500 text-6xl mb-4">ğŸ’¥</div>
                        <h2 class="text-2xl font-bold text-red-700 mb-4">Application Error</h2>
                        <p class="text-gray-700 mb-4">
                            An error occurred while loading the application:
                        </p>
                        <div class="bg-red-100 border border-red-300 rounded-lg p-3 mb-4">
                            <code class="text-red-700 text-sm">${error.message}</code>
                        </div>
                        <button onclick="location.reload()" class="bg-red-500 text-white px-6 py-2 rounded-lg hover:bg-red-600 transition-colors">
                            Reload Page
                        </button>
                    </div>
                </div>
            `;
        }
    }
    </script>
</body>
</html>