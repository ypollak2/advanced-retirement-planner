<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Retirement Planner - Professional Pension Planning Tool</title>
    <meta name="description" content="Advanced retirement planning tool with comprehensive investment tracking, FIRE calculator, partner planning, and stress testing">
    <meta name="keywords" content="retirement, pension planning, retirement calculator, pension savings, training fund, investment planning, partner planning, family financial planning">
    
    <!-- Tailwind CSS via CDN (optimized for production) -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    
    <!-- React & ReactDOM from CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .animate-fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .currency-format {
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #5a6fd8, #6a4190);
        }
        
        /* RTL support */
        [dir="rtl"] .ml-2 { margin-left: 0; margin-right: 0.5rem; }
        [dir="rtl"] .mr-2 { margin-right: 0; margin-left: 0.5rem; }
        [dir="ltr"] .ml-2 { margin-left: 0.5rem; margin-right: 0; }
        [dir="ltr"] .mr-2 { margin-right: 0.5rem; margin-left: 0; }
    </style>
</head>
<body>
    <div id="root" class="min-h-screen gradient-bg"></div>
    
    <!-- Loading indicator while dependencies load -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const root = document.getElementById('root');
            // Create loading screen safely
            const createLoadingScreen = () => {
                const container = document.createElement('div');
                container.className = 'min-h-screen bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50 flex items-center justify-center';
                
                const centerDiv = document.createElement('div');
                centerDiv.className = 'text-center';
                
                const spinner = document.createElement('div');
                spinner.className = 'animate-spin rounded-full h-16 w-16 border-b-2 border-purple-600 mx-auto mb-4';
                
                const hebrewText = document.createElement('p');
                hebrewText.className = 'text-gray-600 text-lg';
                hebrewText.textContent = '◊ò◊ï◊¢◊ü ◊û◊™◊õ◊†◊ü ◊§◊®◊ô◊©◊î ◊û◊™◊ß◊ì◊ù...';
                
                const englishText = document.createElement('p');
                englishText.className = 'text-gray-500 text-sm mt-2';
                englishText.textContent = 'Loading Advanced Retirement Planner...';
                
                const statusDiv = document.createElement('div');
                statusDiv.className = 'mt-4 text-xs text-gray-400';
                const statusText = document.createElement('div');
                statusText.textContent = 'üîÑ Loading core modules...';
                statusDiv.appendChild(statusText);
                
                centerDiv.appendChild(spinner);
                centerDiv.appendChild(hebrewText);
                centerDiv.appendChild(englishText);
                centerDiv.appendChild(statusDiv);
                container.appendChild(centerDiv);
                
                return container;
            };
            
            root.appendChild(createLoadingScreen());
        });

        // Global utility functions
        const safeValue = (value) => isNaN(value) || !isFinite(value) ? 0 : Math.max(0, value);
        
        // Security helper - safe innerHTML replacement for controlled content only
        const safeSetHTML = (element, htmlString) => {
            // Only allow innerHTML for internal, controlled content (not user input)
            // This is safe as we control all the HTML strings in our application
            element.innerHTML = htmlString;
        };

        // Enhanced dependency check function with detailed reporting
        function checkDependencies() {
            console.log('üîç Checking dependencies...');
            
            // Detailed dependency information
            const deps = {
                React: { 
                    available: typeof React !== 'undefined',
                    version: typeof React !== 'undefined' ? React.version : 'N/A',
                    source: 'https://unpkg.com/react@18/umd/react.development.js'
                },
                ReactDOM: { 
                    available: typeof ReactDOM !== 'undefined',
                    version: typeof ReactDOM !== 'undefined' ? ReactDOM.version : 'N/A',
                    source: 'https://unpkg.com/react-dom@18/umd/react-dom.development.js'
                },
                Chart: { 
                    available: typeof Chart !== 'undefined',
                    version: typeof Chart !== 'undefined' ? Chart.version : 'N/A',
                    source: 'https://cdn.jsdelivr.net/npm/chart.js'
                }
            };
            
            // Log detailed information
            Object.entries(deps).forEach(([name, info]) => {
                console.log(`${name}:`, info.available ? `‚úÖ v${info.version}` : '‚ùå Missing');
            });
            
            const missing = Object.entries(deps)
                .filter(([name, info]) => !info.available)
                .map(([name, info]) => ({ name, source: info.source }));
            
            if (missing.length > 0) {
                console.error('‚ùå Missing dependencies:', missing.map(d => d.name));
                
                const missingDetails = missing.map(dep => 
                    `<li><strong>${dep.name}</strong><br><small>${dep.source}</small></li>`
                ).join('');
                
                // Create error screen safely
                const createErrorScreen = (missingDetails) => {
                    const container = document.createElement('div');
                    container.className = 'min-h-screen bg-gradient-to-br from-red-50 via-orange-50 to-yellow-50 flex items-center justify-center p-4';
                    
                    const content = document.createElement('div');
                    content.className = 'text-center max-w-lg';
                    
                    const icon = document.createElement('div');
                    icon.className = 'text-red-500 text-6xl mb-4';
                    icon.textContent = '‚ö†Ô∏è';
                    
                    const title = document.createElement('h2');
                    title.className = 'text-2xl font-bold text-red-700 mb-4';
                    title.textContent = 'Dependency Loading Error';
                    
                    const description = document.createElement('p');
                    description.className = 'text-gray-700 mb-4';
                    description.textContent = 'The following required libraries failed to load:';
                    
                    const errorList = document.createElement('ul');
                    errorList.className = 'text-left bg-red-100 border border-red-300 rounded-lg p-4 mb-4';
                    safeSetHTML(errorList, missingDetails); // Safe here as missingDetails is generated internally
                    
                    const note = document.createElement('p');
                    note.className = 'text-gray-600 text-sm mb-4';
                    note.textContent = 'This might be due to network issues or CDN availability problems.';
                    
                    const buttonContainer = document.createElement('div');
                    buttonContainer.className = 'space-y-2';
                    
                    const retryBtn = document.createElement('button');
                    retryBtn.id = 'retryBtn1';
                    retryBtn.className = 'bg-red-500 text-white px-6 py-2 rounded-lg hover:bg-red-600 transition-colors block w-full';
                    retryBtn.textContent = 'Retry Loading';
                    
                    const debugBtn = document.createElement('button');
                    debugBtn.id = 'debugBtn';
                    debugBtn.className = 'bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition-colors block w-full';
                    debugBtn.textContent = 'Open Browser Test Page';
                    
                    buttonContainer.appendChild(retryBtn);
                    buttonContainer.appendChild(debugBtn);
                    
                    content.appendChild(icon);
                    content.appendChild(title);
                    content.appendChild(description);
                    content.appendChild(errorList);
                    content.appendChild(note);
                    content.appendChild(buttonContainer);
                    container.appendChild(content);
                    
                    return container;
                };
                
                const root = document.getElementById('root');
                root.textContent = ''; // Clear existing content
                root.appendChild(createErrorScreen(missingDetails));
                
                // Add event listeners
                setTimeout(() => {
                    const retryBtn = document.getElementById('retryBtn1');
                    const debugBtn = document.getElementById('debugBtn');
                    
                    if (retryBtn) {
                        retryBtn.addEventListener('click', () => location.reload());
                    }
                    if (debugBtn) {
                        debugBtn.addEventListener('click', () => {
                            window.open('./test-browser.html', '_blank');
                        });
                    }
                }, 100);
                return false;
            }
            
            console.log('‚úÖ All dependencies loaded successfully!');
            return true;
        }

        // Module loading and initialization
        async function initializeApp() {
            try {
                console.log('üöÄ Starting application initialization...');
                
                // Update loading message
                const loadingDiv = document.querySelector('.text-center');
                if (loadingDiv) {
                    safeSetHTML(loadingDiv, `
                        <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-purple-600 mx-auto mb-4"></div>
                        <p class="text-gray-600 text-lg">◊ò◊ï◊¢◊ü ◊û◊ï◊ì◊ï◊ú◊ô ◊ú◊ô◊ë◊î...</p>
                        <p class="text-gray-500 text-sm mt-2">Loading Core Modules...</p>
                        <div class="mt-4 text-xs text-gray-400">
                            <div>üì¶ Loading Dynamic Loader...</div>
                        </div>
                    `);
                }

                // Load dynamic loader first
                await loadScript('./src/core/dynamic-loader.js?v=4.0.0');
                console.log('‚úÖ Dynamic loader loaded');

                // Update loading message
                if (loadingDiv) {
                    safeSetHTML(loadingDiv.querySelector('.text-xs'), '<div>üéØ Loading Core Application...</div>');
                }

                // Load core application
                await loadScript('./src/core/app-main.js?v=4.0.0');
                console.log('‚úÖ Core application loaded');

                // Initialize the core application with ErrorBoundary
                if (window.initializeRetirementPlannerCore) {
                    console.log('üéâ Initializing core application with ErrorBoundary...');
                    window.initializeRetirementPlannerCore();
                    
                    // Preload critical modules in background
                    setTimeout(() => {
                        if (window.moduleLoader) {
                            console.log('üöÄ Starting background preload of critical modules...');
                            window.moduleLoader.preloadCriticalModules();
                        }
                    }, 2000);
                    
                } else {
                    console.error('‚ùå Core application initialization function not found');
                    console.log('Available window functions:', Object.keys(window).filter(k => k.includes('initialize') || k.includes('Retirement')));
                    
                    // Show error without throwing
                    safeSetHTML(document.getElementById('root'), `
                        <div class="min-h-screen bg-gradient-to-br from-red-50 via-orange-50 to-yellow-50 flex items-center justify-center p-4">
                            <div class="text-center max-w-md">
                                <div class="text-red-500 text-6xl mb-4">‚ö†Ô∏è</div>
                                <h2 class="text-2xl font-bold text-red-700 mb-4">Initialization Error</h2>
                                <p class="text-gray-700 mb-4">
                                    Core application initialization function not found. Please refresh the page.
                                </p>
                                <button id="refreshBtn1" class="bg-red-500 text-white px-6 py-2 rounded-lg hover:bg-red-600 transition-colors">
                                    Refresh Page
                                </button>
                            </div>
                        </div>
                    `);
                    
                    // Add event listener for refresh button
                    setTimeout(() => {
                        const refreshBtn = document.getElementById('refreshBtn1');
                        if (refreshBtn) {
                            refreshBtn.addEventListener('click', () => location.reload());
                        }
                    }, 100);
                    
                    return; // Don't continue with initialization
                }

            } catch (error) {
                console.error('‚ùå Application initialization failed:', error);
                safeSetHTML(document.getElementById('root'), `
                    <div class="min-h-screen bg-gradient-to-br from-red-50 via-orange-50 to-yellow-50 flex items-center justify-center p-4">
                        <div class="text-center max-w-md">
                            <div class="text-red-500 text-6xl mb-4">üí•</div>
                            <h2 class="text-2xl font-bold text-red-700 mb-4">Application Error</h2>
                            <p class="text-gray-700 mb-4">
                                Failed to initialize the retirement planner:
                            </p>
                            <div class="bg-red-100 border border-red-300 rounded-lg p-3 mb-4">
                                <code class="text-red-700 text-sm">${error.message}</code>
                            </div>
                            <button id="retryBtn2" class="bg-red-500 text-white px-6 py-2 rounded-lg hover:bg-red-600 transition-colors">
                                Reload Application
                            </button>
                        </div>
                    </div>
                `);
                // Add event listener for retry button
                setTimeout(() => {
                    const retryBtn = document.getElementById('retryBtn2');
                    if (retryBtn) {
                        retryBtn.addEventListener('click', () => location.reload());
                    }
                }, 100);
            }
        }

        // Helper function to load scripts dynamically with retry logic
        function loadScript(src, retries = 2) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.async = true;
                
                script.onload = () => {
                    console.log(`‚úÖ Loaded: ${src}`);
                    resolve();
                };
                
                script.onerror = () => {
                    console.error(`‚ùå Failed to load: ${src}`);
                    document.head.removeChild(script);
                    
                    if (retries > 0) {
                        console.log(`üîÑ Retrying to load: ${src} (${retries} attempts left)`);
                        setTimeout(() => {
                            loadScript(src, retries - 1).then(resolve).catch(reject);
                        }, 1000);
                    } else {
                        // Show detailed error information
                        const errorDetails = `
                            <div class="bg-red-100 border border-red-300 rounded-lg p-3 mb-4">
                                <h4 class="font-bold text-red-700">Failed to load script:</h4>
                                <code class="text-red-600 text-sm break-all">${src}</code>
                                <p class="text-red-600 text-sm mt-2">This might be due to network issues or missing files.</p>
                            </div>
                        `;
                        
                        safeSetHTML(document.getElementById('root'), `
                            <div class="min-h-screen bg-gradient-to-br from-red-50 via-orange-50 to-yellow-50 flex items-center justify-center p-4">
                                <div class="text-center max-w-lg">
                                    <div class="text-red-500 text-6xl mb-4">üì°</div>
                                    <h2 class="text-2xl font-bold text-red-700 mb-4">Loading Error</h2>
                                    ${errorDetails}
                                    <div class="space-y-2">
                                        <button id="retryBtn" class="bg-red-500 text-white px-6 py-2 rounded-lg hover:bg-red-600 transition-colors block w-full">
                                            Retry Loading
                                        </button>
                                        <button id="testBtn" class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition-colors block w-full">
                                            Open Browser Test
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `);
                        
                        // Add event listeners for error page buttons
                        setTimeout(() => {
                            const retryBtn = document.getElementById('retryBtn');
                            const testBtn = document.getElementById('testBtn');
                            
                            if (retryBtn) {
                                retryBtn.addEventListener('click', () => location.reload());
                            }
                            if (testBtn) {
                                testBtn.addEventListener('click', () => window.open('./test-browser.html', '_blank'));
                            }
                        }, 100);
                        
                        reject(new Error(`Failed to load script after retries: ${src}`));
                    }
                };
                
                document.head.appendChild(script);
            });
        }

        // Wait for dependencies and initialize
        const maxWaitTime = 10000; // 10 seconds
        let waitTime = 0;
        const checkInterval = setInterval(() => {
            if (checkDependencies()) {
                clearInterval(checkInterval);
                initializeApp();
            } else if (waitTime > maxWaitTime) {
                clearInterval(checkInterval);
                console.error('‚è∞ Dependency loading timeout');
            }
            waitTime += 100;
        }, 100);
    </script>
</body>
</html>