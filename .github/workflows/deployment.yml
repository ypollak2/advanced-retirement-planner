name: ğŸš€ Deployment Pipeline

on:
  workflow_run:
    workflows: ["ğŸ”„ CI Pipeline (Main)"]
    types: [completed]
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'stage'
        type: choice
        options:
          - stage
          - production
          - both
      skip_validation:
        description: 'Skip deployment validation'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '18'
  STAGE_URL: 'https://ypollak2.github.io/advanced-retirement-planner/stage/'
  PRODUCTION_URL: 'https://ypollak2.github.io/advanced-retirement-planner/'

# Concurrency control - only one deployment at a time
concurrency:
  group: deployment
  cancel-in-progress: false

jobs:
  # Job 1: Pre-deployment Checks
  pre-deployment:
    name: ğŸ” Pre-deployment Validation
    runs-on: ubuntu-latest
    if: |
      (github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main') ||
      github.event_name == 'workflow_dispatch'
    timeout-minutes: 10
    
    outputs:
      deploy-stage: ${{ steps.check.outputs.stage }}
      deploy-production: ${{ steps.check.outputs.production }}
      version: ${{ steps.version.outputs.version }}
      
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}
          
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¥ Install dependencies
        run: npm ci --prefer-offline --no-audit
        
      - name: ğŸ·ï¸ Get version
        id: version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Deploying version: $VERSION"
          
      - name: âœ… Deployment readiness check
        id: check
        run: |
          echo "ğŸ” Checking deployment readiness..."
          
          # Run comprehensive pre-deployment validation
          if npm run validate:pre-work 2>/dev/null; then
            echo "âœ… Pre-deployment validation passed"
          else
            echo "âš ï¸ Pre-deployment validation script not found, running basic checks"
            
            # Basic validation
            if [ ! -f "index.html" ] || [ ! -f "package.json" ]; then
              echo "âŒ Missing essential files"
              exit 1
            fi
          fi
          
          # Determine what to deploy based on input or trigger
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            ENVIRONMENT="${{ github.event.inputs.environment }}"
            case $ENVIRONMENT in
              "stage")
                echo "stage=true" >> $GITHUB_OUTPUT
                echo "production=false" >> $GITHUB_OUTPUT
                ;;
              "production")
                echo "stage=false" >> $GITHUB_OUTPUT
                echo "production=true" >> $GITHUB_OUTPUT
                ;;
              "both")
                echo "stage=true" >> $GITHUB_OUTPUT
                echo "production=true" >> $GITHUB_OUTPUT
                ;;
            esac
          else
            # Automatic workflow: deploy to stage first, then production
            echo "stage=true" >> $GITHUB_OUTPUT
            echo "production=true" >> $GITHUB_OUTPUT
          fi
          
      - name: ğŸ“Š Pre-deployment summary
        run: |
          echo "## ğŸš€ Deployment Pipeline Started" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ github.event.workflow_run.head_sha || github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployment Plan" >> $GITHUB_STEP_SUMMARY
          echo "- Stage: ${{ steps.check.outputs.stage == 'true' && 'âœ… Yes' || 'âŒ No' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Production: ${{ steps.check.outputs.production == 'true' && 'âœ… Yes' || 'âŒ No' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

  # Job 2: Stage Deployment
  deploy-stage:
    name: ğŸ­ Deploy to Stage
    runs-on: ubuntu-latest
    needs: pre-deployment
    if: needs.pre-deployment.outputs.deploy-stage == 'true'
    timeout-minutes: 15
    
    environment:
      name: staging
      url: ${{ env.STAGE_URL }}
      
    permissions:
      contents: write
      pages: write
      id-token: write
      
    outputs:
      stage-status: ${{ steps.deploy.outputs.status }}
      stage-url: ${{ steps.deploy.outputs.url }}
      
    steps:
      - name: ğŸ“¥ Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: ğŸ“¥ Install dependencies
        run: npm ci --prefer-offline --no-audit
        
      - name: ğŸ§ª Final test verification
        run: |
          echo "ğŸ§ª Running final tests before stage deployment..."
          npm test
          
      - name: ğŸ“¥ Checkout gh-pages branch for stage
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages-repo
          
      - name: ğŸ­ Deploy to stage folder
        id: deploy
        run: |
          echo "ğŸ­ Deploying to stage environment..."
          
          # Create or update stage folder
          mkdir -p gh-pages-repo/stage
          
          # Copy all files to stage folder (excluding git and node_modules)
          find . -maxdepth 1 \
            ! -name . \
            ! -name gh-pages-repo \
            ! -name .git \
            ! -name .github \
            ! -name node_modules \
            ! -name '*.log' \
            -exec cp -r {} gh-pages-repo/stage/ \;
          
          # Create stage-specific version indicator
          echo "<!-- Stage Deployment v${{ needs.pre-deployment.outputs.version }} - $(date) -->" >> gh-pages-repo/stage/index.html
          
          cd gh-pages-repo
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add stage/
          
          if git diff --staged --quiet; then
            echo "status=no-changes" >> $GITHUB_OUTPUT
            echo "url=${{ env.STAGE_URL }}" >> $GITHUB_OUTPUT
            echo "No changes to deploy to stage"
          else
            git commit -m "ğŸ­ Deploy to stage: v${{ needs.pre-deployment.outputs.version }} ($(date '+%Y-%m-%d %H:%M:%S'))"
            git push origin gh-pages
            
            echo "status=deployed" >> $GITHUB_OUTPUT
            echo "url=${{ env.STAGE_URL }}" >> $GITHUB_OUTPUT
            echo "âœ… Stage deployment completed"
          fi

  # Job 3: Stage Validation
  validate-stage:
    name: âœ… Validate Stage Deployment
    runs-on: ubuntu-latest
    needs: [pre-deployment, deploy-stage]
    if: needs.deploy-stage.outputs.stage-status != 'skipped' && !github.event.inputs.skip_validation
    timeout-minutes: 10
    
    outputs:
      validation-status: ${{ steps.validate.outputs.status }}
      
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: â³ Wait for stage deployment
        run: |
          echo "â³ Waiting for stage deployment to propagate..."
          sleep 60
          
      - name: âœ… Validate stage deployment
        id: validate
        run: |
          echo "âœ… Validating stage deployment..."
          
          MAX_ATTEMPTS=10
          ATTEMPT=1
          
          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "ğŸ” Attempt $ATTEMPT: Checking stage availability..."
            
            if curl -sSf "${{ env.STAGE_URL }}" > /dev/null; then
              echo "âœ… Stage deployment is accessible"
              
              # Check for version indicator
              if curl -s "${{ env.STAGE_URL }}" | grep -q "v${{ needs.pre-deployment.outputs.version }}"; then
                echo "âœ… Correct version deployed"
                echo "status=success" >> $GITHUB_OUTPUT
                break
              else
                echo "âš ï¸ Version mismatch detected"
              fi
              
            else
              echo "âŒ Stage deployment not accessible yet"
            fi
            
            if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
              echo "status=failed" >> $GITHUB_OUTPUT
              echo "âŒ Stage validation failed after $MAX_ATTEMPTS attempts"
              exit 1
            fi
            
            echo "â³ Waiting 30 seconds before retry..."
            sleep 30
            ATTEMPT=$((ATTEMPT + 1))
          done
          
      - name: ğŸ“Š Stage validation summary
        run: |
          echo "### ğŸ­ Stage Deployment Result" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: ${{ needs.deploy-stage.outputs.stage-url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ steps.validate.outputs.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ needs.pre-deployment.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

  # Job 4: Production Deployment (depends on stage success)
  deploy-production:
    name: ğŸŒŸ Deploy to Production
    runs-on: ubuntu-latest
    needs: [pre-deployment, deploy-stage, validate-stage]
    if: |
      needs.pre-deployment.outputs.deploy-production == 'true' && 
      (needs.validate-stage.outputs.validation-status == 'success' || github.event.inputs.skip_validation == 'true')
    timeout-minutes: 15
    
    environment:
      name: production
      url: ${{ env.PRODUCTION_URL }}
      
    permissions:
      contents: write
      pages: write
      id-token: write
      
    outputs:
      production-status: ${{ steps.deploy.outputs.status }}
      production-url: ${{ steps.deploy.outputs.url }}
      
    steps:
      - name: ğŸ“¥ Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: ğŸ“¥ Install dependencies
        run: npm ci --prefer-offline --no-audit
        
      - name: ğŸ§ª Final production test verification
        run: |
          echo "ğŸ§ª Running final tests before production deployment..."
          npm test
          
      - name: ğŸ” Production readiness validation
        run: |
          echo "ğŸ” Final production readiness check..."
          if command -v npm run validate:deployment &> /dev/null; then
            npm run validate:deployment
          else
            echo "âš ï¸ Production validation script not found, proceeding with basic checks"
          fi
          
      - name: ğŸ“¥ Checkout gh-pages branch for production
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages-repo
          
      - name: ğŸŒŸ Deploy to production (root)
        id: deploy
        run: |
          echo "ğŸŒŸ Deploying to production environment..."
          
          # Copy all files to gh-pages root (preserving stage folder)
          find . -maxdepth 1 \
            ! -name . \
            ! -name gh-pages-repo \
            ! -name .git \
            ! -name .github \
            ! -name node_modules \
            ! -name '*.log' \
            -exec cp -r {} gh-pages-repo/ \;
          
          # Create production version indicator
          echo "<!-- Production Deployment v${{ needs.pre-deployment.outputs.version }} - $(date) -->" >> gh-pages-repo/index.html
          
          cd gh-pages-repo
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Add all changes except stage folder
          git add -A
          git reset stage/ 2>/dev/null || true  # Don't remove stage folder
          
          if git diff --staged --quiet; then
            echo "status=no-changes" >> $GITHUB_OUTPUT
            echo "url=${{ env.PRODUCTION_URL }}" >> $GITHUB_OUTPUT
            echo "No changes to deploy to production"
          else
            git commit -m "ğŸ‰ Deploy to production: v${{ needs.pre-deployment.outputs.version }} ($(date '+%Y-%m-%d %H:%M:%S'))"
            git push origin gh-pages
            
            echo "status=deployed" >> $GITHUB_OUTPUT
            echo "url=${{ env.PRODUCTION_URL }}" >> $GITHUB_OUTPUT
            echo "âœ… Production deployment completed"
          fi

  # Job 5: Production Validation
  validate-production:
    name: âœ… Validate Production Deployment  
    runs-on: ubuntu-latest
    needs: [pre-deployment, deploy-production]
    if: needs.deploy-production.outputs.production-status != 'skipped' && !github.event.inputs.skip_validation
    timeout-minutes: 10
    
    outputs:
      validation-status: ${{ steps.validate.outputs.status }}
      
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: â³ Wait for production deployment
        run: |
          echo "â³ Waiting for production deployment to propagate..."
          sleep 90
          
      - name: âœ… Validate production deployment
        id: validate
        run: |
          echo "âœ… Validating production deployment..."
          
          MAX_ATTEMPTS=15
          ATTEMPT=1
          
          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "ğŸ” Attempt $ATTEMPT: Checking production availability..."
            
            if curl -sSf "${{ env.PRODUCTION_URL }}" > /dev/null; then
              echo "âœ… Production deployment is accessible"
              
              # Check for version indicator
              if curl -s "${{ env.PRODUCTION_URL }}" | grep -q "v${{ needs.pre-deployment.outputs.version }}"; then
                echo "âœ… Correct version deployed to production"
                echo "status=success" >> $GITHUB_OUTPUT
                break
              else
                echo "âš ï¸ Version mismatch detected"
              fi
              
            else
              echo "âŒ Production deployment not accessible yet"
            fi
            
            if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
              echo "status=failed" >> $GITHUB_OUTPUT
              echo "âŒ Production validation failed after $MAX_ATTEMPTS attempts"
              exit 1
            fi
            
            echo "â³ Waiting 30 seconds before retry..."
            sleep 30
            ATTEMPT=$((ATTEMPT + 1))
          done

  # Job 6: Deployment Summary & Notifications
  deployment-summary:
    name: ğŸ“Š Deployment Summary
    runs-on: ubuntu-latest
    needs: [pre-deployment, deploy-stage, validate-stage, deploy-production, validate-production]
    if: always()
    timeout-minutes: 5
    
    steps:
      - name: ğŸ“Š Generate deployment summary
        run: |
          echo "## ğŸš€ Deployment Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: ${{ needs.pre-deployment.outputs.version || 'Unknown' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Stage deployment summary
          if [[ "${{ needs.deploy-stage.result }}" != "skipped" ]]; then
            echo "### ğŸ­ Stage Deployment" >> $GITHUB_STEP_SUMMARY
            echo "- **Status**: ${{ needs.deploy-stage.result }}" >> $GITHUB_STEP_SUMMARY
            echo "- **URL**: ${{ env.STAGE_URL }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Validation**: ${{ needs.validate-stage.result || 'Skipped' }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Production deployment summary  
          if [[ "${{ needs.deploy-production.result }}" != "skipped" ]]; then
            echo "### ğŸŒŸ Production Deployment" >> $GITHUB_STEP_SUMMARY
            echo "- **Status**: ${{ needs.deploy-production.result }}" >> $GITHUB_STEP_SUMMARY
            echo "- **URL**: ${{ env.PRODUCTION_URL }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Validation**: ${{ needs.validate-production.result || 'Skipped' }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Overall status
          if [[ "${{ needs.deploy-production.result }}" == "success" && "${{ needs.validate-production.result }}" == "success" ]]; then
            echo "ğŸ‰ **DEPLOYMENT SUCCESSFUL**" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.deploy-stage.result }}" == "success" ]]; then
            echo "ğŸ­ **STAGE DEPLOYMENT SUCCESSFUL**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **DEPLOYMENT FAILED**" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Generated by Deployment Pipeline workflow*" >> $GITHUB_STEP_SUMMARY
          
      - name: ğŸ“ Create deployment comment
        if: needs.deploy-production.result == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            const deploymentStatus = {
              stage: '${{ needs.deploy-stage.result }}',
              production: '${{ needs.deploy-production.result }}',
              stageValidation: '${{ needs.validate-stage.result }}',
              productionValidation: '${{ needs.validate-production.result }}'
            };
            
            let comment = 'ğŸ‰ **Deployment Complete!**\n\n';
            comment += `**Version**: ${{ needs.pre-deployment.outputs.version }}\n`;
            comment += `**Commit**: ${{ github.sha }}\n\n`;
            
            if (deploymentStatus.stage === 'success') {
              comment += `ğŸ­ **Stage**: âœ… Deployed to ${{ env.STAGE_URL }}\n`;
            }
            
            if (deploymentStatus.production === 'success') {
              comment += `ğŸŒŸ **Production**: âœ… Deployed to ${{ env.PRODUCTION_URL }}\n`;
              comment += `**Mirror**: https://advanced-retirement-planner.netlify.app/\n\n`;
            }
            
            comment += `**Deployed at**: ${new Date().toISOString()}\n`;
            comment += `**Workflow**: [View Details](${context.payload.repository.html_url}/actions/runs/${context.runId})`;
            
            github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: comment
            });
            
      - name: ğŸš¨ Notify on deployment failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const comment = 'ğŸš¨ **Deployment Failed**\n\n';
            comment += `**Version**: ${{ needs.pre-deployment.outputs.version || 'Unknown' }}\n`;
            comment += `**Commit**: ${{ github.sha }}\n`;
            comment += `**Failed Jobs**: Check the [workflow run](${context.payload.repository.html_url}/actions/runs/${context.runId}) for details\n\n`;
            comment += `Please review the logs and retry the deployment after fixing any issues.`;
            
            github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: comment
            });