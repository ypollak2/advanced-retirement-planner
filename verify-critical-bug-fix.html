<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verify Critical Bug Fix - Score 27-29</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1 {
            margin: 0;
            color: #333;
        }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .test-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border: 2px solid #ddd;
        }
        .test-card.pass {
            border-color: #28a745;
            background: #f8fff9;
        }
        .test-card.fail {
            border-color: #dc3545;
            background: #fff8f8;
        }
        .test-card.critical {
            border-color: #ff6b6b;
            background: #ffe0e0;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
        .score {
            font-size: 36px;
            font-weight: bold;
            text-align: center;
            margin: 10px 0;
        }
        .score.good { color: #28a745; }
        .score.bad { color: #dc3545; }
        .score.critical { color: #ff6b6b; }
        .status {
            text-align: center;
            font-weight: bold;
            padding: 5px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.pass { background: #d4edda; color: #155724; }
        .status.fail { background: #f8d7da; color: #721c24; }
        .summary {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin: 20px 0;
        }
        .summary h2 {
            margin-top: 0;
        }
        .critical-alert {
            background: #dc3545;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            font-weight: bold;
            text-align: center;
            font-size: 18px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        pre {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîç Critical Bug Verification: Score 27-29 Issue</h1>
        <p>This page tests multiple scenarios to verify if the critical low score bug (27-29) has been fixed in v7.4.0</p>
    </div>

    <div id="criticalAlert" class="critical-alert" style="display: none;">
        ‚ö†Ô∏è CRITICAL BUG DETECTED: Scores are still returning 27-29!
    </div>

    <div class="summary">
        <h2>Test Instructions</h2>
        <p>This test simulates various financial scenarios and checks if they return the problematic 27-29 score range.</p>
        <ol>
            <li>Load the production app's financial health engine</li>
            <li>Run each test scenario</li>
            <li>Check if scores fall in the 27-29 range</li>
            <li>Green = Good (outside 27-29), Red = Bad (27-29 detected)</li>
        </ol>
        <button onclick="runAllTests()">Run All Tests</button>
        <button onclick="clearResults()">Clear Results</button>
    </div>

    <div id="testResults" class="test-grid"></div>

    <div id="summary" class="summary" style="display: none;">
        <h2>Test Summary</h2>
        <div id="summaryContent"></div>
    </div>

    <script>
        // Test scenarios designed to trigger different score ranges
        const testScenarios = [
            {
                id: 'high-income',
                name: 'High Income Professional',
                data: {
                    planningType: 'individual',
                    currentAge: 35,
                    retirementAge: 67,
                    currentMonthlySalary: 50000,
                    currentMonthlyExpenses: 25000,
                    currentPension: 500000,
                    currentTrainingFund: 300000,
                    currentPortfolio: 200000,
                    emergencyFund: 150000,
                    pensionContributionRate: 18.5,
                    trainingFundContributionRate: 10,
                    riskTolerance: 'balanced',
                    expectedAnnualReturn: 7
                },
                expectedRange: { min: 70, max: 95 }
            },
            {
                id: 'average-earner',
                name: 'Average Earner',
                data: {
                    planningType: 'individual',
                    currentAge: 40,
                    retirementAge: 67,
                    currentMonthlySalary: 15000,
                    currentMonthlyExpenses: 12000,
                    currentPension: 150000,
                    currentTrainingFund: 80000,
                    emergencyFund: 30000,
                    pensionContributionRate: 12,
                    trainingFundContributionRate: 7.5,
                    riskTolerance: 'moderate',
                    expectedAnnualReturn: 5
                },
                expectedRange: { min: 45, max: 70 }
            },
            {
                id: 'low-income',
                name: 'Low Income',
                data: {
                    planningType: 'individual',
                    currentAge: 28,
                    retirementAge: 67,
                    currentMonthlySalary: 8000,
                    currentMonthlyExpenses: 7500,
                    currentPension: 10000,
                    currentTrainingFund: 5000,
                    emergencyFund: 0,
                    pensionContributionRate: 6,
                    trainingFundContributionRate: 2.5,
                    riskTolerance: 'conservative',
                    expectedAnnualReturn: 4
                },
                expectedRange: { min: 15, max: 40 }
            },
            {
                id: 'couple-dual-income',
                name: 'Couple - Dual Income',
                data: {
                    planningType: 'couple',
                    partner1Salary: 25000,
                    partner1CurrentPension: 200000,
                    partner1CurrentTrainingFund: 100000,
                    partner2Salary: 20000,
                    partner2CurrentPension: 150000,
                    partner2CurrentTrainingFund: 80000,
                    currentAge: 38,
                    retirementAge: 67,
                    currentMonthlyExpenses: 30000,
                    emergencyFund: 100000,
                    partner1RiskProfile: 'moderate',
                    partner2RiskProfile: 'moderate',
                    partner1ExpectedReturn: 6,
                    partner2ExpectedReturn: 6
                },
                expectedRange: { min: 55, max: 80 }
            },
            {
                id: 'near-retirement',
                name: 'Near Retirement',
                data: {
                    planningType: 'individual',
                    currentAge: 60,
                    retirementAge: 67,
                    currentMonthlySalary: 30000,
                    currentMonthlyExpenses: 20000,
                    currentPension: 800000,
                    currentTrainingFund: 400000,
                    currentPortfolio: 300000,
                    emergencyFund: 200000,
                    pensionContributionRate: 20,
                    trainingFundContributionRate: 10,
                    riskTolerance: 'conservative',
                    expectedAnnualReturn: 4
                },
                expectedRange: { min: 75, max: 95 }
            },
            {
                id: 'zero-income',
                name: 'Zero Income (Edge Case)',
                data: {
                    planningType: 'individual',
                    currentAge: 25,
                    retirementAge: 67,
                    currentMonthlySalary: 0,
                    currentMonthlyExpenses: 5000,
                    currentPension: 0,
                    currentTrainingFund: 0,
                    emergencyFund: 0,
                    pensionContributionRate: 0,
                    trainingFundContributionRate: 0,
                    riskTolerance: 'conservative',
                    expectedAnnualReturn: 3
                },
                expectedRange: { min: 0, max: 15 }
            }
        ];

        let testResults = [];
        let financialHealthEngine = null;

        async function loadFinancialHealthEngine() {
            try {
                // Try to load the engine from production
                const response = await fetch('https://ypollak2.github.io/advanced-retirement-planner/src/utils/financialHealthEngine.js');
                const scriptText = await response.text();
                
                // Create a script element to execute it
                const script = document.createElement('script');
                script.textContent = scriptText;
                document.head.appendChild(script);
                
                // Check if engine is available
                if (window.calculateFinancialHealthScore) {
                    financialHealthEngine = {
                        calculateHealthScore: (inputs) => window.calculateFinancialHealthScore(inputs, {
                            combinePartners: inputs.planningType === 'couple',
                            debugMode: true
                        })
                    };
                    return true;
                }
                
                throw new Error('Financial health engine not found in loaded script');
                
            } catch (error) {
                console.error('Failed to load financial health engine:', error);
                
                // Fallback: Create a mock engine that returns the bug range
                financialHealthEngine = {
                    calculateHealthScore: (inputs) => {
                        // Simulate the bug - always return 27-29
                        return {
                            totalScore: 27 + Math.random() * 2,
                            factorScores: {}
                        };
                    }
                };
                
                return false;
            }
        }

        async function runAllTests() {
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.innerHTML = '<div class="loading">Loading financial health engine...</div>';
            
            // Load the engine
            const engineLoaded = await loadFinancialHealthEngine();
            
            if (!engineLoaded) {
                resultsDiv.innerHTML = '<div class="critical-alert">Failed to load engine - using mock that simulates the bug</div>';
            }
            
            resultsDiv.innerHTML = '';
            testResults = [];
            
            for (const scenario of testScenarios) {
                await runTest(scenario);
                await new Promise(resolve => setTimeout(resolve, 500)); // Small delay between tests
            }
            
            showSummary();
        }

        async function runTest(scenario) {
            try {
                // Run the test
                const result = financialHealthEngine.calculateHealthScore(scenario.data);
                const score = result.totalScore || 0;
                
                // Check if it's in the bug range
                const isBugRange = score >= 27 && score <= 29;
                const isInExpectedRange = score >= scenario.expectedRange.min && score <= scenario.expectedRange.max;
                const passed = !isBugRange && isInExpectedRange;
                
                // Store result
                const testResult = {
                    scenario: scenario,
                    score: score,
                    isBugRange: isBugRange,
                    passed: passed,
                    result: result
                };
                
                testResults.push(testResult);
                displayTestResult(testResult);
                
                // Show critical alert if bug detected
                if (isBugRange) {
                    document.getElementById('criticalAlert').style.display = 'block';
                }
                
            } catch (error) {
                console.error(`Test ${scenario.id} failed:`, error);
                const testResult = {
                    scenario: scenario,
                    score: -1,
                    error: error.message,
                    passed: false
                };
                testResults.push(testResult);
                displayTestResult(testResult);
            }
        }

        function displayTestResult(testResult) {
            const resultsDiv = document.getElementById('testResults');
            const { scenario, score, isBugRange, passed, error } = testResult;
            
            const cardClass = isBugRange ? 'critical' : (passed ? 'pass' : 'fail');
            const scoreClass = isBugRange ? 'critical' : (passed ? 'good' : 'bad');
            const statusText = isBugRange ? '‚ùå BUG DETECTED (27-29)' : (passed ? '‚úÖ PASS' : '‚ùå FAIL');
            const statusClass = passed ? 'pass' : 'fail';
            
            const card = document.createElement('div');
            card.className = `test-card ${cardClass}`;
            card.innerHTML = `
                <h3>${scenario.name}</h3>
                ${error ? 
                    `<div class="status fail">Error: ${error}</div>` :
                    `<div class="score ${scoreClass}">${score.toFixed(1)}</div>
                     <div class="status ${statusClass}">${statusText}</div>
                     <div style="text-align: center; color: #666; font-size: 14px;">
                        Expected: ${scenario.expectedRange.min}-${scenario.expectedRange.max}
                     </div>`
                }
                <details style="margin-top: 10px;">
                    <summary style="cursor: pointer;">Test Data</summary>
                    <pre>${JSON.stringify(scenario.data, null, 2)}</pre>
                </details>
            `;
            
            resultsDiv.appendChild(card);
        }

        function showSummary() {
            const summaryDiv = document.getElementById('summary');
            const summaryContent = document.getElementById('summaryContent');
            
            const total = testResults.length;
            const passed = testResults.filter(r => r.passed).length;
            const failed = total - passed;
            const bugDetected = testResults.filter(r => r.isBugRange).length;
            
            summaryDiv.style.display = 'block';
            summaryContent.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 20px;">
                    <div style="text-align: center;">
                        <div style="font-size: 36px; font-weight: bold;">${total}</div>
                        <div>Total Tests</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 36px; font-weight: bold; color: #28a745;">${passed}</div>
                        <div>Passed</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 36px; font-weight: bold; color: #dc3545;">${failed}</div>
                        <div>Failed</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 36px; font-weight: bold; color: #ff6b6b;">${bugDetected}</div>
                        <div>Bug Detected (27-29)</div>
                    </div>
                </div>
                
                ${bugDetected > 0 ? `
                    <div class="critical-alert">
                        ‚ö†Ô∏è CRITICAL: The 27-29 score bug is still present in ${bugDetected} out of ${total} tests!
                    </div>
                ` : `
                    <div style="background: #d4edda; color: #155724; padding: 15px; border-radius: 8px; text-align: center; font-weight: bold;">
                        ‚úÖ SUCCESS: No 27-29 score bug detected!
                    </div>
                `}
                
                <h3>Score Distribution:</h3>
                <ul>
                    ${testResults.map(r => `
                        <li>${r.scenario.name}: ${r.score >= 0 ? r.score.toFixed(1) : 'Error'} 
                            ${r.isBugRange ? '(BUG!)' : ''}</li>
                    `).join('')}
                </ul>
            `;
        }

        function clearResults() {
            document.getElementById('testResults').innerHTML = '';
            document.getElementById('summary').style.display = 'none';
            document.getElementById('criticalAlert').style.display = 'none';
            testResults = [];
        }
    </script>
</body>
</html>