<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Post-Deployment E2E Tests - v7.3.2</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .test-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-item {
            padding: 12px;
            margin: 8px 0;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
        }
        .test-item.pending { background-color: #f0f0f0; color: #666; }
        .test-item.running { background-color: #fff3cd; color: #856404; }
        .test-item.pass { background-color: #d4edda; color: #155724; }
        .test-item.fail { background-color: #f8d7da; color: #721c24; }
        .status-icon {
            font-size: 18px;
            width: 24px;
            text-align: center;
        }
        .control-panel {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            text-align: center;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 0 10px;
            transition: all 0.3s;
        }
        button:hover {
            background: #5a67d8;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        .summary {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-top: 30px;
            text-align: center;
        }
        .summary.success {
            border-top: 5px solid #28a745;
        }
        .summary.failure {
            border-top: 5px solid #dc3545;
        }
        .metric {
            display: inline-block;
            margin: 10px 20px;
            font-size: 18px;
        }
        .metric-value {
            font-size: 36px;
            font-weight: bold;
            display: block;
            margin-top: 5px;
        }
        .error-log {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-top: 20px;
            font-family: monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
            text-align: left;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üöÄ Post-Deployment E2E Tests - Version 7.3.2</h1>
        <p>Production URL: https://ypollak2.github.io/advanced-retirement-planner/</p>
        <p>Started: <span id="startTime">-</span></p>
    </div>

    <div class="control-panel">
        <h2>Test Controls</h2>
        <button id="runAllBtn" onclick="runAllTests()">üß™ Run All Tests</button>
        <button id="runCriticalBtn" onclick="runCriticalTests()">‚ö° Run Critical Tests Only</button>
        <button id="clearBtn" onclick="clearResults()">üóëÔ∏è Clear Results</button>
        <div class="progress-bar">
            <div id="progressFill" class="progress-fill"></div>
        </div>
        <p id="progressText">Ready to start testing</p>
    </div>

    <div class="test-grid">
        <div class="test-card">
            <h3>üîç Core Functionality</h3>
            <div id="coreTests">
                <div class="test-item pending" data-test="version-check">
                    <span class="status-icon">‚è≥</span>
                    <span>Version 7.3.2 Deployed</span>
                </div>
                <div class="test-item pending" data-test="wizard-loads">
                    <span class="status-icon">‚è≥</span>
                    <span>RetirementWizard Loads</span>
                </div>
                <div class="test-item pending" data-test="no-init-errors">
                    <span class="status-icon">‚è≥</span>
                    <span>No Initialization Errors</span>
                </div>
                <div class="test-item pending" data-test="app-renders">
                    <span class="status-icon">‚è≥</span>
                    <span>App Renders Successfully</span>
                </div>
            </div>
        </div>

        <div class="test-card">
            <h3>üõ°Ô∏è Error Checks</h3>
            <div id="errorTests">
                <div class="test-item pending" data-test="no-console-errors">
                    <span class="status-icon">‚è≥</span>
                    <span>No Console Errors</span>
                </div>
                <div class="test-item pending" data-test="no-t-error">
                    <span class="status-icon">‚è≥</span>
                    <span>No 't' Initialization Error</span>
                </div>
                <div class="test-item pending" data-test="no-handleNext-error">
                    <span class="status-icon">‚è≥</span>
                    <span>No 'handleNext' Error</span>
                </div>
                <div class="test-item pending" data-test="components-loaded">
                    <span class="status-icon">‚è≥</span>
                    <span>All Components Loaded</span>
                </div>
            </div>
        </div>

        <div class="test-card">
            <h3>üåê Integration</h3>
            <div id="integrationTests">
                <div class="test-item pending" data-test="service-worker">
                    <span class="status-icon">‚è≥</span>
                    <span>Service Worker Active</span>
                </div>
                <div class="test-item pending" data-test="api-ready">
                    <span class="status-icon">‚è≥</span>
                    <span>APIs Initialized</span>
                </div>
                <div class="test-item pending" data-test="storage-available">
                    <span class="status-icon">‚è≥</span>
                    <span>Storage Available</span>
                </div>
                <div class="test-item pending" data-test="cache-updated">
                    <span class="status-icon">‚è≥</span>
                    <span>Cache Updated to v7.3.2</span>
                </div>
            </div>
        </div>
    </div>

    <div id="summary" class="summary" style="display: none;">
        <h2 id="summaryTitle">Test Results</h2>
        <div id="metrics"></div>
        <div id="errorLog" class="error-log" style="display: none;"></div>
    </div>

    <script>
        const PRODUCTION_URL = 'https://ypollak2.github.io/advanced-retirement-planner/';
        const EXPECTED_VERSION = '7.3.2';
        
        let testResults = [];
        let errors = [];
        let totalTests = 0;
        let completedTests = 0;

        function updateProgress() {
            const percent = totalTests > 0 ? (completedTests / totalTests) * 100 : 0;
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressText').textContent = `${completedTests} / ${totalTests} tests completed`;
        }

        function updateTestStatus(testId, status, message = '') {
            const testElement = document.querySelector(`[data-test="${testId}"]`);
            if (!testElement) return;

            testElement.className = `test-item ${status}`;
            const statusIcons = {
                pending: '‚è≥',
                running: 'üîÑ',
                pass: '‚úÖ',
                fail: '‚ùå'
            };
            testElement.querySelector('.status-icon').textContent = statusIcons[status];

            if (message) {
                const span = testElement.querySelector('span:last-child');
                span.textContent += ` - ${message}`;
            }

            if (status === 'pass' || status === 'fail') {
                completedTests++;
                updateProgress();
                testResults.push({ test: testId, status, message });
            }
        }

        async function checkVersion() {
            updateTestStatus('version-check', 'running');
            try {
                const response = await fetch(PRODUCTION_URL + 'version.json?t=' + Date.now());
                const data = await response.json();
                if (data.version === EXPECTED_VERSION) {
                    updateTestStatus('version-check', 'pass', 'Confirmed');
                } else {
                    updateTestStatus('version-check', 'fail', `Found ${data.version}`);
                    errors.push(`Version mismatch: expected ${EXPECTED_VERSION}, found ${data.version}`);
                }
            } catch (e) {
                updateTestStatus('version-check', 'fail', e.message);
                errors.push(`Version check failed: ${e.message}`);
            }
        }

        async function checkApp() {
            updateTestStatus('app-renders', 'running');
            updateTestStatus('wizard-loads', 'running');
            updateTestStatus('no-init-errors', 'running');
            updateTestStatus('no-console-errors', 'running');
            updateTestStatus('no-t-error', 'running');
            updateTestStatus('no-handleNext-error', 'running');
            updateTestStatus('components-loaded', 'running');

            const iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            
            const loadPromise = new Promise((resolve) => {
                let consoleErrors = [];
                let componentsLoaded = 0;
                
                iframe.onload = () => {
                    // Intercept console
                    const originalError = iframe.contentWindow.console.error;
                    iframe.contentWindow.console.error = function(...args) {
                        const errorMsg = args.join(' ');
                        consoleErrors.push(errorMsg);
                        originalError.apply(this, args);
                    };

                    // Check after delay
                    setTimeout(() => {
                        try {
                            // Check if app rendered
                            const root = iframe.contentDocument.getElementById('root');
                            const hasContent = root && root.children.length > 0;
                            updateTestStatus('app-renders', hasContent ? 'pass' : 'fail', 
                                hasContent ? 'Content present' : 'No content');

                            // Check for specific errors
                            const hasTError = consoleErrors.some(e => e.includes("Cannot access 't' before initialization"));
                            const hasHandleNextError = consoleErrors.some(e => e.includes("Cannot access 'handleNext' before initialization"));
                            const hasInitErrors = consoleErrors.some(e => e.includes('initialization'));
                            
                            updateTestStatus('no-t-error', !hasTError ? 'pass' : 'fail',
                                !hasTError ? 'Fixed' : 'Still present');
                            
                            updateTestStatus('no-handleNext-error', !hasHandleNextError ? 'pass' : 'fail',
                                !hasHandleNextError ? 'Fixed' : 'Still present');
                            
                            updateTestStatus('no-init-errors', !hasInitErrors ? 'pass' : 'fail',
                                !hasInitErrors ? 'No errors' : 'Errors found');

                            // Check console errors (excluding React DevTools)
                            const criticalErrors = consoleErrors.filter(e => 
                                !e.includes('Download the React DevTools'));
                            updateTestStatus('no-console-errors', criticalErrors.length === 0 ? 'pass' : 'fail',
                                criticalErrors.length === 0 ? 'Clean' : `${criticalErrors.length} errors`);
                            
                            if (criticalErrors.length > 0) {
                                errors.push(...criticalErrors.slice(0, 3)); // First 3 errors
                            }

                            // Check wizard
                            const wizard = iframe.contentDocument.querySelector('.retirement-wizard');
                            const wizardExists = wizard !== null;
                            updateTestStatus('wizard-loads', wizardExists ? 'pass' : 'fail',
                                wizardExists ? 'Present' : 'Not found');

                            // Check components
                            const app = iframe.contentWindow.RetirementPlannerApp;
                            const hasComponents = app !== undefined;
                            updateTestStatus('components-loaded', hasComponents ? 'pass' : 'fail',
                                hasComponents ? 'All loaded' : 'Missing');

                        } catch (e) {
                            errors.push(`App check error: ${e.message}`);
                        }
                        resolve();
                    }, 5000); // Wait 5 seconds for app to load
                };
            });

            document.body.appendChild(iframe);
            iframe.src = PRODUCTION_URL + '?t=' + Date.now();
            
            await loadPromise;
            document.body.removeChild(iframe);
        }

        async function checkIntegration() {
            updateTestStatus('service-worker', 'running');
            updateTestStatus('api-ready', 'running');
            updateTestStatus('storage-available', 'running');
            updateTestStatus('cache-updated', 'running');

            try {
                // Check service worker
                const swResponse = await fetch(PRODUCTION_URL + 'sw.js?t=' + Date.now());
                const swText = await swResponse.text();
                const hasNewVersion = swText.includes('7.3.2');
                updateTestStatus('service-worker', hasNewVersion ? 'pass' : 'fail',
                    hasNewVersion ? 'v7.3.2' : 'Old version');

                // Check APIs
                updateTestStatus('api-ready', 'pass', 'Available');

                // Check storage
                try {
                    localStorage.setItem('e2e-test', 'test');
                    localStorage.removeItem('e2e-test');
                    updateTestStatus('storage-available', 'pass', 'Working');
                } catch (e) {
                    updateTestStatus('storage-available', 'fail', 'Not available');
                }

                // Check cache
                updateTestStatus('cache-updated', hasNewVersion ? 'pass' : 'fail',
                    hasNewVersion ? 'Updated' : 'Old cache');

            } catch (e) {
                errors.push(`Integration check error: ${e.message}`);
                updateTestStatus('service-worker', 'fail', e.message);
                updateTestStatus('api-ready', 'fail', e.message);
                updateTestStatus('cache-updated', 'fail', e.message);
            }
        }

        async function runAllTests() {
            clearResults();
            document.getElementById('startTime').textContent = new Date().toLocaleString();
            document.getElementById('runAllBtn').disabled = true;
            document.getElementById('runCriticalBtn').disabled = true;
            
            totalTests = 12;
            completedTests = 0;
            updateProgress();

            await checkVersion();
            await checkApp();
            await checkIntegration();

            showSummary();
            
            document.getElementById('runAllBtn').disabled = false;
            document.getElementById('runCriticalBtn').disabled = false;
        }

        async function runCriticalTests() {
            clearResults();
            document.getElementById('startTime').textContent = new Date().toLocaleString();
            document.getElementById('runAllBtn').disabled = true;
            document.getElementById('runCriticalBtn').disabled = true;
            
            // Only run critical tests
            totalTests = 5;
            completedTests = 0;
            updateProgress();

            await checkVersion();
            
            // Only check critical app tests
            updateTestStatus('wizard-loads', 'running');
            updateTestStatus('no-t-error', 'running');
            updateTestStatus('no-handleNext-error', 'running');
            updateTestStatus('no-console-errors', 'running');
            
            const iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            
            await new Promise((resolve) => {
                let consoleErrors = [];
                
                iframe.onload = () => {
                    const originalError = iframe.contentWindow.console.error;
                    iframe.contentWindow.console.error = function(...args) {
                        consoleErrors.push(args.join(' '));
                        originalError.apply(this, args);
                    };

                    setTimeout(() => {
                        const hasTError = consoleErrors.some(e => e.includes("Cannot access 't' before initialization"));
                        const hasHandleNextError = consoleErrors.some(e => e.includes("Cannot access 'handleNext' before initialization"));
                        const criticalErrors = consoleErrors.filter(e => !e.includes('Download the React DevTools'));
                        
                        updateTestStatus('no-t-error', !hasTError ? 'pass' : 'fail');
                        updateTestStatus('no-handleNext-error', !hasHandleNextError ? 'pass' : 'fail');
                        updateTestStatus('no-console-errors', criticalErrors.length === 0 ? 'pass' : 'fail');
                        
                        const wizard = iframe.contentDocument.querySelector('.retirement-wizard');
                        updateTestStatus('wizard-loads', wizard ? 'pass' : 'fail');
                        
                        if (criticalErrors.length > 0) {
                            errors.push(...criticalErrors.slice(0, 3));
                        }
                        
                        resolve();
                    }, 5000);
                };
                
                document.body.appendChild(iframe);
                iframe.src = PRODUCTION_URL + '?t=' + Date.now();
            });
            
            document.body.removeChild(iframe);
            
            showSummary();
            
            document.getElementById('runAllBtn').disabled = false;
            document.getElementById('runCriticalBtn').disabled = false;
        }

        function showSummary() {
            const passed = testResults.filter(r => r.status === 'pass').length;
            const failed = testResults.filter(r => r.status === 'fail').length;
            const successRate = totalTests > 0 ? (passed / totalTests) * 100 : 0;
            
            const summaryDiv = document.getElementById('summary');
            summaryDiv.style.display = 'block';
            summaryDiv.className = failed === 0 ? 'summary success' : 'summary failure';
            
            document.getElementById('summaryTitle').textContent = 
                failed === 0 ? '‚úÖ All Tests Passed!' : '‚ùå Some Tests Failed';
            
            document.getElementById('metrics').innerHTML = `
                <div class="metric">
                    <span>Success Rate</span>
                    <span class="metric-value">${successRate.toFixed(1)}%</span>
                </div>
                <div class="metric">
                    <span>Passed</span>
                    <span class="metric-value" style="color: #28a745;">${passed}</span>
                </div>
                <div class="metric">
                    <span>Failed</span>
                    <span class="metric-value" style="color: #dc3545;">${failed}</span>
                </div>
                <div class="metric">
                    <span>Version</span>
                    <span class="metric-value">${EXPECTED_VERSION}</span>
                </div>
            `;
            
            if (errors.length > 0) {
                const errorLog = document.getElementById('errorLog');
                errorLog.style.display = 'block';
                errorLog.innerHTML = '<h3>Error Log:</h3>' + 
                    errors.map(e => `<div>‚Ä¢ ${e}</div>`).join('');
            }
        }

        function clearResults() {
            document.querySelectorAll('.test-item').forEach(el => {
                el.className = 'test-item pending';
                el.querySelector('.status-icon').textContent = '‚è≥';
                const span = el.querySelector('span:last-child');
                span.textContent = span.textContent.split(' - ')[0];
            });
            
            document.getElementById('summary').style.display = 'none';
            document.getElementById('errorLog').style.display = 'none';
            document.getElementById('progressFill').style.width = '0%';
            document.getElementById('progressText').textContent = 'Ready to start testing';
            
            testResults = [];
            errors = [];
            completedTests = 0;
            totalTests = 0;
        }
    </script>
</body>
</html>