<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comprehensive Financial Health Score Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin: 20px 0;
        }
        h1 {
            color: #333;
            margin: 0 0 20px 0;
        }
        .test-case {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            background: #f9f9f9;
        }
        .test-case.success {
            background: #d4edda;
            border-color: #c3e6cb;
        }
        .test-case.error {
            background: #f8d7da;
            border-color: #f5c6cb;
        }
        .test-case.critical {
            background: #ffe0e0;
            border-color: #ff6b6b;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
        .score {
            font-size: 48px;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
        }
        .score.good { color: #28a745; }
        .score.bad { color: #dc3545; }
        .score.critical { color: #ff6b6b; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        pre {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        .alert {
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .alert.critical {
            background: #dc3545;
            color: white;
        }
        .alert.success {
            background: #28a745;
            color: white;
        }
        .alert.warning {
            background: #ffc107;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Comprehensive Financial Health Score Test</h1>
        <p>This test loads all required dependencies and tests the financial health scoring system.</p>
        <button onclick="loadDependencies()">Step 1: Load Dependencies</button>
        <button onclick="runSimpleTest()" disabled id="runTestBtn">Step 2: Run Simple Test</button>
        <button onclick="runAllScenarios()" disabled id="runAllBtn">Step 3: Run All Scenarios</button>
    </div>

    <div id="dependencyStatus" class="container" style="display: none;">
        <h2>Dependency Loading Status</h2>
        <div id="depList"></div>
    </div>

    <div id="testResults" class="container" style="display: none;">
        <h2>Test Results</h2>
        <div id="results"></div>
    </div>

    <script>
        const BASE_URL = 'https://ypollak2.github.io/advanced-retirement-planner/';
        const dependencies = [
            'src/utils/fieldMappingBridge.js?v=7.4.0',
            'src/utils/financialHealthEngine.js?v=7.4.0',
            'src/utils/fieldMappingDictionary.js?v=7.4.0',
            'src/utils/currencyAPI.js?v=7.4.0',
            'src/utils/retirementCalculations.js?v=7.4.0'
        ];

        async function loadDependencies() {
            const statusDiv = document.getElementById('dependencyStatus');
            const depList = document.getElementById('depList');
            statusDiv.style.display = 'block';
            depList.innerHTML = '<div class="loading">Loading dependencies...</div>';
            
            let loadedCount = 0;
            depList.innerHTML = '';
            
            for (const dep of dependencies) {
                const depItem = document.createElement('div');
                depItem.className = 'test-case';
                depItem.innerHTML = `Loading ${dep}...`;
                depList.appendChild(depItem);
                
                try {
                    await loadScript(BASE_URL + dep);
                    depItem.className = 'test-case success';
                    depItem.innerHTML = `‚úÖ Loaded: ${dep}`;
                    loadedCount++;
                } catch (error) {
                    depItem.className = 'test-case error';
                    depItem.innerHTML = `‚ùå Failed: ${dep} - ${error.message}`;
                }
            }
            
            // Check if main function is available
            const funcCheck = document.createElement('div');
            funcCheck.className = 'test-case';
            
            if (window.calculateFinancialHealthScore) {
                funcCheck.className = 'test-case success';
                funcCheck.innerHTML = '‚úÖ calculateFinancialHealthScore function is available';
                document.getElementById('runTestBtn').disabled = false;
                document.getElementById('runAllBtn').disabled = false;
            } else {
                funcCheck.className = 'test-case error';
                funcCheck.innerHTML = '‚ùå calculateFinancialHealthScore function NOT found';
            }
            depList.appendChild(funcCheck);
        }

        function loadScript(url) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = url;
                script.onload = resolve;
                script.onerror = () => reject(new Error('Failed to load'));
                document.head.appendChild(script);
            });
        }

        function runSimpleTest() {
            const resultsDiv = document.getElementById('testResults');
            const results = document.getElementById('results');
            resultsDiv.style.display = 'block';
            
            const testData = {
                planningType: 'individual',
                currentAge: 35,
                retirementAge: 67,
                currentMonthlySalary: 30000,
                currentMonthlyExpenses: 20000,
                currentPension: 200000,
                currentTrainingFund: 100000,
                emergencyFund: 50000,
                pensionContributionRate: 12,
                trainingFundContributionRate: 7.5,
                riskTolerance: 'moderate',
                expectedAnnualReturn: 6
            };
            
            try {
                const result = window.calculateFinancialHealthScore(testData, {
                    combinePartners: false,
                    debugMode: true
                });
                
                const score = result.totalScore || 0;
                const isCriticalBug = score >= 27 && score <= 29;
                
                results.innerHTML = `
                    <div class="test-case ${isCriticalBug ? 'critical' : 'success'}">
                        <h3>Simple Test - Individual with Good Finances</h3>
                        <div class="score ${isCriticalBug ? 'critical' : 'good'}">${score.toFixed(1)}</div>
                        ${isCriticalBug ? 
                            '<div class="alert critical">‚ö†Ô∏è CRITICAL BUG DETECTED: Score is in 27-29 range!</div>' :
                            '<div class="alert success">‚úÖ Score is outside bug range</div>'
                        }
                        <details>
                            <summary>Detailed Results</summary>
                            <pre>${JSON.stringify(result, null, 2)}</pre>
                        </details>
                        <details>
                            <summary>Test Data</summary>
                            <pre>${JSON.stringify(testData, null, 2)}</pre>
                        </details>
                    </div>
                `;
            } catch (error) {
                results.innerHTML = `
                    <div class="test-case error">
                        <h3>Error Running Test</h3>
                        <p>${error.message}</p>
                        <pre>${error.stack}</pre>
                    </div>
                `;
            }
        }

        function runAllScenarios() {
            const resultsDiv = document.getElementById('testResults');
            const results = document.getElementById('results');
            resultsDiv.style.display = 'block';
            results.innerHTML = '';
            
            const scenarios = [
                {
                    name: 'High Income Professional',
                    data: {
                        planningType: 'individual',
                        currentAge: 35,
                        retirementAge: 67,
                        currentMonthlySalary: 50000,
                        currentMonthlyExpenses: 25000,
                        currentPension: 500000,
                        currentTrainingFund: 300000,
                        emergencyFund: 150000,
                        pensionContributionRate: 18.5,
                        trainingFundContributionRate: 10,
                        riskTolerance: 'balanced',
                        expectedAnnualReturn: 7
                    },
                    expectedRange: { min: 70, max: 95 }
                },
                {
                    name: 'Low Income',
                    data: {
                        planningType: 'individual',
                        currentAge: 28,
                        retirementAge: 67,
                        currentMonthlySalary: 8000,
                        currentMonthlyExpenses: 7500,
                        currentPension: 10000,
                        currentTrainingFund: 5000,
                        emergencyFund: 0,
                        pensionContributionRate: 6,
                        trainingFundContributionRate: 2.5,
                        riskTolerance: 'conservative',
                        expectedAnnualReturn: 4
                    },
                    expectedRange: { min: 15, max: 40 }
                },
                {
                    name: 'Couple - Dual Income',
                    data: {
                        planningType: 'couple',
                        partner1Salary: 25000,
                        partner1CurrentPension: 200000,
                        partner1CurrentTrainingFund: 100000,
                        partner2Salary: 20000,
                        partner2CurrentPension: 150000,
                        partner2CurrentTrainingFund: 80000,
                        currentAge: 38,
                        retirementAge: 67,
                        currentMonthlyExpenses: 30000,
                        emergencyFund: 100000
                    },
                    expectedRange: { min: 55, max: 80 }
                }
            ];
            
            let criticalBugCount = 0;
            
            scenarios.forEach(scenario => {
                try {
                    const result = window.calculateFinancialHealthScore(scenario.data, {
                        combinePartners: scenario.data.planningType === 'couple',
                        debugMode: true
                    });
                    
                    const score = result.totalScore || 0;
                    const isCriticalBug = score >= 27 && score <= 29;
                    const inExpectedRange = score >= scenario.expectedRange.min && score <= scenario.expectedRange.max;
                    
                    if (isCriticalBug) criticalBugCount++;
                    
                    const testCase = document.createElement('div');
                    testCase.className = `test-case ${isCriticalBug ? 'critical' : (inExpectedRange ? 'success' : 'error')}`;
                    testCase.innerHTML = `
                        <h3>${scenario.name}</h3>
                        <div class="score ${isCriticalBug ? 'critical' : (inExpectedRange ? 'good' : 'bad')}">${score.toFixed(1)}</div>
                        <p>Expected: ${scenario.expectedRange.min}-${scenario.expectedRange.max}</p>
                        ${isCriticalBug ? 
                            '<div class="alert critical">‚ö†Ô∏è CRITICAL BUG: Score is 27-29!</div>' :
                            (inExpectedRange ? 
                                '<div class="alert success">‚úÖ Score in expected range</div>' :
                                '<div class="alert warning">‚ö†Ô∏è Score outside expected range</div>')
                        }
                        <details>
                            <summary>Factor Scores</summary>
                            <pre>${JSON.stringify(result.factorScores || {}, null, 2)}</pre>
                        </details>
                    `;
                    results.appendChild(testCase);
                    
                } catch (error) {
                    const testCase = document.createElement('div');
                    testCase.className = 'test-case error';
                    testCase.innerHTML = `
                        <h3>${scenario.name}</h3>
                        <p>Error: ${error.message}</p>
                    `;
                    results.appendChild(testCase);
                }
            });
            
            // Summary
            const summary = document.createElement('div');
            summary.className = criticalBugCount > 0 ? 'alert critical' : 'alert success';
            summary.innerHTML = criticalBugCount > 0 ?
                `‚ö†Ô∏è CRITICAL: ${criticalBugCount} tests returned scores in 27-29 bug range!` :
                '‚úÖ SUCCESS: No tests returned scores in 27-29 bug range!';
            results.insertBefore(summary, results.firstChild);
        }
    </script>
</body>
</html>