<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test v7.4.7 Financial Health Scores</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .score-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .score-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .score-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }
        .score-details {
            font-size: 14px;
            color: #666;
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        .status-good { color: #28a745; }
        .status-fair { color: #ffc107; }
        .status-poor { color: #dc3545; }
        .total-score {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            margin: 30px 0;
        }
        .total-score h2 {
            margin: 0 0 10px 0;
            font-size: 28px;
        }
        .total-score-value {
            font-size: 48px;
            font-weight: bold;
        }
        .test-results {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
    </style>
</head>
<body>
    <div class="test-header">
        <h1>v7.4.7 Financial Health Score Test</h1>
        <p>Testing all 8 financial health factors with enhanced field mapping</p>
    </div>

    <div id="testResults"></div>

    <script>
        // Test data with all required fields
        const testInputs = {
            // Basic info
            currentAge: 35,
            retirementAge: 67,
            planningType: 'individual',
            
            // Income
            currentMonthlySalary: 30000,
            monthlyExpenses: 20000,
            
            // Savings
            currentSavings: 500000,
            currentTrainingFund: 300000,
            currentPersonalPortfolio: 200000,
            currentRealEstate: 2000000,
            currentCrypto: 50000,
            currentBankAccount: 100000,
            
            // Contribution rates - using the field names from the wizard
            pensionEmployeeContribution: 6,  // This is the field name used in the wizard
            trainingFundEmployeeContribution: 2.5,
            
            // Monthly contributions
            monthlyAdditionalSavings: 5000,
            personalPortfolioMonthly: 2000,
            
            // Portfolio
            stockPercentage: 60,
            portfolioTaxRate: 25,
            riskTolerance: 'moderate',
            
            // Emergency fund
            emergencyFund: 180000,  // 9 months of expenses
            
            // Debt
            totalDebt: 500000,
            monthlyDebtPayments: 3000,
            
            // Country
            country: 'israel',
            taxCountry: 'ISR'
        };

        async function loadDependencies() {
            const scripts = [
                'src/utils/getFieldValue.js',
                'src/utils/fieldMappingDictionary.js',
                'src/utils/fieldMappingBridge.js',
                'src/utils/financialHealthEngine.js'
            ];

            for (const script of scripts) {
                await new Promise((resolve, reject) => {
                    const scriptElement = document.createElement('script');
                    scriptElement.src = script + '?v=' + Date.now();
                    scriptElement.onload = resolve;
                    scriptElement.onerror = reject;
                    document.head.appendChild(scriptElement);
                });
            }
        }

        function displayResults(scores) {
            const resultsDiv = document.getElementById('testResults');
            
            // Total score card
            const totalScoreHtml = `
                <div class="total-score">
                    <h2>Total Financial Health Score</h2>
                    <div class="total-score-value">${Math.round(scores.totalScore)}%</div>
                    <p>${scores.overallStatus}</p>
                </div>
            `;

            // Individual score cards
            let scoresHtml = '';
            scores.factors.forEach(factor => {
                const statusClass = factor.status === 'good' || factor.status === 'excellent' ? 'status-good' : 
                                  factor.status === 'fair' ? 'status-fair' : 'status-poor';
                
                scoresHtml += `
                    <div class="score-card">
                        <div class="score-header">
                            <h3>${factor.name}</h3>
                            <span class="score-value">${factor.displayScore}% (${factor.weightedScore.toFixed(1)}/${factor.weight})</span>
                        </div>
                        <div class="score-details">
                            <div>Status: <span class="${statusClass}">${factor.status}</span></div>
                            ${factor.details ? `<div>Details: ${JSON.stringify(factor.details, null, 2)}</div>` : ''}
                        </div>
                    </div>
                `;
            });

            // Test results summary
            const testResultsHtml = `
                <div class="test-results">
                    <h3>Test Results Summary</h3>
                    <div class="success">✅ All 8 factors calculated successfully</div>
                    <div>Pension contribution rate found: ${testInputs.pensionEmployeeContribution}%</div>
                    <div>Training fund rate found: ${testInputs.trainingFundEmployeeContribution}%</div>
                    <div>Total score breakdown: ${scores.factors.map(f => `${f.name}: ${f.weightedScore.toFixed(1)}`).join(', ')}</div>
                </div>
            `;

            resultsDiv.innerHTML = totalScoreHtml + scoresHtml + testResultsHtml;
        }

        async function runTest() {
            try {
                console.log('Loading dependencies...');
                await loadDependencies();
                
                console.log('Calculating financial health score...');
                const result = window.calculateFinancialHealthScore(testInputs);
                
                console.log('Full result:', result);
                displayResults(result);
                
                // Log specific scores for debugging
                console.log('Individual factor scores:');
                result.factors.forEach(factor => {
                    console.log(`${factor.name}: ${factor.score}/${factor.weight} = ${factor.displayScore}%`);
                });
                
            } catch (error) {
                console.error('Test failed:', error);
                document.getElementById('testResults').innerHTML = `
                    <div class="test-results">
                        <div class="error">❌ Test failed: ${error.message}</div>
                        <pre>${error.stack}</pre>
                    </div>
                `;
            }
        }

        // Run test on load
        runTest();
    </script>
</body>
</html>