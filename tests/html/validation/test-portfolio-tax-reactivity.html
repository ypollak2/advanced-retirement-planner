<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Portfolio Tax Reactivity Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .test-container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .test-button { background: #4CAF50; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
        .test-button:hover { background: #45a049; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .pass { background: #d4edda; color: #155724; }
        .fail { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        pre { background: #f4f4f4; padding: 10px; border-radius: 5px; overflow-x: auto; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üß™ Portfolio Tax Reactivity Test</h1>
        <p>This test verifies that changing the tax rate properly updates the net value in the UI.</p>
        
        <div class="test-section">
            <h2>Test Instructions:</h2>
            <ol>
                <li>Open the production app and navigate to Step 4 (Current Savings)</li>
                <li>Enter a portfolio value (e.g., 1,000,000 ILS)</li>
                <li>Click "Run Test Script" below</li>
                <li>The script will change the tax rate and verify the net value updates</li>
            </ol>
            
            <button class="test-button" onclick="runTest()">Run Test Script</button>
            <button class="test-button" onclick="copyScript()">Copy Script to Clipboard</button>
        </div>
        
        <div id="results"></div>
        
        <div class="test-section">
            <h3>Manual Test Script:</h3>
            <pre id="script">
// Portfolio Tax Reactivity Test
(function testPortfolioTaxReactivity() {
    console.log('üß™ Testing Portfolio Tax Reactivity...');
    
    // Test configuration
    const portfolioValue = 1000000; // 1M ILS
    const initialTaxRate = 25;
    const newTaxRate = 40;
    
    // Find the portfolio input
    const portfolioInput = document.querySelector('input[type="number"]')?.parentElement?.parentElement?.
        querySelector('input[type="number"]');
    
    if (!portfolioInput) {
        console.error('‚ùå Could not find portfolio input field');
        return;
    }
    
    // Set portfolio value
    portfolioInput.value = portfolioValue;
    portfolioInput.dispatchEvent(new Event('change', { bubbles: true }));
    
    console.log('‚úÖ Set portfolio value to:', portfolioValue);
    
    // Wait for initial render
    setTimeout(() => {
        // Find tax rate input (should be near portfolio input)
        const taxInputs = Array.from(document.querySelectorAll('input[type="number"]'))
            .filter(input => {
                const label = input.parentElement?.querySelector('label')?.textContent || '';
                return label.includes('Tax') || label.includes('◊û◊°');
            });
        
        const taxInput = taxInputs[0]; // First tax input should be main portfolio
        
        if (!taxInput) {
            console.error('‚ùå Could not find tax rate input');
            return;
        }
        
        // Get initial net value
        const getNetValue = () => {
            const netValueElements = Array.from(document.querySelectorAll('div, span'))
                .filter(el => el.textContent.includes('Net:') || el.textContent.includes('◊†◊ò◊ï:'));
            
            if (netValueElements.length > 0) {
                const text = netValueElements[0].textContent;
                const match = text.match(/[\d,]+/);
                return match ? parseInt(match[0].replace(/,/g, '')) : null;
            }
            return null;
        };
        
        const initialNetValue = getNetValue();
        console.log('üìä Initial net value:', initialNetValue);
        
        // Change tax rate
        taxInput.value = newTaxRate;
        taxInput.dispatchEvent(new Event('change', { bubbles: true }));
        taxInput.dispatchEvent(new Event('input', { bubbles: true }));
        taxInput.dispatchEvent(new Event('blur', { bubbles: true }));
        
        console.log('‚úÖ Changed tax rate from', initialTaxRate, 'to', newTaxRate);
        
        // Wait for update and check new net value
        setTimeout(() => {
            const newNetValue = getNetValue();
            console.log('üìä New net value:', newNetValue);
            
            // Calculate expected values
            const expectedInitialNet = portfolioValue * (1 - initialTaxRate / 100);
            const expectedNewNet = portfolioValue * (1 - newTaxRate / 100);
            
            console.log('üìä Expected initial net:', expectedInitialNet);
            console.log('üìä Expected new net:', expectedNewNet);
            
            // Verify the change
            if (newNetValue && Math.abs(newNetValue - expectedNewNet) < 1000) {
                console.log('‚úÖ PASS: Net value updated correctly!');
                console.log('   Portfolio:', portfolioValue);
                console.log('   Tax rate:', newTaxRate + '%');
                console.log('   Net value:', newNetValue);
            } else {
                console.error('‚ùå FAIL: Net value did not update correctly');
                console.error('   Expected:', expectedNewNet);
                console.error('   Actual:', newNetValue);
                
                // Debug info
                console.log('üîç Debug: Check conversion cache');
                if (window.conversionStates) {
                    console.log('Conversion states:', window.conversionStates);
                }
            }
            
            // Test partner portfolios too
            console.log('\nüß™ Testing partner portfolio tax reactivity...');
            testPartnerPortfolios();
            
        }, 2000); // Wait for conversion
        
    }, 1000); // Wait for initial render
    
    function testPartnerPortfolios() {
        // Similar test for partner portfolios
        const partnerInputs = Array.from(document.querySelectorAll('input[type="number"]'))
            .filter(input => {
                const label = input.parentElement?.querySelector('label')?.textContent || '';
                return label.includes('Personal Portfolio') || label.includes('◊™◊ô◊ß ◊ê◊ô◊©◊ô');
            });
        
        console.log('Found', partnerInputs.length, 'partner portfolio inputs');
        
        // Test each partner
        partnerInputs.forEach((input, index) => {
            if (index === 0) return; // Skip main portfolio
            
            const partnerId = index === 1 ? 'Partner 1' : 'Partner 2';
            console.log(`\nüìä Testing ${partnerId}...`);
            
            // Set value
            input.value = 500000;
            input.dispatchEvent(new Event('change', { bubbles: true }));
            
            // Find corresponding tax input
            const parentSection = input.closest('.grid') || input.parentElement?.parentElement;
            const taxInput = Array.from(parentSection?.querySelectorAll('input[type="number"]') || [])
                .find(inp => {
                    const label = inp.parentElement?.querySelector('label')?.textContent || '';
                    return label.includes('Tax') || label.includes('◊û◊°');
                });
            
            if (taxInput) {
                // Change tax rate
                taxInput.value = 35;
                taxInput.dispatchEvent(new Event('change', { bubbles: true }));
                console.log(`‚úÖ ${partnerId}: Changed tax to 35%`);
            } else {
                console.log(`‚ö†Ô∏è ${partnerId}: Could not find tax input`);
            }
        });
    }
})();
            </pre>
        </div>
    </div>
    
    <script>
        function runTest() {
            const script = document.getElementById('script').textContent;
            const results = document.getElementById('results');
            
            results.innerHTML = '<div class="status info">Test script copied to clipboard. Please:</div>' +
                '<ol>' +
                '<li>Open the production app</li>' +
                '<li>Navigate to Step 4 (Current Savings)</li>' +
                '<li>Open browser console (F12)</li>' +
                '<li>Paste and run the script</li>' +
                '<li>Check console output for results</li>' +
                '</ol>';
        }
        
        function copyScript() {
            const script = document.getElementById('script').textContent;
            navigator.clipboard.writeText(script).then(() => {
                document.getElementById('results').innerHTML = 
                    '<div class="status pass">‚úÖ Script copied to clipboard!</div>';
            }).catch(err => {
                document.getElementById('results').innerHTML = 
                    '<div class="status fail">‚ùå Failed to copy: ' + err + '</div>';
            });
        }
    </script>
</body>
</html>