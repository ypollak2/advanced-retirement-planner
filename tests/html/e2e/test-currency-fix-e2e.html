<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Currency Fix E2E Test - v7.3.4</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            margin: 20px;
            background: #1a1a1a;
            color: #0f0;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #000;
            padding: 20px;
            border: 1px solid #0f0;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
        }
        h1, h2 {
            color: #0f0;
            text-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            background: #111;
            border-left: 3px solid #0f0;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            background: #222;
            border-radius: 4px;
        }
        .pass {
            color: #0f0;
            border-left: 4px solid #0f0;
        }
        .fail {
            color: #f00;
            border-left: 4px solid #f00;
        }
        .warning {
            color: #ff0;
            border-left: 4px solid #ff0;
        }
        .loading {
            color: #888;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }
        button {
            background: #0f0;
            color: #000;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            font-weight: bold;
            margin: 5px;
            text-transform: uppercase;
        }
        button:hover {
            background: #0a0;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
        }
        .test-frame {
            width: 100%;
            height: 600px;
            border: 1px solid #0f0;
            margin: 20px 0;
            background: #fff;
        }
        .summary {
            background: #222;
            padding: 20px;
            margin: 20px 0;
            border: 2px solid #0f0;
            font-size: 18px;
        }
        .test-details {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
        }
        pre {
            background: #111;
            padding: 10px;
            overflow-x: auto;
            border: 1px solid #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Currency Fix E2E Test Suite - v7.3.4</h1>
        <p>Testing currency rate initialization fix in RSU components</p>

        <div class="test-section">
            <h2>üìã Test Configuration</h2>
            <div id="config"></div>
        </div>

        <div class="test-section">
            <h2>üß™ Test Results</h2>
            <div id="results"></div>
        </div>

        <div class="test-section">
            <h2>üìä Summary</h2>
            <div id="summary" class="summary"></div>
        </div>

        <div class="test-section">
            <h2>üåê Live Application Test</h2>
            <button onclick="runLiveTest()">Run Live Currency Test</button>
            <button onclick="showApp()">Show Application</button>
            <button onclick="location.reload()">Refresh Tests</button>
            <iframe id="appFrame" class="test-frame" style="display:none;"></iframe>
        </div>
    </div>

    <script>
        const PRODUCTION_URL = 'https://ypollak2.github.io/advanced-retirement-planner/';
        const EXPECTED_VERSION = '7.3.4';
        const tests = [];

        // Configuration
        document.getElementById('config').innerHTML = `
            <div class="test-result">
                <strong>Production URL:</strong> ${PRODUCTION_URL}<br>
                <strong>Expected Version:</strong> v${EXPECTED_VERSION}<br>
                <strong>Test Focus:</strong> Currency Rate Initialization<br>
                <strong>Components:</strong> EnhancedRSUCompanySelector, PartnerRSUSelector
            </div>
        `;

        // Test functions
        async function fetchUrl(url) {
            try {
                const response = await fetch(url);
                const text = await response.text();
                return { status: response.status, text };
            } catch (error) {
                return { status: 'error', text: error.message };
            }
        }

        async function runTests() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="loading">Running tests...</div>';
            tests.length = 0;

            // Test 1: Version Check
            const versionTest = await testVersion();
            tests.push(versionTest);
            updateResults();

            // Test 2: Component Files
            const componentTests = await testComponentFiles();
            tests.push(...componentTests);
            updateResults();

            // Test 3: Currency Fix Verification
            const currencyFixTest = await testCurrencyFix();
            tests.push(currencyFixTest);
            updateResults();

            // Test 4: Service Worker
            const swTest = await testServiceWorker();
            tests.push(swTest);
            updateResults();

            // Summary
            showSummary();
        }

        async function testVersion() {
            const result = await fetchUrl(PRODUCTION_URL + 'version.json');
            if (result.status === 200) {
                try {
                    const version = JSON.parse(result.text).version;
                    return {
                        name: 'Version Check',
                        status: version === EXPECTED_VERSION ? 'pass' : 'fail',
                        details: `Found v${version}`,
                        expected: EXPECTED_VERSION,
                        actual: version
                    };
                } catch (e) {
                    return {
                        name: 'Version Check',
                        status: 'fail',
                        details: 'Failed to parse version.json'
                    };
                }
            }
            return {
                name: 'Version Check',
                status: 'fail',
                details: `HTTP ${result.status}`
            };
        }

        async function testComponentFiles() {
            const components = [
                'src/components/shared/EnhancedRSUCompanySelector.js',
                'src/components/shared/PartnerRSUSelector.js'
            ];
            
            const results = [];
            for (const file of components) {
                const result = await fetchUrl(PRODUCTION_URL + file + '?v=' + EXPECTED_VERSION);
                const testResult = {
                    name: `Component: ${file.split('/').pop()}`,
                    status: result.status === 200 ? 'pass' : 'fail',
                    details: result.status === 200 ? 'File accessible' : `HTTP ${result.status}`
                };
                
                // Check for currency fix
                if (result.status === 200) {
                    const hasNullInit = result.text.includes('React.useState(null)') && 
                                       result.text.includes('currencyRate');
                    const hasOldInit = result.text.includes('React.useState(1)') && 
                                      result.text.includes('currencyRate');
                    
                    if (hasNullInit && !hasOldInit) {
                        testResult.status = 'pass';
                        testResult.details += ' - Currency fix applied ‚úì';
                    } else if (hasOldInit) {
                        testResult.status = 'fail';
                        testResult.details += ' - Still using useState(1) ‚úó';
                    } else {
                        testResult.status = 'warning';
                        testResult.details += ' - Currency state not found';
                    }
                }
                
                results.push(testResult);
            }
            return results;
        }

        async function testCurrencyFix() {
            const rsuFile = await fetchUrl(PRODUCTION_URL + 'src/components/shared/EnhancedRSUCompanySelector.js?v=' + EXPECTED_VERSION);
            
            if (rsuFile.status !== 200) {
                return {
                    name: 'Currency Fix Verification',
                    status: 'fail',
                    details: 'Could not fetch RSU component'
                };
            }

            const checks = {
                nullInit: rsuFile.text.includes('const [currencyRate, setCurrencyRate] = React.useState(null)'),
                loadingDisplay: rsuFile.text.includes('currencyRate !== null && currencyRate > 0'),
                loadingText: rsuFile.text.includes('Loading exchange rate...') || rsuFile.text.includes('◊ò◊ï◊¢◊ü ◊©◊¢◊® ◊ó◊ú◊ô◊§◊ô◊ü...'),
                nullCheck: rsuFile.text.includes('currencyRate === null')
            };

            const allPassed = Object.values(checks).every(v => v);
            
            return {
                name: 'Currency Fix Verification',
                status: allPassed ? 'pass' : 'fail',
                details: allPassed ? 'All currency fixes applied' : 'Some fixes missing',
                checks: checks
            };
        }

        async function testServiceWorker() {
            const result = await fetchUrl(PRODUCTION_URL + 'sw.js');
            if (result.status === 200 && result.text.includes(EXPECTED_VERSION)) {
                return {
                    name: 'Service Worker',
                    status: 'pass',
                    details: 'Updated to v' + EXPECTED_VERSION
                };
            }
            return {
                name: 'Service Worker',
                status: 'fail',
                details: result.status === 200 ? 'Version mismatch' : `HTTP ${result.status}`
            };
        }

        function updateResults() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = tests.map(test => `
                <div class="test-result ${test.status}">
                    <strong>${test.name}:</strong> ${test.status.toUpperCase()}
                    <div class="test-details">${test.details}</div>
                    ${test.checks ? `<pre>${JSON.stringify(test.checks, null, 2)}</pre>` : ''}
                </div>
            `).join('');
        }

        function showSummary() {
            const passed = tests.filter(t => t.status === 'pass').length;
            const failed = tests.filter(t => t.status === 'fail').length;
            const warnings = tests.filter(t => t.status === 'warning').length;
            const total = tests.length;
            const successRate = ((passed / total) * 100).toFixed(1);

            document.getElementById('summary').innerHTML = `
                <div style="display: flex; justify-content: space-between;">
                    <div>
                        <strong>Total Tests:</strong> ${total}<br>
                        <strong>Passed:</strong> <span style="color: #0f0;">${passed}</span><br>
                        <strong>Failed:</strong> <span style="color: #f00;">${failed}</span><br>
                        <strong>Warnings:</strong> <span style="color: #ff0;">${warnings}</span>
                    </div>
                    <div style="text-align: right;">
                        <strong>Success Rate:</strong> ${successRate}%<br>
                        <strong>Version:</strong> ${EXPECTED_VERSION}<br>
                        <strong>Status:</strong> ${failed === 0 ? '‚úÖ DEPLOYED' : '‚ùå ISSUES FOUND'}
                    </div>
                </div>
                ${failed === 0 ? 
                    '<div style="margin-top: 15px; color: #0f0; font-weight: bold;">‚úÖ Currency fix successfully deployed! The 1:1 USD/ILS issue is resolved.</div>' : 
                    '<div style="margin-top: 15px; color: #f00; font-weight: bold;">‚ö†Ô∏è Some tests failed. Please check the results above.</div>'
                }
            `;

            // Log to console
            console.log('Test Summary:', {
                total,
                passed,
                failed,
                warnings,
                successRate: successRate + '%',
                tests: tests
            });
        }

        async function runLiveTest() {
            const frame = document.getElementById('appFrame');
            frame.style.display = 'block';
            frame.src = PRODUCTION_URL;
            
            alert(`Live Test Instructions:
1. The application will load below
2. Set currency to ILS (shekel)
3. Go to the RSU section
4. Select any company (e.g., Apple)
5. Check that it shows "Loading exchange rate..." initially
6. Verify it shows ~3.7 ILS per USD (not 1:1)
7. Test both main and partner RSU selectors in couple mode`);
        }

        function showApp() {
            const frame = document.getElementById('appFrame');
            frame.style.display = frame.style.display === 'none' ? 'block' : 'none';
            if (frame.style.display === 'block' && !frame.src) {
                frame.src = PRODUCTION_URL;
            }
        }

        // Run tests on load
        window.onload = runTests;
    </script>
</body>
</html>