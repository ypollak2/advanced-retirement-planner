<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Post-Deployment E2E Tests - Advanced Retirement Planner v7.3.1</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .header {
            background-color: #2563eb;
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .test-section {
            background-color: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-item {
            padding: 10px;
            margin: 5px 0;
            border-left: 4px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .test-item.pass {
            border-color: #10b981;
            background-color: #f0fdf4;
        }
        .test-item.fail {
            border-color: #ef4444;
            background-color: #fef2f2;
        }
        .test-item.running {
            border-color: #f59e0b;
            background-color: #fffbeb;
        }
        .status {
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }
        .status.pass { background-color: #10b981; color: white; }
        .status.fail { background-color: #ef4444; color: white; }
        .status.running { background-color: #f59e0b; color: white; }
        .summary {
            background-color: #1e40af;
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            font-size: 18px;
        }
        .error-details {
            background-color: #fee;
            padding: 10px;
            margin-top: 5px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            color: #dc2626;
        }
        iframe {
            width: 100%;
            height: 600px;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin-top: 20px;
        }
        .console-output {
            background-color: #1f2937;
            color: #f3f4f6;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .console-error { color: #ef4444; }
        .console-warn { color: #f59e0b; }
        .console-info { color: #3b82f6; }
        .console-log { color: #f3f4f6; }
        button {
            background-color: #2563eb;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }
        button:hover {
            background-color: #1d4ed8;
        }
        button:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üöÄ Post-Deployment E2E Tests - v7.3.1</h1>
        <p>Production URL: https://ypollak2.github.io/advanced-retirement-planner/</p>
        <p>Test Started: <span id="testStartTime"></span></p>
    </div>

    <div class="test-section">
        <h2>Test Controls</h2>
        <button onclick="runAllTests()">Run All Tests</button>
        <button onclick="runCriticalTests()">Run Critical Tests Only</button>
        <button onclick="clearResults()">Clear Results</button>
    </div>

    <div class="test-section">
        <h2>üîç Deployment Verification</h2>
        <div id="deploymentTests"></div>
    </div>

    <div class="test-section">
        <h2>üéØ Core Functionality Tests</h2>
        <div id="coreTests"></div>
    </div>

    <div class="test-section">
        <h2>üíæ Data Persistence Tests</h2>
        <div id="persistenceTests"></div>
    </div>

    <div class="test-section">
        <h2>üåê API Integration Tests</h2>
        <div id="apiTests"></div>
    </div>

    <div class="test-section">
        <h2>‚ôø Accessibility Tests</h2>
        <div id="accessibilityTests"></div>
    </div>

    <div class="test-section">
        <h2>üìä Performance Tests</h2>
        <div id="performanceTests"></div>
    </div>

    <div class="test-section">
        <h2>üñ•Ô∏è Console Output</h2>
        <div id="consoleOutput" class="console-output"></div>
    </div>

    <div id="summary" class="summary" style="display: none;"></div>

    <iframe id="testFrame" style="display: none;"></iframe>

    <script>
        const PRODUCTION_URL = 'https://ypollak2.github.io/advanced-retirement-planner/';
        const EXPECTED_VERSION = '7.3.1';
        let testResults = [];
        let consoleMessages = [];

        // Test definitions
        const deploymentTests = [
            {
                name: 'Application loads successfully',
                test: async (frame) => {
                    const title = await frame.contentDocument.title;
                    if (!title.includes('Advanced Retirement Planner')) {
                        throw new Error(`Unexpected title: ${title}`);
                    }
                }
            },
            {
                name: `Version ${EXPECTED_VERSION} is deployed`,
                test: async (frame) => {
                    const versionElement = frame.contentDocument.querySelector('.version-display');
                    if (!versionElement) {
                        throw new Error('Version element not found');
                    }
                    const version = versionElement.textContent;
                    if (!version.includes(EXPECTED_VERSION)) {
                        throw new Error(`Expected version ${EXPECTED_VERSION}, got ${version}`);
                    }
                }
            },
            {
                name: 'Service Worker is registered',
                test: async (frame) => {
                    const registration = await frame.contentWindow.navigator.serviceWorker.getRegistration();
                    if (!registration) {
                        throw new Error('Service Worker not registered');
                    }
                }
            },
            {
                name: 'No critical console errors',
                test: async (frame) => {
                    const errors = consoleMessages.filter(m => m.type === 'error' && !m.message.includes('Download the React DevTools'));
                    if (errors.length > 0) {
                        throw new Error(`Found ${errors.length} console errors: ${errors[0].message}`);
                    }
                }
            }
        ];

        const coreTests = [
            {
                name: 'Retirement Wizard loads without errors',
                test: async (frame) => {
                    // Wait for wizard to be available
                    await waitFor(() => frame.contentDocument.querySelector('.retirement-wizard'), 5000);
                    const wizard = frame.contentDocument.querySelector('.retirement-wizard');
                    if (!wizard) {
                        throw new Error('Retirement wizard not found');
                    }
                }
            },
            {
                name: 'Financial Health Score displays correctly',
                test: async (frame) => {
                    const healthScore = frame.contentDocument.querySelector('[data-testid="financial-health-score"]');
                    if (healthScore) {
                        const score = healthScore.textContent;
                        if (!score || score === 'NaN') {
                            throw new Error('Invalid financial health score');
                        }
                    }
                }
            },
            {
                name: 'Language switcher works',
                test: async (frame) => {
                    const langToggle = frame.contentDocument.querySelector('[data-testid="language-toggle"]');
                    if (langToggle) {
                        langToggle.click();
                        await new Promise(resolve => setTimeout(resolve, 500));
                        const hebrewText = frame.contentDocument.body.textContent.includes('◊™◊õ◊†◊ï◊ü ◊§◊†◊°◊ô◊î');
                        if (!hebrewText) {
                            throw new Error('Language switch to Hebrew failed');
                        }
                        // Switch back
                        langToggle.click();
                    }
                }
            },
            {
                name: 'Currency selector works',
                test: async (frame) => {
                    const currencySelect = frame.contentDocument.querySelector('[data-testid="currency-selector"]');
                    if (currencySelect) {
                        const options = currencySelect.querySelectorAll('option');
                        if (options.length < 6) { // ILS, USD, EUR, GBP, BTC, ETH
                            throw new Error(`Expected at least 6 currencies, found ${options.length}`);
                        }
                    }
                }
            }
        ];

        const persistenceTests = [
            {
                name: 'LocalStorage saves wizard progress',
                test: async (frame) => {
                    const testData = { test: 'data', timestamp: Date.now() };
                    frame.contentWindow.localStorage.setItem('retirementWizardProgress', JSON.stringify(testData));
                    const saved = frame.contentWindow.localStorage.getItem('retirementWizardProgress');
                    const parsed = JSON.parse(saved);
                    if (parsed.test !== testData.test) {
                        throw new Error('LocalStorage save/load failed');
                    }
                }
            },
            {
                name: 'IndexedDB is available',
                test: async (frame) => {
                    if (!frame.contentWindow.indexedDB) {
                        throw new Error('IndexedDB not available');
                    }
                }
            }
        ];

        const apiTests = [
            {
                name: 'Currency API endpoint responds',
                test: async (frame) => {
                    // Check if currency API module is loaded
                    if (!frame.contentWindow.currencyAPI) {
                        throw new Error('Currency API module not loaded');
                    }
                }
            },
            {
                name: 'Stock price API has fallback',
                test: async (frame) => {
                    // Check if digital asset API is loaded
                    if (!frame.contentWindow.digitalAssetAPI) {
                        throw new Error('Digital Asset API module not loaded');
                    }
                }
            }
        ];

        const accessibilityTests = [
            {
                name: 'Skip navigation link exists',
                test: async (frame) => {
                    const skipLink = frame.contentDocument.querySelector('a[href="#root"]');
                    if (!skipLink) {
                        throw new Error('Skip navigation link not found');
                    }
                }
            },
            {
                name: 'Page has H1 heading',
                test: async (frame) => {
                    const h1 = frame.contentDocument.querySelector('h1');
                    if (!h1) {
                        throw new Error('H1 heading not found');
                    }
                }
            },
            {
                name: 'Keyboard navigation hint displayed',
                test: async (frame) => {
                    const keyboardHint = frame.contentDocument.body.textContent.includes('Alt+Arrow') || 
                                       frame.contentDocument.body.textContent.includes('keyboard navigation');
                    if (!keyboardHint) {
                        console.warn('Keyboard navigation hint not prominently displayed');
                    }
                }
            }
        ];

        const performanceTests = [
            {
                name: 'Page loads within 5 seconds',
                test: async (frame) => {
                    const loadTime = performance.timing.loadEventEnd - performance.timing.navigationStart;
                    if (loadTime > 5000) {
                        throw new Error(`Page load took ${loadTime}ms (> 5000ms)`);
                    }
                }
            },
            {
                name: 'Memory usage is reasonable',
                test: async (frame) => {
                    if (performance.memory) {
                        const usedMB = performance.memory.usedJSHeapSize / 1024 / 1024;
                        if (usedMB > 100) {
                            console.warn(`High memory usage: ${usedMB.toFixed(2)}MB`);
                        }
                    }
                }
            }
        ];

        // Helper functions
        function waitFor(condition, timeout = 5000) {
            return new Promise((resolve, reject) => {
                const startTime = Date.now();
                const interval = setInterval(() => {
                    try {
                        if (condition()) {
                            clearInterval(interval);
                            resolve();
                        } else if (Date.now() - startTime > timeout) {
                            clearInterval(interval);
                            reject(new Error('Timeout waiting for condition'));
                        }
                    } catch (e) {
                        if (Date.now() - startTime > timeout) {
                            clearInterval(interval);
                            reject(e);
                        }
                    }
                }, 100);
            });
        }

        function updateTestUI(containerId, testName, status, error = null) {
            const container = document.getElementById(containerId);
            let testDiv = container.querySelector(`[data-test="${testName}"]`);
            
            if (!testDiv) {
                testDiv = document.createElement('div');
                testDiv.className = 'test-item';
                testDiv.setAttribute('data-test', testName);
                container.appendChild(testDiv);
            }
            
            testDiv.className = `test-item ${status}`;
            testDiv.innerHTML = `
                <span>${testName}</span>
                <span class="status ${status}">${status.toUpperCase()}</span>
            `;
            
            if (error) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-details';
                errorDiv.textContent = error.toString();
                testDiv.appendChild(errorDiv);
            }
        }

        function addConsoleMessage(type, message) {
            const output = document.getElementById('consoleOutput');
            const msgDiv = document.createElement('div');
            msgDiv.className = `console-${type}`;
            msgDiv.textContent = `[${type.toUpperCase()}] ${message}`;
            output.appendChild(msgDiv);
            output.scrollTop = output.scrollHeight;
            
            consoleMessages.push({ type, message, timestamp: Date.now() });
        }

        async function runTestSuite(tests, containerId) {
            const frame = document.getElementById('testFrame');
            
            for (const test of tests) {
                updateTestUI(containerId, test.name, 'running');
                
                try {
                    await test.test(frame);
                    updateTestUI(containerId, test.name, 'pass');
                    testResults.push({ name: test.name, status: 'pass' });
                    addConsoleMessage('info', `‚úÖ ${test.name}`);
                } catch (error) {
                    updateTestUI(containerId, test.name, 'fail', error);
                    testResults.push({ name: test.name, status: 'fail', error: error.toString() });
                    addConsoleMessage('error', `‚ùå ${test.name}: ${error.message}`);
                }
                
                // Small delay between tests
                await new Promise(resolve => setTimeout(resolve, 100));
            }
        }

        async function loadApplication() {
            return new Promise((resolve, reject) => {
                const frame = document.getElementById('testFrame');
                frame.style.display = 'block';
                
                // Set up console interceptor
                frame.onload = () => {
                    // Override console methods in iframe
                    const originalConsole = frame.contentWindow.console;
                    ['log', 'error', 'warn', 'info'].forEach(method => {
                        frame.contentWindow.console[method] = function(...args) {
                            addConsoleMessage(method, args.join(' '));
                            originalConsole[method].apply(originalConsole, args);
                        };
                    });
                    
                    // Wait for app to fully initialize
                    const checkInitialized = setInterval(() => {
                        if (frame.contentWindow.RetirementPlannerApp || 
                            frame.contentDocument.querySelector('.retirement-planner-app')) {
                            clearInterval(checkInitialized);
                            setTimeout(resolve, 1000); // Give it another second
                        }
                    }, 500);
                    
                    // Fallback timeout
                    setTimeout(() => {
                        clearInterval(checkInitialized);
                        resolve();
                    }, 15000);
                };
                
                frame.onerror = reject;
                frame.src = PRODUCTION_URL;
                
                // Timeout after 30 seconds (increased for slow deployment propagation)
                setTimeout(() => reject(new Error('Application load timeout')), 30000);
            });
        }

        async function runAllTests() {
            document.getElementById('summary').style.display = 'none';
            testResults = [];
            consoleMessages = [];
            document.getElementById('consoleOutput').innerHTML = '';
            
            const startTime = new Date();
            document.getElementById('testStartTime').textContent = startTime.toLocaleString();
            
            try {
                addConsoleMessage('info', 'üöÄ Loading application...');
                await loadApplication();
                addConsoleMessage('info', '‚úÖ Application loaded successfully');
                
                // Run all test suites
                await runTestSuite(deploymentTests, 'deploymentTests');
                await runTestSuite(coreTests, 'coreTests');
                await runTestSuite(persistenceTests, 'persistenceTests');
                await runTestSuite(apiTests, 'apiTests');
                await runTestSuite(accessibilityTests, 'accessibilityTests');
                await runTestSuite(performanceTests, 'performanceTests');
                
            } catch (error) {
                addConsoleMessage('error', `Fatal error: ${error.message}`);
            }
            
            // Show summary
            showSummary();
        }

        async function runCriticalTests() {
            document.getElementById('summary').style.display = 'none';
            testResults = [];
            consoleMessages = [];
            document.getElementById('consoleOutput').innerHTML = '';
            
            const startTime = new Date();
            document.getElementById('testStartTime').textContent = startTime.toLocaleString();
            
            try {
                addConsoleMessage('info', 'üöÄ Loading application...');
                await loadApplication();
                addConsoleMessage('info', '‚úÖ Application loaded successfully');
                
                // Run only critical tests
                await runTestSuite(deploymentTests, 'deploymentTests');
                await runTestSuite(coreTests.slice(0, 2), 'coreTests'); // Just wizard and health score
                
            } catch (error) {
                addConsoleMessage('error', `Fatal error: ${error.message}`);
            }
            
            // Show summary
            showSummary();
        }

        function showSummary() {
            const passed = testResults.filter(r => r.status === 'pass').length;
            const failed = testResults.filter(r => r.status === 'fail').length;
            const total = testResults.length;
            
            const summaryDiv = document.getElementById('summary');
            summaryDiv.style.display = 'block';
            
            const status = failed === 0 ? '‚úÖ ALL TESTS PASSED' : '‚ùå SOME TESTS FAILED';
            const statusColor = failed === 0 ? '#10b981' : '#ef4444';
            
            summaryDiv.innerHTML = `
                <h2 style="margin: 0 0 10px 0;">${status}</h2>
                <div>Total Tests: ${total}</div>
                <div>Passed: ${passed} (${((passed/total)*100).toFixed(1)}%)</div>
                <div>Failed: ${failed}</div>
                <div style="margin-top: 10px;">
                    <strong>Production URL:</strong> ${PRODUCTION_URL}<br>
                    <strong>Version:</strong> ${EXPECTED_VERSION}<br>
                    <strong>Test Completed:</strong> ${new Date().toLocaleString()}
                </div>
            `;
            
            summaryDiv.style.backgroundColor = statusColor;
            
            // Log to console for CI/CD
            console.log(`E2E Test Results: ${passed}/${total} passed`);
            if (failed > 0) {
                console.error('Failed tests:', testResults.filter(r => r.status === 'fail'));
            }
        }

        function clearResults() {
            ['deploymentTests', 'coreTests', 'persistenceTests', 'apiTests', 'accessibilityTests', 'performanceTests'].forEach(id => {
                document.getElementById(id).innerHTML = '';
            });
            document.getElementById('consoleOutput').innerHTML = '';
            document.getElementById('summary').style.display = 'none';
            document.getElementById('testFrame').style.display = 'none';
            testResults = [];
            consoleMessages = [];
        }

        // Auto-run critical tests on load
        window.addEventListener('load', () => {
            addConsoleMessage('info', 'üéØ Post-Deployment E2E Test Suite Ready');
            addConsoleMessage('info', `Target: ${PRODUCTION_URL}`);
            addConsoleMessage('info', `Expected Version: ${EXPECTED_VERSION}`);
            // Uncomment to auto-run: runCriticalTests();
        });
    </script>
</body>
</html>