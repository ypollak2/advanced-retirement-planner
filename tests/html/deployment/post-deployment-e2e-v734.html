<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Post-Deployment E2E Tests - v7.3.4</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #0a0e27;
            color: #e0e6ed;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        h1 {
            color: #4fc3f7;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 0 0 20px rgba(79, 195, 247, 0.5);
        }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .test-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .test-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(79, 195, 247, 0.2);
        }
        .test-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .test-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #4fc3f7;
        }
        .test-status {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            text-transform: uppercase;
        }
        .status-pending {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
            border: 1px solid #ffc107;
        }
        .status-running {
            background: rgba(33, 150, 243, 0.2);
            color: #2196f3;
            border: 1px solid #2196f3;
            animation: pulse 1.5s infinite;
        }
        .status-pass {
            background: rgba(76, 175, 80, 0.2);
            color: #4caf50;
            border: 1px solid #4caf50;
        }
        .status-fail {
            background: rgba(244, 67, 54, 0.2);
            color: #f44336;
            border: 1px solid #f44336;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        .test-details {
            margin-top: 10px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            max-height: 200px;
            overflow-y: auto;
        }
        .control-panel {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        button {
            background: #4fc3f7;
            color: #0a0e27;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1em;
        }
        button:hover {
            background: #29b6f6;
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(79, 195, 247, 0.4);
        }
        button:disabled {
            background: #555;
            color: #999;
            cursor: not-allowed;
            transform: none;
        }
        .summary-panel {
            background: linear-gradient(135deg, rgba(79, 195, 247, 0.1), rgba(41, 182, 246, 0.05));
            border: 2px solid #4fc3f7;
            border-radius: 12px;
            padding: 30px;
            margin-top: 30px;
            text-align: center;
        }
        .summary-stats {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            flex-wrap: wrap;
            gap: 20px;
        }
        .stat {
            text-align: center;
        }
        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stat-label {
            color: #8892b0;
            font-size: 0.9em;
            text-transform: uppercase;
        }
        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 20px;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4caf50, #29b6f6);
            transition: width 0.3s ease;
        }
        .test-iframe {
            width: 100%;
            height: 700px;
            border: 2px solid #4fc3f7;
            border-radius: 12px;
            margin-top: 20px;
            background: white;
        }
        .hidden {
            display: none;
        }
        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .log-time {
            color: #8892b0;
            font-size: 0.85em;
        }
        .error {
            color: #f44336;
        }
        .success {
            color: #4caf50;
        }
        .warning {
            color: #ffc107;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸš€ Post-Deployment E2E Test Suite</h1>
        
        <div class="control-panel">
            <div>
                <strong>Version:</strong> 7.3.4 | 
                <strong>Environment:</strong> Production | 
                <strong>URL:</strong> <a href="https://ypollak2.github.io/advanced-retirement-planner/" target="_blank" style="color: #4fc3f7;">Live Site</a>
            </div>
            <div>
                <button onclick="runAllTests()">Run All Tests</button>
                <button onclick="runCriticalTests()">Critical Tests Only</button>
                <button onclick="showLiveApp()">Show Live App</button>
                <button onclick="exportResults()">Export Results</button>
            </div>
        </div>

        <div class="summary-panel hidden" id="summaryPanel">
            <h2>Test Summary</h2>
            <div class="summary-stats">
                <div class="stat">
                    <div class="stat-value" id="totalTests">0</div>
                    <div class="stat-label">Total Tests</div>
                </div>
                <div class="stat">
                    <div class="stat-value success" id="passedTests">0</div>
                    <div class="stat-label">Passed</div>
                </div>
                <div class="stat">
                    <div class="stat-value error" id="failedTests">0</div>
                    <div class="stat-label">Failed</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="successRate">0%</div>
                    <div class="stat-label">Success Rate</div>
                </div>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressBar" style="width: 0%"></div>
            </div>
        </div>

        <div class="test-grid" id="testGrid"></div>

        <iframe id="appFrame" class="test-iframe hidden"></iframe>
    </div>

    <script>
        const PRODUCTION_URL = 'https://ypollak2.github.io/advanced-retirement-planner/';
        const EXPECTED_VERSION = '7.3.4';
        
        const testSuites = [
            {
                id: 'deployment',
                title: 'ðŸš€ Deployment Verification',
                critical: true,
                tests: [
                    {
                        name: 'Version Check',
                        run: async () => {
                            const response = await fetch(PRODUCTION_URL + 'version.json');
                            const data = await response.json();
                            if (data.version !== EXPECTED_VERSION) {
                                throw new Error(`Expected v${EXPECTED_VERSION}, got v${data.version}`);
                            }
                            return `Version ${EXPECTED_VERSION} confirmed`;
                        }
                    },
                    {
                        name: 'Service Worker',
                        run: async () => {
                            const response = await fetch(PRODUCTION_URL + 'sw.js');
                            const text = await response.text();
                            if (!text.includes(EXPECTED_VERSION)) {
                                throw new Error('Service Worker not updated');
                            }
                            return 'Service Worker updated to v' + EXPECTED_VERSION;
                        }
                    },
                    {
                        name: 'Main Page Load',
                        run: async () => {
                            const response = await fetch(PRODUCTION_URL);
                            if (response.status !== 200) {
                                throw new Error(`HTTP ${response.status}`);
                            }
                            const text = await response.text();
                            if (!text.includes('Advanced Retirement Planner')) {
                                throw new Error('Invalid page content');
                            }
                            return 'Main page loads successfully';
                        }
                    }
                ]
            },
            {
                id: 'currency',
                title: 'ðŸ’± Currency Fix Verification',
                critical: true,
                tests: [
                    {
                        name: 'RSU Component Currency Init',
                        run: async () => {
                            const response = await fetch(PRODUCTION_URL + 'src/components/shared/EnhancedRSUCompanySelector.js?v=' + EXPECTED_VERSION);
                            const text = await response.text();
                            
                            if (text.includes('useState(1)') && text.includes('currencyRate')) {
                                throw new Error('Still using useState(1) for currency rate');
                            }
                            
                            if (!text.includes('useState(null)') || !text.includes('currencyRate')) {
                                throw new Error('Currency rate not properly initialized to null');
                            }
                            
                            return 'Currency rate correctly initialized to null';
                        }
                    },
                    {
                        name: 'Partner RSU Currency Init',
                        run: async () => {
                            const response = await fetch(PRODUCTION_URL + 'src/components/shared/PartnerRSUSelector.js?v=' + EXPECTED_VERSION);
                            const text = await response.text();
                            
                            if (!text.includes('useState(null)') || !text.includes('currencyRate')) {
                                throw new Error('Partner RSU currency not properly initialized');
                            }
                            
                            return 'Partner RSU currency correctly initialized';
                        }
                    },
                    {
                        name: 'Currency Display Logic',
                        run: async () => {
                            const response = await fetch(PRODUCTION_URL + 'src/components/shared/EnhancedRSUCompanySelector.js?v=' + EXPECTED_VERSION);
                            const text = await response.text();
                            
                            if (!text.includes('currencyRate !== null && currencyRate > 0')) {
                                throw new Error('Missing null check for currency display');
                            }
                            
                            if (!text.includes('Loading exchange rate') && !text.includes('×˜×•×¢×Ÿ ×©×¢×¨ ×—×œ×™×¤×™×Ÿ')) {
                                throw new Error('Missing loading state text');
                            }
                            
                            return 'Currency display logic properly handles null state';
                        }
                    }
                ]
            },
            {
                id: 'core',
                title: 'ðŸŽ¯ Core Functionality',
                critical: true,
                tests: [
                    {
                        name: 'Retirement Calculator',
                        run: async () => {
                            const response = await fetch(PRODUCTION_URL + 'src/utils/retirementCalculations.js?v=' + EXPECTED_VERSION);
                            if (response.status !== 200) {
                                throw new Error('Calculator script not accessible');
                            }
                            const text = await response.text();
                            if (!text.includes('calculateRetirement')) {
                                throw new Error('Missing core calculation function');
                            }
                            return 'Retirement calculator loaded';
                        }
                    },
                    {
                        name: 'Financial Health Engine',
                        run: async () => {
                            const response = await fetch(PRODUCTION_URL + 'src/utils/financialHealthEngine.js?v=' + EXPECTED_VERSION);
                            if (response.status !== 200) {
                                throw new Error('Financial health engine not accessible');
                            }
                            return 'Financial health engine loaded';
                        }
                    },
                    {
                        name: 'Currency API',
                        run: async () => {
                            const response = await fetch(PRODUCTION_URL + 'src/utils/currencyAPI.js?v=' + EXPECTED_VERSION);
                            const text = await response.text();
                            if (!text.includes('CurrencyAPI')) {
                                throw new Error('Currency API not properly defined');
                            }
                            return 'Currency API loaded with fallback rates';
                        }
                    }
                ]
            },
            {
                id: 'components',
                title: 'ðŸ§© Component Loading',
                critical: false,
                tests: [
                    {
                        name: 'Retirement Wizard',
                        run: async () => {
                            const response = await fetch(PRODUCTION_URL + 'src/components/wizard/RetirementWizard.js?v=' + EXPECTED_VERSION);
                            if (response.status !== 200) {
                                throw new Error('Wizard component not accessible');
                            }
                            const text = await response.text();
                            // Check for the fix we applied
                            if (text.includes("Cannot access 't' before initialization")) {
                                throw new Error('Initialization error still present');
                            }
                            return 'Wizard component loads without initialization errors';
                        }
                    },
                    {
                        name: 'Accessibility Utils',
                        run: async () => {
                            const response = await fetch(PRODUCTION_URL + 'src/utils/accessibilityUtils.js?v=' + EXPECTED_VERSION);
                            const text = await response.text();
                            // Check that number navigation was removed
                            if (text.includes('parseInt(key)') && text.includes('wizardStepChange')) {
                                throw new Error('Number key navigation not removed');
                            }
                            return 'Accessibility utils updated (no number nav)';
                        }
                    },
                    {
                        name: 'Export Functions',
                        run: async () => {
                            const response = await fetch(PRODUCTION_URL + 'src/utils/exportFunctions.js?v=' + EXPECTED_VERSION);
                            if (response.status !== 200) {
                                throw new Error('Export functions not accessible');
                            }
                            return 'Export functions available';
                        }
                    }
                ]
            },
            {
                id: 'performance',
                title: 'âš¡ Performance Tests',
                critical: false,
                tests: [
                    {
                        name: 'Page Load Time',
                        run: async () => {
                            const start = performance.now();
                            await fetch(PRODUCTION_URL);
                            const loadTime = performance.now() - start;
                            if (loadTime > 3000) {
                                throw new Error(`Load time too high: ${loadTime.toFixed(0)}ms`);
                            }
                            return `Page loaded in ${loadTime.toFixed(0)}ms`;
                        }
                    },
                    {
                        name: 'Asset Caching',
                        run: async () => {
                            // First request
                            const response1 = await fetch(PRODUCTION_URL + 'src/version.js?v=' + EXPECTED_VERSION);
                            const headers1 = response1.headers;
                            
                            // Second request should be cached
                            const start = performance.now();
                            const response2 = await fetch(PRODUCTION_URL + 'src/version.js?v=' + EXPECTED_VERSION);
                            const cacheTime = performance.now() - start;
                            
                            if (cacheTime > 50) {
                                return `Cache working (${cacheTime.toFixed(0)}ms) - may vary`;
                            }
                            return `Excellent cache performance (${cacheTime.toFixed(0)}ms)`;
                        }
                    },
                    {
                        name: 'Bundle Size Check',
                        run: async () => {
                            const criticalFiles = [
                                'index.html',
                                'src/components/core/RetirementPlannerApp.js',
                                'src/utils/retirementCalculations.js'
                            ];
                            
                            let totalSize = 0;
                            for (const file of criticalFiles) {
                                const response = await fetch(PRODUCTION_URL + file + (file.endsWith('.js') ? '?v=' + EXPECTED_VERSION : ''));
                                const text = await response.text();
                                totalSize += text.length;
                            }
                            
                            const sizeMB = (totalSize / 1024 / 1024).toFixed(2);
                            if (totalSize > 5 * 1024 * 1024) {
                                throw new Error(`Bundle too large: ${sizeMB}MB`);
                            }
                            return `Total critical bundle: ${sizeMB}MB`;
                        }
                    }
                ]
            },
            {
                id: 'security',
                title: 'ðŸ”’ Security Checks',
                critical: false,
                tests: [
                    {
                        name: 'HTTPS Enforcement',
                        run: async () => {
                            if (!PRODUCTION_URL.startsWith('https://')) {
                                throw new Error('Not using HTTPS');
                            }
                            return 'HTTPS enforced';
                        }
                    },
                    {
                        name: 'No Exposed Secrets',
                        run: async () => {
                            const response = await fetch(PRODUCTION_URL);
                            const text = await response.text();
                            
                            const patterns = ['api_key', 'API_KEY', 'secret', 'SECRET', 'password', 'token'];
                            for (const pattern of patterns) {
                                if (text.includes(pattern + '=') || text.includes(pattern + ':')) {
                                    throw new Error(`Potential exposed secret: ${pattern}`);
                                }
                            }
                            return 'No exposed secrets found';
                        }
                    },
                    {
                        name: 'Content Security',
                        run: async () => {
                            const response = await fetch(PRODUCTION_URL);
                            const csp = response.headers.get('Content-Security-Policy');
                            // GitHub Pages doesn't set CSP headers, this is expected
                            return 'Security check complete (GitHub Pages hosting)';
                        }
                    }
                ]
            }
        ];

        let testResults = [];
        let isRunning = false;

        function createTestCard(suite) {
            return `
                <div class="test-card" id="suite-${suite.id}">
                    <div class="test-header">
                        <div class="test-title">${suite.title}</div>
                        <div class="test-status status-pending" id="status-${suite.id}">Pending</div>
                    </div>
                    <div class="test-details" id="details-${suite.id}"></div>
                </div>
            `;
        }

        function updateTestStatus(suiteId, status, details = '') {
            const statusEl = document.getElementById(`status-${suiteId}`);
            const detailsEl = document.getElementById(`details-${suiteId}`);
            
            statusEl.className = `test-status status-${status}`;
            statusEl.textContent = status.charAt(0).toUpperCase() + status.slice(1);
            
            if (details) {
                const time = new Date().toLocaleTimeString();
                detailsEl.innerHTML += `<div class="log-entry"><span class="log-time">[${time}]</span> ${details}</div>`;
                detailsEl.scrollTop = detailsEl.scrollHeight;
            }
        }

        function updateSummary() {
            const total = testResults.length;
            const passed = testResults.filter(r => r.status === 'pass').length;
            const failed = testResults.filter(r => r.status === 'fail').length;
            const rate = total > 0 ? Math.round((passed / total) * 100) : 0;
            
            document.getElementById('totalTests').textContent = total;
            document.getElementById('passedTests').textContent = passed;
            document.getElementById('failedTests').textContent = failed;
            document.getElementById('successRate').textContent = rate + '%';
            document.getElementById('progressBar').style.width = rate + '%';
            
            if (total > 0) {
                document.getElementById('summaryPanel').classList.remove('hidden');
            }
        }

        async function runTestSuite(suite, criticalOnly = false) {
            if (criticalOnly && !suite.critical) return;
            
            updateTestStatus(suite.id, 'running', 'Starting tests...');
            
            let suitePass = true;
            
            for (const test of suite.tests) {
                try {
                    updateTestStatus(suite.id, 'running', `Running: ${test.name}`);
                    const result = await test.run();
                    
                    testResults.push({
                        suite: suite.title,
                        test: test.name,
                        status: 'pass',
                        message: result
                    });
                    
                    updateTestStatus(suite.id, 'running', `<span class="success">âœ“ ${test.name}: ${result}</span>`);
                } catch (error) {
                    suitePass = false;
                    
                    testResults.push({
                        suite: suite.title,
                        test: test.name,
                        status: 'fail',
                        message: error.message
                    });
                    
                    updateTestStatus(suite.id, 'running', `<span class="error">âœ— ${test.name}: ${error.message}</span>`);
                }
                
                updateSummary();
                await new Promise(resolve => setTimeout(resolve, 500)); // Brief pause between tests
            }
            
            updateTestStatus(suite.id, suitePass ? 'pass' : 'fail');
        }

        async function runAllTests() {
            if (isRunning) return;
            
            isRunning = true;
            testResults = [];
            
            // Reset all test cards
            testSuites.forEach(suite => {
                updateTestStatus(suite.id, 'pending');
                document.getElementById(`details-${suite.id}`).innerHTML = '';
            });
            
            for (const suite of testSuites) {
                await runTestSuite(suite);
            }
            
            isRunning = false;
        }

        async function runCriticalTests() {
            if (isRunning) return;
            
            isRunning = true;
            testResults = [];
            
            // Reset critical test cards
            testSuites.filter(s => s.critical).forEach(suite => {
                updateTestStatus(suite.id, 'pending');
                document.getElementById(`details-${suite.id}`).innerHTML = '';
            });
            
            for (const suite of testSuites) {
                await runTestSuite(suite, true);
            }
            
            isRunning = false;
        }

        function showLiveApp() {
            const frame = document.getElementById('appFrame');
            frame.classList.toggle('hidden');
            if (!frame.src) {
                frame.src = PRODUCTION_URL;
            }
        }

        function exportResults() {
            const report = {
                version: EXPECTED_VERSION,
                timestamp: new Date().toISOString(),
                url: PRODUCTION_URL,
                summary: {
                    total: testResults.length,
                    passed: testResults.filter(r => r.status === 'pass').length,
                    failed: testResults.filter(r => r.status === 'fail').length,
                    successRate: testResults.length > 0 ? 
                        Math.round((testResults.filter(r => r.status === 'pass').length / testResults.length) * 100) + '%' : '0%'
                },
                results: testResults
            };
            
            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `e2e-test-results-v${EXPECTED_VERSION}-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Initialize UI
        window.onload = () => {
            const grid = document.getElementById('testGrid');
            testSuites.forEach(suite => {
                grid.innerHTML += createTestCard(suite);
            });
            
            // Auto-run critical tests on load
            setTimeout(() => runCriticalTests(), 1000);
        };
    </script>
</body>
</html>